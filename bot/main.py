# bot/main.py - Discord Bot å•Ÿå‹•ä¸»ç¨‹å¼

import os
import sys
import asyncio
import discord
from dotenv import load_dotenv
from discord.ext import commands

# ğŸ‘‰ Windows ç›¸å®¹ï¼šé¿å… asyncio event loop å·²é—œé–‰éŒ¯èª¤
if sys.platform.startswith('win'):
    asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())

# ğŸ‘‰ è¼‰å…¥ .env ç’°å¢ƒè®Šæ•¸
load_dotenv()

# ğŸ‘‰ æª¢æŸ¥å¿…éœ€çš„ç’°å¢ƒè®Šæ•¸
required_vars = ["DISCORD_TOKEN", "DB_HOST", "DB_USER", "DB_PASSWORD", "DB_NAME"]
missing = [var for var in required_vars if os.getenv(var) is None]
if missing:
    print(f"âš ï¸ ç¼ºå°‘ .env è¨­å®šï¼š{', '.join(missing)}")
    print("è«‹åƒè€ƒ .env.example ä¸¦å»ºç«‹ .env å¾Œå†é‡æ–°å•Ÿå‹•ã€‚")
    sys.exit(1)

# ğŸ‘‰ å»ºç«‹ Discord Bot å¯¦ä¾‹
intents = discord.Intents.default()
intents.message_content = True  # è‹¥è¦æ”¯æ´ on_message ç›£è½å™¨
bot = commands.Bot(command_prefix="/", intents=intents)

# ğŸ‘‰ Bot ä¸Šç·šæ™‚åŸ·è¡Œ
@bot.event
async def on_ready():
    print(f"âœ… æ©Ÿå™¨äººå·²ä¸Šç·šï¼š{bot.user} (ID: {bot.user.id})")
    
    # æª¢æŸ¥è¼‰å…¥çš„æŒ‡ä»¤
    commands_list = [cmd.name for cmd in bot.tree.get_commands()]
    print(f"è¼‰å…¥çš„æŒ‡ä»¤ï¼š{commands_list}")
    
    # âœ… å¼·åˆ¶åŒæ­¥æŒ‡ä»¤åˆ° Discord
    try:
        print("ğŸ”„ é–‹å§‹åŒæ­¥æŒ‡ä»¤åˆ° Discord...")
        
        # æ–¹æ³•ä¸€ï¼šå…¨åŸŸåŒæ­¥ï¼ˆæ¨è–¦ï¼Œä½†éœ€è¦1å°æ™‚ç”Ÿæ•ˆï¼‰
        synced = await bot.tree.sync()
        print(f"âœ… å…¨åŸŸåŒæ­¥æˆåŠŸï¼š{len(synced)} å€‹æŒ‡ä»¤")
        
        # æ–¹æ³•äºŒï¼šå¦‚æœä½ æƒ³ç«‹å³åœ¨ç‰¹å®šä¼ºæœå™¨æ¸¬è©¦ï¼Œä½¿ç”¨é€™å€‹ï¼ˆæ›¿æ›ç‚ºä½ çš„ä¼ºæœå™¨IDï¼‰
        # guild = discord.Object(id=1392396522905276446)  # æ›¿æ›ç‚ºä½ çš„ä¼ºæœå™¨ID
        # synced = await bot.tree.sync(guild=guild)
        # print(f"âœ… ä¼ºæœå™¨åŒæ­¥æˆåŠŸï¼š{len(synced)} å€‹æŒ‡ä»¤")
        
        for cmd in synced:
            print(f"  - /{cmd.name}: {cmd.description}")
            
    except Exception as e:
        print(f"âŒ æŒ‡ä»¤åŒæ­¥å¤±æ•—ï¼š{e}")

# ğŸ‘‰ å¯é¸ï¼šåŠ å…¥æ‰‹å‹•åŒæ­¥æŒ‡ä»¤ï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰
@bot.command()
async def sync(ctx):
    """æ‰‹å‹•åŒæ­¥æŒ‡ä»¤ï¼ˆæ¸¬è©¦ç”¨ï¼‰"""
    if ctx.author.id != 292993868092276736:  # æ›¿æ›ç‚ºä½ çš„ Discord ç”¨æˆ¶ ID
        await ctx.send("âŒ åªæœ‰é–‹ç™¼è€…å¯ä»¥ä½¿ç”¨æ­¤æŒ‡ä»¤ã€‚")
        return
    
    try:
        synced = await bot.tree.sync()
        await ctx.send(f"âœ… åŒæ­¥æˆåŠŸï¼š{len(synced)} å€‹æŒ‡ä»¤")
    except Exception as e:
        await ctx.send(f"âŒ åŒæ­¥å¤±æ•—ï¼š{e}")

# ğŸ‘‰ ä¸»åŸ·è¡Œé‚è¼¯
async def main():
    try:
        # âœ… è³‡æ–™åº«åˆå§‹åŒ–
        from bot.db.pool import db_pool
        from shared import config  # å…±ç”¨è¨­å®šå€¼ä¾†è‡ª shared/config.py

        await db_pool.init_pool(
            host=config.DB_HOST,
            port=config.DB_PORT,
            user=config.DB_USER,
            password=config.DB_PASSWORD,
            db_name=config.DB_NAME
        )

        # âœ… è‡ªå‹•å»ºç«‹è³‡æ–™è¡¨ï¼ˆè‹¥å°šæœªå­˜åœ¨ï¼‰
        from bot.db import vote_dao
        await vote_dao.create_tables()

        # âœ… è¼‰å…¥åŠŸèƒ½æ¨¡çµ„ï¼ˆCogsï¼‰
        print("ğŸ”„ è¼‰å…¥åŠŸèƒ½æ¨¡çµ„...")
        await bot.load_extension("bot.cogs.vote")
        print("âœ… vote.py è¼‰å…¥æˆåŠŸ")
        
        await bot.load_extension("bot.cogs.vote_listener")
        print("âœ… vote_listener.py è¼‰å…¥æˆåŠŸ")

        await bot.load_extension("bot.cogs.ticket")
        print("âœ… ticket.py è¼‰å…¥æˆåŠŸ")
        # âœ… å•Ÿå‹•æ©Ÿå™¨äºº
        print("ğŸš€ å•Ÿå‹•æ©Ÿå™¨äºº...")
        await bot.start(config.DISCORD_TOKEN)

    except Exception as e:
        print(f"âŒ æ©Ÿå™¨äººå•Ÿå‹•å¤±æ•—ï¼š{e}")
        import traceback
        print(f"å®Œæ•´éŒ¯èª¤ï¼š{traceback.format_exc()}")
        raise

# ğŸ‘‰ åŸ·è¡Œ main å‡½å¼
if __name__ == "__main__":
    asyncio.run(main())