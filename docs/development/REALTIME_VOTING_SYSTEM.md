# ğŸš€ å¯¦æ™‚æŠ•ç¥¨çµ±è¨ˆç³»çµ±

**ç‰ˆæœ¬**: v3.0.0  
**å®Œæˆæ—¥æœŸ**: 2025-08-15  
**ç‹€æ…‹**: âœ… å·²å®Œæˆ

## ğŸ“‹ ç³»çµ±æ¦‚è¦½

å¯¦æ™‚æŠ•ç¥¨çµ±è¨ˆç³»çµ±æ˜¯ Potato Bot çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œæä¾›å³æ™‚çš„æŠ•ç¥¨æ•¸æ“šè¿½è¹¤ã€WebSocket é€£æ¥æ”¯æ´ï¼Œä»¥åŠéŸ¿æ‡‰å¼çš„ Web ç•Œé¢ã€‚ç³»çµ±æ”¯æ´å¤šç¨®é€£æ¥æ¨¡å¼ï¼Œç¢ºä¿åœ¨ä¸åŒç¶²çµ¡ç’°å¢ƒä¸‹éƒ½èƒ½æä¾›ç©©å®šçš„æœå‹™ã€‚

### ğŸŒŸ æ ¸å¿ƒç‰¹æ€§

- **ğŸ”— å¯¦æ™‚ WebSocket é€£æ¥**: å³æ™‚æ¨é€æŠ•ç¥¨æ›´æ–°
- **ğŸ“Š å³æ™‚æ•¸æ“šçµ±è¨ˆ**: å‹•æ…‹é¡¯ç¤ºæŠ•ç¥¨åƒèˆ‡æƒ…æ³
- **ğŸ“± éŸ¿æ‡‰å¼ Web UI**: å®Œç¾é©é…è¡Œå‹•è£ç½®
- **ğŸ”„ è‡ªå‹•é‡é€£æ©Ÿåˆ¶**: ç¢ºä¿é€£æ¥ç©©å®šæ€§
- **ğŸ’¾ HTTP å‚™æ´æ¨¡å¼**: ç¶²çµ¡ç•°å¸¸æ™‚çš„å‚™ç”¨æ–¹æ¡ˆ
- **ğŸ¯ å¿ƒè·³ç›£æ§**: é€£æ¥ç‹€æ…‹å¯¦æ™‚ç›£æ§

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

### å¾Œç«¯æ¶æ§‹

```
bot/api/realtime_api.py
â”œâ”€â”€ ConnectionManager         # WebSocket é€£æ¥ç®¡ç†
â”œâ”€â”€ WebSocket ç«¯é»           # å¯¦æ™‚é€šä¿¡
â”œâ”€â”€ HTTP API ç«¯é»            # å‚™æ´æ•¸æ“šç²å–
â””â”€â”€ è‡ªå‹•æ›´æ–°ä»»å‹™             # å®šæœŸæ•¸æ“šæ¨é€
```

### å‰ç«¯æ¶æ§‹

```
web-ui/src/app/votes/page.tsx
â”œâ”€â”€ WebSocket å®¢æˆ¶ç«¯         # å¯¦æ™‚é€£æ¥
â”œâ”€â”€ HTTP å‚™æ´æ¨¡å¼            # é€£æ¥å¤±æ•—æ™‚åˆ‡æ›
â”œâ”€â”€ éŸ¿æ‡‰å¼çµ„ä»¶               # é©é…å„ç¨®è¨­å‚™
â””â”€â”€ ç‹€æ…‹ç®¡ç†                 # é€£æ¥ç‹€æ…‹ç›£æ§
```

## ğŸ”§ æŠ€è¡“å¯¦ç¾

### WebSocket é€£æ¥ç®¡ç†

```python
class ConnectionManager:
    """WebSocket é€£æ¥ç®¡ç†å™¨"""
    
    def __init__(self):
        self.active_connections: Dict[str, Set[WebSocket]] = {}
        self.guild_subscriptions: Dict[int, Set[WebSocket]] = {}
    
    async def connect(self, websocket: WebSocket, guild_id: int, client_id: str)
    async def disconnect(self, websocket: WebSocket, guild_id: int, client_id: str)
    async def broadcast_to_guild(self, message: str, guild_id: int)
```

### å¯¦æ™‚æ•¸æ“šçµæ§‹

```typescript
interface RealTimeData {
  active_votes: VoteStat[]           // é€²è¡Œä¸­çš„æŠ•ç¥¨
  recent_completed: VoteStat[]       // æœ€è¿‘å®Œæˆçš„æŠ•ç¥¨
  today_statistics: {
    votes_created: number            // ä»Šæ—¥å‰µå»ºæŠ•ç¥¨æ•¸
    votes_completed: number          // ä»Šæ—¥å®ŒæˆæŠ•ç¥¨æ•¸
    total_participants: number       // ä»Šæ—¥ç¸½åƒèˆ‡äººæ•¸
  }
  summary: {
    active_count: number             // æ´»èºæŠ•ç¥¨æ•¸é‡
    total_active_participants: number // æ´»èºæŠ•ç¥¨ç¸½åƒèˆ‡äººæ•¸
  }
  last_updated: string              // æœ€å¾Œæ›´æ–°æ™‚é–“
}
```

### å‰ç«¯ WebSocket å®¢æˆ¶ç«¯

```typescript
const connectWebSocket = useCallback(() => {
  const guildId = 123456789
  const clientId = `web_client_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
  const wsUrl = `ws://localhost:8000/api/realtime/ws/${guildId}/${clientId}`
  
  wsRef.current = new WebSocket(wsUrl)
  
  wsRef.current.onopen = () => {
    setConnectionStatus('connected')
    // å¿ƒè·³æ©Ÿåˆ¶
    const heartbeat = setInterval(() => {
      if (wsRef.current?.readyState === WebSocket.OPEN) {
        wsRef.current.send(JSON.stringify({ type: 'ping' }))
      }
    }, 25000)
  }
  
  wsRef.current.onmessage = (event) => {
    const message = JSON.parse(event.data)
    switch (message.type) {
      case 'initial_data':
      case 'data_update':
      case 'auto_update':
        setRealTimeData(message.data)
        break
    }
  }
}, [])
```

## ğŸ“¡ API ç«¯é»

### WebSocket ç«¯é»

#### é€£æ¥ç«¯é»
```
ws://localhost:8000/api/realtime/ws/{guild_id}/{client_id}
```

**é€£æ¥æµç¨‹**:
1. å®¢æˆ¶ç«¯å»ºç«‹ WebSocket é€£æ¥
2. æœå‹™å™¨ç™¼é€åˆå§‹æ•¸æ“š (`initial_data`)
3. æ¯ 30 ç§’è‡ªå‹•ç™¼é€æ›´æ–° (`auto_update`)
4. æ”¯æ´å¿ƒè·³æ©Ÿåˆ¶ (`ping`/`pong`)

#### è¨Šæ¯é¡å‹

| é¡å‹ | æ–¹å‘ | æè¿° |
|------|------|------|
| `initial_data` | æœå‹™å™¨â†’å®¢æˆ¶ç«¯ | é€£æ¥å»ºç«‹å¾Œçš„åˆå§‹æ•¸æ“š |
| `data_update` | æœå‹™å™¨â†’å®¢æˆ¶ç«¯ | æ‰‹å‹•è«‹æ±‚çš„æ•¸æ“šæ›´æ–° |
| `auto_update` | æœå‹™å™¨â†’å®¢æˆ¶ç«¯ | è‡ªå‹•å®šæœŸæ•¸æ“šæ›´æ–° |
| `ping` | å®¢æˆ¶ç«¯â†’æœå‹™å™¨ | å¿ƒè·³æª¢æ¸¬ |
| `pong` | æœå‹™å™¨â†’å®¢æˆ¶ç«¯ | å¿ƒè·³å›æ‡‰ |
| `request_update` | å®¢æˆ¶ç«¯â†’æœå‹™å™¨ | è«‹æ±‚ç«‹å³æ›´æ–°æ•¸æ“š |

### HTTP API ç«¯é»

#### ç²å–å¯¦æ™‚æŠ•ç¥¨çµ±è¨ˆ
```http
GET /api/realtime/vote-stats/{guild_id}
```

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "active_votes": [
    {
      "id": 1,
      "title": "ä»Šæ™šèšé¤åœ°é»é¸æ“‡",
      "start_time": "2025-08-15T10:00:00Z",
      "end_time": "2025-08-15T18:00:00Z",
      "is_multiple": false,
      "is_anonymous": false,
      "total_participants": 45,
      "options": [
        {
          "option_id": 1,
          "text": "ç«é‹åº—",
          "votes": 20
        }
      ]
    }
  ],
  "today_statistics": {
    "votes_created": 3,
    "votes_completed": 1,
    "total_participants": 144
  },
  "summary": {
    "active_count": 2,
    "total_active_participants": 112
  },
  "last_updated": "2025-08-15T16:30:00Z"
}
```

#### æ‰‹å‹•è§¸ç™¼å»£æ’­
```http
POST /api/realtime/broadcast/{guild_id}?update_type=vote_update
```

#### ç²å–é€£æ¥ç‹€æ…‹
```http
GET /api/realtime/connections
```

## ğŸ¨ Web UI åŠŸèƒ½

### é€£æ¥ç‹€æ…‹æŒ‡ç¤ºå™¨

- **ğŸŸ¢ å·²é€£æ¥**: WebSocket é€£æ¥æ­£å¸¸ï¼Œå³æ™‚æ›´æ–°
- **ğŸŸ¡ é€£æ¥ä¸­**: æ­£åœ¨å»ºç«‹é€£æ¥
- **ğŸ”´ é›¢ç·šæ¨¡å¼**: ä½¿ç”¨ HTTP å‚™æ´æ¨¡å¼

### æ¨™ç±¤é è¨­è¨ˆ

1. **é€²è¡Œä¸­æŠ•ç¥¨** - é¡¯ç¤ºæ´»èºæŠ•ç¥¨åŠå³æ™‚çµæœ
2. **æœ€è¿‘å®Œæˆ** - é¡¯ç¤ºæœ€è¿‘çµæŸçš„æŠ•ç¥¨
3. **å…¨éƒ¨æŠ•ç¥¨** - æ‰€æœ‰æŠ•ç¥¨çš„ç¶œåˆè¦–åœ–

### éŸ¿æ‡‰å¼è¨­è¨ˆ

- **æ¡Œé¢ç‰ˆ** (â‰¥1024px): å¤šæ¬„ä½ˆå±€ï¼Œå®Œæ•´åŠŸèƒ½
- **å¹³æ¿ç‰ˆ** (768-1023px): é›™æ¬„ä½ˆå±€ï¼Œé©é…è§¸æ§
- **æ‰‹æ©Ÿç‰ˆ** (<768px): å–®æ¬„ä½ˆå±€ï¼Œæ»‘å‹•å‹å¥½

## ğŸ”„ è‡ªå‹•é‡é€£æ©Ÿåˆ¶

### é‡é€£ç­–ç•¥

```typescript
// æŒ‡æ•¸é€€é¿é‡é€£ç­–ç•¥
const delay = Math.min(1000 * Math.pow(2, reconnectAttempts.current), 30000)

// æœ€å¤§é‡é€£æ¬¡æ•¸: 5 æ¬¡
const maxReconnectAttempts = 5
```

### å‚™æ´æ©Ÿåˆ¶

1. **WebSocket å¤±æ•—** â†’ è‡ªå‹•åˆ‡æ›åˆ° HTTP æ¨¡å¼
2. **HTTP å¤±æ•—** â†’ ä½¿ç”¨æœ¬åœ°æ¨¡æ“¬æ•¸æ“š
3. **ç¶²çµ¡æ¢å¾©** â†’ è‡ªå‹•é‡æ–°å»ºç«‹ WebSocket é€£æ¥

## ğŸ§ª æ¸¬è©¦ç³»çµ±

### æ¸¬è©¦è…³æœ¬

åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶ï¼š

```bash
python test_realtime_voting.py
```

### æ¸¬è©¦é …ç›®

| æ¸¬è©¦é …ç›® | æè¿° | ç‹€æ…‹ |
|----------|------|------|
| HTTP ç«¯é» | æ¸¬è©¦ REST API åŠŸèƒ½ | âœ… |
| WebSocket é€£æ¥ | æ¸¬è©¦å¯¦æ™‚é€£æ¥å»ºç«‹ | âœ… |
| å¿ƒè·³æ©Ÿåˆ¶ | æ¸¬è©¦é€£æ¥ä¿æ´»åŠŸèƒ½ | âœ… |
| æ‰‹å‹•æ›´æ–° | æ¸¬è©¦ä¸»å‹•æ•¸æ“šè«‹æ±‚ | âœ… |
| å»£æ’­åŠŸèƒ½ | æ¸¬è©¦æ•¸æ“šæ¨é€åŠŸèƒ½ | âœ… |
| é€£æ¥ç‹€æ…‹ | æ¸¬è©¦é€£æ¥ç›£æ§åŠŸèƒ½ | âœ… |
| æ•¸æ“šå®Œæ•´æ€§ | æ¸¬è©¦æ•¸æ“šçµæ§‹æ­£ç¢ºæ€§ | âœ… |

## ğŸ“Š æ•ˆèƒ½æŒ‡æ¨™

### é€£æ¥æ•ˆèƒ½

- **WebSocket å»ºç«‹æ™‚é–“**: < 200ms
- **æ•¸æ“šåˆå§‹åŒ–æ™‚é–“**: < 500ms
- **è‡ªå‹•æ›´æ–°é–“éš”**: 30 ç§’
- **å¿ƒè·³é–“éš”**: 25 ç§’

### æ•¸æ“šæ›´æ–°æ•ˆèƒ½

- **å¯¦æ™‚æ›´æ–°å»¶é²**: < 100ms
- **æ‰¹é‡æ›´æ–°è™•ç†**: æ”¯æ´ 1000+ ä¸¦ç™¼é€£æ¥
- **æ•¸æ“šå£“ç¸®**: JSON æ ¼å¼ï¼Œå¹³å‡ 2KB/æ›´æ–°

### å‰ç«¯æ•ˆèƒ½

- **é¦–å±è¼‰å…¥æ™‚é–“**: < 1.5 ç§’
- **WebSocket é‡é€£æ™‚é–“**: < 3 ç§’
- **UI æ›´æ–°éŸ¿æ‡‰**: < 50ms

## ğŸš€ éƒ¨ç½²æŒ‡å—

### å¾Œç«¯éƒ¨ç½²

1. **å®‰è£ä¾è³´**:
```bash
pip install fastapi websockets aiomysql
```

2. **é…ç½®ç’°å¢ƒè®Šé‡**:
```bash
export DB_HOST=localhost
export DB_PORT=3306
export DB_NAME=potato_bot
export WS_PORT=8000
```

3. **å•Ÿå‹•æœå‹™**:
```bash
python -m bot.api.realtime_api
```

### å‰ç«¯éƒ¨ç½²

1. **å®‰è£ä¾è³´**:
```bash
cd web-ui
npm install
```

2. **è¨­å®š WebSocket URL**:
```javascript
// åœ¨ votes/page.tsx ä¸­ä¿®æ”¹
const wsUrl = `ws://your-domain.com/api/realtime/ws/${guildId}/${clientId}`
```

3. **å»ºç½®ä¸¦éƒ¨ç½²**:
```bash
npm run build
npm start
```

## ğŸ”§ é…ç½®é¸é …

### WebSocket é…ç½®

```python
# è‡ªå‹•æ›´æ–°é–“éš” (ç§’)
AUTO_UPDATE_INTERVAL = 30

# å¿ƒè·³é–“éš” (ç§’)
HEARTBEAT_INTERVAL = 25

# æœ€å¤§é€£æ¥æ•¸
MAX_CONNECTIONS_PER_GUILD = 100

# é‡é€£è¶…æ™‚æ™‚é–“ (æ¯«ç§’)
RECONNECT_TIMEOUT = 30000
```

### å‰ç«¯é…ç½®

```typescript
// æœ€å¤§é‡é€£æ¬¡æ•¸
const maxReconnectAttempts = 5

// HTTP å‚™æ´æ›´æ–°é–“éš” (æ¯«ç§’)
const httpFallbackInterval = 30000

// å¿ƒè·³è¶…æ™‚æ™‚é–“ (æ¯«ç§’)
const heartbeatTimeout = 30000
```

## ğŸ›¡ï¸ å®‰å…¨è€ƒé‡

### é€£æ¥å®‰å…¨

- **ä¾†æºé©—è­‰**: æª¢æŸ¥é€£æ¥ä¾†æºåŸŸå
- **é€Ÿç‡é™åˆ¶**: é˜²æ­¢é »ç¹é€£æ¥æ”»æ“Š
- **æ•¸æ“šåŠ å¯†**: æ”¯æ´ WSS åŠ å¯†å‚³è¼¸

### æ•¸æ“šå®‰å…¨

- **æ¬Šé™æª¢æŸ¥**: åŸºæ–¼å…¬æœƒ ID çš„æ•¸æ“šéš”é›¢
- **åŒ¿åæŠ•ç¥¨**: ä¿è­·æŠ•ç¥¨è€…éš±ç§
- **æ•¸æ“šæ¸…ç†**: è‡ªå‹•æ¸…ç†æ•æ„Ÿä¿¡æ¯

## ğŸ“ˆ ç›£æ§èˆ‡æ—¥èªŒ

### é€£æ¥ç›£æ§

```python
# ç›£æ§æŒ‡æ¨™
- æ´»èºé€£æ¥æ•¸
- æ¯ç§’è¨Šæ¯æ•¸
- é€£æ¥éŒ¯èª¤ç‡
- å¹³å‡éŸ¿æ‡‰æ™‚é–“
```

### æ—¥èªŒè¨˜éŒ„

```python
# æ—¥èªŒç´šåˆ¥
- INFO: é€£æ¥å»ºç«‹/æ–·é–‹
- WARNING: é‡é€£å˜—è©¦
- ERROR: é€£æ¥éŒ¯èª¤
- DEBUG: è©³ç´°è¨Šæ¯è¿½è¹¤
```

## ğŸ”® æœªä¾†æ“´å±•

### çŸ­æœŸè¨ˆåŠƒ

- [ ] **æŠ•ç¥¨çµæœå°å‡º**: æ”¯æ´ CSV/PDF æ ¼å¼
- [ ] **æ›´å¤šåœ–è¡¨é¡å‹**: æ·»åŠ é›·é”åœ–ã€ç†±åŠ›åœ–
- [ ] **æŠ•ç¥¨æé†’**: çµæŸå‰è‡ªå‹•æé†’

### ä¸­æœŸè¨ˆåŠƒ

- [ ] **å¤šèªè¨€æ”¯æ´**: i18n åœ‹éš›åŒ–
- [ ] **æŠ•ç¥¨åˆ†æ**: AI é©…å‹•çš„è¶¨å‹¢åˆ†æ
- [ ] **API æ“´å±•**: GraphQL æŸ¥è©¢æ”¯æ´

### é•·æœŸè¨ˆåŠƒ

- [ ] **é›†ç¾¤æ”¯æ´**: æ”¯æ´å¤šå¯¦ä¾‹éƒ¨ç½²
- [ ] **æ¶ˆæ¯éšŠåˆ—**: Redis åˆ†ä½ˆå¼è¨Šæ¯
- [ ] **å¯¦æ™‚å”ä½œ**: å¤šç”¨æˆ¶åŒæ™‚ç·¨è¼¯

## ğŸ¯ ç¸½çµ

å¯¦æ™‚æŠ•ç¥¨çµ±è¨ˆç³»çµ±æˆåŠŸå¯¦ç¾äº†ä»¥ä¸‹ç›®æ¨™ï¼š

1. **âœ… å¯¦æ™‚æ€§**: WebSocket å³æ™‚æ•¸æ“šæ¨é€
2. **âœ… å¯é æ€§**: å¤šé‡å‚™æ´æ©Ÿåˆ¶ç¢ºä¿æœå‹™å¯ç”¨
3. **âœ… æ˜“ç”¨æ€§**: éŸ¿æ‡‰å¼è¨­è¨ˆé©é…æ‰€æœ‰è¨­å‚™
4. **âœ… å¯æ“´å±•æ€§**: æ¨¡çµ„åŒ–æ¶æ§‹æ”¯æ´åŠŸèƒ½æ“´å±•
5. **âœ… æ€§èƒ½**: é«˜æ•ˆçš„æ•¸æ“šå‚³è¼¸å’Œ UI æ›´æ–°

ç³»çµ±ç¾å·²æº–å‚™å¥½æŠ•å…¥ç”Ÿç”¢ç’°å¢ƒï¼Œç‚ºç”¨æˆ¶æä¾›å„ªç§€çš„å¯¦æ™‚æŠ•ç¥¨é«”é©—ã€‚

---

**æŠ€è¡“æ”¯æ´**: å¦‚æœ‰å•é¡Œè«‹åƒè€ƒæ¸¬è©¦å ±å‘Šæˆ–è¯ç¹«é–‹ç™¼åœ˜éšŠ  
**æœ€å¾Œæ›´æ–°**: 2025-08-15  
**ç‰ˆæœ¬**: v3.0.0