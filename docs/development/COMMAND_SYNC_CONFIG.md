# 🔄 指令自動同步配置說明

**配置項目**: `SYNC_COMMANDS`  
**預設值**: `true`  
**類型**: 布林值 (true/false)  

---

## 📋 功能說明

指令自動同步功能控制 Discord 斜線指令 (Slash Commands) 是否在機器人啟動時自動同步到 Discord 伺服器。

### ✅ 啟用同步 (`SYNC_COMMANDS=true`)
- **行為**: 機器人啟動時自動將本地定義的指令同步到 Discord
- **適用場景**: 
  - 開發環境 - 新增或修改指令後需要立即生效
  - 生產環境 - 首次部署或指令有重大更新
  - 測試環境 - 需要驗證指令功能

### 🚫 停用同步 (`SYNC_COMMANDS=false`)
- **行為**: 機器人啟動時跳過指令同步，使用已存在的 Discord 指令
- **適用場景**:
  - 生產環境 - 指令已穩定，避免不必要的 API 呼叫
  - 頻繁重啟 - 避免觸發 Discord 的速率限制
  - 多實例部署 - 只需一個實例負責同步指令

---

## ⚙️ 配置方法

### 方法1: 環境變數設定 (推薦)
在 `.env` 檔案中設定：
```env
# 啟用指令自動同步
SYNC_COMMANDS=true

# 停用指令自動同步  
SYNC_COMMANDS=false
```

### 方法2: 系統環境變數
在系統中設定環境變數：
```bash
export SYNC_COMMANDS=true
```

### 方法3: 運行時設定
在啟動時指定：
```bash
SYNC_COMMANDS=true python start.py
```

---

## 🔧 智能同步機制

系統實現了智能同步機制，包含以下特性：

### 1. 重複檢查避免
- **檢查現有指令**: 啟動時先檢查 Discord 是否已有註冊指令
- **智能跳過**: 如果發現已有指令且數量匹配，自動跳過同步
- **避免重複**: 減少不必要的 API 呼叫和潛在的速率限制

### 2. 速率限制處理
- **安全機制**: 如果遇到 Discord API 速率限制，優雅處理
- **繼續運行**: 同步失敗不會影響機器人正常啟動
- **日誌記錄**: 詳細記錄同步過程和結果

### 3. 錯誤處理
- **容錯機制**: 同步失敗時機器人仍可正常運行
- **日誌提醒**: 清楚記錄失敗原因和建議解決方案
- **手動同步**: 提供 `!sync` 指令供管理員手動觸發同步

---

## 📊 日誌輸出說明

### 正常同步流程
```
🔍 發現 15 個本地命令等待同步
✅ 同步了 15 個斜線命令
```

### 智能跳過同步
```
🔍 發現 15 個本地命令等待同步
✅ Discord 已有 15 個註冊命令，跳過同步
```

### 同步被停用
```
🔍 發現 15 個本地命令等待同步
🚫 命令同步已停用（SYNC_COMMANDS=false）
💡 如需啟用同步，請設定 SYNC_COMMANDS=true
```

### 同步失敗處理
```
❌ 命令同步失敗：Discord API 速率限制
⚠️ 機器人將繼續運行，可稍後使用 !sync 命令手動同步
```

---

## 🛠️ 手動同步指令

即使停用了自動同步，管理員仍可使用以下指令手動同步：

### Discord 指令
```
!sync
```
- **權限**: 需要管理員權限
- **功能**: 立即同步所有斜線指令到當前伺服器
- **回應**: 顯示同步的指令數量

### 開發者指令
```python
# 在程式碼中手動觸發同步
await bot.tree.sync()
```

---

## 🎯 最佳實踐建議

### 🟢 開發環境
```env
# 開發環境建議啟用自動同步
SYNC_COMMANDS=true
DEBUG=true
LOG_LEVEL=DEBUG
```
- **好處**: 指令修改後立即生效，便於測試
- **注意**: 可能會觸發速率限制，適度重啟

### 🟡 測試環境  
```env
# 測試環境可選擇性啟用
SYNC_COMMANDS=true
DEBUG=false
LOG_LEVEL=INFO
```
- **好處**: 確保測試環境指令與開發環境一致
- **建議**: 在測試開始前同步一次，測試期間可停用

### 🔴 生產環境
```env
# 生產環境建議謹慎使用
SYNC_COMMANDS=false
DEBUG=false
LOG_LEVEL=INFO
```
- **好處**: 避免不必要的 API 呼叫和潛在風險
- **建議**: 只在指令有重大更新時啟用同步

---

## ⚠️ 注意事項

### Discord API 限制
- **速率限制**: Discord 對指令同步有嚴格的速率限制
- **全域指令**: 全域指令更新可能需要 1 小時才能完全生效
- **頻率控制**: 避免頻繁觸發同步，建議間隔至少 10 分鐘

### 多實例部署
- **協調機制**: 多實例環境中，只需一個實例負責同步
- **配置建議**: 主實例啟用同步，其他實例停用
- **避免衝突**: 防止多個實例同時同步造成衝突

### 指令版本控制
- **向後相容**: 指令修改時注意向後相容性
- **段階發布**: 重大指令變更建議採用段階發布策略
- **回滾準備**: 準備指令回滾方案，以應對意外情況

---

## 🔍 故障排除

### Q: 指令同步失敗怎麼辦？
**A**: 
1. 檢查 Discord Token 是否有效
2. 確認機器人有足夠權限
3. 等待速率限制重置後重試
4. 使用 `!sync` 指令手動同步

### Q: 指令更新後不生效？
**A**:
1. 確認 `SYNC_COMMANDS=true` 
2. 重新啟動機器人
3. 等待 Discord 緩存更新（最多1小時）
4. 檢查指令語法是否正確

### Q: 如何確認指令已成功同步？
**A**:
1. 查看機器人啟動日誌
2. 在 Discord 中輸入 `/` 查看可用指令
3. 使用 `!sync` 指令確認同步狀態

---

**配置文檔版本**: v1.0  
**最後更新**: 2025-08-30  
**適用版本**: Potato Bot v2025.08.30+