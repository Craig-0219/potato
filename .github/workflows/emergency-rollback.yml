name: ğŸš¨ Emergency Rollback

on:
  workflow_dispatch:
    inputs:
      rollback_target:
        description: 'å›æ»¾ç›®æ¨™ (commit SHA æˆ–æ¨™ç±¤)'
        required: true
        type: string
      rollback_reason:
        description: 'å›æ»¾åŸå› '
        required: true
        type: choice
        options:
          - 'Critical Bug'
          - 'Performance Issue'
          - 'Security Incident'
          - 'Data Corruption'
          - 'Service Outage'
          - 'Other'
      confirm_rollback:
        description: 'ç¢ºèªå›æ»¾ (è¼¸å…¥ CONFIRM)'
        required: true
        type: string
      notify_team:
        description: 'é€šçŸ¥åœ˜éšŠ'
        required: false
        default: true
        type: boolean

env:
  PYTHON_VERSION: '3.10'

jobs:
  # ==========================================
  # éšæ®µ 1: å›æ»¾å‰é©—è­‰
  # ==========================================
  pre-rollback-validation:
    name: ğŸ” Pre-rollback Validation
    runs-on: ubuntu-latest
    outputs:
      can_rollback: ${{ steps.validation.outputs.can_rollback }}
      rollback_plan: ${{ steps.validation.outputs.rollback_plan }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Validate rollback request
        id: validation
        run: |
          # é©—è­‰ç¢ºèªå­—ä¸²
          if [ "${{ inputs.confirm_rollback }}" != "CONFIRM" ]; then
            echo "âŒ Rollback not confirmed. Please type 'CONFIRM' to proceed."
            echo "can_rollback=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # é©—è­‰ç›®æ¨™å­˜åœ¨
          target="${{ inputs.rollback_target }}"
          if ! git rev-parse --verify "$target" >/dev/null 2>&1; then
            echo "âŒ Rollback target '$target' not found"
            echo "can_rollback=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # ç²å–ç›®æ¨™ commit è³‡è¨Š
          target_commit=$(git rev-parse "$target")
          target_message=$(git log -1 --pretty=format:"%s" "$target_commit")
          target_date=$(git log -1 --pretty=format:"%ci" "$target_commit")

          # ç²å–ç•¶å‰ commit è³‡è¨Š
          current_commit=$(git rev-parse HEAD)
          current_message=$(git log -1 --pretty=format:"%s" "$current_commit")

          # æª¢æŸ¥æ˜¯å¦çœŸçš„éœ€è¦å›æ»¾
          if [ "$target_commit" = "$current_commit" ]; then
            echo "âš ï¸ Target commit is same as current commit. No rollback needed."
            echo "can_rollback=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # åˆ†æå›æ»¾å½±éŸ¿
          commits_to_revert=$(git rev-list --count "$target_commit".."$current_commit")
          files_affected=$(git diff --name-only "$target_commit".."$current_commit" | wc -l)

          # ç”Ÿæˆå›æ»¾è¨ˆåŠƒ
          rollback_plan="
          ğŸ¯ Rollback Plan:
          ================
          ğŸ“ Current: $current_commit ($current_message)
          ğŸ”„ Target:  $target_commit ($target_message)
          ğŸ“… Target Date: $target_date
          ğŸ“Š Commits to Revert: $commits_to_revert
          ğŸ“ Files Affected: $files_affected
          ğŸš¨ Reason: ${{ inputs.rollback_reason }}
          "

          echo "can_rollback=true" >> $GITHUB_OUTPUT
          echo "rollback_plan<<EOF" >> $GITHUB_OUTPUT
          echo "$rollback_plan" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "target_commit=$target_commit" >> $GITHUB_OUTPUT
          echo "commits_to_revert=$commits_to_revert" >> $GITHUB_OUTPUT

          echo "$rollback_plan"

  # ==========================================
  # éšæ®µ 2: å»ºç«‹å›æ»¾å‚™ä»½
  # ==========================================
  create-backup:
    name: ğŸ’¾ Create Rollback Backup
    runs-on: ubuntu-latest
    needs: pre-rollback-validation
    if: needs.pre-rollback-validation.outputs.can_rollback == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ’¾ Create backup branch
        run: |
          backup_branch="rollback-backup-$(date +%Y%m%d-%H%M%S)"

          echo "ğŸ’¾ Creating backup branch: $backup_branch"
          git checkout -b "$backup_branch"
          git push origin "$backup_branch"

          echo "âœ… Backup created: $backup_branch"
          echo "This branch can be used to restore if rollback needs to be reverted."

  # ==========================================
  # éšæ®µ 3: åŸ·è¡Œå›æ»¾
  # ==========================================
  execute-rollback:
    name: ğŸ”„ Execute Rollback
    runs-on: ubuntu-latest
    needs: [pre-rollback-validation, create-backup]
    if: needs.pre-rollback-validation.outputs.can_rollback == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name 'Emergency Rollback Bot'
          git config --global user.email 'noreply@github.com'

      - name: ğŸ”„ Execute rollback
        run: |
          target_commit="${{ needs.pre-rollback-validation.outputs.target_commit }}"
          reason="${{ inputs.rollback_reason }}"

          echo "ğŸ”„ Executing emergency rollback..."
          echo "  Target: $target_commit"
          echo "  Reason: $reason"

          # å‰µå»ºå›æ»¾ commit è¨Šæ¯
          rollback_msg="ğŸš¨ EMERGENCY ROLLBACK: $reason

          Rollback to: $target_commit
          Reason: $reason
          Triggered by: ${{ github.actor }}
          Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)

          This rollback reverts ${{ needs.pre-rollback-validation.outputs.commits_to_revert }} commits.

          ğŸ†˜ Emergency rollback performed via GitHub Actions

          Co-Authored-By: Emergency Rollback Bot <noreply@github.com>"

          # åŸ·è¡Œ hard reset åˆ°ç›®æ¨™ commit
          git reset --hard "$target_commit"

          # å¼·åˆ¶æ¨é€ (å±éšªæ“ä½œï¼Œåƒ…é™ç·Šæ€¥æƒ…æ³)
          echo "âš ï¸ Force pushing rollback to main branch..."
          git push --force-with-lease origin main

          echo "âœ… Emergency rollback completed"

  # ==========================================
  # éšæ®µ 4: å›æ»¾å¾Œé©—è­‰
  # ==========================================
  post-rollback-validation:
    name: âœ… Post-rollback Validation
    runs-on: ubuntu-latest
    needs: [pre-rollback-validation, execute-rollback]
    if: needs.pre-rollback-validation.outputs.can_rollback == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: âœ… Validate rollback success
        run: |
          echo "âœ… Validating rollback success..."

          # é©—è­‰ç•¶å‰ commit æ˜¯å¦ç‚ºç›®æ¨™ commit
          current_commit=$(git rev-parse HEAD)
          target_commit="${{ needs.pre-rollback-validation.outputs.target_commit }}"

          if [ "$current_commit" = "$target_commit" ]; then
            echo "âœ… Rollback successful - now at target commit"
          else
            echo "âŒ Rollback failed - current commit doesn't match target"
            exit 1
          fi

          # åŸºæœ¬å¥åº·æª¢æŸ¥
          echo "ğŸ¥ Running basic health checks..."
          python -m compileall bot/ shared/ -q
          echo "âœ… Syntax validation passed"

      - name: ğŸ§ª Run critical tests
        env:
          TESTING: true
          DISCORD_TOKEN: ${{ secrets.DISCORD_TEST_TOKEN }}
          DB_HOST: "localhost"
          DB_USER: "test_user"
          DB_PASSWORD: ${{ secrets.DB_TEST_PASSWORD }}
          DB_NAME: "test_database"
          DB_PORT: "3306"
          JWT_SECRET: ${{ secrets.JWT_TEST_SECRET }}
        run: |
          echo "ğŸ§ª Running critical tests after rollback..."

          # å®‰è£ä¾è³´
          pip install -r requirements.txt

          # åŸ·è¡ŒåŸºæœ¬é…ç½®æ¸¬è©¦
          python3 -c "
          import sys
          sys.path.append('.')
          try:
              import shared.config
              print('âœ… Config module loads successfully after rollback')

              from bot.db.pool import init_database
              print('âœ… Database module loads successfully after rollback')

          except Exception as e:
              print(f'âŒ Critical test failed after rollback: {e}')
              sys.exit(1)
          "

          echo "âœ… Critical tests passed"

  # ==========================================
  # éšæ®µ 5: å›æ»¾é€šçŸ¥å’Œå¾ŒçºŒè¡Œå‹•
  # ==========================================
  rollback-notification:
    name: ğŸ“¢ Rollback Notifications
    runs-on: ubuntu-latest
    needs: [pre-rollback-validation, execute-rollback, post-rollback-validation]
    if: always() && needs.pre-rollback-validation.outputs.can_rollback == 'true'

    steps:
      - name: ğŸ“¢ Generate rollback report
        run: |
          echo "ğŸ“¢ Emergency Rollback Report"
          echo "============================"

          if [ "${{ needs.execute-rollback.result }}" = "success" ] && [ "${{ needs.post-rollback-validation.result }}" = "success" ]; then
            status="âœ… SUCCESSFUL"
            echo "ğŸ‰ Emergency rollback completed successfully!"
          else
            status="âŒ FAILED"
            echo "ğŸ’¥ Emergency rollback failed - immediate attention required!"
          fi

          cat << EOF
          ğŸ“Š Rollback Summary:
          ==================
          ğŸš¨ Status: $status
          ğŸ¯ Target: ${{ inputs.rollback_target }}
          ğŸ“‹ Reason: ${{ inputs.rollback_reason }}
          ğŸ‘¤ Triggered by: ${{ github.actor }}
          ğŸ“… Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          ğŸ“Š Commits Reverted: ${{ needs.pre-rollback-validation.outputs.commits_to_revert }}

          ${{ needs.pre-rollback-validation.outputs.rollback_plan }}

          ğŸ“‹ Next Actions:
          ================
          1. âœ… Verify system stability
          2. ğŸ“Š Monitor application metrics
          3. ğŸ” Investigate root cause
          4. ğŸ“ Document incident
          5. ğŸ”„ Plan forward fix
          EOF

      - name: ğŸš¨ High priority notification
        if: needs.execute-rollback.result == 'success'
        run: |
          echo "ğŸš¨ EMERGENCY ROLLBACK COMPLETED"
          echo "================================"
          echo "ğŸ¯ System has been rolled back due to: ${{ inputs.rollback_reason }}"
          echo "ğŸ‘€ Immediate monitoring and investigation required"
          echo "ğŸ“ Consider notifying stakeholders if not already done"

      - name: ğŸ’¥ Rollback failure notification
        if: needs.execute-rollback.result != 'success'
        run: |
          echo "ğŸ’¥ EMERGENCY ROLLBACK FAILED"
          echo "============================"
          echo "ğŸš¨ CRITICAL: Automated rollback failed!"
          echo "âš¡ Manual intervention required IMMEDIATELY"
          echo "ğŸ“ Escalate to senior team members"
          echo "ğŸ”§ Consider manual git operations or alternative recovery"
