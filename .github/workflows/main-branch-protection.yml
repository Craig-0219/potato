name: ğŸ›¡ï¸ Main Branch Protection - Production Files Only

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, edited]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_check:
        description: 'å¼·åˆ¶åŸ·è¡Œå®Œæ•´æª¢æŸ¥'
        required: false
        default: true
        type: boolean

env:
  PYTHON_VERSION: '3.10'

jobs:
  # ==========================================
  # éšæ®µ 1: ç”Ÿç”¢æª”æ¡ˆåˆè¦æ€§æª¢æŸ¥
  # ==========================================
  production-compliance-check:
    name: ğŸ” Production Files Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“‹ ç”Ÿç”¢æª”æ¡ˆç™½åå–®é©—è­‰
        run: |
          echo "ğŸ” åŸ·è¡Œç”Ÿç”¢æª”æ¡ˆç™½åå–®é©—è­‰..."
          
          # å®šç¾©ç”Ÿç”¢ç’°å¢ƒå…è¨±çš„æª”æ¡ˆæ¨¡å¼
          cat > production_whitelist.txt << 'EOF'
          # æ ¸å¿ƒç¨‹å¼æª”æ¡ˆ
          bot/**/*.py
          shared/**/*.py
          web-ui/**/*.js
          web-ui/**/*.ts
          web-ui/**/*.tsx
          web-ui/**/*.json
          web-ui/**/*.css
          web-ui/**/*.html
          
          # é…ç½®æª”æ¡ˆ
          requirements.txt
          pyproject.toml
          .env.example
          .gitignore
          .gitattributes
          .gitconfig
          
          # å•Ÿå‹•è…³æœ¬
          start.py
          start.sh
          start.bat
          
          # æ–‡æª” (åƒ…åŸºæœ¬æ–‡æª”)
          README.md
          docs/system/ADMIN_PERMISSION_SETUP.md
          docs/user-guides/COMMANDS.md
          docs/user-guides/USER_MANUAL.md
          
          # CI/CD æµç¨‹ (åƒ…ç”Ÿç”¢ç›¸é—œ)
          .github/workflows/deploy-to-production.yml
          .github/workflows/deploy-to-ptero.yml
          .github/workflows/emergency-rollback.yml
          .github/workflows/main-branch-protection.yml
          .github/workflows/security-scans.yml
          .github/workflows/smart-change-detection.yml
          .github/workflows/code-quality.yml
          .github/workflows/test-coverage.yml
          EOF
          
          # å®šç¾©åš´æ ¼ç¦æ­¢çš„æª”æ¡ˆæ¨¡å¼
          cat > production_blacklist.txt << 'EOF'
          # é–‹ç™¼å·¥å…·é…ç½®
          .bandit
          .flake8
          .pre-commit-config.yaml
          .safety-policy.json
          .secrets.baseline
          .semgrepignore
          pytest.ini
          
          # æ¸¬è©¦æª”æ¡ˆ
          tests/**/*
          **/test_*.py
          **/*_test.py
          **/*_tests.py
          
          # é–‹ç™¼è…³æœ¬
          scripts/**/*
          tools/**/*
          
          # æ§‹å»ºæª”æ¡ˆ
          Dockerfile*
          docker-compose*.yml
          Makefile
          
          # é–‹ç™¼æ–‡æª”
          docs/development/**/*
          docs/plans/**/*
          docs/archives/**/*
          docs/reports/**/*
          docs/issues/**/*
          DEVELOPMENT*.md
          CONTRIBUTING.md
          
          # è‡¨æ™‚æª”æ¡ˆ
          *.tmp
          *.temp
          *.log
          *.cache
          .pytest_cache/**/*
          __pycache__/**/*
          *.pyc
          
          # IDE é…ç½®
          .vscode/**/*
          .idea/**/*
          *.swp
          *.swo
          .DS_Store
          
          # å¯¦é©—æ€§æª”æ¡ˆ
          experimental/**/*
          prototype/**/*
          demo/**/*
          sandbox/**/*
          
          # å‚™ä»½æª”æ¡ˆ
          *.bak
          *.backup
          *.old
          EOF
          
          echo "âœ… ç™½åå–®å’Œé»‘åå–®æº–å‚™å®Œæˆ"

      - name: ğŸ” æª¢æŸ¥ç¦æ­¢æª”æ¡ˆ
        run: |
          echo "ğŸ” æª¢æŸ¥æ˜¯å¦å­˜åœ¨ç¦æ­¢çš„é–‹ç™¼æª”æ¡ˆ..."
          
          violation_found=false
          violations_list=""
          
          # æª¢æŸ¥é»‘åå–®ä¸­çš„ç¦æ­¢æª”æ¡ˆ
          while IFS= read -r pattern; do
            # è·³éè¨»é‡‹å’Œç©ºè¡Œ
            if [[ "$pattern" =~ ^[[:space:]]*# ]] || [[ -z "$pattern" ]]; then
              continue
            fi
            
            # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
            if ls $pattern 2>/dev/null | head -1 | grep -q .; then
              echo "âŒ ç™¼ç¾ç¦æ­¢çš„æª”æ¡ˆé¡å‹: $pattern"
              violations_list="$violations_list\n- $pattern"
              violation_found=true
            fi
          done < production_blacklist.txt
          
          if [ "$violation_found" = true ]; then
            echo "ğŸš¨ MAIN åˆ†æ”¯æ±™æŸ“æª¢æ¸¬ï¼"
            echo "=============================="
            echo "ç™¼ç¾ä»¥ä¸‹ä¸æ‡‰è©²å­˜åœ¨æ–¼ main åˆ†æ”¯çš„æª”æ¡ˆï¼š"
            echo -e "$violations_list"
            echo ""
            echo "ğŸ’¡ è§£æ±ºæ–¹æ¡ˆï¼š"
            echo "1. å°‡é€™äº›æª”æ¡ˆç§»è‡³ dev åˆ†æ”¯"
            echo "2. æˆ–è€…å®Œå…¨ç§»é™¤é€™äº›é–‹ç™¼ç”¨æª”æ¡ˆ"
            echo "3. main åˆ†æ”¯æ‡‰è©²åªåŒ…å«ç”Ÿç”¢ç’°å¢ƒå¿…éœ€çš„æª”æ¡ˆ"
            echo ""
            echo "ğŸš« PR è¢«æ‹’çµ• - main åˆ†æ”¯ä¿è­·å•Ÿå‹•"
            exit 1
          else
            echo "âœ… æœªç™¼ç¾ç¦æ­¢çš„æª”æ¡ˆé¡å‹"
          fi

      - name: ğŸ“ æª”æ¡ˆçµæ§‹åˆè¦æ€§æª¢æŸ¥
        run: |
          echo "ğŸ“ æª¢æŸ¥æª”æ¡ˆçµæ§‹æ˜¯å¦ç¬¦åˆç”Ÿç”¢æ¨™æº–..."
          
          # æª¢æŸ¥å¿…é ˆå­˜åœ¨çš„æ ¸å¿ƒç›®éŒ„
          required_dirs=("bot" "shared" "web-ui" ".github/workflows")
          missing_dirs=""
          
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "âŒ ç¼ºå°‘å¿…éœ€ç›®éŒ„: $dir"
              missing_dirs="$missing_dirs $dir"
            else
              echo "âœ… ç›®éŒ„å­˜åœ¨: $dir"
            fi
          done
          
          if [ -n "$missing_dirs" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€çš„æ ¸å¿ƒç›®éŒ„: $missing_dirs"
            exit 1
          fi
          
          # æª¢æŸ¥å¿…é ˆå­˜åœ¨çš„æ ¸å¿ƒæª”æ¡ˆ
          required_files=(
            "bot/main.py"
            "requirements.txt"
            ".env.example"
            "README.md"
            "start.py"
          )
          
          missing_files=""
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ ç¼ºå°‘å¿…éœ€æª”æ¡ˆ: $file"
              missing_files="$missing_files $file"
            else
              echo "âœ… æª”æ¡ˆå­˜åœ¨: $file"
            fi
          done
          
          if [ -n "$missing_files" ]; then
            echo "ğŸš¨ ç¼ºå°‘å¿…éœ€çš„æ ¸å¿ƒæª”æ¡ˆ: $missing_files"
            exit 1
          fi
          
          echo "âœ… æª”æ¡ˆçµæ§‹ç¬¦åˆç”Ÿç”¢æ¨™æº–"

      - name: ğŸ§¹ ä»£ç¢¼å“è³ªæª¢æŸ¥
        run: |
          echo "ğŸ§¹ æª¢æŸ¥ Python ä»£ç¢¼å“è³ª..."
          
          # å®‰è£æª¢æŸ¥å·¥å…·
          pip install black isort flake8
          
          # æª¢æŸ¥æ˜¯å¦æœ‰æ ¼å¼å•é¡Œ
          echo "ğŸ” æª¢æŸ¥ Black æ ¼å¼åŒ–..."
          if ! black --check --diff . > black_report.txt 2>&1; then
            echo "âŒ ç™¼ç¾ä»£ç¢¼æ ¼å¼å•é¡Œï¼š"
            head -20 black_report.txt
            echo "ğŸ’¡ è«‹åœ¨ dev åˆ†æ”¯ä¸­åŸ·è¡Œ 'black .' ä¿®å¾©æ ¼å¼å•é¡Œ"
            exit 1
          fi
          
          echo "ğŸ” æª¢æŸ¥ import æ’åº..."
          if ! isort --check --diff . > isort_report.txt 2>&1; then
            echo "âŒ ç™¼ç¾ import æ’åºå•é¡Œï¼š"
            head -20 isort_report.txt  
            echo "ğŸ’¡ è«‹åœ¨ dev åˆ†æ”¯ä¸­åŸ·è¡Œ 'isort .' ä¿®å¾© import æ’åº"
            exit 1
          fi
          
          echo "âœ… ä»£ç¢¼å“è³ªæª¢æŸ¥é€šé"

      - name: ğŸ“Š ç”Ÿç”¢å°±ç·’æ€§è©•ä¼°
        run: |
          echo "ğŸ“Š è©•ä¼° main åˆ†æ”¯ç”Ÿç”¢å°±ç·’æ€§..."
          
          # çµ±è¨ˆæª”æ¡ˆé¡å‹
          total_files=$(find . -type f -not -path "./.git/*" | wc -l)
          python_files=$(find . -name "*.py" -not -path "./.git/*" | wc -l)
          config_files=$(find . -name "*.txt" -o -name "*.toml" -o -name "*.yml" -o -name "*.yaml" | grep -v ".github" | wc -l)
          
          echo "ğŸ“ˆ æª”æ¡ˆçµ±è¨ˆï¼š"
          echo "  ç¸½æª”æ¡ˆæ•¸: $total_files"
          echo "  Python æª”æ¡ˆ: $python_files"  
          echo "  é…ç½®æª”æ¡ˆ: $config_files"
          
          # æª¢æŸ¥æ˜¯å¦åœ¨åˆç†ç¯„åœå…§ (ç”Ÿç”¢ç’°å¢ƒæ‡‰è©²ç²¾ç°¡)
          if [ $total_files -gt 500 ]; then
            echo "âš ï¸ è­¦å‘Š: æª”æ¡ˆæ•¸é‡éå¤š ($total_files > 500)"
            echo "ğŸ’¡ å»ºè­°æ¸…ç†ä¸å¿…è¦çš„æª”æ¡ˆä»¥ä¿æŒç²¾ç°¡"
          fi
          
          # ç”Ÿæˆç”Ÿç”¢å°±ç·’å ±å‘Š
          echo "âœ… Main åˆ†æ”¯ç”Ÿç”¢å°±ç·’æ€§è©•ä¼°å®Œæˆ"
          echo "ğŸ“‹ è©•ä¼°çµæœ: ç¬¦åˆç”Ÿç”¢æ¨™æº–"

  # ==========================================  
  # éšæ®µ 2: å®‰å…¨æ€§æƒæ
  # ==========================================
  security-scan:
    name: ğŸ›¡ï¸ Production Security Scan
    runs-on: ubuntu-latest
    needs: production-compliance-check
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ”’ å®‰å…¨æ¼æ´æƒæ
        run: |
          echo "ğŸ”’ åŸ·è¡Œç”Ÿç”¢ç’°å¢ƒå®‰å…¨æƒæ..."
          
          # å®‰è£å®‰å…¨æƒæå·¥å…·
          pip install bandit safety
          
          # æƒæ Python ä»£ç¢¼å®‰å…¨å•é¡Œ
          echo "ğŸ” æƒæä»£ç¢¼å®‰å…¨å•é¡Œ..."
          bandit -r bot/ shared/ -f json -o bandit-report.json || true
          
          # æª¢æŸ¥ä¾è³´å®‰å…¨
          echo "ğŸ“¦ æª¢æŸ¥ä¾è³´åŒ…å®‰å…¨..."
          safety check --json --output safety-report.json || true
          
          echo "âœ… å®‰å…¨æƒæå®Œæˆ"

      - name: ğŸ“‹ å®‰å…¨å ±å‘Šæ‘˜è¦
        run: |
          echo "ğŸ“‹ ç”Ÿæˆå®‰å…¨å ±å‘Šæ‘˜è¦..."
          
          if [ -f bandit-report.json ]; then
            high_issues=$(jq '.results | length' bandit-report.json 2>/dev/null || echo "0")
            echo "ğŸ” ä»£ç¢¼å®‰å…¨å•é¡Œ: $high_issues å€‹"
            
            if [ "$high_issues" -gt 5 ]; then
              echo "âš ï¸ è­¦å‘Š: ç™¼ç¾è¼ƒå¤šå®‰å…¨å•é¡Œï¼Œå»ºè­°ä¿®å¾©å¾Œå†åˆä½µ"
            fi
          fi
          
          if [ -f safety-report.json ]; then
            vuln_count=$(jq '. | length' safety-report.json 2>/dev/null || echo "0")
            echo "ğŸ“¦ ä¾è³´æ¼æ´: $vuln_count å€‹"
          fi
          
          echo "âœ… å®‰å…¨è©•ä¼°ç¬¦åˆç”Ÿç”¢è¦æ±‚"

  # ==========================================
  # éšæ®µ 3: æœ€çµ‚ä¿è­·æ±ºç­–
  # ==========================================
  protection-decision:
    name: ğŸ¯ Final Protection Decision
    runs-on: ubuntu-latest
    needs: [production-compliance-check, security-scan]
    if: always()

    steps:
      - name: ğŸ“Š å½™ç¸½æª¢æŸ¥çµæœ
        run: |
          echo "ğŸ“Š Main åˆ†æ”¯ä¿è­·æª¢æŸ¥çµæœå½™ç¸½"
          echo "========================================="
          
          compliance_status="${{ needs.production-compliance-check.result }}"
          security_status="${{ needs.security-scan.result }}"
          
          echo "ğŸ” æª”æ¡ˆåˆè¦æ€§æª¢æŸ¥: $compliance_status"
          echo "ğŸ›¡ï¸ å®‰å…¨æƒæ: $security_status"
          
          if [ "$compliance_status" = "success" ] && [ "$security_status" = "success" ]; then
            echo ""
            echo "âœ… MAIN åˆ†æ”¯ä¿è­·æª¢æŸ¥é€šé"
            echo "ğŸ‰ æ‰€æœ‰æª¢æŸ¥å‡ç¬¦åˆç”Ÿç”¢æ¨™æº–"
            echo "ğŸš€ å¯ä»¥å®‰å…¨åˆä½µåˆ° main åˆ†æ”¯"
          else
            echo ""
            echo "âŒ MAIN åˆ†æ”¯ä¿è­·æª¢æŸ¥å¤±æ•—"
            echo "ğŸš« PR è¢«é˜»æ­¢åˆä½µåˆ° main åˆ†æ”¯"
            echo ""
            echo "ğŸ’¡ ä¿®å¾©å»ºè­°ï¼š"
            if [ "$compliance_status" != "success" ]; then
              echo "  - ä¿®å¾©æª”æ¡ˆåˆè¦æ€§å•é¡Œ"
              echo "  - ç§»é™¤ä¸æ‡‰å­˜åœ¨æ–¼ç”Ÿç”¢ç’°å¢ƒçš„æª”æ¡ˆ"
            fi
            if [ "$security_status" != "success" ]; then
              echo "  - ä¿®å¾©å®‰å…¨æ¼æ´"  
              echo "  - æ›´æ–°æœ‰æ¼æ´çš„ä¾è³´åŒ…"
            fi
            exit 1
          fi

      - name: ğŸ”” ä¿è­·ç‹€æ…‹é€šçŸ¥
        if: always()
        run: |
          echo "ğŸ”” Main åˆ†æ”¯ä¿è­·ç‹€æ…‹é€šçŸ¥"
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Main åˆ†æ”¯å—åˆ°å®Œå–„ä¿è­·"
            echo "ğŸ›¡ï¸ ç”Ÿç”¢æª”æ¡ˆå®Œæ•´æ€§å·²é©—è­‰"
            echo "ğŸ”’ å®‰å…¨æ¨™æº–ç¬¦åˆè¦æ±‚"
          else
            echo "ğŸš¨ Main åˆ†æ”¯ä¿è­·å•Ÿå‹•"  
            echo "ğŸš« é˜»æ­¢ä¸ç¬¦åˆæ¨™æº–çš„è®Šæ›´"
            echo "ğŸ’ª ç¢ºä¿ç”Ÿç”¢ç’°å¢ƒå“è³ª"
          fi