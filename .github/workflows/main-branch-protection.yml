name: 🛡️ Main Branch Protection - Production Files Only

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, edited]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_check:
        description: '強制執行完整檢查'
        required: false
        default: true
        type: boolean

env:
  PYTHON_VERSION: '3.10'

jobs:
  # ==========================================
  # 階段 1: 生產檔案合規性檢查
  # ==========================================
  production-compliance-check:
    name: 🔍 Production Files Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 📋 生產檔案合規性檢查
        run: |
          .github/scripts/production-compliance-check.sh

      - name: 🧹 代碼品質檢查
        run: |
          .github/scripts/code-quality-check.sh

  # ==========================================  
  # 階段 2: 安全性掃描
  # ==========================================
  security-scan:
    name: 🛡️ Production Security Scan
    runs-on: ubuntu-latest
    needs: production-compliance-check
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 🔒 安全性掃描
        run: |
          .github/scripts/security-scan.sh

  # ==========================================
  # 階段 3: 最終保護決策
  # ==========================================
  protection-decision:
    name: 🎯 Final Protection Decision
    runs-on: ubuntu-latest
    needs: [production-compliance-check, security-scan]
    if: always()

    steps:
      - name: 📊 彙總檢查結果
        run: |
          echo "📊 Main 分支保護檢查結果彙總"
          echo "========================================="
          
          compliance_status="${{ needs.production-compliance-check.result }}"
          security_status="${{ needs.security-scan.result }}"
          
          echo "🔍 檔案合規性檢查: $compliance_status"
          echo "🛡️ 安全掃描: $security_status"
          
          if [ "$compliance_status" = "success" ] && [ "$security_status" = "success" ]; then
            echo ""
            echo "✅ MAIN 分支保護檢查通過"
            echo "🎉 所有檢查均符合生產標準"
            echo "🚀 可以安全合併到 main 分支"
          else
            echo ""
            echo "❌ MAIN 分支保護檢查失敗"
            echo "🚫 PR 被阻止合併到 main 分支"
            echo ""
            echo "💡 修復建議："
            if [ "$compliance_status" != "success" ]; then
              echo "  - 修復檔案合規性問題"
              echo "  - 移除不應存在於生產環境的檔案"
            fi
            if [ "$security_status" != "success" ]; then
              echo "  - 修復安全漏洞"  
              echo "  - 更新有漏洞的依賴包"
            fi
            exit 1
          fi

      - name: 🔔 保護狀態通知
        if: always()
        run: |
          echo "🔔 Main 分支保護狀態通知"
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Main 分支受到完善保護"
            echo "🛡️ 生產檔案完整性已驗證"
            echo "🔒 安全標準符合要求"
          else
            echo "🚨 Main 分支保護啟動"  
            echo "🚫 阻止不符合標準的變更"
            echo "💪 確保生產環境品質"
          fi