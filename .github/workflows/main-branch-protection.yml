name: ğŸ›¡ï¸ Main Branch Protection

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  production-compliance:
    name: ğŸ”’ ç”Ÿç”¢åˆè¦å¼·åˆ¶æª¢æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ›¡ï¸ åŸ·è¡Œç”Ÿç”¢æª”æ¡ˆåˆè¦æª¢æŸ¥
      id: compliance
      run: |
        echo "ğŸ” åŸ·è¡Œ main åˆ†æ”¯ç”Ÿç”¢æª”æ¡ˆåˆè¦æª¢æŸ¥..."
        chmod +x .github/scripts/production-compliance-check.sh
        
        # åŸ·è¡Œæª¢æŸ¥ä¸¦æ•ç²çµæœ
        if .github/scripts/production-compliance-check.sh; then
          echo "âœ… ç”Ÿç”¢åˆè¦æª¢æŸ¥é€šé"
          echo "compliance_status=passed" >> $GITHUB_OUTPUT
        else
          echo "âŒ ç”Ÿç”¢åˆè¦æª¢æŸ¥å¤±æ•—"
          echo "compliance_status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: ğŸ“‹ Main åˆ†æ”¯ä¿è­·ç¸½çµ
      if: always()
      run: |
        echo "ğŸ›¡ï¸ Main åˆ†æ”¯ä¿è­·æª¢æŸ¥å®Œæˆ"
        echo ""
        echo "ğŸ“Š æª¢æŸ¥çµæœ:"
        
        if [[ "${{ steps.compliance.outputs.compliance_status }}" == "passed" ]]; then
          echo "âœ… ç”Ÿç”¢åˆè¦æª¢æŸ¥: é€šé"
          echo ""
          echo "ğŸ‰ æ­¤ PR ç¬¦åˆ main åˆ†æ”¯çš„ç”Ÿç”¢æ¨™æº–"
          echo "ğŸ”’ æ‰€æœ‰æª”æ¡ˆéƒ½ç¬¦åˆç”Ÿç”¢ç’°å¢ƒç™½åå–®è¦æ±‚"
          echo "âœ¨ å¯ä»¥å®‰å…¨åˆä½µåˆ° main åˆ†æ”¯"
        else
          echo "âŒ ç”Ÿç”¢åˆè¦æª¢æŸ¥: å¤±æ•—"
          echo ""
          echo "ğŸš« æ­¤ PR åŒ…å«ä¸ç¬¦åˆç”Ÿç”¢æ¨™æº–çš„æª”æ¡ˆ"
          echo "ğŸ’¡ è«‹ç§»é™¤ä»¥ä¸‹é¡å‹çš„æª”æ¡ˆï¼š"
          echo "   â€¢ æ¸¬è©¦æª”æ¡ˆ (tests/**, *_test.py)"
          echo "   â€¢ é–‹ç™¼å·¥å…·é…ç½® (.bandit, .flake8, pytest.ini)"
          echo "   â€¢ å»ºæ§‹æª”æ¡ˆ (Dockerfile, Makefile)"
          echo "   â€¢ å¯¦é©—æ€§æª”æ¡ˆ (experimental/**, prototype/**)"
          echo "   â€¢ IDE é…ç½®æª”æ¡ˆ (.vscode/**, .idea/**)"
          echo ""
          echo "ğŸ”§ è§£æ±ºæ–¹æ¡ˆ:"
          echo "1. å°‡é€™äº›æª”æ¡ˆä¿ç•™åœ¨ dev åˆ†æ”¯"
          echo "2. main åˆ†æ”¯æ‡‰åªåŒ…å«ç”Ÿç”¢ç’°å¢ƒå¿…éœ€çš„æª”æ¡ˆ"
          echo "3. é‡æ–°æäº¤ PRï¼Œåƒ…åŒ…å«ç™½åå–®ä¸­çš„æª”æ¡ˆ"
        fi

  branch-policy-check:
    name: ğŸš¦ åˆ†æ”¯ç­–ç•¥æª¢æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ” æª¢æŸ¥åˆ†æ”¯ç­–ç•¥
      run: |
        echo "ğŸš¦ æª¢æŸ¥ main åˆ†æ”¯ç­–ç•¥åˆè¦æ€§..."
        
        # æª¢æŸ¥æ˜¯å¦æœ‰ç›´æ¥æ¨é€åˆ° mainï¼ˆæ‡‰è©²åªå…è¨± PRï¼‰
        if [[ "${{ github.event_name }}" == "push" ]] && [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "âš ï¸ æª¢æ¸¬åˆ°ç›´æ¥æ¨é€åˆ° main åˆ†æ”¯"
          
          # æª¢æŸ¥æ˜¯å¦æ˜¯åˆä½µæäº¤ï¼ˆå…è¨±ï¼‰æˆ–ç›´æ¥æ¨é€ï¼ˆä¸å…è¨±ï¼‰
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          if [[ "$COMMIT_MESSAGE" == *"Merge pull request"* ]] || [[ "$COMMIT_MESSAGE" == *"Auto-merge"* ]]; then
            echo "âœ… åˆä½µæäº¤ - å…è¨±"
          else
            echo "âŒ ç›´æ¥æ¨é€åˆ° main åˆ†æ”¯ä¸è¢«å…è¨±"
            echo "ğŸ’¡ è«‹ä½¿ç”¨ Pull Request æµç¨‹"
            exit 1
          fi
        fi
        
        echo "âœ… åˆ†æ”¯ç­–ç•¥æª¢æŸ¥é€šé"
    
    - name: ğŸ“Š åˆ†æ”¯ä¿è­·ç‹€æ…‹å ±å‘Š
      if: always()
      run: |
        echo "ğŸ›¡ï¸ Main åˆ†æ”¯ä¿è­·ç‹€æ…‹å ±å‘Š"
        echo "================================"
        echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref }}"
        echo "ğŸ¯ äº‹ä»¶: ${{ github.event_name }}"
        echo "ğŸ‘¤ è§¸ç™¼è€…: ${{ github.actor }}"
        echo ""
        
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "âœ… æ­£ç¢ºä½¿ç”¨ PR æµç¨‹åˆä½µåˆ° main"
          echo "ğŸ” PR æ¨™é¡Œ: ${{ github.event.pull_request.title }}"
          echo "ğŸ‘¥ PR ä½œè€…: ${{ github.event.pull_request.user.login }}"
        fi
        
        echo ""
        echo "ğŸ‰ Main åˆ†æ”¯ä¿è­·æ©Ÿåˆ¶æ­£å¸¸é‹è¡Œ"