name: ğŸ›¡ï¸ Main Branch Protection - Production Files Only

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, edited]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_check:
        description: 'å¼·åˆ¶åŸ·è¡Œå®Œæ•´æª¢æŸ¥'
        required: false
        default: true
        type: boolean

env:
  PYTHON_VERSION: '3.10'

jobs:
  # ==========================================
  # éšæ®µ 1: ç”Ÿç”¢æª”æ¡ˆåˆè¦æ€§æª¢æŸ¥
  # ==========================================
  production-compliance-check:
    name: ğŸ” Production Files Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“‹ ç”Ÿç”¢æª”æ¡ˆåˆè¦æ€§æª¢æŸ¥
        run: |
          .github/scripts/production-compliance-check.sh

      - name: ğŸ§¹ ä»£ç¢¼å“è³ªæª¢æŸ¥
        run: |
          .github/scripts/code-quality-check.sh

  # ==========================================  
  # éšæ®µ 2: å®‰å…¨æ€§æƒæ
  # ==========================================
  security-scan:
    name: ğŸ›¡ï¸ Production Security Scan
    runs-on: ubuntu-latest
    needs: production-compliance-check
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ”’ å®‰å…¨æ€§æƒæ
        run: |
          .github/scripts/security-scan.sh

  # ==========================================
  # éšæ®µ 3: æœ€çµ‚ä¿è­·æ±ºç­–
  # ==========================================
  protection-decision:
    name: ğŸ¯ Final Protection Decision
    runs-on: ubuntu-latest
    needs: [production-compliance-check, security-scan]
    if: always()

    steps:
      - name: ğŸ“Š å½™ç¸½æª¢æŸ¥çµæœ
        run: |
          echo "ğŸ“Š Main åˆ†æ”¯ä¿è­·æª¢æŸ¥çµæœå½™ç¸½"
          echo "========================================="
          
          compliance_status="${{ needs.production-compliance-check.result }}"
          security_status="${{ needs.security-scan.result }}"
          
          echo "ğŸ” æª”æ¡ˆåˆè¦æ€§æª¢æŸ¥: $compliance_status"
          echo "ğŸ›¡ï¸ å®‰å…¨æƒæ: $security_status"
          
          if [ "$compliance_status" = "success" ] && [ "$security_status" = "success" ]; then
            echo ""
            echo "âœ… MAIN åˆ†æ”¯ä¿è­·æª¢æŸ¥é€šé"
            echo "ğŸ‰ æ‰€æœ‰æª¢æŸ¥å‡ç¬¦åˆç”Ÿç”¢æ¨™æº–"
            echo "ğŸš€ å¯ä»¥å®‰å…¨åˆä½µåˆ° main åˆ†æ”¯"
          else
            echo ""
            echo "âŒ MAIN åˆ†æ”¯ä¿è­·æª¢æŸ¥å¤±æ•—"
            echo "ğŸš« PR è¢«é˜»æ­¢åˆä½µåˆ° main åˆ†æ”¯"
            echo ""
            echo "ğŸ’¡ ä¿®å¾©å»ºè­°ï¼š"
            if [ "$compliance_status" != "success" ]; then
              echo "  - ä¿®å¾©æª”æ¡ˆåˆè¦æ€§å•é¡Œ"
              echo "  - ç§»é™¤ä¸æ‡‰å­˜åœ¨æ–¼ç”Ÿç”¢ç’°å¢ƒçš„æª”æ¡ˆ"
            fi
            if [ "$security_status" != "success" ]; then
              echo "  - ä¿®å¾©å®‰å…¨æ¼æ´"  
              echo "  - æ›´æ–°æœ‰æ¼æ´çš„ä¾è³´åŒ…"
            fi
            exit 1
          fi

      - name: ğŸ”” ä¿è­·ç‹€æ…‹é€šçŸ¥
        if: always()
        run: |
          echo "ğŸ”” Main åˆ†æ”¯ä¿è­·ç‹€æ…‹é€šçŸ¥"
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Main åˆ†æ”¯å—åˆ°å®Œå–„ä¿è­·"
            echo "ğŸ›¡ï¸ ç”Ÿç”¢æª”æ¡ˆå®Œæ•´æ€§å·²é©—è­‰"
            echo "ğŸ”’ å®‰å…¨æ¨™æº–ç¬¦åˆè¦æ±‚"
          else
            echo "ğŸš¨ Main åˆ†æ”¯ä¿è­·å•Ÿå‹•"  
            echo "ğŸš« é˜»æ­¢ä¸ç¬¦åˆæ¨™æº–çš„è®Šæ›´"
            echo "ğŸ’ª ç¢ºä¿ç”Ÿç”¢ç’°å¢ƒå“è³ª"
          fi