name: ğŸ”„ è‡ªå‹•åŒæ­¥ main â†’ ptero

on:
  push:
    branches: [main]
  schedule:
    # æ¯å¤© UTC 2:00 (å°åŒ—æ™‚é–“ 10:00) è‡ªå‹•æª¢æŸ¥åŒæ­¥
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼·åˆ¶åŒæ­¥ï¼ˆå¿½ç•¥è¡çªï¼‰'
        type: boolean
        default: false
      sync_message:
        description: 'è‡ªå®šç¾©åŒæ­¥è¨Šæ¯'
        type: string
        default: ''

permissions:
  contents: write
  actions: write
  checks: read
  pull-requests: read

env:
  PTERO_BRANCH: ptero
  MAIN_BRANCH: main

jobs:
  detect-changes:
    name: ğŸ” æª¢æ¸¬è®Šæ›´
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
      commits_count: ${{ steps.check.outputs.commits_count }}
      latest_commit: ${{ steps.check.outputs.latest_commit }}
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: æª¢æŸ¥åˆ†æ”¯å·®ç•°
        id: check
        run: |
          # ç²å–å…©å€‹åˆ†æ”¯çš„æœ€æ–°æäº¤
          git fetch origin ${{ env.MAIN_BRANCH }}
          git fetch origin ${{ env.PTERO_BRANCH }}:${{ env.PTERO_BRANCH }}
          
          # æª¢æŸ¥æ˜¯å¦æœ‰æ–°çš„æäº¤éœ€è¦åŒæ­¥
          COMMITS_BEHIND=$(git rev-list --count ${{ env.PTERO_BRANCH }}..origin/${{ env.MAIN_BRANCH }})
          LATEST_COMMIT=$(git rev-parse --short origin/${{ env.MAIN_BRANCH }})
          
          echo "commits_count=$COMMITS_BEHIND" >> $GITHUB_OUTPUT
          echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          
          if [ "$COMMITS_BEHIND" -gt 0 ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“Š ç™¼ç¾ $COMMITS_BEHIND å€‹æ–°æäº¤éœ€è¦åŒæ­¥åˆ° ptero"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… ptero åˆ†æ”¯å·²æ˜¯æœ€æ–°ï¼Œç„¡éœ€åŒæ­¥"
          fi

  sync-to-ptero:
    name: ğŸ”„ åŒæ­¥åˆ° ptero åˆ†æ”¯
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    timeout-minutes: 10
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½® Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: åŸ·è¡Œæ™ºèƒ½åˆä½µåŒæ­¥
        id: merge
        run: |
          echo "ğŸ”„ é–‹å§‹åŒæ­¥ ${{ env.MAIN_BRANCH }} â†’ ${{ env.PTERO_BRANCH }}"
          
          # åˆ‡æ›åˆ° ptero åˆ†æ”¯
          git checkout ${{ env.PTERO_BRANCH }}
          
          # æª¢æŸ¥æ˜¯å¦ç‚ºå¼·åˆ¶åŒæ­¥
          if [ "${{ github.event.inputs.force_sync }}" = "true" ]; then
            echo "âš ï¸ åŸ·è¡Œå¼·åˆ¶åŒæ­¥æ¨¡å¼"
            
            # å¼·åˆ¶åŒæ­¥ï¼šé‡ç½® ptero ç‚ºç°¡åŒ–ç‰ˆçš„ main
            git checkout ${{ env.MAIN_BRANCH }} -- src/ .env.example requirements.txt pyproject.toml
            
            # ä¿æŒ ptero ç‰¹æœ‰çš„æ–‡ä»¶
            git checkout HEAD -- README.md start.py
            
            # ç¢ºä¿ bot ç›®éŒ„å­˜åœ¨ï¼ˆptero åˆ†æ”¯ç‰¹æœ‰ï¼‰
            if [ ! -d "bot" ]; then
              mkdir -p bot/services bot/utils
              
              # å‰µå»º ptero åˆ†æ”¯éœ€è¦çš„ç°¡åŒ–æ–‡ä»¶  
              echo "# bot/services/vote_manager.py - Ptero ç°¡åŒ–ç‰ˆ" > bot/services/vote_manager.py
              echo "# æŠ•ç¥¨ç®¡ç†æœå‹™ - è¨—ç®¡ç‰ˆæœ¬" >> bot/services/vote_manager.py
              echo "from datetime import datetime" >> bot/services/vote_manager.py
              echo "from typing import Dict, Any, List" >> bot/services/vote_manager.py
              echo "import discord" >> bot/services/vote_manager.py
              echo "" >> bot/services/vote_manager.py
              echo "class VoteManager:" >> bot/services/vote_manager.py
              echo "    # ç°¡åŒ–çš„æŠ•ç¥¨ç®¡ç†å™¨" >> bot/services/vote_manager.py
              echo "    def __init__(self):" >> bot/services/vote_manager.py
              echo "        self.active_votes = {}" >> bot/services/vote_manager.py
              
              echo "# bot/utils/validator.py - Ptero ç°¡åŒ–ç‰ˆ" > bot/utils/validator.py
              echo "# åŸºæœ¬é©—è­‰å·¥å…· - è¨—ç®¡ç‰ˆæœ¬" >> bot/utils/validator.py
              echo "import re" >> bot/utils/validator.py
              echo "from typing import Tuple" >> bot/utils/validator.py
              echo "" >> bot/utils/validator.py
              echo "def validate_discord_id(discord_id) -> bool:" >> bot/utils/validator.py
              echo "    # é©—è­‰Discord IDæ ¼å¼" >> bot/utils/validator.py
              echo "    try:" >> bot/utils/validator.py
              echo "        if isinstance(discord_id, str):" >> bot/utils/validator.py
              echo "            if not discord_id.isdigit():" >> bot/utils/validator.py
              echo "                return False" >> bot/utils/validator.py
              echo "            discord_id = int(discord_id)" >> bot/utils/validator.py
              echo "        return 10000000000000000 <= discord_id <= 999999999999999999999" >> bot/utils/validator.py
              echo "    except (ValueError, TypeError):" >> bot/utils/validator.py
              echo "        return False" >> bot/utils/validator.py
            fi
            
            sync_message="${{ github.event.inputs.sync_message }}"
            if [ -z "$sync_message" ]; then
              sync_message="ğŸ”„ å¼·åˆ¶åŒæ­¥: æ›´æ–°è‡³ main@${{ needs.detect-changes.outputs.latest_commit }}"
            fi
            
          else
            echo "ğŸ“ åŸ·è¡Œæ¨™æº–åˆä½µåŒæ­¥"
            
            # æ¨™æº–åˆä½µåŒæ­¥
            if git merge ${{ env.MAIN_BRANCH }} --no-edit; then
              echo "merge_status=success" >> $GITHUB_OUTPUT
              sync_message="ğŸ”„ è‡ªå‹•åŒæ­¥: åˆä½µ main (${{ needs.detect-changes.outputs.commits_count }} commits) â†’ ptero"
            else
              echo "âš ï¸ ç™¼ç¾åˆä½µè¡çªï¼Œå˜—è©¦æ™ºèƒ½è§£æ±º..."
              
              # æ™ºèƒ½è¡çªè§£æ±ºç­–ç•¥
              # å°æ–¼ç‰¹å®šæ–‡ä»¶ï¼Œå„ªå…ˆä½¿ç”¨ ptero çš„ç‰ˆæœ¬
              if [ -f "README.md" ]; then
                git checkout --theirs README.md
                echo "âœ… ä¿ç•™ ptero ç‰ˆæœ¬çš„ README.md"
              fi
              
              if [ -f "start.py" ]; then
                git checkout --theirs start.py
                echo "âœ… ä¿ç•™ ptero ç‰ˆæœ¬çš„ start.py" 
              fi
              
              # å°æ–¼å…¶ä»–æ–‡ä»¶ï¼Œå„ªå…ˆä½¿ç”¨ main çš„ç‰ˆæœ¬
              git add .
              
              if git commit --no-edit; then
                echo "merge_status=conflict_resolved" >> $GITHUB_OUTPUT
                sync_message="ğŸ”§ è‡ªå‹•åŒæ­¥: è§£æ±ºè¡çªä¸¦åˆä½µ main â†’ ptero"
              else
                echo "âŒ ç„¡æ³•è‡ªå‹•è§£æ±ºè¡çª"
                echo "merge_status=failed" >> $GITHUB_OUTPUT
                exit 1
              fi
            fi
          fi
          
          echo "sync_message=$sync_message" >> $GITHUB_OUTPUT

      - name: æ¨é€è®Šæ›´
        if: steps.merge.outputs.merge_status != 'failed'
        run: |
          echo "ğŸ“¤ æ¨é€åŒæ­¥çµæœåˆ°é ç¨‹åˆ†æ”¯..."
          git push origin ${{ env.PTERO_BRANCH }}
          echo "âœ… åŒæ­¥å®Œæˆ"

      - name: å‰µå»ºåŒæ­¥å ±å‘Š
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const syncStatus = '${{ steps.merge.outputs.merge_status }}';
            const commitCount = '${{ needs.detect-changes.outputs.commits_count }}';
            const latestCommit = '${{ needs.detect-changes.outputs.latest_commit }}';
            const syncMessage = '${{ steps.merge.outputs.sync_message }}';
            
            let emoji = 'âœ…';
            let status = 'Success';
            let details = `æˆåŠŸåŒæ­¥ ${commitCount} å€‹æäº¤åˆ° ptero åˆ†æ”¯`;
            
            if (syncStatus === 'failed') {
              emoji = 'âŒ';
              status = 'Failed';
              details = 'åŒæ­¥å¤±æ•—ï¼Œéœ€è¦æ‰‹å‹•è™•ç†è¡çª';
            } else if (syncStatus === 'conflict_resolved') {
              emoji = 'ğŸ”§';
              status = 'Success (Conflicts Resolved)';
              details = `è‡ªå‹•è§£æ±ºè¡çªä¸¦åŒæ­¥ ${commitCount} å€‹æäº¤`;
            }
            
            const reportBody = `## ${emoji} ptero åˆ†æ”¯åŒæ­¥å ±å‘Š
            
            **ç‹€æ…‹**: ${status}
            **è©³æƒ…**: ${details}
            **æœ€æ–°æäº¤**: \`${latestCommit}\`
            **åŒæ­¥è¨Šæ¯**: ${syncMessage}
            
            ### åŒæ­¥å…§å®¹
            - ğŸ“¦ åŒæ­¥ ${commitCount} å€‹æ–°æäº¤
            - ğŸ”„ ä¿æŒ ptero åˆ†æ”¯çš„ç°¡åŒ–ç‰¹æ€§
            - ğŸ“ ç¶­æŒè¨—ç®¡éƒ¨ç½²ç‰ˆæœ¬çš„é…ç½®
            
            ---
            *è‡ªå‹•åŒæ­¥ç”± GitHub Actions åŸ·è¡Œ*`;
            
            // å¦‚æœæ˜¯å®šæœŸåŒæ­¥ä¸”æ²’æœ‰å¤±æ•—ï¼Œå‰µå»ºè¨è«–è€Œä¸æ˜¯ issue
            if (context.eventName === 'schedule' && syncStatus !== 'failed') {
              console.log('å®šæœŸåŒæ­¥æˆåŠŸï¼Œè¨˜éŒ„åˆ°æ—¥èªŒ');
              console.log(reportBody);
            } else if (syncStatus === 'failed') {
              // å¤±æ•—æ™‚å‰µå»º issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš¨ ptero åˆ†æ”¯åŒæ­¥å¤±æ•— - ${new Date().toISOString().split('T')[0]}`,
                body: reportBody,
                labels: ['sync-failure', 'maintenance']
              });
            } else {
              console.log('åŒæ­¥æˆåŠŸ');
              console.log(reportBody);
            }

  health-check:
    name: ğŸ¥ å¥åº·æª¢æŸ¥
    runs-on: ubuntu-latest
    needs: [detect-changes, sync-to-ptero]
    if: always() && needs.sync-to-ptero.result == 'success'
    
    steps:
      - name: æª¢å‡º ptero åˆ†æ”¯
        uses: actions/checkout@v4
        with:
          ref: ptero
          
      - name: é©—è­‰åˆ†æ”¯å®Œæ•´æ€§
        run: |
          echo "ğŸ” é©—è­‰ ptero åˆ†æ”¯å®Œæ•´æ€§..."
          
          # æª¢æŸ¥å¿…è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          required_files=("README.md" "start.py" ".env.example" "requirements.txt")
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ ç¼ºå°‘å¿…è¦æ–‡ä»¶: $file"
              exit 1
            else
              echo "âœ… æ–‡ä»¶å­˜åœ¨: $file"
            fi
          done
          
          # æª¢æŸ¥ç›®éŒ„çµæ§‹
          if [ -d "src" ]; then
            echo "âœ… src ç›®éŒ„å­˜åœ¨"
          else
            echo "âŒ src ç›®éŒ„ç¼ºå¤±"
            exit 1
          fi
          
          if [ -d "bot" ]; then
            echo "âœ… bot ç›®éŒ„å­˜åœ¨ (ptero ç‰¹æœ‰)"
          else
            echo "âš ï¸ bot ç›®éŒ„ä¸å­˜åœ¨ï¼Œé€™å¯èƒ½å½±éŸ¿è¨—ç®¡ç‰ˆæœ¬"
          fi
          
          echo "ğŸ‰ ptero åˆ†æ”¯å¥åº·æª¢æŸ¥é€šéï¼"

  notify-completion:
    name: ğŸ“¢ å®Œæˆé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [detect-changes, sync-to-ptero, health-check]
    if: always() && needs.detect-changes.outputs.has_changes == 'true'
    
    steps:
      - name: ç™¼é€å®Œæˆé€šçŸ¥
        uses: actions/github-script@v7
        with:
          script: |
            const syncResult = '${{ needs.sync-to-ptero.result }}';
            const healthResult = '${{ needs.health-check.result }}';
            const commitCount = '${{ needs.detect-changes.outputs.commits_count }}';
            
            let emoji = 'ğŸ‰';
            let title = 'ptero åˆ†æ”¯åŒæ­¥å®Œæˆ';
            let status = 'æˆåŠŸ';
            
            if (syncResult === 'failure' || healthResult === 'failure') {
              emoji = 'ğŸš¨';
              title = 'ptero åˆ†æ”¯åŒæ­¥ç•°å¸¸';
              status = 'å¤±æ•—';
            }
            
            console.log(`${emoji} ${title}`);
            console.log(`ç‹€æ…‹: ${status}`);
            console.log(`åŒæ­¥æäº¤æ•¸: ${commitCount}`);
            console.log(`åŒæ­¥çµæœ: ${syncResult}`);
            console.log(`å¥åº·æª¢æŸ¥: ${healthResult}`);