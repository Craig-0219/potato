name: ğŸš€ Deploy to Ptero Branch

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  deploy-to-ptero:
    name: ğŸš€ Deploy to Ptero Branch
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com" # pragma: allowlist secret

      - name: Create clean ptero deployment
        run: |
          # å‰µå»ºä¸¦åˆ‡æ›åˆ° ptero åˆ†æ”¯
          git checkout -B ptero

          # ç§»é™¤ä¸éœ€è¦çš„é–‹ç™¼æ–‡ä»¶
          rm -rf .github/workflows
          rm -rf tests/
          rm -rf docs/
          rm -rf scripts/
          rm -rf .pre-commit-config.yaml
          rm -rf .coveragerc
          rm -rf .bandit
          rm -rf .safety-policy.json
          rm -rf .semgrepignore
          rm -rf .secrets.baseline
          rm -rf CI_CD_*.md
          rm -rf IMPLEMENTATION_PLAN.md
          rm -rf NEXT_PHASE_DEVELOPMENT_PLAN.md
          rm -rf PRIORITY_MATRIX.md
          rm -rf PHASE_COMPLETION_SUMMARY.md
          rm -rf DEV_WORKFLOWS_ENHANCEMENT_PLAN.md
          rm -rf test_*.py
          rm -rf trigger_merge.txt
          rm -rf bandit-report.json
          rm -rf security_reports

          # æ¸…ç† Python ç·¨è­¯æ–‡ä»¶å’Œæ—¥èªŒ
          find . -name "*.pyc" -delete
          find . -name "*.log" -delete
          find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          find . -name ".pytest_cache" -type d -exec rm -rf {} + 2>/dev/null || true
          
          # ç§»é™¤ä»»ä½•æ„å¤–çš„æ–‡æª”æ–‡ä»¶
          find . -name "*.md" -not -path "./README.md" -delete 2>/dev/null || true

          # ç¢ºä¿å¿…è¦çš„å•Ÿå‹•æ–‡ä»¶æœ‰åŸ·è¡Œæ¬Šé™
          chmod +x start.sh 2>/dev/null || true
          chmod +x start.py 2>/dev/null || true

          # ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
          echo "# Potato Discord Bot - Production Version" > VERSION
          echo "Version: $(date '+%Y.%m.%d')" >> VERSION
          echo "Build: $(git rev-parse --short HEAD)" >> VERSION
          echo "Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> VERSION
          echo "Source: main branch" >> VERSION

          # ç¢ºä¿ .env.example å­˜åœ¨
          if [ ! -f .env.example ]; then
            echo "# Potato Discord Bot Environment Configuration" > .env.example
            echo "DISCORD_TOKEN=your_discord_bot_token_here" >> .env.example
            echo "DATABASE_URL=postgresql://user:password@localhost:5432/potato_bot" >> .env.example
            echo "REDIS_URL=redis://localhost:6379" >> .env.example
          fi

      - name: Commit and push to ptero
        run: |
          git add .
          git commit -m "ğŸš€ éƒ¨ç½²åˆ° Ptero åˆ†æ”¯ - $(date '+%Y-%m-%d %H:%M:%S')

          ğŸ“¦ ç‰ˆæœ¬: $(date '+%Y.%m.%d')
          ğŸ”— ä¾†æº: main åˆ†æ”¯ ($(git log main -1 --format='%h'))

          âœ… éƒ¨ç½²å…§å®¹:
          â€¢ å®Œæ•´ Bot æ ¸å¿ƒæ–‡ä»¶ (bot/)
          â€¢ å…±ç”¨æ¨¡çµ„å’Œé…ç½® (shared/)
          â€¢ è·¨å¹³å°å•Ÿå‹•å·¥å…·
          â€¢ ç”Ÿç”¢ç’°å¢ƒä¾è³´
          â€¢ ç’°å¢ƒé…ç½®ç¯„ä¾‹

          ğŸ›¡ï¸ å®‰å…¨ä¿è­‰:
          â€¢ ç§»é™¤æ‰€æœ‰é–‹ç™¼å’Œæ¸¬è©¦æ–‡ä»¶
          â€¢ ç„¡æ•æ„Ÿè³‡æ–™
          â€¢ ç”Ÿç”¢å°±ç·’ç‰ˆæœ¬" || echo "No changes to commit"

          git push origin ptero --force

      - name: Deployment summary
        run: |
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ“¦ Ptero åˆ†æ”¯å·²æ›´æ–°"
          echo "ğŸ”— ä¾†æº: main åˆ†æ”¯ $(git log main -1 --format='%h - %s')"
          echo "â° éƒ¨ç½²æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
