name: ğŸš€ Deploy to Ptero Branch

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
      - 'LICENSE'
      - '.github/workflows/**' # é¿å…workflowæ–‡ä»¶è®Šæ›´è§¸ç™¼éƒ¨ç½²
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'å¼·åˆ¶éƒ¨ç½²åˆ° ptero åˆ†æ”¯'
        required: false
        default: false
        type: boolean
      skip_quality_check:
        description: 'è·³éå“è³ªæª¢æŸ¥ï¼ˆç·Šæ€¥éƒ¨ç½²ç”¨ï¼‰'
        required: false
        default: false
        type: boolean
  # æ–°å¢ï¼šç•¶auto-merge workflowæˆåŠŸå¾Œè‡ªå‹•è§¸ç™¼
  workflow_run:
    workflows: ["ğŸ¤– Auto Merge Dev to Main"]
    types: [completed]
    branches: [main]

env:
  PYTHON_VERSION: '3.10'
  TARGET_BRANCH: 'ptero'

# ç¢ºä¿åŒæ™‚åªæœ‰ä¸€å€‹éƒ¨ç½²é€²è¡Œ
concurrency:
  group: deploy-to-ptero
  cancel-in-progress: false

jobs:
  # ==========================================
  # éšæ®µ 1: éƒ¨ç½²å‰é©—è­‰
  # ==========================================
  pre-deployment-validation:
    name: ğŸ” Pre-deployment Validation
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.decision.outputs.should_deploy }}
      commit_sha: ${{ steps.info.outputs.commit_sha }}

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: ğŸ“Š æ”¶é›†éƒ¨ç½²è³‡è¨Š
        id: info
        run: |
          echo "commit_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "commit_message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
          echo "author=${{ github.actor }}" >> $GITHUB_OUTPUT
          
          echo "ğŸ” éƒ¨ç½²è³‡è¨Šï¼š"
          echo "  Commit: ${{ github.sha }}"
          echo "  ä½œè€…: ${{ github.actor }}"
          echo "  åˆ†æ”¯: main â†’ ptero"

      - name: ğŸ¯ éƒ¨ç½²æ±ºç­–
        id: decision
        run: |
          should_deploy="false"
          deployment_reason=""
          
          # æ‰‹å‹•è§¸ç™¼ç¸½æ˜¯éƒ¨ç½²
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            should_deploy="true"
            deployment_reason="æ‰‹å‹•è§¸ç™¼éƒ¨ç½²"
          
          # workflow_runè§¸ç™¼ï¼ˆä¾†è‡ªauto-mergeï¼‰
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
              should_deploy="true"
              deployment_reason="devåˆ†æ”¯è‡ªå‹•åˆä½µæˆåŠŸï¼Œè§¸ç™¼éƒ¨ç½²"
            else
              should_deploy="false"
              deployment_reason="auto-merge workflowå¤±æ•—ï¼Œè·³ééƒ¨ç½²"
            fi
          
          # ç›´æ¥æ¨é€åˆ°mainåˆ†æ”¯
          elif [ "${{ github.event_name }}" = "push" ]; then
            # æª¢æŸ¥æ˜¯å¦ç‚ºåˆä½µæäº¤æˆ–é‡è¦æ›´æ–°
            if git log -1 --pretty=%B | grep -i "merge\|åˆä½µ\|ğŸš€\|release" > /dev/null; then
              should_deploy="true"
              deployment_reason="åµæ¸¬åˆ°é‡è¦æ›´æ–°æˆ–åˆä½µæäº¤"
            else
              should_deploy="false"
              deployment_reason="æ™®é€šæäº¤ï¼Œå»ºè­°é€édevåˆ†æ”¯æµç¨‹"
            fi
          fi
          
          echo "should_deploy=$should_deploy" >> $GITHUB_OUTPUT
          echo "deployment_reason=$deployment_reason" >> $GITHUB_OUTPUT
          echo "ğŸ¯ éƒ¨ç½²æ±ºç­–: $should_deploy ($deployment_reason)"

  # ==========================================
  # éšæ®µ 2: å¿«é€Ÿå“è³ªæª¢æŸ¥
  # ==========================================
  quality-check:
    name: âš¡ Quick Quality Check
    runs-on: ubuntu-latest
    needs: pre-deployment-validation
    if: needs.pre-deployment-validation.outputs.should_deploy == 'true' && github.event.inputs.skip_quality_check != 'true'

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ” èªæ³•æª¢æŸ¥
        run: |
          echo "ğŸ” åŸ·è¡Œ Python èªæ³•æª¢æŸ¥..."
          
          # å®‰è£å¿…è¦çš„æª¢æŸ¥å·¥å…·
          pip install --no-deps flake8
          
          # é¦–å…ˆæª¢æŸ¥ä¸»è¦å…¥å£é»
          python -m py_compile bot/main.py
          echo "âœ… ä¸»ç¨‹åºèªæ³•æª¢æŸ¥é€šé"
          
          # æ‰¹é‡æª¢æŸ¥æ‰€æœ‰Pythonæ–‡ä»¶
          python -c "
          import os
          import py_compile
          import sys
          
          error_count = 0
          total_files = 0
          
          for root, dirs, files in os.walk('.'):
              # è·³éä¸éœ€è¦çš„ç›®éŒ„
              if any(skip_dir in root for skip_dir in ['.git', '__pycache__', '.pytest_cache', 'node_modules']):
                  continue
              
              for file in files:
                  if file.endswith('.py'):
                      filepath = os.path.join(root, file)
                      total_files += 1
                      try:
                          py_compile.compile(filepath, doraise=True)
                          print(f'âœ… {filepath}')
                      except Exception as e:
                          print(f'âŒ èªæ³•éŒ¯èª¤ {filepath}: {e}')
                          error_count += 1
          
          print(f'\nğŸ“Š æª¢æŸ¥çµæœ: {total_files - error_count}/{total_files} æ–‡ä»¶é€šé')
          if error_count > 0:
              print(f'âŒ ç™¼ç¾ {error_count} å€‹èªæ³•éŒ¯èª¤')
              sys.exit(1)
          else:
              print('ğŸ‰ æ‰€æœ‰ Python æª”æ¡ˆèªæ³•æª¢æŸ¥é€šé')
          "
          
          # åŸºæœ¬ä»£ç¢¼è¦ç¯„æª¢æŸ¥
          echo "ğŸ§¹ åŸ·è¡ŒåŸºæœ¬ä»£ç¢¼è¦ç¯„æª¢æŸ¥..."
          flake8 --select=E9,F63,F7,F82 --show-source --statistics bot/ shared/ || {
            echo "âš ï¸ ç™¼ç¾ä»£ç¢¼è¦ç¯„å•é¡Œï¼Œä½†ä¸é˜»æ­¢éƒ¨ç½²"
          }

      - name: ğŸ“ æª¢æŸ¥å¿…è¦æª”æ¡ˆ
        run: |
          echo "ğŸ“ æª¢æŸ¥éƒ¨ç½²å¿…è¦æª”æ¡ˆ..."
          
          required_files=("bot/main.py" "requirements.txt" ".env.example" "start.py")
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ ç¼ºå°‘å¿…è¦æª”æ¡ˆ: $file"
              exit 1
            else
              echo "âœ… $file"
            fi
          done
          
          echo "âœ… æ‰€æœ‰å¿…è¦æª”æ¡ˆå­˜åœ¨"

  # ==========================================
  # éšæ®µ 3: éƒ¨ç½²åˆ° ptero åˆ†æ”¯
  # ==========================================
  deploy-to-ptero:
    name: ğŸš€ Deploy to Ptero Branch
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, quality-check]
    if: needs.pre-deployment-validation.outputs.should_deploy == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ é…ç½® Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # è¨­ç½®å®‰å…¨é…ç½®
          git config --global init.defaultBranch main
          git config --global pull.rebase false
          
          echo "âœ… Git é…ç½®å®Œæˆ"

      - name: ğŸŒ¿ æº–å‚™ ptero åˆ†æ”¯
        run: |
          echo "ğŸŒ¿ æº–å‚™ ptero åˆ†æ”¯..."
          
          # æª¢æŸ¥ ptero åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git show-ref --verify --quiet refs/remotes/origin/ptero; then
            echo "ptero åˆ†æ”¯å·²å­˜åœ¨ï¼Œåˆ‡æ›ä¸¦æ›´æ–°"
            git checkout ptero
            git pull origin ptero || echo "ptero åˆ†æ”¯æ‹‰å–å¤±æ•—ï¼Œç¹¼çºŒåŸ·è¡Œ"
          else
            echo "å»ºç«‹æ–°çš„ ptero åˆ†æ”¯"
            git checkout -b ptero
          fi
          
          echo "âœ… ptero åˆ†æ”¯æº–å‚™å®Œæˆ"

      - name: ğŸ”„ åŒæ­¥ main å…§å®¹åˆ° ptero
        run: |
          echo "ğŸ”„ åŒæ­¥ main åˆ†æ”¯å…§å®¹..."
          
          # åˆ‡æ›åˆ° main åˆ†æ”¯ç²å–æœ€æ–°å…§å®¹
          git checkout main
          git pull origin main
          
          # åˆ‡å› ptero ä¸¦åˆä½µ main çš„è®Šæ›´
          git checkout ptero
          
          # ä½¿ç”¨ merge ç­–ç•¥åŒæ­¥å…§å®¹
          if git merge main --no-edit; then
            echo "âœ… æˆåŠŸåˆä½µ main åˆ†æ”¯åˆ° ptero"
          else
            echo "âŒ åˆä½µè¡çªï¼Œå˜—è©¦è¦†è“‹ç­–ç•¥..."
            git merge --abort
            
            # ä½¿ç”¨å¼·åˆ¶è¦†è“‹ç­–ç•¥
            git reset --hard main
            echo "âœ… ä½¿ç”¨è¦†è“‹ç­–ç•¥åŒæ­¥å®Œæˆ"
          fi

      - name: ğŸ¯ å„ªåŒ– ptero åˆ†æ”¯å…§å®¹
        run: |
          echo "ğŸ¯ å„ªåŒ– ptero åˆ†æ”¯å…§å®¹..."
          
          # æ¸…ç†ä¸éœ€è¦çš„é–‹ç™¼æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          rm -rf .pytest_cache/ __pycache__/ *.pyc tests/ docs/development/ 2>/dev/null || true
          rm -f .pre-commit-config.yaml .bandit .safety-policy.json pytest.ini 2>/dev/null || true
          
          # ç¢ºä¿ç”Ÿç”¢å¿…éœ€æª”æ¡ˆå­˜åœ¨
          required_files=("bot/main.py" "requirements.txt" ".env.example" "start.py")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ ç¼ºå°‘å¿…è¦æ–‡ä»¶: $file"
              exit 1
            fi
          done
          
          # å»ºç«‹è©³ç´°çš„éƒ¨ç½²è³‡è¨Šæª”æ¡ˆ
          cat > DEPLOYMENT_INFO.md << EOF
          # ğŸš€ Ptero éƒ¨ç½²è³‡è¨Š
          
          **éƒ¨ç½²æ™‚é–“**: $(date -u +%Y-%m-%dT%H:%M:%SZ)  
          **æºåˆ†æ”¯**: main  
          **Commit Hash**: \`${{ needs.pre-deployment-validation.outputs.commit_sha }}\`  
          **éƒ¨ç½²è€…**: ${{ github.actor }}  
          **è§¸ç™¼äº‹ä»¶**: ${{ github.event_name }}  
          **GitHub Run ID**: ${{ github.run_id }}  
          **å·¥ä½œæµç¨‹URL**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ## ğŸ“‹ éƒ¨ç½²æª¢æŸ¥æ¸…å–®
          
          - [x] Python èªæ³•æª¢æŸ¥é€šé
          - [x] å¿…è¦æ–‡ä»¶å®Œæ•´æ€§é©—è­‰
          - [x] Git åˆ†æ”¯åŒæ­¥å®Œæˆ
          - [x] ç”Ÿç”¢ç’°å¢ƒå„ªåŒ–è™•ç†
          
          ## ğŸ”— ç›¸é—œé€£çµ
          
          - [æºCommitè©³æƒ…](https://github.com/${{ github.repository }}/commit/${{ needs.pre-deployment-validation.outputs.commit_sha }})
          - [Pteroåˆ†æ”¯](https://github.com/${{ github.repository }}/tree/ptero)
          - [éƒ¨ç½²æ—¥èªŒ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          
          > æ­¤åˆ†æ”¯å°ˆç‚º Pterodactyl è¨—ç®¡ç’°å¢ƒå„ªåŒ–ï¼ŒåŒ…å«ç´”æ·¨çš„ç”Ÿç”¢ä»£ç¢¼ã€‚  
          > ğŸ¤– è‡ªå‹•éƒ¨ç½²ç³»çµ± v2.0
          EOF
          
          # ç”Ÿæˆç‰ˆæœ¬æ¨™è¨˜æ–‡ä»¶
          echo "{\"version\":\"$(date +%Y%m%d_%H%M%S)\",\"commit\":\"${{ needs.pre-deployment-validation.outputs.commit_sha }}\",\"deploy_time\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > .ptero_deploy_info.json
          
          echo "âœ… ptero åˆ†æ”¯å„ªåŒ–å®Œæˆ"

      - name: ğŸ“¤ æ¨é€åˆ° ptero åˆ†æ”¯
        run: |
          echo "ğŸ“¤ æ¨é€åˆ° ptero åˆ†æ”¯..."
          
          # æ·»åŠ æ‰€æœ‰è®Šæ›´
          git add -A
          
          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
          else
            git commit -m "ğŸš€ è‡ªå‹•éƒ¨ç½²å¾ main åˆ†æ”¯

            æº Commit: ${{ needs.pre-deployment-validation.outputs.commit_sha }}
            éƒ¨ç½²æ™‚é–“: $(date -u +%Y-%m-%dT%H:%M:%SZ)
            éƒ¨ç½²è€…: ${{ github.actor }}
            
            ğŸ¤– è‡ªå‹•éƒ¨ç½²ç³»çµ±"
          fi
          
          # æ¨é€åˆ°é ç¨‹ ptero åˆ†æ”¯
          git push origin ptero
          
          echo "âœ… æˆåŠŸæ¨é€åˆ° ptero åˆ†æ”¯"

  # ==========================================
  # éšæ®µ 4: éƒ¨ç½²å¾Œé©—è­‰å’Œé€šçŸ¥
  # ==========================================
  post-deployment:
    name: ğŸ“¢ Post-deployment Notification
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, deploy-to-ptero]
    if: always() && needs.pre-deployment-validation.outputs.should_deploy == 'true'

    steps:
      - name: ğŸ“Š éƒ¨ç½²ç‹€æ…‹ç¸½çµ
        run: |
          echo "ğŸ“Š Ptero éƒ¨ç½²ç‹€æ…‹ç¸½çµ"
          echo "===================="
          echo "ğŸ¯ ç›®æ¨™åˆ†æ”¯: ptero"
          echo "ğŸ”— æº Commit: ${{ needs.pre-deployment-validation.outputs.commit_sha }}"
          echo "ğŸ‘¤ éƒ¨ç½²è€…: ${{ github.actor }}"
          echo "ğŸ“… éƒ¨ç½²æ™‚é–“: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "ğŸš€ è§¸ç™¼æ–¹å¼: ${{ github.event_name }}"
          
          if [ "${{ needs.deploy-to-ptero.result }}" = "success" ]; then
            echo "âœ… ç‹€æ…‹: éƒ¨ç½²æˆåŠŸ"
            echo "ğŸ‰ main åˆ†æ”¯å·²æˆåŠŸéƒ¨ç½²åˆ° ptero åˆ†æ”¯ï¼"
            echo "ğŸŒ è¨—ç®¡ç’°å¢ƒæ‡‰è©²æœƒè‡ªå‹•æ›´æ–°"
          else
            echo "âŒ ç‹€æ…‹: éƒ¨ç½²å¤±æ•—"
            echo "ğŸ’¥ éƒ¨ç½²éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ"
          fi

      - name: ğŸ“ˆ æ›´æ–°éƒ¨ç½²çµ±è¨ˆ
        if: needs.deploy-to-ptero.result == 'success'
        run: |
          echo "ğŸ“ˆ æ›´æ–°éƒ¨ç½²çµ±è¨ˆå’Œè¨˜éŒ„..."
          echo "=============================="
          echo "ğŸ“Š æœ¬æ¬¡éƒ¨ç½²çµ±è¨ˆ:"
          echo "  â€¢ æˆåŠŸéƒ¨ç½²åˆ° ptero: +1"
          echo "  â€¢ éƒ¨ç½² ID: ${{ github.run_id }}"
          echo "  â€¢ éƒ¨ç½²æ™‚é•·: ç´„ ${{ github.job }} åˆ†é˜"
          echo "  â€¢ æºåˆ†æ”¯: main"
          echo "  â€¢ ç›®æ¨™åˆ†æ”¯: ptero"
          echo "  â€¢ æœ€å¾ŒæˆåŠŸéƒ¨ç½²: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "=============================="
          echo "âœ… éƒ¨ç½²çµ±è¨ˆå·²è¨˜éŒ„"
          
          # å‰µå»ºæˆåŠŸæ¨™è¨˜ï¼ˆå¯ç”¨æ–¼ç›£æ§ï¼‰
          echo "ğŸ† éƒ¨ç½²æˆåŠŸæ¨™è¨˜å·²ç”Ÿæˆ"
      
      - name: ğŸš¨ å¤±æ•—è™•ç†
        if: needs.deploy-to-ptero.result != 'success'
        run: |
          echo "ğŸš¨ éƒ¨ç½²å¤±æ•—è™•ç†ç¨‹åº"
          echo "=============================="
          echo "âŒ éƒ¨ç½²ç‹€æ…‹: å¤±æ•—"
          echo "ğŸ’¥ å¤±æ•—åŸå› : è«‹æŸ¥çœ‹ä¸Šè¿°æ—¥èªŒ"
          echo "ğŸ› ï¸ å»ºè­°æ“ä½œ:"
          echo "  1. æª¢æŸ¥æº commit æ˜¯å¦æœ‰èªæ³•éŒ¯èª¤"
          echo "  2. é©—è­‰ GitHub Token æ¬Šé™"
          echo "  3. æª¢æŸ¥æ˜¯å¦æœ‰åˆ†æ”¯è¡çª"
          echo "  4. æŸ¥çœ‹è©³ç´°éŒ¯èª¤æ—¥èªŒ"
          echo "=============================="
          echo "ğŸ“ å¦‚éœ€å”åŠ©ï¼Œè«‹æŸ¥çœ‹ GitHub Issues"

  # ==========================================
  # éšæ®µ 4: éƒ¨ç½²å¥åº·æª¢æŸ¥
  # ==========================================
  deployment-health-check:
    name: ğŸ¥ Deployment Health Check
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, deploy-to-ptero]
    if: needs.deploy-to-ptero.result == 'success'
    
    steps:
      - name: Checkout ptero branch
        uses: actions/checkout@v4
        with:
          ref: ptero
          fetch-depth: 1
      
      - name: ğŸ©º é©—è­‰éƒ¨ç½²å®Œæ•´æ€§
        run: |
          echo "ğŸ©º é©—è­‰ ptero åˆ†æ”¯éƒ¨ç½²å®Œæ•´æ€§..."
          
          # æª¢æŸ¥é—œéµæ–‡ä»¶
          required_files=("bot/main.py" "requirements.txt" ".env.example" "start.py" "DEPLOYMENT_INFO.md")
          missing_files=0
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file"
            else
              echo "âŒ ç¼ºå¤±: $file"
              missing_files=$((missing_files + 1))
            fi
          done
          
          if [ $missing_files -gt 0 ]; then
            echo "ğŸ’¥ éƒ¨ç½²é©—è­‰å¤±æ•—: ç¼ºå¤± $missing_files å€‹å¿…è¦æ–‡ä»¶"
            exit 1
          fi
          
          # é©—è­‰éƒ¨ç½²è³‡è¨Šæ–‡ä»¶
          if [ -f ".ptero_deploy_info.json" ]; then
            echo "ğŸ“‹ éƒ¨ç½²è³‡è¨Šé©—è­‰:"
            cat .ptero_deploy_info.json | python3 -m json.tool
            echo "âœ… éƒ¨ç½²è³‡è¨Šæ ¼å¼æ­£ç¢º"
          fi
          
          echo "ğŸ‰ éƒ¨ç½²å®Œæ•´æ€§é©—è­‰é€šé"
      
      - name: ğŸ“Š ç”Ÿæˆéƒ¨ç½²å ±å‘Š
        run: |
          echo "ğŸ“Š ç”Ÿæˆéƒ¨ç½²ç‹€æ…‹å ±å‘Š..."
          
          commit_hash=$(git rev-parse HEAD)
          file_count=$(find . -type f -not -path "./.git/*" | wc -l)
          size_kb=$(du -sk . | cut -f1)
          
          echo "ğŸ“‹ Ptero åˆ†æ”¯ç‹€æ…‹å ±å‘Š"
          echo "============================"
          echo "ğŸ”— æœ€æ–° Commit: $commit_hash"
          echo "ğŸ“ æª”æ¡ˆç¸½æ•¸: $file_count"
          echo "ğŸ“¦ åˆ†æ”¯å¤§å°: ${size_kb}KB"
          echo "â° æª¢æŸ¥æ™‚é–“: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "ğŸ¯ ç›®æ¨™ç’°å¢ƒ: Pterodactyl"
          echo "============================"
          
          echo "âœ… éƒ¨ç½²å ±å‘Šç”Ÿæˆå®Œæˆ"