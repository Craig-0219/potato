name: ğŸš€ Deploy to Ptero

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'å¼·åˆ¶éƒ¨ç½² (è·³éæª¢æŸ¥)'
        type: boolean
        default: false
      target_commit:
        description: 'æŒ‡å®šéƒ¨ç½²çš„ commit SHA (å¯é¸)'
        type: string
        required: false

permissions:
  contents: write
  actions: read

env:
  TARGET_BRANCH: ptero
  
jobs:
  pre-deploy-check:
    name: ğŸ” éƒ¨ç½²å‰æª¢æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      commit_sha: ${{ steps.check.outputs.commit_sha }}
      commit_message: ${{ steps.check.outputs.commit_message }}
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # éœ€è¦å®Œæ•´æ­·å²ä¾†æ¯”è¼ƒåˆ†æ”¯
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ” åŸ·è¡Œéƒ¨ç½²æª¢æŸ¥
      id: check
      run: |
        echo "ğŸ” åŸ·è¡Œéƒ¨ç½²å‰æª¢æŸ¥..."
        
        # ç²å–ç›®æ¨™ commit
        if [[ "${{ github.event.inputs.target_commit }}" != "" ]]; then
          TARGET_COMMIT="${{ github.event.inputs.target_commit }}"
          echo "ğŸ¯ ä½¿ç”¨æŒ‡å®šçš„ commit: $TARGET_COMMIT"
        else
          TARGET_COMMIT="${{ github.sha }}"
          echo "ğŸ¯ ä½¿ç”¨ç•¶å‰ commit: $TARGET_COMMIT"
        fi
        
        # ç²å– commit ä¿¡æ¯
        COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s" $TARGET_COMMIT)
        COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an" $TARGET_COMMIT)
        
        echo "ğŸ“ Commit è¨Šæ¯: $COMMIT_MESSAGE"
        echo "ğŸ‘¤ ä½œè€…: $COMMIT_AUTHOR"
        
        # æª¢æŸ¥ ptero åˆ†æ”¯æ˜¯å¦å­˜åœ¨
        if git show-ref --quiet refs/remotes/origin/ptero; then
          echo "âœ… Ptero åˆ†æ”¯å·²å­˜åœ¨"
          
          # æª¢æŸ¥æ˜¯å¦æœ‰æ–°çš„è®Šæ›´
          if git diff --quiet origin/ptero...$TARGET_COMMIT; then
            echo "âš ï¸ æ²’æœ‰æ–°çš„è®Šæ›´éœ€è¦éƒ¨ç½²"
            if [[ "${{ github.event.inputs.force_deploy }}" == "true" ]]; then
              echo "ğŸ”„ å¼·åˆ¶éƒ¨ç½²æ¨¡å¼ï¼Œç¹¼çºŒåŸ·è¡Œ"
              SHOULD_DEPLOY="true"
            else
              echo "â­ï¸ è·³ééƒ¨ç½²"
              SHOULD_DEPLOY="false"
            fi
          else
            echo "ğŸ†• æª¢æ¸¬åˆ°æ–°è®Šæ›´ï¼Œæº–å‚™éƒ¨ç½²"
            SHOULD_DEPLOY="true"
            
            # é¡¯ç¤ºè®Šæ›´æ‘˜è¦
            echo "ğŸ“Š è®Šæ›´æ‘˜è¦:"
            git diff --stat origin/ptero...$TARGET_COMMIT
          fi
        else
          echo "ğŸ†• Ptero åˆ†æ”¯ä¸å­˜åœ¨ï¼Œå°‡å»ºç«‹æ–°åˆ†æ”¯"
          SHOULD_DEPLOY="true"
        fi
        
        # æª¢æŸ¥æ˜¯å¦ç‚ºç·Šæ€¥ä¿®å¾©
        if [[ "$COMMIT_MESSAGE" == *"hotfix"* ]] || [[ "$COMMIT_MESSAGE" == *"urgent"* ]] || [[ "$COMMIT_MESSAGE" == *"emergency"* ]]; then
          echo "ğŸš¨ æª¢æ¸¬åˆ°ç·Šæ€¥ä¿®å¾©ï¼Œå„ªå…ˆéƒ¨ç½²"
          SHOULD_DEPLOY="true"
        fi
        
        echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
        echo "commit_sha=$TARGET_COMMIT" >> $GITHUB_OUTPUT
        echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT

  production-compliance:
    name: ğŸ›¡ï¸ ç”Ÿç”¢åˆè¦æª¢æŸ¥
    runs-on: ubuntu-latest
    needs: pre-deploy-check
    if: needs.pre-deploy-check.outputs.should_deploy == 'true' && github.event.inputs.force_deploy != 'true'
    timeout-minutes: 3
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.pre-deploy-check.outputs.commit_sha }}
    
    - name: ğŸ›¡ï¸ åŸ·è¡Œç”Ÿç”¢æª”æ¡ˆåˆè¦æª¢æŸ¥
      run: |
        echo "ğŸ” åŸ·è¡Œç”Ÿç”¢æª”æ¡ˆåˆè¦æª¢æŸ¥..."
        chmod +x .github/scripts/production-compliance-check.sh
        .github/scripts/production-compliance-check.sh
        
        echo "âœ… ç”Ÿç”¢åˆè¦æª¢æŸ¥é€šé"

  deploy-to-ptero:
    name: ğŸš€ éƒ¨ç½²åˆ° Ptero
    runs-on: ubuntu-latest
    needs: [pre-deploy-check, production-compliance]
    if: always() && needs.pre-deploy-check.outputs.should_deploy == 'true' && (needs.production-compliance.result == 'success' || needs.production-compliance.result == 'skipped')
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: ${{ needs.pre-deploy-check.outputs.commit_sha }}
    
    - name: âš™ï¸ é…ç½® Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git config --local push.default simple
    
    - name: ğŸŒ¿ æº–å‚™ Ptero åˆ†æ”¯
      run: |
        echo "ğŸŒ¿ æº–å‚™ ptero åˆ†æ”¯..."
        
        # æª¢æŸ¥é ç¨‹ ptero åˆ†æ”¯æ˜¯å¦å­˜åœ¨
        if git ls-remote --exit-code --heads origin ptero; then
          echo "âœ… é ç¨‹ ptero åˆ†æ”¯å­˜åœ¨ï¼Œæª¢å‡ºåˆ†æ”¯"
          git fetch origin ptero:ptero
          git checkout ptero
        else
          echo "ğŸ†• å»ºç«‹æ–°çš„ ptero åˆ†æ”¯"
          git checkout -b ptero
        fi
        
        # é¡¯ç¤ºç•¶å‰åˆ†æ”¯ç‹€æ…‹
        echo "ğŸ“Š ç•¶å‰åˆ†æ”¯: $(git branch --show-current)"
        echo "ğŸ“Š æœ€æ–° commit: $(git log -1 --oneline)"
    
    - name: ğŸ”„ åŒæ­¥ Main åˆ° Ptero
      run: |
        echo "ğŸ”„ åŒæ­¥ main åˆ†æ”¯å…§å®¹åˆ° ptero..."
        
        # ç¢ºä¿æˆ‘å€‘åœ¨ ptero åˆ†æ”¯ä¸Š
        git checkout ptero
        
        # åˆä½µ main åˆ†æ”¯çš„è®Šæ›´
        MAIN_COMMIT="${{ needs.pre-deploy-check.outputs.commit_sha }}"
        echo "ğŸ“¥ åˆä½µ commit: $MAIN_COMMIT"
        
        # åŸ·è¡Œåˆä½µ (ç­–ç•¥ï¼šæ¥å— main åˆ†æ”¯çš„æ‰€æœ‰è®Šæ›´)
        if git merge $MAIN_COMMIT --strategy-option=theirs --no-edit; then
          echo "âœ… åˆä½µæˆåŠŸ"
        else
          echo "âš ï¸ åˆä½µæ™‚ç™¼ç”Ÿè¡çªï¼Œä½¿ç”¨ theirs ç­–ç•¥è§£æ±º"
          git merge --strategy-option=theirs --no-edit $MAIN_COMMIT
        fi
        
        # æ›´æ–° commit è¨Šæ¯  
        DEPLOY_MESSAGE="ğŸš€ Deploy: ${{ needs.pre-deploy-check.outputs.commit_message }}\n\nğŸ“… éƒ¨ç½²æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')\nğŸ¯ ä¾†æº commit: $MAIN_COMMIT\nğŸŒ¿ ç›®æ¨™åˆ†æ”¯: ptero\n\nğŸ¤– è‡ªå‹•éƒ¨ç½² by GitHub Actions"
        
        git commit --amend -m "$DEPLOY_MESSAGE" || echo "ç„¡éœ€ä¿®æ”¹ commit"
    
    - name: ğŸš€ æ¨é€åˆ° Ptero
      run: |
        echo "ğŸš€ æ¨é€è®Šæ›´åˆ° ptero åˆ†æ”¯..."
        
        # æ¨é€åˆ°é ç¨‹ ptero åˆ†æ”¯
        git push origin ptero
        
        echo "âœ… æˆåŠŸæ¨é€åˆ° ptero åˆ†æ”¯"
        
        # é¡¯ç¤ºéƒ¨ç½²çµæœ
        echo "ğŸ“Š éƒ¨ç½²çµæœ:"
        echo "  ğŸŒ¿ ç›®æ¨™åˆ†æ”¯: ptero"
        echo "  ğŸ“ Commit SHA: $(git rev-parse HEAD)"
        echo "  ğŸ“… éƒ¨ç½²æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
    
    - name: ğŸ¯ å‰µå»ºéƒ¨ç½²æ¨™ç±¤
      if: github.event_name == 'push'
      run: |
        echo "ğŸ·ï¸ å‰µå»ºéƒ¨ç½²æ¨™ç±¤..."
        
        # å‰µå»ºéƒ¨ç½²æ¨™ç±¤
        DEPLOY_TAG="deploy-$(date -u '+%Y%m%d-%H%M%S')"
        COMMIT_SHA=$(git rev-parse HEAD)
        
        git tag -a "$DEPLOY_TAG" -m "ğŸš€ Production deployment\n\nğŸ“… éƒ¨ç½²æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')\nğŸ¯ ä¾†æº: main branch\nğŸŒ¿ éƒ¨ç½²åˆ°: ptero branch\nğŸ“ Commit: $COMMIT_SHA\n\nğŸ¤– è‡ªå‹•å‰µå»º by GitHub Actions"
        
        # æ¨é€æ¨™ç±¤
        git push origin "$DEPLOY_TAG"
        
        echo "âœ… å‰µå»ºéƒ¨ç½²æ¨™ç±¤: $DEPLOY_TAG"

  post-deploy-notification:
    name: ğŸ“¢ éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [pre-deploy-check, production-compliance, deploy-to-ptero]
    if: always() && needs.pre-deploy-check.outputs.should_deploy == 'true'
    timeout-minutes: 2
    
    steps:
    - name: ğŸ“Š ç”Ÿæˆéƒ¨ç½²å ±å‘Š
      run: |
        echo "ğŸ“Š éƒ¨ç½²åŸ·è¡Œå ±å‘Š"
        echo "=========================="
        echo "ğŸ¯ ç›®æ¨™åˆ†æ”¯: ptero"
        echo "ğŸ“ Commit: ${{ needs.pre-deploy-check.outputs.commit_sha }}"
        echo "ğŸ’¬ è¨Šæ¯: ${{ needs.pre-deploy-check.outputs.commit_message }}"
        echo "â° éƒ¨ç½²æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        
        # æª¢æŸ¥å„éšæ®µçµæœ
        echo "ğŸ“‹ åŸ·è¡Œçµæœ:"
        
        if [[ "${{ needs.production-compliance.result }}" == "success" ]]; then
          echo "  ğŸ›¡ï¸ ç”Ÿç”¢åˆè¦æª¢æŸ¥: âœ… é€šé"
        elif [[ "${{ needs.production-compliance.result }}" == "skipped" ]]; then
          echo "  ğŸ›¡ï¸ ç”Ÿç”¢åˆè¦æª¢æŸ¥: â­ï¸ è·³é (å¼·åˆ¶éƒ¨ç½²)"
        else
          echo "  ğŸ›¡ï¸ ç”Ÿç”¢åˆè¦æª¢æŸ¥: âŒ å¤±æ•—"
        fi
        
        if [[ "${{ needs.deploy-to-ptero.result }}" == "success" ]]; then
          echo "  ğŸš€ éƒ¨ç½²åŸ·è¡Œ: âœ… æˆåŠŸ"
          echo ""
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼Ptero åˆ†æ”¯å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬"
          echo "ğŸ”— æª¢æŸ¥éƒ¨ç½²: https://github.com/${{ github.repository }}/tree/ptero"
        else
          echo "  ğŸš€ éƒ¨ç½²åŸ·è¡Œ: âŒ å¤±æ•—"
          echo ""
          echo "âŒ éƒ¨ç½²å¤±æ•—ï¼è«‹æª¢æŸ¥åŸ·è¡Œæ—¥èªŒä¸¦æ‰‹å‹•è™•ç†"
          echo "ğŸ’¡ å»ºè­°æª¢æŸ¥:"
          echo "  1. åˆ†æ”¯è¡çªå•é¡Œ"
          echo "  2. æ¬Šé™é…ç½®"
          echo "  3. ç”Ÿç”¢åˆè¦æª¢æŸ¥çµæœ"
        fi
        
        echo ""
        echo "ğŸ“ˆ éƒ¨ç½²çµ±è¨ˆ:"
        echo "  ğŸ”„ è‡ªå‹•éƒ¨ç½²æ¬¡æ•¸: ${{ github.run_number }}"
        echo "  âš¡ å·¥ä½œæµç¨‹ ID: ${{ github.run_id }}"