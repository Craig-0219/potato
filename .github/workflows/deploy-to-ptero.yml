name: ðŸš€ Deploy to Ptero Branch

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'å¼·åˆ¶éƒ¨ç½²åˆ° ptero åˆ†æ”¯'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.10'
  TARGET_BRANCH: 'ptero'

jobs:
  # ==========================================
  # éšŽæ®µ 1: éƒ¨ç½²å‰é©—è­‰
  # ==========================================
  pre-deployment-validation:
    name: ðŸ” Pre-deployment Validation
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.decision.outputs.should_deploy }}
      commit_sha: ${{ steps.info.outputs.commit_sha }}

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: ðŸ“Š æ”¶é›†éƒ¨ç½²è³‡è¨Š
        id: info
        run: |
          echo "commit_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "commit_message=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT
          echo "author=${{ github.actor }}" >> $GITHUB_OUTPUT
          
          echo "ðŸ” éƒ¨ç½²è³‡è¨Šï¼š"
          echo "  Commit: ${{ github.sha }}"
          echo "  ä½œè€…: ${{ github.actor }}"
          echo "  åˆ†æ”¯: main â†’ ptero"

      - name: ðŸŽ¯ éƒ¨ç½²æ±ºç­–
        id: decision
        run: |
          should_deploy="true"
          
          # æ‰‹å‹•è§¸ç™¼ç¸½æ˜¯éƒ¨ç½²
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "æ‰‹å‹•è§¸ç™¼éƒ¨ç½²"
            should_deploy="true"
          fi
          
          # æª¢æŸ¥æ˜¯å¦ç‚ºåˆä½µæäº¤
          if git log -1 --pretty=%B | grep -i "merge\|åˆä½µ" > /dev/null; then
            echo "åµæ¸¬åˆ°åˆä½µæäº¤ï¼ŒåŸ·è¡Œéƒ¨ç½²"
            should_deploy="true"
          fi
          
          echo "should_deploy=$should_deploy" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ éƒ¨ç½²æ±ºç­–: $should_deploy"

  # ==========================================
  # éšŽæ®µ 2: å¿«é€Ÿå“è³ªæª¢æŸ¥
  # ==========================================
  quality-check:
    name: âš¡ Quick Quality Check
    runs-on: ubuntu-latest
    needs: pre-deployment-validation
    if: needs.pre-deployment-validation.outputs.should_deploy == 'true'

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ” èªžæ³•æª¢æŸ¥
        run: |
          echo "ðŸ” åŸ·è¡Œ Python èªžæ³•æª¢æŸ¥..."
          python -m py_compile bot/main.py
          python -c "
          import os
          import py_compile
          
          for root, dirs, files in os.walk('.'):
              if '.git' in root:
                  continue
              for file in files:
                  if file.endswith('.py'):
                      filepath = os.path.join(root, file)
                      try:
                          py_compile.compile(filepath, doraise=True)
                      except Exception as e:
                          print(f'èªžæ³•éŒ¯èª¤: {filepath}: {e}')
                          exit(1)
          print('âœ… æ‰€æœ‰ Python æª”æ¡ˆèªžæ³•æª¢æŸ¥é€šéŽ')
          "

      - name: ðŸ“ æª¢æŸ¥å¿…è¦æª”æ¡ˆ
        run: |
          echo "ðŸ“ æª¢æŸ¥éƒ¨ç½²å¿…è¦æª”æ¡ˆ..."
          
          required_files=("bot/main.py" "requirements.txt" ".env.example" "start.py")
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ ç¼ºå°‘å¿…è¦æª”æ¡ˆ: $file"
              exit 1
            else
              echo "âœ… $file"
            fi
          done
          
          echo "âœ… æ‰€æœ‰å¿…è¦æª”æ¡ˆå­˜åœ¨"

  # ==========================================
  # éšŽæ®µ 3: éƒ¨ç½²åˆ° ptero åˆ†æ”¯
  # ==========================================
  deploy-to-ptero:
    name: ðŸš€ Deploy to Ptero Branch
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, quality-check]
    if: needs.pre-deployment-validation.outputs.should_deploy == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ é…ç½® Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ðŸŒ¿ æº–å‚™ ptero åˆ†æ”¯
        run: |
          echo "ðŸŒ¿ æº–å‚™ ptero åˆ†æ”¯..."
          
          # æª¢æŸ¥ ptero åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git show-ref --verify --quiet refs/remotes/origin/ptero; then
            echo "ptero åˆ†æ”¯å·²å­˜åœ¨ï¼Œåˆ‡æ›ä¸¦æ›´æ–°"
            git checkout ptero
            git pull origin ptero || echo "ptero åˆ†æ”¯æ‹‰å–å¤±æ•—ï¼Œç¹¼çºŒåŸ·è¡Œ"
          else
            echo "å»ºç«‹æ–°çš„ ptero åˆ†æ”¯"
            git checkout -b ptero
          fi
          
          echo "âœ… ptero åˆ†æ”¯æº–å‚™å®Œæˆ"

      - name: ðŸ”„ åŒæ­¥ main å…§å®¹åˆ° ptero
        run: |
          echo "ðŸ”„ åŒæ­¥ main åˆ†æ”¯å…§å®¹..."
          
          # åˆ‡æ›åˆ° main åˆ†æ”¯ç²å–æœ€æ–°å…§å®¹
          git checkout main
          git pull origin main
          
          # åˆ‡å›ž ptero ä¸¦åˆä½µ main çš„è®Šæ›´
          git checkout ptero
          
          # ä½¿ç”¨ merge ç­–ç•¥åŒæ­¥å…§å®¹
          if git merge main --no-edit; then
            echo "âœ… æˆåŠŸåˆä½µ main åˆ†æ”¯åˆ° ptero"
          else
            echo "âŒ åˆä½µè¡çªï¼Œå˜—è©¦è¦†è“‹ç­–ç•¥..."
            git merge --abort
            
            # ä½¿ç”¨å¼·åˆ¶è¦†è“‹ç­–ç•¥
            git reset --hard main
            echo "âœ… ä½¿ç”¨è¦†è“‹ç­–ç•¥åŒæ­¥å®Œæˆ"
          fi

      - name: ðŸŽ¯ å„ªåŒ– ptero åˆ†æ”¯å…§å®¹
        run: |
          echo "ðŸŽ¯ å„ªåŒ– ptero åˆ†æ”¯å…§å®¹..."
          
          # ç¢ºä¿åªåŒ…å«ç”Ÿç”¢å¿…éœ€æª”æ¡ˆ
          if [ -f "pyproject.toml" ]; then
            echo "ä¿ç•™ pyproject.toml"
          fi
          
          # å»ºç«‹éƒ¨ç½²è³‡è¨Šæª”æ¡ˆ
          cat > DEPLOYMENT_INFO.md << EOF
          # ðŸš€ Ptero éƒ¨ç½²è³‡è¨Š
          
          **éƒ¨ç½²æ™‚é–“**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **æºåˆ†æ”¯**: main
          **Commit**: ${{ needs.pre-deployment-validation.outputs.commit_sha }}
          **éƒ¨ç½²è€…**: ${{ github.actor }}
          **è§¸ç™¼äº‹ä»¶**: ${{ github.event_name }}
          
          ---
          
          æ­¤åˆ†æ”¯å°ˆç‚º Pterodactyl è¨—ç®¡ç’°å¢ƒå„ªåŒ–ï¼ŒåŒ…å«ç´”æ·¨çš„ç”Ÿç”¢ä»£ç¢¼ã€‚
          EOF
          
          echo "âœ… ptero åˆ†æ”¯å„ªåŒ–å®Œæˆ"

      - name: ðŸ“¤ æŽ¨é€åˆ° ptero åˆ†æ”¯
        run: |
          echo "ðŸ“¤ æŽ¨é€åˆ° ptero åˆ†æ”¯..."
          
          # æ·»åŠ æ‰€æœ‰è®Šæ›´
          git add -A
          
          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
          else
            git commit -m "ðŸš€ è‡ªå‹•éƒ¨ç½²å¾ž main åˆ†æ”¯

            æº Commit: ${{ needs.pre-deployment-validation.outputs.commit_sha }}
            éƒ¨ç½²æ™‚é–“: $(date -u +%Y-%m-%dT%H:%M:%SZ)
            éƒ¨ç½²è€…: ${{ github.actor }}
            
            ðŸ¤– è‡ªå‹•éƒ¨ç½²ç³»çµ±"
          fi
          
          # æŽ¨é€åˆ°é ç¨‹ ptero åˆ†æ”¯
          git push origin ptero
          
          echo "âœ… æˆåŠŸæŽ¨é€åˆ° ptero åˆ†æ”¯"

  # ==========================================
  # éšŽæ®µ 4: éƒ¨ç½²å¾Œé©—è­‰å’Œé€šçŸ¥
  # ==========================================
  post-deployment:
    name: ðŸ“¢ Post-deployment Notification
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, deploy-to-ptero]
    if: always() && needs.pre-deployment-validation.outputs.should_deploy == 'true'

    steps:
      - name: ðŸ“Š éƒ¨ç½²ç‹€æ…‹ç¸½çµ
        run: |
          echo "ðŸ“Š Ptero éƒ¨ç½²ç‹€æ…‹ç¸½çµ"
          echo "===================="
          echo "ðŸŽ¯ ç›®æ¨™åˆ†æ”¯: ptero"
          echo "ðŸ”— æº Commit: ${{ needs.pre-deployment-validation.outputs.commit_sha }}"
          echo "ðŸ‘¤ éƒ¨ç½²è€…: ${{ github.actor }}"
          echo "ðŸ“… éƒ¨ç½²æ™‚é–“: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "ðŸš€ è§¸ç™¼æ–¹å¼: ${{ github.event_name }}"
          
          if [ "${{ needs.deploy-to-ptero.result }}" = "success" ]; then
            echo "âœ… ç‹€æ…‹: éƒ¨ç½²æˆåŠŸ"
            echo "ðŸŽ‰ main åˆ†æ”¯å·²æˆåŠŸéƒ¨ç½²åˆ° ptero åˆ†æ”¯ï¼"
            echo "ðŸŒ è¨—ç®¡ç’°å¢ƒæ‡‰è©²æœƒè‡ªå‹•æ›´æ–°"
          else
            echo "âŒ ç‹€æ…‹: éƒ¨ç½²å¤±æ•—"
            echo "ðŸ’¥ éƒ¨ç½²éŽç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ"
          fi

      - name: ðŸ“ˆ æ›´æ–°éƒ¨ç½²çµ±è¨ˆ
        if: needs.deploy-to-ptero.result == 'success'
        run: |
          echo "ðŸ“ˆ æ›´æ–°éƒ¨ç½²çµ±è¨ˆ..."
          echo "  ðŸ“Š æˆåŠŸéƒ¨ç½²åˆ° ptero: +1"
          echo "  â±ï¸ éƒ¨ç½² ID: ${{ github.run_id }}"
          echo "  ðŸ“… æœ€å¾ŒæˆåŠŸéƒ¨ç½²: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "âœ… çµ±è¨ˆå·²æ›´æ–°"