# .github/workflows/ci.yml
# GitHub Actions CI/CD å·¥ä½œæµç¨‹

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.10'

jobs:
  # ä»£ç¢¼å“è³ªæª¢æŸ¥
  quality:
    runs-on: ubuntu-latest
    name: Code Quality
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Code formatting check
      run: |
        black --check bot/ shared/ tests/
        isort --check-only bot/ shared/ tests/
    
    - name: Lint check
      run: |
        flake8 bot/ shared/ tests/
        mypy bot/ shared/
    
    - name: Security check
      run: |
        bandit -r bot/ shared/ -f json -o bandit-report.json
    
    - name: Upload security report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: bandit-security-report
        path: bandit-report.json

  # æ¸¬è©¦
  test:
    runs-on: ubuntu-latest
    name: Tests
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_DATABASE: test_potato_bot
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
          MYSQL_ROOT_PASSWORD: root_password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[test]"
    
    - name: Set up test environment
      run: |
        echo "TESTING=true" >> $GITHUB_ENV
        echo "DB_HOST=127.0.0.1" >> $GITHUB_ENV
        echo "DB_PORT=3306" >> $GITHUB_ENV
        echo "DB_USER=test_user" >> $GITHUB_ENV
        echo "DB_PASSWORD=test_password" >> $GITHUB_ENV
        echo "DB_NAME=test_potato_bot" >> $GITHUB_ENV
        echo "DISCORD_TOKEN=test_token_$(openssl rand -hex 25)" >> $GITHUB_ENV
        echo "JWT_SECRET=test_jwt_secret_key_for_ci_only" >> $GITHUB_ENV
        echo "REDIS_URL=redis://127.0.0.1:6379/0" >> $GITHUB_ENV
    
    - name: Run tests
      run: |
        python -m pytest tests/ -v --cov=bot --cov-report=xml --cov-report=term-missing --cov-fail-under=70
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      if: success()
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  # æ§‹å»ºæª¢æŸ¥
  build:
    runs-on: ubuntu-latest
    name: Build Check
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Test installation
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Test imports
      run: |
        python -c "from bot.main import PotatoBot"
        python -c "from bot.api.app import app"
        python -c "from shared.config import validate_config_enhanced"

  # Docker æ§‹å»ºæ¸¬è©¦
  docker:
    runs-on: ubuntu-latest
    name: Docker Build
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      run: |
        docker build -t potato-bot:test .
    
    - name: Test Docker image
      run: |
        docker run --rm potato-bot:test python -c "print('Docker build successful')"

  # æŠ€è¡“å‚µå‹™æª¢æŸ¥
  technical-debt:
    runs-on: ubuntu-latest
    name: Technical Debt Analysis
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install analysis tools
      run: |
        pip install radon complexity-report
    
    - name: Check code complexity
      run: |
        radon cc bot/ -a -s
        radon mi bot/ -s
    
    - name: Generate technical debt report
      run: |
        echo "## Technical Debt Report" > tech-debt-report.md
        echo "### Code Complexity" >> tech-debt-report.md
        radon cc bot/ -a -s >> tech-debt-report.md
        echo "### Maintainability Index" >> tech-debt-report.md
        radon mi bot/ -s >> tech-debt-report.md
    
    - name: Upload technical debt report
      uses: actions/upload-artifact@v3
      with:
        name: technical-debt-report
        path: tech-debt-report.md

  # æ•´åˆæª¢æŸ¥ï¼ˆæ‰€æœ‰ job å®Œæˆå¾Œï¼‰
  integration:
    runs-on: ubuntu-latest
    name: Integration Check
    needs: [quality, test, build, docker, technical-debt]
    
    steps:
    - name: All checks passed
      run: |
        echo "ğŸ‰ All CI checks passed successfully!"
        echo "âœ… Code quality check passed"
        echo "âœ… Tests passed"
        echo "âœ… Build check passed"
        echo "âœ… Docker build passed"
        echo "âœ… Technical debt analysis completed"

  # è‡ªå‹•éƒ¨ç½² (åƒ…åœ¨ main åˆ†æ”¯)
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    needs: integration
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deployment placeholder
      run: |
        echo "ğŸš€ Ready for deployment!"
        echo "This step would trigger actual deployment in production"
        echo "Current deployment targets:"
        echo "- Production Discord Bot"
        echo "- API Server"
        echo "- Web Interface"

  # ç™¼å¸ƒè™•ç† (åƒ…åœ¨æ¨™ç±¤æ¨é€æ™‚)
  release:
    runs-on: ubuntu-latest
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## Changes
          - æŠ€è¡“å‚µå‹™è™•ç†å®Œæˆ
          - ä»£ç¢¼å“è³ªå·¥å…·æ•´åˆ
          - æ¸¬è©¦æ¡†æ¶å»ºç«‹
          - å®‰å…¨æ€§å¼·åŒ–
        draft: false
        prerelease: false