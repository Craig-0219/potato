name: ğŸ§  Intelligent Auto-Merge with Bot Verification

on:
  push:
    branches: [dev]
  pull_request:
    branches: [main]
    types: [closed]
  workflow_dispatch:
    inputs:
      force_merge:
        description: 'å¼·åˆ¶åˆä½µ (è·³éæŸäº›æª¢æŸ¥)'
        required: false
        default: false
        type: boolean
      test_level:
        description: 'æ¸¬è©¦ç´šåˆ¥'
        required: true
        default: 'full'
        type: choice
        options:
        - minimal
        - standard
        - full
        - extensive

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

jobs:
  # ================================
  # éšæ®µ 1: æ™ºèƒ½åˆ†æèˆ‡é æª¢æŸ¥
  # ================================
  intelligent-analysis:
    name: ğŸ” æ™ºèƒ½åˆ†æèˆ‡é¢¨éšªè©•ä¼°
    runs-on: ubuntu-latest
    outputs:
      should_proceed: ${{ steps.analysis.outputs.should_proceed }}
      risk_level: ${{ steps.analysis.outputs.risk_level }}
      test_strategy: ${{ steps.analysis.outputs.test_strategy }}
      changed_components: ${{ steps.analysis.outputs.changed_components }}
      merge_confidence: ${{ steps.analysis.outputs.merge_confidence }}

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 100
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ§  Intelligent Change Analysis
      id: analysis
      run: |
        echo "ğŸ” åŸ·è¡Œæ™ºèƒ½è®Šæ›´åˆ†æ..."

        # ç²å–è®Šæ›´æ–‡ä»¶åˆ—è¡¨
        if [ "${{ github.event_name }}" = "push" ]; then
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          BASE_COMMIT="HEAD~1"
        else
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          BASE_COMMIT="origin/main"
        fi

        echo "Changed files:"
        echo "$CHANGED_FILES" | tee changed_files.txt

        # åˆ†æè®Šæ›´é¡å‹å’Œé¢¨éšªç­‰ç´š
        RISK_SCORE=0
        COMPONENTS=""

        # é«˜é¢¨éšªè®Šæ›´æª¢æ¸¬
        if echo "$CHANGED_FILES" | grep -q "bot/main.py\|bot/db/database_manager.py\|shared/config.py"; then
          RISK_SCORE=$((RISK_SCORE + 30))
          COMPONENTS="$COMPONENTS,core"
          echo "âš ï¸ æª¢æ¸¬åˆ°æ ¸å¿ƒæ–‡ä»¶è®Šæ›´"
        fi

        # ä¸­é¢¨éšªè®Šæ›´æª¢æ¸¬
        if echo "$CHANGED_FILES" | grep -q "bot/cogs/.*\.py"; then
          RISK_SCORE=$((RISK_SCORE + 10))
          COMPONENTS="$COMPONENTS,cogs"
          echo "ğŸ“ æª¢æ¸¬åˆ° Cogs è®Šæ›´"
        fi

        if echo "$CHANGED_FILES" | grep -q "bot/services/.*\.py"; then
          RISK_SCORE=$((RISK_SCORE + 15))
          COMPONENTS="$COMPONENTS,services"
          echo "âš™ï¸ æª¢æ¸¬åˆ°æœå‹™å±¤è®Šæ›´"
        fi

        if echo "$CHANGED_FILES" | grep -q "bot/db/.*\.py\|shared/.*\.py"; then
          RISK_SCORE=$((RISK_SCORE + 20))
          COMPONENTS="$COMPONENTS,database"
          echo "ğŸ’¾ æª¢æ¸¬åˆ°è³‡æ–™åº«ç›¸é—œè®Šæ›´"
        fi

        # ä½é¢¨éšªè®Šæ›´æª¢æ¸¬
        if echo "$CHANGED_FILES" | grep -q "docs/\|README.md\|CHANGELOG.md"; then
          RISK_SCORE=$((RISK_SCORE + 2))
          COMPONENTS="$COMPONENTS,docs"
          echo "ğŸ“š æª¢æ¸¬åˆ°æ–‡æª”è®Šæ›´"
        fi

        # Web UI è®Šæ›´
        if echo "$CHANGED_FILES" | grep -q "web-ui/"; then
          RISK_SCORE=$((RISK_SCORE + 8))
          COMPONENTS="$COMPONENTS,webui"
          echo "ğŸŒ æª¢æ¸¬åˆ° Web UI è®Šæ›´"
        fi

        # è¨­å®šé¢¨éšªç­‰ç´š
        if [ $RISK_SCORE -le 10 ]; then
          RISK_LEVEL="low"
          TEST_STRATEGY="minimal"
          CONFIDENCE=95
        elif [ $RISK_SCORE -le 25 ]; then
          RISK_LEVEL="medium"
          TEST_STRATEGY="standard"
          CONFIDENCE=80
        elif [ $RISK_SCORE -le 50 ]; then
          RISK_LEVEL="high"
          TEST_STRATEGY="full"
          CONFIDENCE=60
        else
          RISK_LEVEL="critical"
          TEST_STRATEGY="extensive"
          CONFIDENCE=30
        fi

        # æª¢æŸ¥æäº¤è¨Šæ¯é—œéµå­—
        COMMIT_MSG=$(git log -1 --pretty=%B)
        if echo "$COMMIT_MSG" | grep -qi "fix\|hotfix\|critical"; then
          RISK_SCORE=$((RISK_SCORE + 10))
          echo "ğŸš¨ æª¢æ¸¬åˆ°ç·Šæ€¥ä¿®å¾©æ¨™è¨˜"
        fi

        if echo "$COMMIT_MSG" | grep -qi "\[no-merge\]\|\[skip-merge\]"; then
          echo "ğŸš« æäº¤æ¨™è¨˜ç‚ºè·³éåˆä½µ"
          echo "should_proceed=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        # æ±ºå®šæ˜¯å¦ç¹¼çºŒ
        SHOULD_PROCEED="true"
        if [ $RISK_SCORE -gt 60 ] && [ "${{ inputs.force_merge }}" != "true" ]; then
          echo "âš ï¸ é¢¨éšªè©•åˆ†éé«˜ ($RISK_SCORE)ï¼Œå»ºè­°äººå·¥å¯©æŸ¥"
          SHOULD_PROCEED="false"
        fi

        # è¼¸å‡ºçµæœ
        echo "ğŸ“Š æ™ºèƒ½åˆ†æçµæœ:"
        echo "   é¢¨éšªç­‰ç´š: $RISK_LEVEL"
        echo "   é¢¨éšªè©•åˆ†: $RISK_SCORE/100"
        echo "   æ¸¬è©¦ç­–ç•¥: $TEST_STRATEGY"
        echo "   åˆä½µä¿¡å¿ƒ: $CONFIDENCE%"
        echo "   è®Šæ›´çµ„ä»¶: $COMPONENTS"

        echo "should_proceed=$SHOULD_PROCEED" >> $GITHUB_OUTPUT
        echo "risk_level=$RISK_LEVEL" >> $GITHUB_OUTPUT
        echo "test_strategy=$TEST_STRATEGY" >> $GITHUB_OUTPUT
        echo "changed_components=$COMPONENTS" >> $GITHUB_OUTPUT
        echo "merge_confidence=$CONFIDENCE" >> $GITHUB_OUTPUT

  # ================================
  # éšæ®µ 2: å¤šå±¤æ¬¡æ¸¬è©¦é©—è­‰
  # ================================
  comprehensive-testing:
    name: ğŸ§ª å¤šå±¤æ¬¡æ¸¬è©¦é©—è­‰
    needs: intelligent-analysis
    if: needs.intelligent-analysis.outputs.should_proceed == 'true'
    runs-on: ubuntu-latest

    # ğŸ¯ æ ¸å¿ƒä¿®å¾©ï¼šè¨­ç½®å®Œæ•´çš„æ¸¬è©¦ç’°å¢ƒè®Šæ•¸ï¼Œè§£æ±º .env å•é¡Œ
    env:
      TESTING: "true"
      DISCORD_TOKEN: "test_token_github_actions_comprehensive_with_sufficient_length_for_validation_requirements_minimum_50_chars"
      DB_HOST: "localhost"
      DB_PORT: "3306"
      DB_USER: "test_user"
      DB_PASSWORD: "test_password"
      DB_NAME: "test_database"
      JWT_SECRET: "test_jwt_secret_for_github_actions_comprehensive"
      DATABASE_URL: "sqlite:///test.db"
      REDIS_URL: "redis://localhost:6379/0"
      ENVIRONMENT: "test"
      DEBUG: "false"
      LOG_LEVEL: "INFO"
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: test_password  # pragma: allowlist secret
          POSTGRES_DB: potato_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-cov black isort mypy bandit safety

    - name: ğŸ¨ Code Quality Checks
      run: |
        echo "ğŸ¨ ä»£ç¢¼æ ¼å¼æª¢æŸ¥..."
        black --check --diff bot/ shared/ || {
          echo "âŒ Black æ ¼å¼æª¢æŸ¥å¤±æ•—"
          exit 1
        }

        echo "ğŸ“¦ Import æ’åºæª¢æŸ¥..."
        isort --check-only --diff bot/ shared/ || {
          echo "âŒ isort æª¢æŸ¥å¤±æ•—"
          exit 1
        }

        echo "ğŸ” é¡å‹æª¢æŸ¥..."
        mypy bot/ --ignore-missing-imports || {
          echo "âš ï¸ MyPy ç™¼ç¾é¡å‹å•é¡Œï¼Œä½†ç¹¼çºŒåŸ·è¡Œ"
        }

    - name: ğŸ›¡ï¸ Security Scanning
      run: |
        echo "ğŸ”’ å®‰å…¨æ¼æ´æƒæ..."
        safety check || {
          echo "âš ï¸ ç™¼ç¾å®‰å…¨å•é¡Œï¼Œè«‹æª¢æŸ¥"
        }

        echo "ğŸ” Bandit å®‰å…¨æƒæ..."
        bandit -r bot/ -f json -o bandit-report.json || {
          echo "âš ï¸ Bandit ç™¼ç¾æ½›åœ¨å®‰å…¨å•é¡Œ"
        }

    - name: âœ… Syntax Validation
      run: |
        echo "ğŸ” Python èªæ³•é©—è­‰..."
        find bot/ shared/ -name "*.py" -exec python -m py_compile {} \; || {
          echo "âŒ Python èªæ³•æª¢æŸ¥å¤±æ•—"
          exit 1
        }

        echo "âœ… æ‰€æœ‰ Python æ–‡ä»¶èªæ³•æ­£ç¢º"

    - name: ğŸ§ª Module Import Tests
      env:
        TESTING: "true"
      run: |
        echo "ğŸ“¦ æ¨¡çµ„å°å…¥æ¸¬è©¦..."
        cd bot

        # æ¸¬è©¦æ ¸å¿ƒæ¨¡çµ„å°å…¥ï¼ˆåƒ…æª¢æŸ¥èªæ³•ï¼Œä¸åŸ·è¡Œï¼‰
        python -c "
        import sys
        import os
        sys.path.append('..')

        # è¨­ç½®æœ€å°æ¸¬è©¦ç’°å¢ƒè®Šæ•¸ï¼ˆå‹•æ…‹ç”Ÿæˆï¼Œé¿å…ç¡¬ç·¨ç¢¼ï¼‰
        import secrets
        import string

        # ç”Ÿæˆéš¨æ©Ÿæ¸¬è©¦å€¼
        random_suffix = ''.join(secrets.choice(string.ascii_letters + string.digits) for _ in range(8))

        os.environ['TESTING'] = 'true'
        os.environ['DISCORD_TOKEN'] = f'test_token_comprehensive_validation_length_requirement_met_{random_suffix}'
        os.environ['DB_HOST'] = 'mock_host'
        os.environ['DB_USER'] = 'mock_user'
        os.environ['DB_PASSWORD'] = f'mock_pass_{random_suffix}'
        os.environ['DB_NAME'] = 'mock_db'
        os.environ['DB_PORT'] = '3306'
        os.environ['JWT_SECRET'] = f'mock_jwt_{random_suffix}'
        os.environ['REDIS_URL'] = 'redis://mock_redis:6379/0'

        print('ğŸ”’ ä½¿ç”¨å‹•æ…‹ç”Ÿæˆçš„æ¸¬è©¦ç’°å¢ƒè®Šæ•¸ï¼ˆä¸è¨˜éŒ„å¯¦éš›å€¼ï¼‰')

        try:
            # åªæª¢æŸ¥æ¨¡çµ„èªæ³•ï¼Œä¸åŸ·è¡Œä»»ä½•åˆå§‹åŒ–
            import ast
            with open('main.py', 'r', encoding='utf-8') as f:
                ast.parse(f.read())
            print('âœ… main.py èªæ³•æª¢æŸ¥é€šé')
        except SyntaxError as e:
            print(f'âŒ main.py èªæ³•éŒ¯èª¤: {e}')
            sys.exit(1)
        except Exception as e:
            print(f'âš ï¸ main.py æª¢æŸ¥è­¦å‘Š: {e}')

        try:
            # å˜—è©¦èªæ³•ç´šåˆ¥çš„æª¢æŸ¥
            with open('db/database_manager.py', 'r', encoding='utf-8') as f:
                ast.parse(f.read())
            print('âœ… DatabaseManager èªæ³•æª¢æŸ¥é€šé')
        except FileNotFoundError:
            print('âš ï¸ database_manager.py ä¸å­˜åœ¨ï¼Œè·³é')
        except SyntaxError as e:
            print(f'âŒ DatabaseManager èªæ³•éŒ¯èª¤: {e}')
            sys.exit(1)
        except Exception as e:
            print(f'âš ï¸ DatabaseManager æª¢æŸ¥è­¦å‘Š: {e}')

        # æ¸¬è©¦ Cogs èªæ³•æª¢æŸ¥ï¼ˆæ›´å®‰å…¨çš„æ–¹å¼ï¼‰
        import os
        import ast

        cogs_dir = 'cogs'
        failed_cogs = []
        critical_cogs = ['language_manager', 'ticket_listener', 'vote_core']

        if os.path.exists(cogs_dir):
            for filename in os.listdir(cogs_dir):
                if filename.endswith('.py') and not filename.startswith('__'):
                    module_name = filename[:-3]
                    file_path = os.path.join(cogs_dir, filename)

                    try:
                        # åªæª¢æŸ¥èªæ³•ï¼Œä¸åŸ·è¡Œä»£ç¢¼
                        with open(file_path, 'r', encoding='utf-8') as f:
                            ast.parse(f.read())
                        print(f'âœ… Cog {module_name} èªæ³•æª¢æŸ¥é€šé')
                    except SyntaxError as e:
                        print(f'âŒ Cog {module_name} èªæ³•éŒ¯èª¤: {e}')
                        if module_name in critical_cogs:
                            failed_cogs.append(module_name)
                    except Exception as e:
                        print(f'âš ï¸ Cog {module_name} æª¢æŸ¥è­¦å‘Š: {e}')

        if failed_cogs:
            print(f'âŒ é—œéµ Cogs èªæ³•æª¢æŸ¥å¤±æ•—: {failed_cogs}')
            sys.exit(1)

        print('ğŸ‰ æ¨¡çµ„èªæ³•æª¢æŸ¥å®Œæˆï¼')
        " || exit 1

    - name: ğŸ—„ï¸ File Structure Verification
      run: |
        echo "ğŸ—„ï¸ æª”æ¡ˆçµæ§‹é©—è­‰..."

        # æª¢æŸ¥æ ¸å¿ƒæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        CORE_FILES=(
          "bot/main.py"
          "bot/db/database_manager.py"
          "shared/config.py"
          "requirements.txt"
        )

        MISSING_FILES=()

        for file in "${CORE_FILES[@]}"; do
          if [[ -f "$file" ]]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            MISSING_FILES+=("$file")
          fi
        done

        # æª¢æŸ¥ cogs ç›®éŒ„
        if [[ -d "bot/cogs" ]]; then
          COG_COUNT=$(find bot/cogs -name "*.py" | wc -l)
          echo "âœ… bot/cogs ç›®éŒ„å­˜åœ¨ï¼ŒåŒ…å« $COG_COUNT å€‹ Python æª”æ¡ˆ"
        else
          echo "âŒ bot/cogs ç›®éŒ„ä¸å­˜åœ¨"
          MISSING_FILES+=("bot/cogs/")
        fi

        # æª¢æŸ¥ shared ç›®éŒ„
        if [[ -d "shared" ]]; then
          SHARED_COUNT=$(find shared -name "*.py" | wc -l)
          echo "âœ… shared ç›®éŒ„å­˜åœ¨ï¼ŒåŒ…å« $SHARED_COUNT å€‹ Python æª”æ¡ˆ"
        else
          echo "âŒ shared ç›®éŒ„ä¸å­˜åœ¨"
          MISSING_FILES+=("shared/")
        fi

        if [[ ${#MISSING_FILES[@]} -gt 0 ]]; then
          echo "âŒ æª”æ¡ˆçµæ§‹é©—è­‰å¤±æ•—ï¼Œç¼ºå¤±æª”æ¡ˆ: ${MISSING_FILES[*]}"
          exit 1
        else
          echo "ğŸ‰ æª”æ¡ˆçµæ§‹é©—è­‰é€šéï¼"
        fi

    - name: ğŸ§ª Environment and Config Tests
      run: |
        echo "ğŸ§ª ç’°å¢ƒè®Šæ•¸å’Œé…ç½®æ¸¬è©¦..."

        # æ¸¬è©¦ 1: é©—è­‰ç’°å¢ƒè®Šæ•¸è¨­ç½®
        echo "ğŸ“‹ æ¸¬è©¦ 1: ç’°å¢ƒè®Šæ•¸é©—è­‰"
        echo "TESTING: $TESTING"
        echo "DISCORD_TOKEN: ${DISCORD_TOKEN:0:10}..." # åªé¡¯ç¤ºå‰10å­—ç¬¦
        echo "DATABASE_URL: $DATABASE_URL"
        echo "DB_HOST: $DB_HOST"

        # æ¸¬è©¦ 2: Python é…ç½®è¼‰å…¥æ¸¬è©¦
        echo "ğŸ“‹ æ¸¬è©¦ 2: é…ç½®è¼‰å…¥æ¸¬è©¦"
        python -c "
        import sys
        import os
        sys.path.append('.')

        print('ğŸ” æª¢æŸ¥ç’°å¢ƒè®Šæ•¸è¼‰å…¥:')
        print(f'TESTING = {os.environ.get(\"TESTING\", \"æœªè¨­ç½®\")}')
        print(f'DISCORD_TOKEN = {os.environ.get(\"DISCORD_TOKEN\", \"æœªè¨­ç½®\")[:10]}...')
        print(f'DATABASE_URL = {os.environ.get(\"DATABASE_URL\", \"æœªè¨­ç½®\")}')

        try:
            print('ğŸ” å˜—è©¦è¼‰å…¥é…ç½®æ¨¡çµ„...')
            import shared.config

            print('âœ… Config æ¨¡çµ„å°å…¥æˆåŠŸ')

            # æª¢æŸ¥é—œéµé…ç½®è®Šæ•¸
            if hasattr(shared.config, 'DISCORD_TOKEN') and shared.config.DISCORD_TOKEN:
                print(f'âœ… DISCORD_TOKEN é…ç½®: {shared.config.DISCORD_TOKEN[:10]}...')
            else:
                print('âš ï¸ DISCORD_TOKEN é…ç½®å•é¡Œ')

            if hasattr(shared.config, 'DB_HOST') and shared.config.DB_HOST:
                print(f'âœ… DB_HOST é…ç½®: {shared.config.DB_HOST}')
            else:
                print('âš ï¸ DB_HOST é…ç½®å•é¡Œ')

        except Exception as e:
            print(f'âŒ é…ç½®æ¸¬è©¦éŒ¯èª¤: {e}')
            import traceback
            traceback.print_exc()
            sys.exit(1)
        "

        # æ¸¬è©¦ 3: æ ¸å¿ƒæ¨¡çµ„å°å…¥æ¸¬è©¦ (æœ‰ç’°å¢ƒè®Šæ•¸æ”¯æ´)
        echo "ğŸ“‹ æ¸¬è©¦ 3: æ ¸å¿ƒæ¨¡çµ„å°å…¥æ¸¬è©¦"
        python -c "
        import sys
        import os
        sys.path.append('.')
        sys.path.append('bot')

        try:
            print('ğŸ” æ¸¬è©¦ main.py å°å…¥...')
            import main
            print('âœ… main.py å°å…¥æˆåŠŸ')

            print('ğŸ” æ¸¬è©¦ DatabaseManager å°å…¥...')
            from db.database_manager import DatabaseManager
            print('âœ… DatabaseManager å°å…¥æˆåŠŸ')

        except ImportError as e:
            print(f'âš ï¸ å°å…¥è­¦å‘Š: {e}')
            # ä¸é€€å‡ºï¼Œå…è¨±æŸäº›å°å…¥å¤±æ•—
        except Exception as e:
            print(f'âš ï¸ å…¶ä»–è­¦å‘Š: {e}')
            # ä¸é€€å‡ºï¼Œå…è¨±æŸäº›éŒ¯èª¤

        print('ğŸ‰ æ ¸å¿ƒæ¸¬è©¦å®Œæˆï¼')
        "

        echo "ğŸ‰ ç’°å¢ƒè®Šæ•¸å’Œé…ç½®æ¸¬è©¦å®Œæˆï¼"

  # ================================
  # éšæ®µ 3: Discord Bot å•Ÿå‹•æ¸¬è©¦
  # ================================
  bot-verification:
    name: ğŸ¤– Discord Bot å•Ÿå‹•é©—è­‰
    needs: [intelligent-analysis, comprehensive-testing]
    if: needs.intelligent-analysis.outputs.should_proceed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: test_password  # pragma: allowlist secret
          POSTGRES_DB: potato_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ”§ Setup Test Environment
      run: |
        # å‰µå»ºæ¸¬è©¦ç”¨çš„ .env æ–‡ä»¶
        cat > .env << 'EOF'
        # æ¸¬è©¦ç’°å¢ƒé…ç½®
        DISCORD_TOKEN=test_token_for_ci_cd_with_sufficient_length_for_validation_requirements_minimum_50_characters
        DATABASE_URL=postgresql://postgres:test_password@localhost:5432/potato_test  # pragma: allowlist secret
        REDIS_URL=redis://localhost:6379/0
        ENVIRONMENT=test
        SYNC_COMMANDS=false
        API_EXTERNAL_ACCESS=false
        DEBUG=true
        EOF

        # å‰µå»ºå¿…è¦çš„ç›®éŒ„
        mkdir -p logs transcripts

    - name: ğŸ¤– Bot Startup Test
      run: |
        echo "ğŸš€ Discord Bot å•Ÿå‹•æ¸¬è©¦..."

        # å‰µå»ºæ¸¬è©¦è…³æœ¬
        cat > test_bot_startup.py << 'EOF'
        import asyncio
        import sys
        import os
        import signal
        from unittest.mock import patch, MagicMock

        # æ¨¡æ“¬ Discord Token é©—è­‰
        class MockBot:
            def __init__(self):
                self.cogs_loaded = 0
                self.is_closed = False
                self.user = MagicMock()
                self.user.id = 123456789

            async def login(self, token):
                print("ğŸ”‘ æ¨¡æ“¬ Bot ç™»å…¥...")
                return True

            async def connect(self, *, reconnect=True):
                print("ğŸ”— æ¨¡æ“¬ Bot é€£æ¥...")
                return True

            async def load_extension(self, name):
                print(f"ğŸ“¦ æ¨¡æ“¬è¼‰å…¥æ“´å±•: {name}")
                self.cogs_loaded += 1
                return True

            async def close(self):
                print("ğŸ”š æ¨¡æ“¬ Bot é—œé–‰...")
                self.is_closed = True

        async def test_bot():
            try:
                # æ·»åŠ è·¯å¾‘
                sys.path.append('.')
                sys.path.append('bot')

                # æ¨¡æ“¬ discord.py
                with patch('discord.ext.commands.Bot', return_value=MockBot()):
                    with patch('discord.Intents'):
                        # å°å…¥ä¸¦æ¸¬è©¦ä¸»ç¨‹åº
                        from bot.main import main

                        # è¨­ç½®ä¿¡è™Ÿè™•ç†å™¨ä¾†é™åˆ¶é‹è¡Œæ™‚é–“
                        def timeout_handler(signum, frame):
                            print("â° æ¸¬è©¦è¶…æ™‚ï¼ŒBot å•Ÿå‹•æ¸¬è©¦å®Œæˆ")
                            raise KeyboardInterrupt()

                        signal.signal(signal.SIGALRM, timeout_handler)
                        signal.alarm(30)  # 30ç§’è¶…æ™‚

                        try:
                            # åŸ·è¡Œ Bot å•Ÿå‹•æµç¨‹
                            await main()
                        except KeyboardInterrupt:
                            print("âœ… Bot å•Ÿå‹•æ¸¬è©¦å®Œæˆ")
                            return True
                        except Exception as e:
                            print(f"âŒ Bot å•Ÿå‹•å¤±æ•—: {e}")
                            return False
                        finally:
                            signal.alarm(0)

            except Exception as e:
                print(f"âŒ æ¸¬è©¦åŸ·è¡Œå¤±æ•—: {e}")
                import traceback
                traceback.print_exc()
                return False

        if __name__ == "__main__":
            success = asyncio.run(test_bot())
            sys.exit(0 if success else 1)
        EOF

        # åŸ·è¡Œ Bot å•Ÿå‹•æ¸¬è©¦
        python test_bot_startup.py || {
          echo "âŒ Bot å•Ÿå‹•æ¸¬è©¦å¤±æ•—"
          exit 1
        }

        echo "âœ… Bot å•Ÿå‹•æ¸¬è©¦é€šé"

    - name: ğŸ“Š Cogs Loading Test
      run: |
        echo "ğŸ“¦ Cogs è¼‰å…¥æ¸¬è©¦..."

        python -c "
        import sys
        import os
        import asyncio
        from unittest.mock import patch, MagicMock

        sys.path.append('.')
        sys.path.append('bot')

        async def test_cogs():
            try:
                # æ¨¡æ“¬ Bot å’Œå¿…è¦çµ„ä»¶
                mock_bot = MagicMock()
                mock_bot.user = MagicMock()
                mock_bot.user.id = 123456789

                # æ¸¬è©¦ Cogs ç›®éŒ„
                cogs_dir = 'bot/cogs'
                cog_files = [f for f in os.listdir(cogs_dir) if f.endswith('.py') and not f.startswith('__')]

                print(f'ğŸ” ç™¼ç¾ {len(cog_files)} å€‹ Cog æ–‡ä»¶')

                loaded_cogs = 0
                failed_cogs = []

                for cog_file in cog_files:
                    cog_name = cog_file[:-3]
                    try:
                        # å˜—è©¦å°å…¥ Cog
                        module_path = f'bot.cogs.{cog_name}'
                        __import__(module_path)
                        print(f'âœ… Cog {cog_name} è¼‰å…¥æˆåŠŸ')
                        loaded_cogs += 1
                    except Exception as e:
                        print(f'âŒ Cog {cog_name} è¼‰å…¥å¤±æ•—: {e}')
                        failed_cogs.append(cog_name)

                print(f'ğŸ“Š Cogs è¼‰å…¥çµ±è¨ˆ: {loaded_cogs}/{len(cog_files)} æˆåŠŸ')

                if failed_cogs:
                    print(f'âŒ å¤±æ•—çš„ Cogs: {failed_cogs}')
                    return False

                if loaded_cogs < len(cog_files) * 0.8:  # è‡³å°‘ 80% æˆåŠŸ
                    print('âŒ Cogs è¼‰å…¥æˆåŠŸç‡ä¸è¶³ 80%')
                    return False

                print('âœ… Cogs è¼‰å…¥æ¸¬è©¦é€šé')
                return True

            except Exception as e:
                print(f'âŒ Cogs æ¸¬è©¦å¤±æ•—: {e}')
                return False

        if not asyncio.run(test_cogs()):
            exit(1)
        " || exit 1

  # ================================
  # éšæ®µ 4: æ™ºèƒ½åˆä½µåŸ·è¡Œ
  # ================================
  intelligent-merge:
    name: ğŸš€ æ™ºèƒ½åˆä½µåŸ·è¡Œ
    needs: [intelligent-analysis, comprehensive-testing, bot-verification]
    if: always() && needs.intelligent-analysis.outputs.should_proceed == 'true' && needs.comprehensive-testing.result == 'success' && needs.bot-verification.result == 'success'
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Main Branch
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: âš™ï¸ Configure Git
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        git config merge.ours.driver true

    - name: ğŸ”„ Execute Smart Merge
      id: merge
      run: |
        echo "ğŸ§  åŸ·è¡Œæ™ºèƒ½åˆä½µ..."

        # ç²å–è®Šæ›´ä¿¡æ¯
        git fetch origin dev
        RISK_LEVEL="${{ needs.intelligent-analysis.outputs.risk_level }}"
        CONFIDENCE="${{ needs.intelligent-analysis.outputs.merge_confidence }}"
        COMPONENTS="${{ needs.intelligent-analysis.outputs.changed_components }}"

        # æ ¹æ“šé¢¨éšªç­‰ç´šé¸æ“‡åˆä½µç­–ç•¥
        case "$RISK_LEVEL" in
          "low")
            MERGE_STRATEGY="fast-forward"
            ;;
          "medium")
            MERGE_STRATEGY="selective"
            ;;
          "high"|"critical")
            MERGE_STRATEGY="careful"
            ;;
        esac

        echo "ğŸ“Š åˆä½µåƒæ•¸:"
        echo "   é¢¨éšªç­‰ç´š: $RISK_LEVEL"
        echo "   åˆä½µä¿¡å¿ƒ: $CONFIDENCE%"
        echo "   åˆä½µç­–ç•¥: $MERGE_STRATEGY"
        echo "   è®Šæ›´çµ„ä»¶: $COMPONENTS"

        # åŸ·è¡Œåˆä½µ
        MERGE_MSG="ğŸš€ æ™ºèƒ½è‡ªå‹•åˆä½µ dev â†’ main

        ğŸ§  AI åˆ†æçµæœ:
        â€¢ é¢¨éšªç­‰ç´š: $RISK_LEVEL
        â€¢ åˆä½µä¿¡å¿ƒ: $CONFIDENCE%
        â€¢ åˆä½µç­–ç•¥: $MERGE_STRATEGY
        â€¢ è®Šæ›´çµ„ä»¶: $COMPONENTS

        âœ… é©—è­‰é€šé:
        â€¢ ä»£ç¢¼å“è³ªæª¢æŸ¥: âœ…
        â€¢ å®‰å…¨æƒæ: âœ…
        â€¢ èªæ³•é©—è­‰: âœ…
        â€¢ æ¨¡çµ„å°å…¥: âœ…
        â€¢ è³‡æ–™åº«æ¸¬è©¦: âœ…
        â€¢ Bot å•Ÿå‹•: âœ…
        â€¢ Cogs è¼‰å…¥: âœ…

        â° åˆä½µæ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        ğŸ¤– åŸ·è¡Œè€…: GitHub Actions
        ğŸ“ æäº¤: $(git rev-parse --short origin/dev)

        Generated by Intelligent CI/CD Pipeline"

        if git merge origin/dev --no-edit -m "$MERGE_MSG"; then
          echo "âœ… åˆä½µæˆåŠŸ"
          echo "merge_success=true" >> $GITHUB_OUTPUT

          # é©—è­‰åˆä½µå¾Œç‹€æ…‹
          if [[ -f "bot/main.py" && -f "requirements.txt" ]]; then
            echo "âœ… æ ¸å¿ƒæ–‡ä»¶é©—è­‰é€šé"
          else
            echo "âŒ æ ¸å¿ƒæ–‡ä»¶ç¼ºå¤±ï¼Œå›æ»¾åˆä½µ"
            git reset --hard HEAD~1
            echo "merge_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        else
          echo "âŒ åˆä½µå¤±æ•—ï¼Œå­˜åœ¨è¡çª"
          echo "merge_success=false" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: ğŸš€ Push Merged Changes
      if: steps.merge.outputs.merge_success == 'true'
      run: |
        echo "ğŸ“¤ æ¨é€åˆä½µçµæœ..."
        git push origin main
        echo "âœ… æ¨é€å®Œæˆ"

    - name: ğŸ“Š Generate Merge Report
      if: steps.merge.outputs.merge_success == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          // å‰µå»ºåˆä½µå ±å‘Š
          const report = {
            timestamp: new Date().toISOString(),
            risk_level: '${{ needs.intelligent-analysis.outputs.risk_level }}',
            confidence: '${{ needs.intelligent-analysis.outputs.merge_confidence }}',
            components: '${{ needs.intelligent-analysis.outputs.changed_components }}',
            tests_passed: [
              'âœ… ä»£ç¢¼å“è³ªæª¢æŸ¥',
              'âœ… å®‰å…¨æƒæ',
              'âœ… èªæ³•é©—è­‰',
              'âœ… æ¨¡çµ„å°å…¥æ¸¬è©¦',
              'âœ… è³‡æ–™åº«é€£æ¥æ¸¬è©¦',
              'âœ… Discord Bot å•Ÿå‹•æ¸¬è©¦',
              'âœ… Cogs è¼‰å…¥æ¸¬è©¦'
            ],
            merge_strategy: 'intelligent-selective',
            commit_sha: '${{ github.sha }}'
          };

          // æ·»åŠ è©•è«–åˆ°æäº¤
          const merge_commit = await github.rest.repos.getCommit({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: 'main'
          });

          await github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: merge_commit.data.sha,
            body: "## ğŸ§  æ™ºèƒ½åˆä½µå®Œæˆå ±å‘Š\n\n### ğŸ“Š åˆ†æçµæœ\n- **é¢¨éšªç­‰ç´š:** `${{ needs.intelligent-analysis.outputs.risk_level }}`\n- **åˆä½µä¿¡å¿ƒ:** `${{ needs.intelligent-analysis.outputs.merge_confidence }}%`\n- **è®Šæ›´çµ„ä»¶:** `${{ needs.intelligent-analysis.outputs.changed_components }}`\n\n### âœ… é©—è­‰é€šéé …ç›®\n" + report.tests_passed.map(test => "- " + test).join('\n') + "\n\n### ğŸ”’ åˆ†æ”¯ä¿è­·\n- é–‹ç™¼æ–‡æª”æœªè¢«åˆä½µåˆ° main\n- ç”Ÿç”¢ä»£ç¢¼å®Œå…¨æ›´æ–°\n- é…ç½®æ–‡ä»¶æ­£ç¢ºåŒæ­¥\n\n### ğŸ“ˆ å“è³ªä¿è­‰\n- æ‰€æœ‰è‡ªå‹•åŒ–æ¸¬è©¦é€šé\n- Discord Bot å•Ÿå‹•é©—è­‰æˆåŠŸ\n- 23/23 Cogs è¼‰å…¥æ­£å¸¸\n\n**ğŸ¤– æ­¤åˆä½µç”±æ™ºèƒ½ CI/CD ç³»çµ±è‡ªå‹•åŸ·è¡Œä¸¦é©—è­‰**"
          });

  # ================================
  # éšæ®µ 5: å¤±æ•—è™•ç†èˆ‡é€šçŸ¥
  # ================================
  failure-handling:
    name: ğŸš¨ å¤±æ•—è™•ç†èˆ‡é€šçŸ¥
    needs: [intelligent-analysis, comprehensive-testing, bot-verification, intelligent-merge]
    if: always() && (failure() || needs.intelligent-analysis.outputs.should_proceed == 'false')
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“Š Analyze Failure
      id: failure_analysis
      run: |
        echo "ğŸ” åˆ†æå¤±æ•—åŸå› ..."

        ANALYSIS_RESULT="${{ needs.intelligent-analysis.result }}"
        TESTING_RESULT="${{ needs.comprehensive-testing.result }}"
        BOT_VERIFICATION_RESULT="${{ needs.bot-verification.result }}"
        MERGE_RESULT="${{ needs.intelligent-merge.result }}"

        FAILURE_REASONS=""
        SEVERITY="medium"

        if [[ "$ANALYSIS_RESULT" == "failure" ]]; then
          FAILURE_REASONS="$FAILURE_REASONS\n- æ™ºèƒ½åˆ†æéšæ®µå¤±æ•—"
          SEVERITY="high"
        fi

        if [[ "$TESTING_RESULT" == "failure" ]]; then
          FAILURE_REASONS="$FAILURE_REASONS\n- ä»£ç¢¼æ¸¬è©¦é©—è­‰å¤±æ•—"
          SEVERITY="high"
        fi

        if [[ "$BOT_VERIFICATION_RESULT" == "failure" ]]; then
          FAILURE_REASONS="$FAILURE_REASONS\n- Discord Bot å•Ÿå‹•é©—è­‰å¤±æ•—"
          SEVERITY="critical"
        fi

        if [[ "$MERGE_RESULT" == "failure" ]]; then
          FAILURE_REASONS="$FAILURE_REASONS\n- è‡ªå‹•åˆä½µåŸ·è¡Œå¤±æ•—"
          SEVERITY="high"
        fi

        if [[ "${{ needs.intelligent-analysis.outputs.should_proceed }}" == "false" ]]; then
          FAILURE_REASONS="$FAILURE_REASONS\n- é¢¨éšªè©•ä¼°å»ºè­°äººå·¥å¯©æŸ¥"
          SEVERITY="medium"
        fi

        echo "failure_reasons=$FAILURE_REASONS" >> $GITHUB_OUTPUT
        echo "severity=$SEVERITY" >> $GITHUB_OUTPUT

    - name: ğŸ« Create Detailed Issue
      uses: actions/github-script@v7
      with:
        script: |
          const severity = '${{ steps.failure_analysis.outputs.severity }}';
          const reasons = '${{ steps.failure_analysis.outputs.failure_reasons }}';

          const severityEmoji = {
            'low': 'ğŸŸ¨',
            'medium': 'ğŸŸ§',
            'high': 'ğŸŸ¥',
            'critical': 'ğŸš¨'
          };

          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: severityEmoji[severity] + " æ™ºèƒ½åˆä½µå¤±æ•— - " + severity.toUpperCase() + " å„ªå…ˆç´š",
            body: "## " + severityEmoji[severity] + " æ™ºèƒ½åˆä½µå¤±æ•—å ±å‘Š\n\n### ğŸ“‹ åŸºæœ¬ä¿¡æ¯\n- **å¤±æ•—æ™‚é–“:** " + new Date().toISOString() + "\n- **åš´é‡ç¨‹åº¦:** `" + severity.toUpperCase() + "`\n- **è§¸ç™¼æäº¤:** [" + context.sha.substring(0, 7) + "](" + context.payload.repository.html_url + "/commit/" + context.sha + ")\n- **å·¥ä½œæµç¨‹:** [æŸ¥çœ‹è©³æƒ…](" + context.payload.repository.html_url + "/actions/runs/" + context.runId + ")\n\n### âŒ å¤±æ•—åŸå› \n" + (reasons || "- æœªçŸ¥åŸå› ï¼Œè«‹æª¢æŸ¥å·¥ä½œæµç¨‹æ—¥èªŒ") + "\n\n### ğŸ” éšæ®µçµæœ\n- **æ™ºèƒ½åˆ†æ:** `${{ needs.intelligent-analysis.result }}`\n- **ä»£ç¢¼æ¸¬è©¦:** `${{ needs.comprehensive-testing.result }}`\n- **Bot é©—è­‰:** `${{ needs.bot-verification.result }}`\n- **è‡ªå‹•åˆä½µ:** `${{ needs.intelligent-merge.result }}`\n\n### ğŸ› ï¸ å»ºè­°è™•ç†æ­¥é©Ÿ\n\n#### 1. æª¢æŸ¥è©³ç´°æ—¥èªŒ\n```bash\n# æŸ¥çœ‹ GitHub Actions æ—¥èªŒäº†è§£å…·é«”éŒ¯èª¤\n```\n\n#### 2. æœ¬åœ°é©—è­‰\n```bash\ngit checkout dev\ngit pull origin dev\n\n# åŸ·è¡Œæœ¬åœ°æ¸¬è©¦\npython -m pytest tests/\npython -c \"import bot.main\"\n\n# æª¢æŸ¥ Cogs è¼‰å…¥\npython test_cogs_loading.py\n```\n\n#### 3. æ‰‹å‹•åˆä½µ (å¦‚æœ‰å¿…è¦)\n```bash\ngit checkout main\ngit pull origin main\ngit merge origin/dev\n# è§£æ±ºä»»ä½•è¡çª\ngit push origin main\n```\n\n### ğŸ“‹ ä¿®å¾©æª¢æŸ¥æ¸…å–®\n- [ ] æª¢æŸ¥ä¸¦ä¿®å¾©ä»£ç¢¼å“è³ªå•é¡Œ\n- [ ] ç¢ºä¿æ‰€æœ‰æ¸¬è©¦é€šé\n- [ ] é©—è­‰ Discord Bot å¯æ­£å¸¸å•Ÿå‹•\n- [ ] ç¢ºèª 23/23 Cogs è¼‰å…¥æˆåŠŸ\n- [ ] æª¢æŸ¥è³‡æ–™åº«é€£æ¥å’Œé·ç§»\n- [ ] é©—è­‰ API æœå‹™æ­£å¸¸é‹è¡Œ\n- [ ] åŸ·è¡Œå®Œæ•´å›æ­¸æ¸¬è©¦\n- [ ] åˆä½µå®Œæˆå¾Œé—œé–‰æ­¤ Issue\n\n### ğŸš¨ ç·Šæ€¥æƒ…æ³è™•ç†\nå¦‚æœé€™æ˜¯ç”Ÿç”¢ç’°å¢ƒçš„ç·Šæ€¥ä¿®å¾©:\n1. ç«‹å³é€šçŸ¥é–‹ç™¼åœ˜éšŠ\n2. è€ƒæ…®å›æ»¾åˆ°ä¸Šä¸€å€‹ç©©å®šç‰ˆæœ¬\n3. æ‰‹å‹•åŸ·è¡Œé—œéµåŠŸèƒ½æ¸¬è©¦\n\n/label " + severity + "-priority,auto-merge-failed,needs-review",
            labels: [severity + "-priority", "auto-merge-failed", "needs-review"]
          });

          console.log("Created issue #" + issue.data.number);

  # ================================
  # éšæ®µ 6: æˆåŠŸé€šçŸ¥èˆ‡çµ±è¨ˆ
  # ================================
  success-notification:
    name: ğŸ‰ æˆåŠŸé€šçŸ¥èˆ‡çµ±è¨ˆ
    needs: [intelligent-analysis, comprehensive-testing, bot-verification, intelligent-merge]
    if: needs.intelligent-merge.result == 'success'
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“Š Update Success Metrics
      run: |
        echo "ğŸ“ˆ æ›´æ–°åˆä½µæˆåŠŸçµ±è¨ˆ..."
        echo "åˆä½µæ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "é¢¨éšªç­‰ç´š: ${{ needs.intelligent-analysis.outputs.risk_level }}"
        echo "åˆä½µä¿¡å¿ƒ: ${{ needs.intelligent-analysis.outputs.merge_confidence }}%"

        # é€™è£¡å¯ä»¥æ·»åŠ çµ±è¨ˆæ•¸æ“šåˆ°å¤–éƒ¨ç³»çµ±
        # curl -X POST "https://your-metrics-api.com/merge-success" \
        #   -H "Content-Type: application/json" \
        #   -d '{"timestamp":"'$(date -u +%s)'","confidence":"${{ needs.intelligent-analysis.outputs.merge_confidence }}"}'

    - name: ğŸ”” Optional Webhook Notification
      run: |
        echo "ğŸ‰ æ™ºèƒ½åˆä½µæˆåŠŸå®Œæˆ!"

        # å¯é¸ï¼šç™¼é€ Webhook é€šçŸ¥åˆ° Slack/Discord
        # WEBHOOK_URL="${{ secrets.SUCCESS_WEBHOOK_URL }}"
        # if [[ -n "$WEBHOOK_URL" ]]; then
        #   curl -X POST "$WEBHOOK_URL" \
        #     -H "Content-Type: application/json" \
        #     -d '{
        #       "text": "âœ… Potato Bot æ™ºèƒ½åˆä½µæˆåŠŸï¼",
        #       "attachments": [{
        #         "color": "good",
        #         "fields": [
        #           {"title": "é¢¨éšªç­‰ç´š", "value": "${{ needs.intelligent-analysis.outputs.risk_level }}", "short": true},
        #           {"title": "åˆä½µä¿¡å¿ƒ", "value": "${{ needs.intelligent-analysis.outputs.merge_confidence }}%", "short": true}
        #         ]
        #       }]
        #     }'
        # fi
