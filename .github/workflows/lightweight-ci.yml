name: ğŸš€ Lightweight CI - Essential Checks Only

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev, main]

env:
  PYTHON_VERSION: '3.10'

jobs:
  essential-checks:
    name: ğŸ” å¿…è¦æ¢ä»¶æª¢æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 8

    # è¨­ç½®å¿…è¦çš„ç’°å¢ƒè®Šæ•¸ï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰
    env:
      TESTING: true
      DISCORD_TOKEN: test_token_comprehensive_validation_length_requirement_met_12345678_abcdefghijk
      DATABASE_URL: sqlite:///test.db
      DB_HOST: localhost
      DB_USER: test_user
      DB_PASSWORD: test_password_secure_testing_environment_only  # pragma: allowlist secret
      DB_NAME: test_database
      DB_PORT: 3306
      JWT_SECRET: test_jwt_secret_for_automated_testing_purposes_only  # pragma: allowlist secret
      REDIS_URL: redis://localhost:6379/0

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ å®‰è£å¿…è¦ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install discord.py>=2.5.0 aiomysql fastapi python-dotenv
        pip install black isort flake8

    - name: ğŸ” èªæ³•é©—è­‰æ¸¬è©¦
      run: |
        echo "ğŸ” æª¢æŸ¥æ ¸å¿ƒæ–‡ä»¶èªæ³•..."

        # æª¢æŸ¥ä¸»ç¨‹å¼
        python -m py_compile bot/main.py
        echo "âœ… bot/main.py èªæ³•æ­£ç¢º"

        # æª¢æŸ¥é…ç½®æ–‡ä»¶
        python -c "
        import ast
        with open('shared/config.py', 'r', encoding='utf-8') as f:
            ast.parse(f.read())
        print('âœ… shared/config.py èªæ³•æ­£ç¢º')
        "

        # æª¢æŸ¥é—œéµ Cogs
        for cog in bot/cogs/ticket_core.py bot/cogs/vote_core.py bot/cogs/language_core.py; do
          if [ -f "$cog" ]; then
            python -m py_compile "$cog"
            echo "âœ… $cog èªæ³•æ­£ç¢º"
          fi
        done

    - name: ğŸ”§ é…ç½®è¼‰å…¥æ¸¬è©¦
      run: |
        echo "ğŸ”§ æ¸¬è©¦é…ç½®è¼‰å…¥..."
        python -c "
        import sys
        import os
        sys.path.append('.')

        # æ¸¬è©¦é…ç½®è¼‰å…¥
        from shared.config import DISCORD_TOKEN, DB_HOST
        print(f'âœ… é…ç½®è¼‰å…¥æˆåŠŸ')
        print(f'Discord Token é•·åº¦: {len(DISCORD_TOKEN)}')
        print(f'è³‡æ–™åº«ä¸»æ©Ÿ: {DB_HOST}')
        "

    - name: ğŸš€ åŸºæœ¬æœå‹™åˆå§‹åŒ–æ¸¬è©¦
      timeout-minutes: 3
      run: |
        echo "ğŸš€ æ¸¬è©¦åŸºæœ¬æœå‹™åˆå§‹åŒ–..."
        python -c "
        import sys
        import os
        import asyncio
        from unittest.mock import patch, MagicMock

        sys.path.append('.')

        # Mock Discord ç›¸é—œé¡åˆ¥
        with patch('discord.ext.commands.Bot') as mock_bot:
            with patch('discord.Intents'):
                mock_instance = MagicMock()
                mock_bot.return_value = mock_instance

                try:
                    # å˜—è©¦å°å…¥ä¸»è¦æ¨¡çµ„
                    from shared.config import Config
                    print('âœ… é…ç½®ç³»çµ±æ­£å¸¸')

                    from shared.logger import logger
                    print('âœ… æ—¥èªŒç³»çµ±æ­£å¸¸')

                    # æª¢æŸ¥è³‡æ–™åº«ç®¡ç†å™¨èƒ½å¦åˆå§‹åŒ–
                    from bot.db.database_manager import DatabaseManager
                    print('âœ… è³‡æ–™åº«ç®¡ç†å™¨å¯åˆå§‹åŒ–')

                    print('ğŸ‰ åŸºæœ¬æœå‹™åˆå§‹åŒ–æ¸¬è©¦é€šé')

                except Exception as e:
                    print(f'âŒ åˆå§‹åŒ–æ¸¬è©¦å¤±æ•—: {e}')
                    import traceback
                    traceback.print_exc()
                    sys.exit(1)
        "

    - name: ğŸ“Š ä¾è³´ä¸€è‡´æ€§æª¢æŸ¥
      run: |
        echo "ğŸ“Š æª¢æŸ¥ä¾è³´ä¸€è‡´æ€§..."

        # æª¢æŸ¥ requirements.txt æ˜¯å¦å­˜åœ¨
        if [ ! -f requirements.txt ]; then
          echo "âŒ requirements.txt ä¸å­˜åœ¨"
          exit 1
        fi

        # æª¢æŸ¥é—œéµä¾è³´
        if ! grep -q "discord.py" requirements.txt && \
           ! grep -q "discord.py" docs/requirements/requirements-production.txt; then
          echo "âš ï¸ æœªæ‰¾åˆ° discord.py ä¾è³´è²æ˜"
        fi

        echo "âœ… ä¾è³´æª¢æŸ¥å®Œæˆ"

    - name: ğŸ¯ ä»£ç¢¼å“è³ªå¿«é€Ÿæª¢æŸ¥
      continue-on-error: true
      run: |
        echo "ğŸ¯ å¿«é€Ÿä»£ç¢¼å“è³ªæª¢æŸ¥..."

        # æª¢æŸ¥æ˜¯å¦æœ‰æ˜é¡¯çš„èªæ³•å•é¡Œ
        if command -v flake8 >/dev/null; then
          echo "ğŸ” åŸ·è¡Œ flake8 æª¢æŸ¥..."
          flake8 bot/main.py shared/config.py --select=E9,F63,F7,F82 --quiet || echo "âš ï¸ ç™¼ç¾æ½›åœ¨èªæ³•å•é¡Œ"
        fi

        echo "âœ… ä»£ç¢¼å“è³ªæª¢æŸ¥å®Œæˆ"

  # å¿«é€Ÿæ•´åˆæ¸¬è©¦ - åƒ…åœ¨æ ¸å¿ƒæ–‡ä»¶è®Šæ›´æ™‚åŸ·è¡Œ
  integration-test:
    name: ğŸ”— å¿«é€Ÿæ•´åˆæ¸¬è©¦
    runs-on: ubuntu-latest
    needs: essential-checks
    if: contains(github.event.head_commit.message, '[test-integration]') ||
        (github.event_name == 'pull_request' &&
         contains(github.event.pull_request.title, 'core'))
    timeout-minutes: 5

    env:
      TESTING: true
      DISCORD_TOKEN: test_token_comprehensive_validation_length_requirement_met_12345678_integration
      DATABASE_URL: sqlite:///integration_test.db
      DB_HOST: localhost
      DB_USER: test_user
      DB_PASSWORD: test_password_secure_integration_testing_only  # pragma: allowlist secret
      DB_NAME: integration_test
      JWT_SECRET: test_jwt_secret_integration_testing  # pragma: allowlist secret

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ å®‰è£å®Œæ•´ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ”— æ•´åˆåˆå§‹åŒ–æ¸¬è©¦
      timeout-minutes: 3
      run: |
        echo "ğŸ”— åŸ·è¡Œæ•´åˆåˆå§‹åŒ–æ¸¬è©¦..."
        python -c "
        import sys
        import asyncio
        from unittest.mock import patch, MagicMock, AsyncMock

        sys.path.append('.')

        async def test_integration():
            # Mock Discord Bot
            with patch('discord.ext.commands.Bot') as mock_bot_class:
                mock_bot = MagicMock()
                mock_bot.user = MagicMock()
                mock_bot.user.id = 123456789
                mock_bot.guilds = []
                mock_bot_class.return_value = mock_bot

                with patch('discord.Intents'):
                    try:
                        from bot.main import PotatoBot
                        print('âœ… PotatoBot é¡åˆ¥å¯æ­£å¸¸å°å…¥')

                        # æ¸¬è©¦åŸºæœ¬åˆå§‹åŒ–æµç¨‹
                        from shared.config import DISCORD_TOKEN
                        from bot.db.database_manager import DatabaseManager

                        print('âœ… æ•´åˆæ¸¬è©¦é€šé - æ ¸å¿ƒçµ„ä»¶å¯æ­£å¸¸åˆå§‹åŒ–')

                    except Exception as e:
                        print(f'âŒ æ•´åˆæ¸¬è©¦å¤±æ•—: {e}')
                        import traceback
                        traceback.print_exc()
                        return False
            return True

        import asyncio
        result = asyncio.run(test_integration())
        if not result:
            sys.exit(1)
        "

  # çµæœå½™ç¸½
  summary:
    name: ğŸ“‹ æª¢æŸ¥çµæœå½™ç¸½
    runs-on: ubuntu-latest
    needs: [essential-checks]
    if: always()

    steps:
    - name: ğŸ“‹ å½™ç¸½æª¢æŸ¥çµæœ
      run: |
        echo "ğŸ“‹ è¼•é‡ç´š CI æª¢æŸ¥çµæœå½™ç¸½"
        echo "================================"

        if [ "${{ needs.essential-checks.result }}" == "success" ]; then
          echo "âœ… å¿…è¦æ¢ä»¶æª¢æŸ¥: é€šé"
          echo "ğŸ¯ ä»£ç¢¼å“è³ª: ç¬¦åˆåŸºæœ¬è¦æ±‚"
          echo "ğŸš€ æœå‹™åˆå§‹åŒ–: æ­£å¸¸"
          echo ""
          echo "ğŸ‰ è¼•é‡ç´š CI æª¢æŸ¥å…¨éƒ¨é€šéï¼"
          echo "âœ¨ ä»£ç¢¼å·²æº–å‚™å¥½é€²è¡Œè‡ªå‹•åˆä½µ"
        else
          echo "âŒ å¿…è¦æ¢ä»¶æª¢æŸ¥: å¤±æ•—"
          echo ""
          echo "ğŸ”§ è«‹æª¢æŸ¥ä»¥ä¸‹é …ç›®ï¼š"
          echo "  - Python èªæ³•éŒ¯èª¤"
          echo "  - é…ç½®æ–‡ä»¶å•é¡Œ"
          echo "  - é—œéµä¾è³´ç¼ºå¤±"
          echo "  - æœå‹™åˆå§‹åŒ–å¤±æ•—"
          exit 1
        fi
