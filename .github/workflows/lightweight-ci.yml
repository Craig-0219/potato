name: 🚀 Essential Checks Only

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev, main]

env:
  PYTHON_VERSION: '3.10'

jobs:
  essential-checks:
    name: 🔍 必要條件檢查
    runs-on: ubuntu-latest
    timeout-minutes: 5

    env:
      TESTING: true
      DISCORD_TOKEN: test_token_comprehensive_validation_length_requirement_met_12345678_abcdefghijk
      DATABASE_URL: sqlite:///test.db
      DB_HOST: localhost
      DB_USER: test_user
      DB_PASSWORD: test_password_secure_testing_environment_only  # pragma: allowlist secret
      DB_NAME: test_database
      DB_PORT: 3306
      JWT_SECRET: test_jwt_secret_for_automated_testing_purposes_only  # pragma: allowlist secret

    steps:
    - name: 📥 檢出代碼
      uses: actions/checkout@v4

    - name: 🐍 設置 Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: 📦 安裝必要依賴
      run: |
        python -m pip install --upgrade pip
        pip install discord.py>=2.5.0 aiomysql fastapi python-dotenv

    - name: 🔍 語法驗證
      run: |
        echo "🔍 檢查核心文件語法..."
        python -m py_compile bot/main.py
        python -c "import ast; ast.parse(open('shared/config.py').read())"
        echo "✅ 語法檢查通過"

    - name: 🔧 配置載入測試
      run: |
        echo "🔧 測試配置載入..."
        python -c "
        import sys; sys.path.append('.')
        from shared.config import DISCORD_TOKEN, DB_HOST
        print('✅ 配置載入成功')
        "

    - name: 🚀 基本初始化測試
      run: |
        echo "🚀 測試基本初始化..."
        python -c "
        import sys; sys.path.append('.')
        from unittest.mock import patch, MagicMock

        with patch('discord.ext.commands.Bot') as mock_bot:
            with patch('discord.Intents'):
                mock_bot.return_value = MagicMock()

                from shared.config import Config
                from shared.logger import logger
                from bot.db.database_manager import DatabaseManager
                print('✅ 核心組件初始化正常')
        "

    - name: 📊 依賴檢查
      run: |
        echo "📊 檢查依賴..."
        test -f requirements.txt || { echo "❌ requirements.txt 不存在"; exit 1; }
        echo "✅ 依賴檢查完成"
