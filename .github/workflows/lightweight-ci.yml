name: ğŸš€ Essential Checks Only

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev, main]

env:
  PYTHON_VERSION: '3.10'

jobs:
  essential-checks:
    name: ğŸ” å¿…è¦æ¢ä»¶æª¢æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 5

    env:
      TESTING: true
      DISCORD_TOKEN: test_token_comprehensive_validation_length_requirement_met_12345678_abcdefghijk
      DATABASE_URL: sqlite:///test.db
      DB_HOST: localhost
      DB_USER: test_user
      DB_PASSWORD: test_password_secure_testing_environment_only  # pragma: allowlist secret
      DB_NAME: test_database
      DB_PORT: 3306
      JWT_SECRET: test_jwt_secret_for_automated_testing_purposes_only  # pragma: allowlist secret

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ å®‰è£å¿…è¦ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install discord.py>=2.5.0 aiomysql fastapi python-dotenv

    - name: ğŸ” èªæ³•é©—è­‰
      run: |
        echo "ğŸ” æª¢æŸ¥æ ¸å¿ƒæ–‡ä»¶èªæ³•..."
        python -m py_compile bot/main.py
        python -c "import ast; ast.parse(open('shared/config.py').read())"
        echo "âœ… èªæ³•æª¢æŸ¥é€šé"

    - name: ğŸ”§ é…ç½®è¼‰å…¥æ¸¬è©¦
      run: |
        echo "ğŸ”§ æ¸¬è©¦é…ç½®è¼‰å…¥..."
        python -c "
        import sys; sys.path.append('.')
        from shared.config import DISCORD_TOKEN, DB_HOST
        print('âœ… é…ç½®è¼‰å…¥æˆåŠŸ')
        "

    - name: ğŸš€ åŸºæœ¬åˆå§‹åŒ–æ¸¬è©¦
      run: |
        echo "ğŸš€ æ¸¬è©¦åŸºæœ¬åˆå§‹åŒ–..."
        python -c "
        import sys; sys.path.append('.')
        from unittest.mock import patch, MagicMock

        with patch('discord.ext.commands.Bot') as mock_bot:
            with patch('discord.Intents'):
                mock_bot.return_value = MagicMock()

                from shared.config import DISCORD_TOKEN, DB_HOST
                from shared.logger import logger
                from bot.db.database_manager import DatabaseManager
                print('âœ… æ ¸å¿ƒçµ„ä»¶åˆå§‹åŒ–æ­£å¸¸')
        "

    - name: ğŸ“Š ä¾è³´æª¢æŸ¥
      run: |
        echo "ğŸ“Š æª¢æŸ¥ä¾è³´..."
        test -f requirements.txt || { echo "âŒ requirements.txt ä¸å­˜åœ¨"; exit 1; }
        echo "âœ… ä¾è³´æª¢æŸ¥å®Œæˆ"

    - name: ğŸ§ª Cogs è¼‰å…¥æ¸¬è©¦
      run: |
        echo "ğŸ§ª æ¸¬è©¦é—œéµ Cogs è¼‰å…¥..."
        python -c "
        import sys; sys.path.append('.')
        from unittest.mock import patch, MagicMock

        with patch('discord.ext.commands.Bot') as mock_bot:
            with patch('discord.Intents'):
                mock_bot.return_value = MagicMock()
                
                # æ¸¬è©¦é—œéµ Cogs
                try:
                    from bot.cogs.ticket_core import TicketCore
                    print('âœ… TicketCore å¯è¼‰å…¥')
                except Exception as e:
                    print(f'âš ï¸ TicketCore è¼‰å…¥å•é¡Œ: {e}')
                
                try:
                    from bot.cogs.vote_core import VoteCore  
                    print('âœ… VoteCore å¯è¼‰å…¥')
                except Exception as e:
                    print(f'âš ï¸ VoteCore è¼‰å…¥å•é¡Œ: {e}')
                
                try:
                    from bot.cogs.language_core import LanguageManager
                    print('âœ… LanguageManager å¯è¼‰å…¥')
                except Exception as e:
                    print(f'âš ï¸ LanguageManager è¼‰å…¥å•é¡Œ: {e}')
        "

    - name: ğŸ”§ æ ¸å¿ƒæœå‹™æ¸¬è©¦
      run: |
        echo "ğŸ”§ æ¸¬è©¦æ ¸å¿ƒæœå‹™åˆå§‹åŒ–..."
        python -c "
        import sys; sys.path.append('.')
        from unittest.mock import patch, MagicMock, AsyncMock

        # æ¸¬è©¦è³‡æ–™åº«ç®¡ç†å™¨
        try:
            from bot.db.database_manager import DatabaseManager
            print('âœ… DatabaseManager å¯åˆå§‹åŒ–')
        except Exception as e:
            print(f'âš ï¸ DatabaseManager å•é¡Œ: {e}')
        
        # æ¸¬è©¦å¿«å–ç®¡ç†å™¨  
        try:
            from shared.local_cache_manager import LocalCacheManager
            cache = LocalCacheManager()
            print('âœ… LocalCacheManager å¯åˆå§‹åŒ–')
        except Exception as e:
            print(f'âš ï¸ LocalCacheManager å•é¡Œ: {e}')
            
        # æ¸¬è©¦é›¢ç·šæ¨¡å¼ç®¡ç†å™¨
        try:
            from shared.offline_mode_manager import OfflineModeManager
            offline_mgr = OfflineModeManager()
            print('âœ… OfflineModeManager å¯åˆå§‹åŒ–')
        except Exception as e:
            print(f'âš ï¸ OfflineModeManager å•é¡Œ: {e}')
        "

    - name: ğŸš€ Bot ä¸»ç¨‹å¼æ¸¬è©¦  
      run: |
        echo "ğŸš€ æ¸¬è©¦ Bot ä¸»ç¨‹å¼åˆå§‹åŒ–..."
        python -c "
        import sys; sys.path.append('.')
        from unittest.mock import patch, MagicMock, AsyncMock
        
        with patch('discord.ext.commands.Bot') as mock_bot_class:
            with patch('discord.Intents'):
                mock_bot = MagicMock()
                mock_bot.user = MagicMock()
                mock_bot.user.id = 123456789
                mock_bot.guilds = []
                mock_bot_class.return_value = mock_bot
                
                try:
                    from bot.main import PotatoBot
                    print('âœ… PotatoBot é¡åˆ¥å¯æ­£å¸¸å°å…¥')
                    print('âœ… ä¸»ç¨‹å¼çµæ§‹å®Œæ•´')
                except Exception as e:
                    print(f'âš ï¸ ä¸»ç¨‹å¼å•é¡Œ: {e}')
        "
