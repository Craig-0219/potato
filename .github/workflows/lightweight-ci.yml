name: ğŸš€ Essential Checks Only

on:
  workflow_run:
    workflows: ["ğŸ§  Smart Change Detection"]
    branches: [dev, main]
    types: [completed]
  workflow_dispatch:
    inputs:
      force_run:
        description: 'å¼·åˆ¶åŸ·è¡Œå®Œæ•´æª¢æŸ¥'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.10'

jobs:
  # ç²å–è®Šæ›´æª¢æ¸¬çµæœ
  get-change-info:
    name: ğŸ“‹ ç²å–è®Šæ›´åˆ†æçµæœ
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      change_type: ${{ steps.get-info.outputs.change_type }}
      impact_level: ${{ steps.get-info.outputs.impact_level }}
      should_run: ${{ steps.get-info.outputs.should_run }}
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ” ç²å–è®Šæ›´æª¢æ¸¬çµæœ
      id: get-info
      run: |
        # å¾è§¸ç™¼çš„ workflow run ä¸­ç²å–çµæœ
        if [ "${{ github.event_name }}" = "workflow_run" ]; then
          # æª¢æŸ¥å‰ä¸€å€‹ workflow (Smart Change Detection) çš„çµæœ
          PREV_WORKFLOW_ID="${{ github.event.workflow_run.id }}"
          echo "Previous workflow ID: $PREV_WORKFLOW_ID"
          
          # æ¨¡æ“¬ç²å–è®Šæ›´é¡å‹ (å¯¦éš›å¯¦ä½œä¸­æœƒå¾ API ç²å–)
          # é€™è£¡è¨­ç½®é è¨­å€¼ï¼Œå¯¦éš›æœƒæ ¹æ“š Smart Change Detection çš„è¼¸å‡º
          CHANGE_TYPE="code"
          IMPACT_LEVEL="medium"
          SHOULD_RUN="true"
        else
          # workflow_dispatch è§¸ç™¼ï¼Œå¼·åˆ¶åŸ·è¡Œæˆ–æ ¹æ“šè¼¸å…¥æ±ºå®š
          CHANGE_TYPE="${{ inputs.force_run == true && 'critical' || 'unknown' }}"
          IMPACT_LEVEL="high" 
          SHOULD_RUN="true"
        fi
        
        echo "change_type=$CHANGE_TYPE" >> $GITHUB_OUTPUT
        echo "impact_level=$IMPACT_LEVEL" >> $GITHUB_OUTPUT
        echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
        
        echo "ğŸ“Š è®Šæ›´æª¢æ¸¬çµæœ:"
        echo "  â€¢ è®Šæ›´é¡å‹: $CHANGE_TYPE"
        echo "  â€¢ å½±éŸ¿ç­‰ç´š: $IMPACT_LEVEL" 
        echo "  â€¢ æ˜¯å¦åŸ·è¡Œ: $SHOULD_RUN"

  essential-checks:
    name: ğŸ” å¿…è¦æ¢ä»¶æª¢æŸ¥
    needs: get-change-info
    runs-on: ubuntu-latest
    timeout-minutes: 8
    if: needs.get-change-info.outputs.should_run == 'true'

    env:
      TESTING: true
      DISCORD_TOKEN: test_token_comprehensive_validation_length_requirement_met_12345678_abcdefghijk
      DATABASE_URL: sqlite:///test.db
      DB_HOST: localhost
      DB_USER: test_user
      DB_PASSWORD: test_password_secure_testing_environment_only  # pragma: allowlist secret
      DB_NAME: test_database
      DB_PORT: 3306
      JWT_SECRET: test_jwt_secret_for_automated_testing_purposes_only  # pragma: allowlist secret
      REDIS_URL: redis://localhost:6379/0
      # OAuth æ¸¬è©¦è®Šæ•¸ (é¿å…è­¦å‘Š)
      DISCORD_CLIENT_ID: test_client_id_12345678
      DISCORD_CLIENT_SECRET: test_client_secret_testing_purposes_only  # pragma: allowlist secret
      DISCORD_REDIRECT_URI: http://localhost:8080/auth/discord/callback
      DISCORD_GUILD_ID: test_guild_id_987654321
      # API é…ç½®
      ENABLE_API_SERVER: true
      API_EXTERNAL_ACCESS: false
      LOCAL_API_HOST: 127.0.0.1
      LOCAL_API_PORT: 8080

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ å®‰è£å¿…è¦ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install discord.py>=2.5.0 aiomysql fastapi python-dotenv

    - name: ğŸ” èªæ³•é©—è­‰
      run: |
        echo "ğŸ” æª¢æŸ¥æ ¸å¿ƒæ–‡ä»¶èªæ³•..."
        python -m py_compile bot/main.py
        python -c "import ast; ast.parse(open('shared/config.py').read())"
        echo "âœ… èªæ³•æª¢æŸ¥é€šé"

    - name: ğŸ”§ é…ç½®è¼‰å…¥æ¸¬è©¦
      run: |
        echo "ğŸ”§ æ¸¬è©¦é…ç½®è¼‰å…¥..."
        python -c "
        import sys; sys.path.append('.')
        from shared.config import DISCORD_TOKEN, DB_HOST
        print('âœ… é…ç½®è¼‰å…¥æˆåŠŸ')
        "

    - name: ğŸš€ åŸºæœ¬åˆå§‹åŒ–æ¸¬è©¦
      run: |
        echo "ğŸš€ æ¸¬è©¦åŸºæœ¬åˆå§‹åŒ–..."
        python -c "
        import sys; sys.path.append('.')
        from unittest.mock import patch, MagicMock

        with patch('discord.ext.commands.Bot') as mock_bot:
            with patch('discord.Intents'):
                mock_bot.return_value = MagicMock()

                from shared.config import DISCORD_TOKEN, DB_HOST
                from shared.logger import logger
                from bot.db.database_manager import DatabaseManager
                print('âœ… æ ¸å¿ƒçµ„ä»¶åˆå§‹åŒ–æ­£å¸¸')
        "

    - name: ğŸ“Š ä¾è³´æª¢æŸ¥
      run: |
        echo "ğŸ“Š æª¢æŸ¥ä¾è³´..."
        test -f requirements.txt || { echo "âŒ requirements.txt ä¸å­˜åœ¨"; exit 1; }
        echo "âœ… ä¾è³´æª¢æŸ¥å®Œæˆ"

    - name: ğŸ§ª Cogs è¼‰å…¥æ¸¬è©¦
      if: needs.get-change-info.outputs.change_type != 'docs' && needs.get-change-info.outputs.change_type != 'config'
      run: |
        echo "ğŸ§ª æ¸¬è©¦é—œéµ Cogs è¼‰å…¥..."
        python -c "
        import sys; sys.path.append('.')
        from unittest.mock import patch, MagicMock

        with patch('discord.ext.commands.Bot') as mock_bot:
            with patch('discord.Intents'):
                mock_bot.return_value = MagicMock()

                # æ¸¬è©¦é—œéµ Cogs
                try:
                    from bot.cogs.ticket_core import TicketCore
                    print('âœ… TicketCore å¯è¼‰å…¥')
                except Exception as e:
                    print(f'âš ï¸ TicketCore è¼‰å…¥å•é¡Œ: {e}')

                try:
                    from bot.cogs.vote_core import VoteCore
                    print('âœ… VoteCore å¯è¼‰å…¥')
                except Exception as e:
                    print(f'âš ï¸ VoteCore è¼‰å…¥å•é¡Œ: {e}')

                try:
                    from bot.cogs.language_core import LanguageManager
                    print('âœ… LanguageManager å¯è¼‰å…¥')
                except Exception as e:
                    print(f'âš ï¸ LanguageManager è¼‰å…¥å•é¡Œ: {e}')
        "

    - name: ğŸ”§ æ ¸å¿ƒæœå‹™æ¸¬è©¦
      if: needs.get-change-info.outputs.change_type != 'docs'
      run: |
        echo "ğŸ”§ æ¸¬è©¦æ ¸å¿ƒæœå‹™åˆå§‹åŒ–..."
        python -c "
        import sys; sys.path.append('.')
        from unittest.mock import patch, MagicMock, AsyncMock

        # æ¸¬è©¦è³‡æ–™åº«ç®¡ç†å™¨
        try:
            from bot.db.database_manager import DatabaseManager
            print('âœ… DatabaseManager å¯åˆå§‹åŒ–')
        except Exception as e:
            print(f'âš ï¸ DatabaseManager å•é¡Œ: {e}')

        # æ¸¬è©¦å¿«å–ç®¡ç†å™¨
        try:
            from shared.cache_manager import MultiLevelCacheManager
            cache = MultiLevelCacheManager()
            print('âœ… MultiLevelCacheManager å¯åˆå§‹åŒ–')
        except Exception as e:
            print(f'âš ï¸ MultiLevelCacheManager å•é¡Œ: {e}')

        # æ¸¬è©¦é›¢ç·šæ¨¡å¼ç®¡ç†å™¨
        try:
            from shared.offline_mode_manager import OfflineModeManager
            offline_mgr = OfflineModeManager()
            print('âœ… OfflineModeManager å¯åˆå§‹åŒ–')
        except Exception as e:
            print(f'âš ï¸ OfflineModeManager å•é¡Œ: {e}')
        "

    - name: ğŸš€ Bot ä¸»ç¨‹å¼æ¸¬è©¦  
      if: needs.get-change-info.outputs.change_type == 'critical' || needs.get-change-info.outputs.change_type == 'code'
      run: |
        echo "ğŸš€ æ¸¬è©¦ Bot ä¸»ç¨‹å¼åˆå§‹åŒ–..."
        python -c "
        import sys; sys.path.append('.')
        from unittest.mock import patch, MagicMock, AsyncMock

        with patch('discord.ext.commands.Bot') as mock_bot_class:
            with patch('discord.Intents'):
                mock_bot = MagicMock()
                mock_bot.user = MagicMock()
                mock_bot.user.id = 123456789
                mock_bot.guilds = []
                mock_bot_class.return_value = mock_bot

                try:
                    from bot.main import PotatoBot
                    print('âœ… PotatoBot é¡åˆ¥å¯æ­£å¸¸å°å…¥')
                    print('âœ… ä¸»ç¨‹å¼çµæ§‹å®Œæ•´')
                except Exception as e:
                    print(f'âš ï¸ ä¸»ç¨‹å¼å•é¡Œ: {e}')
        "

    - name: ğŸ¯ API æœå‹™æ¸¬è©¦
      if: needs.get-change-info.outputs.change_type == 'api' || needs.get-change-info.outputs.change_type == 'critical'
      run: |
        echo "ğŸ¯ æ¸¬è©¦ API æœå‹™å’Œè·¯ç”±..."
        python -c "
        import sys; sys.path.append('.')
        from unittest.mock import patch, MagicMock

        # æ¸¬è©¦ FastAPI è·¯ç”±
        try:
            from bot.api.routes.tickets import router as tickets_router
            print('âœ… Tickets API è·¯ç”±å¯è¼‰å…¥')
        except Exception as e:
            print(f'âš ï¸ Tickets API å•é¡Œ: {e}')

        try:
            from bot.api.routes.system import router as system_router
            print('âœ… System API è·¯ç”±å¯è¼‰å…¥')
        except Exception as e:
            print(f'âš ï¸ System API å•é¡Œ: {e}')

        try:
            from bot.api.routes.analytics import router as analytics_router
            print('âœ… Analytics API è·¯ç”±å¯è¼‰å…¥')
        except Exception as e:
            print(f'âš ï¸ Analytics API å•é¡Œ: {e}')

        # æ¸¬è©¦ API æ‡‰ç”¨
        try:
            from bot.api.app import create_app
            print('âœ… FastAPI æ‡‰ç”¨å¯å‰µå»º')
        except Exception as e:
            print(f'âš ï¸ FastAPI æ‡‰ç”¨å•é¡Œ: {e}')
        "

    - name: ğŸ—„ï¸ è³‡æ–™å­˜å–å±¤æ¸¬è©¦
      run: |
        echo "ğŸ—„ï¸ æ¸¬è©¦è³‡æ–™å­˜å–å±¤ (DAO)..."
        python -c "
        import sys; sys.path.append('.')
        from unittest.mock import patch, MagicMock, AsyncMock

        # æ¸¬è©¦ DAO é¡åˆ¥ (ç›´æ¥åœ¨ db ç›®éŒ„ä¸‹)
        try:
            from bot.db.ticket_dao import TicketDAO
            print('âœ… TicketDAO å¯åˆå§‹åŒ–')
        except Exception as e:
            print(f'âš ï¸ TicketDAO å•é¡Œ: {e}')

        try:
            from bot.db.vote_dao import VoteDAO
            print('âœ… VoteDAO å¯åˆå§‹åŒ–')
        except Exception as e:
            print(f'âš ï¸ VoteDAO å•é¡Œ: {e}')

        try:
            from bot.db.language_dao import LanguageDAO
            print('âœ… LanguageDAO å¯åˆå§‹åŒ–')
        except Exception as e:
            print(f'âš ï¸ LanguageDAO å•é¡Œ: {e}')

        try:
            from bot.db.base_dao import BaseDAO
            print('âœ… BaseDAO åŸºç¤é¡åˆ¥å¯åˆå§‹åŒ–')
        except Exception as e:
            print(f'âš ï¸ BaseDAO å•é¡Œ: {e}')

        try:
            from bot.db.cached_ticket_dao import CachedTicketDAO
            print('âœ… CachedTicketDAO å¯åˆå§‹åŒ–')
        except Exception as e:
            print(f'âš ï¸ CachedTicketDAO å•é¡Œ: {e}')

        try:
            from bot.db.security_dao import SecurityDAO
            print('âœ… SecurityDAO å¯åˆå§‹åŒ–')
        except Exception as e:
            print(f'âš ï¸ SecurityDAO å•é¡Œ: {e}')
        "

    - name: ğŸ® æœå‹™ç®¡ç†å™¨æ¸¬è©¦
      run: |
        echo "ğŸ® æ¸¬è©¦æœå‹™ç®¡ç†å™¨å±¤..."
        python -c "
        import sys; sys.path.append('.')
        from unittest.mock import patch, MagicMock, AsyncMock

        # æ¸¬è©¦å„ç¨®æœå‹™ç®¡ç†å™¨
        try:
            from bot.services.ticket_manager import TicketManager
            print('âœ… TicketManager å¯åˆå§‹åŒ–')
        except Exception as e:
            print(f'âš ï¸ TicketManager å•é¡Œ: {e}')

        try:
            from bot.services.vote_manager import VoteManager
            print('âœ… VoteManager å¯åˆå§‹åŒ–')
        except Exception as e:
            print(f'âš ï¸ VoteManager å•é¡Œ: {e}')

        try:
            from bot.services.economy_manager import EconomyManager
            print('âœ… EconomyManager å¯åˆå§‹åŒ–')
        except Exception as e:
            print(f'âš ï¸ EconomyManager å•é¡Œ: {e}')

        try:
            from bot.services.notification_manager import NotificationManager
            print('âœ… NotificationManager å¯åˆå§‹åŒ–')
        except Exception as e:
            print(f'âš ï¸ NotificationManager å•é¡Œ: {e}')
        "

    - name: ğŸ”§ å·¥å…·å’Œè¼”åŠ©æ¨¡çµ„æ¸¬è©¦
      run: |
        echo "ğŸ”§ æ¸¬è©¦å·¥å…·å’Œè¼”åŠ©æ¨¡çµ„..."
        python -c "
        import sys; sys.path.append('.')

        # æ¸¬è©¦å·¥å…·æ¨¡çµ„
        try:
            from bot.utils.time_utils import format_time_delta
            print('âœ… time_utils å·¥å…·å¯ä½¿ç”¨')
        except Exception as e:
            print(f'âš ï¸ time_utils å•é¡Œ: {e}')

        try:
            from bot.utils.embed_builder import EmbedBuilder
            print('âœ… EmbedBuilder å·¥å…·å¯ä½¿ç”¨')
        except Exception as e:
            print(f'âš ï¸ EmbedBuilder å•é¡Œ: {e}')

        try:
            from bot.utils.validator import validate_ticket_data
            print('âœ… validator å·¥å…·å¯ä½¿ç”¨')
        except Exception as e:
            print(f'âš ï¸ validator å•é¡Œ: {e}')

        # æ¸¬è©¦å…±äº«æ¨¡çµ„
        try:
            from shared.logger import logger
            logger.info('æ¸¬è©¦æ—¥èªŒè¨˜éŒ„')
            print('âœ… logger ç³»çµ±æ­£å¸¸å·¥ä½œ')
        except Exception as e:
            print(f'âš ï¸ logger å•é¡Œ: {e}')
        "

    - name: ğŸ“Š æ•´åˆåŠŸèƒ½æ¸¬è©¦
      run: |
        echo "ğŸ“Š åŸ·è¡Œæ•´åˆåŠŸèƒ½æ¸¬è©¦..."
        python -c "
        import sys; sys.path.append('.')
        from unittest.mock import patch, MagicMock, AsyncMock

        # æ•´åˆæ¸¬è©¦ - æ¨¡æ“¬ Bot å®Œæ•´å•Ÿå‹•æµç¨‹
        with patch('discord.ext.commands.Bot') as mock_bot_class:
            with patch('discord.Intents'):
                with patch('aiomysql.connect', new_callable=AsyncMock):
                    mock_bot = MagicMock()
                    mock_bot.user = MagicMock()
                    mock_bot.user.id = 123456789
                    mock_bot.guilds = []
                    mock_bot_class.return_value = mock_bot

                    try:
                        # æ¸¬è©¦å®Œæ•´çš„ Bot åˆå§‹åŒ–éˆ
                        from bot.main import PotatoBot
                        from bot.db.database_manager import DatabaseManager
                        from shared.cache_manager import MultiLevelCacheManager

                        print('âœ… å®Œæ•´åˆå§‹åŒ–éˆæ¸¬è©¦é€šé')
                        print('âœ… æ‰€æœ‰æ ¸å¿ƒçµ„ä»¶å¯å”åŒå·¥ä½œ')

                    except Exception as e:
                        print(f'âš ï¸ æ•´åˆæ¸¬è©¦å•é¡Œ: {e}')
                        import traceback
                        print(f'è©³ç´°éŒ¯èª¤: {traceback.format_exc()[:200]}...')
        "

    - name: ğŸ“‹ æ™ºèƒ½åŸ·è¡Œæ‘˜è¦
      if: always()
      run: |
        echo "ğŸ§  æ™ºèƒ½ CI åŸ·è¡Œæ‘˜è¦"
        echo "======================"
        echo "è®Šæ›´é¡å‹: ${{ needs.get-change-info.outputs.change_type }}"
        echo "å½±éŸ¿ç­‰ç´š: ${{ needs.get-change-info.outputs.impact_level }}"
        echo ""
        
        CHANGE_TYPE="${{ needs.get-change-info.outputs.change_type }}"
        
        echo "ğŸ“Š åŸ·è¡Œçš„æª¢æŸ¥é …ç›®:"
        echo "âœ… èªæ³•é©—è­‰ - åŸºç¤å¿…è¦æª¢æŸ¥"
        echo "âœ… é…ç½®è¼‰å…¥æ¸¬è©¦ - åŸºç¤å¿…è¦æª¢æŸ¥"
        echo "âœ… åŸºæœ¬åˆå§‹åŒ–æ¸¬è©¦ - åŸºç¤å¿…è¦æª¢æŸ¥"
        echo "âœ… ä¾è³´æª¢æŸ¥ - åŸºç¤å¿…è¦æª¢æŸ¥"
        
        if [[ "$CHANGE_TYPE" != "docs" && "$CHANGE_TYPE" != "config" ]]; then
          echo "âœ… Cogs è¼‰å…¥æ¸¬è©¦ - ä»£ç¢¼è®Šæ›´æª¢æŸ¥"
        else
          echo "â­ï¸  Cogs è¼‰å…¥æ¸¬è©¦ - è·³é (æ–‡æª”/é…ç½®è®Šæ›´)"
        fi
        
        if [[ "$CHANGE_TYPE" != "docs" ]]; then
          echo "âœ… æ ¸å¿ƒæœå‹™æ¸¬è©¦ - éæ–‡æª”è®Šæ›´æª¢æŸ¥"
        else
          echo "â­ï¸  æ ¸å¿ƒæœå‹™æ¸¬è©¦ - è·³é (æ–‡æª”è®Šæ›´)"
        fi
        
        if [[ "$CHANGE_TYPE" == "critical" || "$CHANGE_TYPE" == "code" ]]; then
          echo "âœ… Bot ä¸»ç¨‹å¼æ¸¬è©¦ - é—œéµ/ä»£ç¢¼è®Šæ›´æª¢æŸ¥"
        else
          echo "â­ï¸  Bot ä¸»ç¨‹å¼æ¸¬è©¦ - è·³é (éé—œéµè®Šæ›´)"
        fi
        
        if [[ "$CHANGE_TYPE" == "api" || "$CHANGE_TYPE" == "critical" ]]; then
          echo "âœ… API æœå‹™æ¸¬è©¦ - API/é—œéµè®Šæ›´æª¢æŸ¥"
        else
          echo "â­ï¸  API æœå‹™æ¸¬è©¦ - è·³é (é API è®Šæ›´)"
        fi
        
        echo "âœ… è³‡æ–™å­˜å–å±¤æ¸¬è©¦ - å®Œæ•´æª¢æŸ¥"
        echo "âœ… æœå‹™ç®¡ç†å™¨æ¸¬è©¦ - å®Œæ•´æª¢æŸ¥"  
        echo "âœ… å·¥å…·å’Œè¼”åŠ©æ¨¡çµ„æ¸¬è©¦ - å®Œæ•´æª¢æŸ¥"
        echo "âœ… æ•´åˆåŠŸèƒ½æ¸¬è©¦ - å®Œæ•´æª¢æŸ¥"
        
        echo ""
        echo "ğŸ’¡ æ™ºèƒ½è·³éæ©Ÿåˆ¶å·²å•Ÿå‹•ï¼Œæ ¹æ“šè®Šæ›´é¡å‹å„ªåŒ–åŸ·è¡Œæ™‚é–“!"
