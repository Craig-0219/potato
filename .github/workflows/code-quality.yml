name: ğŸ¨ Code Quality Checks

on:
  pull_request:
    branches: [main, dev]
    paths:
      - '**.py'
      - 'pyproject.toml'
      - 'requirements*.txt'
  push:
    branches: [main, dev]
    paths:
      - '**.py'
      - 'pyproject.toml'
      - 'requirements*.txt'

permissions:
  contents: write  # éœ€è¦å¯«å…¥æ¬Šé™ä¾†æ¨é€ä¿®å¾©
  checks: write
  pull-requests: write

env:
  PYTHON_VERSION: '3.10'

jobs:
  format-and-lint:
    name: ğŸ¨ æ ¼å¼åŒ–å’Œèªæ³•æª¢æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 12

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ è¨­ç½® Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ å®‰è£æ ¼å¼åŒ–å·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install black>=24.8.0 "isort[colors]>=5.13.2" flake8>=7.1.1 mypy>=1.11.2 autoflake>=2.0.0
        pip install -r requirements.txt

    - name: ğŸ§¹ æª¢æŸ¥æœªä½¿ç”¨çš„å°å…¥
      run: |
        echo "ğŸ§¹ æª¢æŸ¥æœªä½¿ç”¨çš„å°å…¥å’Œè®Šé‡..."
        autoflake --check --recursive --remove-all-unused-imports --remove-unused-variables bot/ shared/

    - name: ğŸ¨ ä»£ç¢¼æ ¼å¼æª¢æŸ¥ (Black)
      run: |
        echo "ğŸ¨ æª¢æŸ¥ä»£ç¢¼æ ¼å¼..."
        black --check --diff --color .

    - name: ğŸ“š å°å…¥æ’åºæª¢æŸ¥ (isort)
      run: |
        echo "ğŸ“š æª¢æŸ¥å°å…¥æ’åº..."
        isort --check --diff --color .

    - name: ğŸ” èªæ³•å’Œé¢¨æ ¼æª¢æŸ¥ (flake8)
      run: |
        echo "ğŸ” åŸ·è¡Œèªæ³•å’Œé¢¨æ ¼æª¢æŸ¥..."
        # ä½¿ç”¨å…§è¯é…ç½®ï¼Œé¿å…ä¾è³´ .flake8 æª”æ¡ˆ
        flake8 . --statistics --tee --output-file=flake8-report.txt \
          --max-line-length=88 \
          --extend-ignore=E203,E501,W503 \
          --exclude=.git,__pycache__,build,dist,.venv

    - name: ğŸ”¬ é¡å‹æª¢æŸ¥ (mypy)
      run: |
        echo "ğŸ”¬ åŸ·è¡Œé¡å‹æª¢æŸ¥..."
        mypy bot/ shared/ --no-error-summary || true
        # æš«æ™‚å…è¨±é¡å‹æª¢æŸ¥å¤±æ•—ï¼Œåƒ…ä½œè­¦å‘Š

    - name: ğŸ“Š ç”Ÿæˆä»£ç¢¼å“è³ªå ±å‘Š
      if: always()
      run: |
        echo "ğŸ“Š ä»£ç¢¼å“è³ªæª¢æŸ¥æ‘˜è¦"
        echo "===================="

        if [ -f flake8-report.txt ]; then
          echo "ğŸ” Flake8 çµæœ:"
          tail -n 10 flake8-report.txt
        fi

        echo ""
        echo "âœ¨ å¦‚æœæª¢æŸ¥å¤±æ•—ï¼Œè«‹é‹è¡Œä»¥ä¸‹å‘½ä»¤ä¿®å¾©:"
        echo "black ."
        echo "isort ."
        echo "autoflake --in-place --recursive --remove-all-unused-imports --remove-unused-variables bot/ shared/"

    - name: ğŸ“¤ ä¸Šå‚³å“è³ªå ±å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: code-quality-reports
        path: |
          flake8-report.txt
        retention-days: 7

  format-fix:
    name: ğŸ”§ è‡ªå‹•æ ¼å¼åŒ–ä¿®å¾© (åƒ…é™ dev åˆ†æ”¯)
    runs-on: ubuntu-latest
    if: failure() && github.ref == 'refs/heads/dev' && github.event_name == 'push'
    needs: format-and-lint

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ å®‰è£å·¥å…·
      run: |
        pip install black "isort[colors]" autoflake

    - name: ğŸ”§ è‡ªå‹•ä¿®å¾©æ ¼å¼å•é¡Œ
      run: |
        echo "ğŸ”§ è‡ªå‹•ä¿®å¾©ä»£ç¢¼æ ¼å¼..."
        autoflake --in-place --recursive --remove-all-unused-imports --remove-unused-variables bot/ shared/
        black .
        isort .

    - name: ğŸ“¤ æäº¤ä¿®å¾©
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        if ! git diff --quiet; then
          echo "ğŸ“¤ ç™¼ç¾æ ¼å¼å•é¡Œï¼Œè‡ªå‹•ä¿®å¾©ä¸­..."
          git add .
          git commit -m "ğŸ¨ è‡ªå‹•æ ¼å¼åŒ–ä¿®å¾©

          ğŸ¤– ç”± GitHub Actions è‡ªå‹•åŸ·è¡Œä»£ç¢¼æ ¼å¼åŒ–
          â€¢ blackã€isortã€autoflake å·¥å…·è‡ªå‹•ä¿®å¾©

          Generated with Claude Code
          Co-Authored-By: GitHub Actions <action@github.com>"
          git push
          echo "âœ… æ ¼å¼åŒ–ä¿®å¾©å®Œæˆ"
        else
          echo "âœ… ç„¡éœ€æ ¼å¼åŒ–ä¿®å¾©"
        fi
