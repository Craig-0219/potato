name: ğŸ” Code Quality

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'

jobs:
  code-quality:
    name: ğŸ¯ ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .[dev]
    
    - name: ğŸ“Š Cache Quality Tools
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~/.cache/pre-commit
        key: quality-${{ runner.os }}-${{ hashFiles('pyproject.toml', '.pre-commit-config.yaml') }}
    
    - name: ğŸ” Black - ç¨‹å¼ç¢¼æ ¼å¼æª¢æŸ¥
      run: |
        echo "ğŸ¨ æª¢æŸ¥ç¨‹å¼ç¢¼æ ¼å¼..."
        black --check --diff bot/ shared/
    
    - name: ğŸ”„ isort - Import æ’åºæª¢æŸ¥
      run: |
        echo "ğŸ“ æª¢æŸ¥ import æ’åº..."
        isort --check-only --diff bot/ shared/
    
    - name: ğŸ¾ Flake8 - ç¨‹å¼ç¢¼é¢¨æ ¼æª¢æŸ¥
      run: |
        echo "âœ¨ æª¢æŸ¥ç¨‹å¼ç¢¼é¢¨æ ¼..."
        flake8 bot/ shared/
    
    - name: ğŸ”¬ MyPy - å‹åˆ¥æª¢æŸ¥
      run: |
        echo "ğŸ›¡ï¸ åŸ·è¡Œå‹åˆ¥æª¢æŸ¥..."
        mypy bot/ shared/ || echo "âš ï¸ å‹åˆ¥æª¢æŸ¥ç™¼ç¾å•é¡Œï¼Œä½†ä¸é˜»æ–·æµç¨‹"
      continue-on-error: true
    
    - name: ğŸ“ è¤‡é›œåº¦åˆ†æ
      run: |
        echo "ğŸ“Š åˆ†æç¨‹å¼ç¢¼è¤‡é›œåº¦..."
        # ä½¿ç”¨ radon åˆ†æè¤‡é›œåº¦
        pip install radon
        radon cc bot/ shared/ -a -nb
        radon mi bot/ shared/ -nb
    
    - name: ğŸ“‹ ç¨‹å¼ç¢¼å“è³ªå ±å‘Š
      if: always()
      run: |
        echo "ğŸ“Š ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥å®Œæˆ!"
        echo ""
        echo "âœ… å·²å®Œæˆçš„æª¢æŸ¥:"
        echo "  â€¢ Black æ ¼å¼æª¢æŸ¥"
        echo "  â€¢ isort import æ’åº"
        echo "  â€¢ Flake8 é¢¨æ ¼æª¢æŸ¥"
        echo "  â€¢ MyPy å‹åˆ¥æª¢æŸ¥ (è­¦å‘Š)"
        echo "  â€¢ è¤‡é›œåº¦åˆ†æ"
        echo ""
        echo "ğŸ’¡ æç¤º: åœ¨æœ¬åœ°åŸ·è¡Œ 'make format' å¯è‡ªå‹•ä¿®å¾©æ ¼å¼å•é¡Œ"

  documentation-check:
    name: ğŸ“š æ–‡ä»¶å“è³ªæª¢æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ” æª¢æŸ¥æ–‡ä»¶å®Œæ•´æ€§
      run: |
        echo "ğŸ“‹ æª¢æŸ¥å¿…è¦æ–‡ä»¶..."
        
        # æª¢æŸ¥å¿…è¦æ–‡ä»¶å­˜åœ¨
        required_files=(
          "README.md"
          "pyproject.toml"
          "requirements.txt"
          ".gitignore"
        )
        
        for file in "${required_files[@]}"; do
          if [[ -f "$file" ]]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            exit 1
          fi
        done
    
    - name: ğŸ“– Markdown æ ¼å¼æª¢æŸ¥
      run: |
        echo "ğŸ“ æª¢æŸ¥ Markdown æ ¼å¼..."
        
        # æª¢æŸ¥ README åŸºæœ¬çµæ§‹
        if grep -q "# " README.md; then
          echo "âœ… README åŒ…å«æ¨™é¡Œ"
        else
          echo "âš ï¸ README ç¼ºå°‘ä¸»æ¨™é¡Œ"
        fi
        
        if grep -q "## " README.md; then
          echo "âœ… README åŒ…å«ç« ç¯€"
        else
          echo "âš ï¸ README ç¼ºå°‘ç« ç¯€çµæ§‹"
        fi
    
    - name: ğŸ·ï¸ ç‰ˆæœ¬ä¸€è‡´æ€§æª¢æŸ¥
      run: |
        echo "ğŸ”¢ æª¢æŸ¥ç‰ˆæœ¬ä¸€è‡´æ€§..."
        
        # å¾ pyproject.toml ç²å–ç‰ˆæœ¬
        VERSION=$(grep "version = " pyproject.toml | cut -d '"' -f 2)
        echo "ğŸ“¦ å°ˆæ¡ˆç‰ˆæœ¬: $VERSION"
        
        # æª¢æŸ¥å…¶ä»–æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å¼•ç”¨
        if grep -q "$VERSION" README.md; then
          echo "âœ… README ç‰ˆæœ¬ä¸€è‡´"
        else
          echo "âš ï¸ README ç‰ˆæœ¬å¯èƒ½éœ€è¦æ›´æ–°"
        fi

  dependency-check:
    name: ğŸ”’ ä¾è³´å®‰å…¨æª¢æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ” æª¢æŸ¥ä¾è³´æ¼æ´
      run: |
        echo "ğŸ›¡ï¸ åŸ·è¡Œä¾è³´å®‰å…¨æƒæ..."
        
        pip install "safety<3.6.0" "typer<0.17" pip-audit
        
        # ä½¿ç”¨ safety æª¢æŸ¥å·²çŸ¥æ¼æ´
        echo "ğŸ”’ Safety å®‰å…¨æª¢æŸ¥..."
        safety check --json || echo "âš ï¸ Safety ç™¼ç¾æ½›åœ¨å®‰å…¨å•é¡Œ"
        
        # ä½¿ç”¨ pip-audit æª¢æŸ¥
        echo "ğŸ” Pip-audit æª¢æŸ¥..."
        pip-audit --format=json || echo "âš ï¸ Pip-audit ç™¼ç¾æ½›åœ¨å•é¡Œ"
    
    - name: ğŸ“Š ä¾è³´åˆ†æå ±å‘Š
      if: always()
      run: |
        echo "ğŸ“‹ ä¾è³´å®‰å…¨æª¢æŸ¥å®Œæˆ!"
        echo ""
        echo "ğŸ” å·²åŸ·è¡Œçš„æª¢æŸ¥:"
        echo "  â€¢ Safety å·²çŸ¥æ¼æ´æƒæ"
        echo "  â€¢ Pip-audit å®‰å…¨å¯©è¨ˆ"
        echo ""
        echo "ğŸ’¡ å»ºè­°å®šæœŸæ›´æ–°ä¾è³´å¥—ä»¶ä»¥ä¿®å¾©å®‰å…¨æ¼æ´"