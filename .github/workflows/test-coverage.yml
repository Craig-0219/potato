name: ğŸ§ª Test Coverage & Quality

on:
  pull_request:
    branches: [main, dev]
    paths:
      - '**.py'
      - 'tests/**'
      - 'pyproject.toml'
      - 'requirements*.txt'
  push:
    branches: [main, dev]
    paths:
      - '**.py'
      - 'tests/**'
      - 'pyproject.toml'
      - 'requirements*.txt'
  workflow_dispatch:
    inputs:
      test_level:
        description: 'æ¸¬è©¦å±¤ç´š'
        required: false
        default: 'all'
        type: choice
        options:
          - unit
          - integration
          - e2e
          - all

env:
  PYTHON_VERSION: '3.10'
  COVERAGE_THRESHOLD: 60

jobs:
  test-matrix:
    name: ğŸ§ª æ¸¬è©¦çŸ©é™£
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      matrix:
        python-version: ['3.10', '3.11']
        test-type: [unit, integration]

    # æ¸¬è©¦æœå‹™
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password  # pragma: allowlist secret
          MYSQL_DATABASE: test_database
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password  # pragma: allowlist secret
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    env:
      # æ¸¬è©¦ç’°å¢ƒè®Šæ•¸
      TESTING: true
      DISCORD_TOKEN: test_token_comprehensive_validation_length_requirement_met_12345678_abcdefghijk
      DATABASE_URL: mysql://test_user:test_password@localhost:3306/test_database  # pragma: allowlist secret
      DB_HOST: localhost
      DB_USER: test_user
      DB_PASSWORD: test_password  # pragma: allowlist secret
      DB_NAME: test_database
      DB_PORT: 3306
      JWT_SECRET: test_jwt_secret_for_automated_testing_purposes_only  # pragma: allowlist secret
      REDIS_URL: redis://127.0.0.1:6379/0
      # OAuth å’Œå…¶ä»–é…ç½®
      DISCORD_CLIENT_ID: test_client_id_12345678
      DISCORD_CLIENT_SECRET: test_client_secret_testing_purposes_only  # pragma: allowlist secret
      DISCORD_REDIRECT_URI: http://localhost:8080/auth/discord/callback
      DISCORD_GUILD_ID: test_guild_id_987654321
      ENABLE_API_SERVER: true
      API_EXTERNAL_ACCESS: false

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest>=8.0.0 pytest-asyncio>=0.23.0 pytest-cov>=4.0.0
        pip install pytest-xdist pytest-mock coverage[toml] pytest-timeout>=2.3.1
        
        # ç¢ºä¿é—œéµä¾è³´å·²å®‰è£
        pip install redis>=5.0.1
        
        # å®‰è£ redis-tools ç”¨æ–¼æ•´åˆæ¸¬è©¦
        sudo apt-get update
        sudo apt-get install -y redis-tools

    - name: â³ ç­‰å¾…æœå‹™å•Ÿå‹•
      if: matrix.test-type == 'integration'
      run: |
        echo "â³ ç­‰å¾…è³‡æ–™åº«å’Œ Redis æœå‹™å•Ÿå‹•..."
        sleep 15

        # é©—è­‰æœå‹™é€£æ¥
        mysql -h 127.0.0.1 -u test_user -ptest_password -e "SELECT 1" test_database
        redis-cli -h 127.0.0.1 ping

    - name: ğŸ§ª åŸ·è¡Œå–®å…ƒæ¸¬è©¦
      if: matrix.test-type == 'unit'
      run: |
        echo "ğŸ§ª åŸ·è¡Œå–®å…ƒæ¸¬è©¦..."
        pytest tests/unit/ \
          -v \
          --tb=short \
          --cov=bot \
          --cov=shared \
          --cov-report=html:htmlcov-${{ matrix.python-version }}-unit \
          --cov-report=xml:coverage-${{ matrix.python-version }}-unit.xml \
          --cov-report=term-missing \
          --junit-xml=junit-${{ matrix.python-version }}-unit.xml \
          --maxfail=5 \
          -n auto

    - name: ğŸ”— åŸ·è¡Œæ•´åˆæ¸¬è©¦
      if: matrix.test-type == 'integration'
      run: |
        echo "ğŸ”— åŸ·è¡Œæ•´åˆæ¸¬è©¦..."
        pytest tests/integration/ \
          -v \
          --tb=short \
          --cov=bot \
          --cov=shared \
          --cov-append \
          --cov-report=html:htmlcov-${{ matrix.python-version }}-integration \
          --cov-report=xml:coverage-${{ matrix.python-version }}-integration.xml \
          --junit-xml=junit-${{ matrix.python-version }}-integration.xml \
          --maxfail=3 \
          -m "not slow" \
          -x

    - name: ğŸ“Š è¦†è“‹ç‡å ±å‘Š
      if: always()
      run: |
        echo "ğŸ“Š ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š..."
        coverage report --show-missing
        coverage json -o coverage-${{ matrix.python-version }}-${{ matrix.test-type }}.json

    - name: ğŸ“¤ ä¸Šå‚³è¦†è“‹ç‡åˆ° Codecov
      if: matrix.python-version == '3.10'
      uses: codecov/codecov-action@v4
      with:
        file: coverage-${{ matrix.python-version }}-${{ matrix.test-type }}.xml
        flags: ${{ matrix.test-type }}-tests
        name: codecov-${{ matrix.test-type }}-${{ matrix.python-version }}
        fail_ci_if_error: false

    - name: ğŸ“¤ ä¸Šå‚³æ¸¬è©¦å ±å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports-${{ matrix.python-version }}-${{ matrix.test-type }}
        path: |
          htmlcov-${{ matrix.python-version }}-${{ matrix.test-type }}/
          coverage-${{ matrix.python-version }}-${{ matrix.test-type }}.xml
          coverage-${{ matrix.python-version }}-${{ matrix.test-type }}.json
          junit-${{ matrix.python-version }}-${{ matrix.test-type }}.xml
        retention-days: 30

  # E2E æ¸¬è©¦ (ç«¯åˆ°ç«¯)
  e2e-tests:
    name: ğŸš€ ç«¯åˆ°ç«¯æ¸¬è©¦
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.test_level == 'e2e' || github.event.inputs.test_level == 'all'))
    timeout-minutes: 30

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: test_database_e2e
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping --silent" --health-interval=10s --health-timeout=5s --health-retries=3

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    env:
      TESTING: true
      E2E_TESTING: true
      DISCORD_TOKEN: test_token_comprehensive_validation_length_requirement_met_12345678_abcdefghijk
      DATABASE_URL: mysql://test_user:test_password@localhost:3306/test_database_e2e
      DB_HOST: localhost
      DB_USER: test_user
      DB_PASSWORD: test_password
      DB_NAME: test_database_e2e
      DB_PORT: 3306
      REDIS_URL: redis://127.0.0.1:6379/1

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        pip install -e ".[dev,test]"

    - name: â³ æº–å‚™ E2E ç’°å¢ƒ
      run: |
        echo "â³ æº–å‚™ç«¯åˆ°ç«¯æ¸¬è©¦ç’°å¢ƒ..."
        sleep 20

        # åˆå§‹åŒ–æ¸¬è©¦è³‡æ–™åº«
        mysql -h 127.0.0.1 -u test_user -ptest_password -e "CREATE DATABASE IF NOT EXISTS test_database_e2e;" || true

    - name: ğŸš€ åŸ·è¡Œ E2E æ¸¬è©¦
      run: |
        echo "ğŸš€ åŸ·è¡Œç«¯åˆ°ç«¯æ¸¬è©¦..."
        pytest tests/e2e/ \
          -v \
          --tb=long \
          --junit-xml=junit-e2e.xml \
          --maxfail=1 \
          -s \
          --timeout 300

    - name: ğŸ“¤ ä¸Šå‚³ E2E å ±å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: e2e-test-reports
        path: |
          junit-e2e.xml
        retention-days: 30

  # è¦†è“‹ç‡åŒ¯ç¸½å’Œå“è³ªé–€æª»
  coverage-summary:
    name: ğŸ“Š è¦†è“‹ç‡æ‘˜è¦
    runs-on: ubuntu-latest
    needs: test-matrix
    if: always()

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ å®‰è£è¦†è“‹ç‡å·¥å…·
      run: |
        pip install coverage[toml] jq

    - name: ğŸ“¥ ä¸‹è¼‰è¦†è“‹ç‡å ±å‘Š
      uses: actions/download-artifact@v4
      with:
        pattern: test-reports-*
        path: coverage-reports/
        merge-multiple: true

    - name: ğŸ“Š åˆä½µè¦†è“‹ç‡æ•¸æ“š
      run: |
        echo "ğŸ“Š è™•ç†è¦†è“‹ç‡å ±å‘Š..."
        cd coverage-reports/

        # åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„è¦†è“‹ç‡æ–‡ä»¶
        echo "ğŸ“ å¯ç”¨çš„è¦†è“‹ç‡æ–‡ä»¶:"
        ls -la coverage-*.xml 2>/dev/null || echo "ç„¡ XML æ–‡ä»¶"
        ls -la coverage-*.json 2>/dev/null || echo "ç„¡ JSON æ–‡ä»¶"

        # å˜—è©¦å¾ç¾æœ‰ XML æ–‡ä»¶åˆä½µè¦†è“‹ç‡
        if ls coverage-*.xml 1> /dev/null 2>&1; then
          echo "ğŸ“Š è™•ç† XML è¦†è“‹ç‡æ–‡ä»¶..."
          # ä½¿ç”¨ç¬¬ä¸€å€‹ XML æ–‡ä»¶ä½œç‚ºåŸºæº–
          FIRST_XML=$(ls coverage-*.xml | head -1)
          echo "ä½¿ç”¨æ–‡ä»¶: $FIRST_XML"
          
          # æå–è¦†è“‹ç‡ç™¾åˆ†æ¯” (å¾ XML ä¸­)
          COVERAGE_PERCENT=$(python3 -c "import xml.etree.ElementTree as ET; tree = ET.parse('$FIRST_XML'); root = tree.getroot(); coverage = root.attrib.get('line-rate', '0'); print(int(float(coverage) * 100))" 2>/dev/null || echo "0")
        else
          echo "âš ï¸ æœªæ‰¾åˆ°å¯ç”¨çš„è¦†è“‹ç‡æ–‡ä»¶"
          COVERAGE_PERCENT=0
        fi

        echo "è¨ˆç®—å¾—åˆ°è¦†è“‹ç‡: ${COVERAGE_PERCENT}%"

        # ç”Ÿæˆçµ±è¨ˆæ‘˜è¦
        echo "## ğŸ“Š æ¸¬è©¦è¦†è“‹ç‡æ‘˜è¦" > final-summary.md
        echo "" >> final-summary.md
        echo "**ç¸½è¦†è“‹ç‡**: ${COVERAGE_PERCENT}%" >> final-summary.md
        echo "**é–€æª»è¦æ±‚**: ${COVERAGE_THRESHOLD}%" >> final-summary.md
        echo "" >> final-summary.md

        if [ "$COVERAGE_PERCENT" -ge "${COVERAGE_THRESHOLD}" ]; then
          echo "âœ… **ç‹€æ…‹**: é€šéè¦†è“‹ç‡è¦æ±‚" >> final-summary.md
          echo "COVERAGE_STATUS=pass" >> $GITHUB_ENV
        else
          echo "âŒ **ç‹€æ…‹**: æœªé”è¦†è“‹ç‡é–€æª»" >> final-summary.md
          echo "COVERAGE_STATUS=fail" >> $GITHUB_ENV
        fi

        echo "COVERAGE_PERCENT=$COVERAGE_PERCENT" >> $GITHUB_ENV

        echo "" >> final-summary.md
        echo "### å¯ç”¨å ±å‘Š" >> final-summary.md
        echo "- XML å ±å‘Š: $(ls coverage-*.xml 2>/dev/null | wc -l) å€‹" >> final-summary.md
        echo "- JSON å ±å‘Š: $(ls coverage-*.json 2>/dev/null | wc -l) å€‹" >> final-summary.md

    - name: ğŸ’¬ è¦†è“‹ç‡è©•è«– (PR)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');

          let summary = '';
          try {
            summary = fs.readFileSync('coverage-reports/final-summary.md', 'utf8');
          } catch (e) {
            summary = 'âŒ ç„¡æ³•è®€å–è¦†è“‹ç‡å ±å‘Š';
          }

          const comment = `## ğŸ§ª æ¸¬è©¦è¦†è“‹ç‡å ±å‘Š

          ${summary}

          ---

          ğŸ“‹ **CI/CD ç‹€æ…‹**:
          - âœ… æ¸¬è©¦åŸ·è¡Œå®Œæˆ
          - ${process.env.COVERAGE_STATUS === 'pass' ? 'âœ…' : 'âŒ'} è¦†è“‹ç‡: ${process.env.COVERAGE_PERCENT}%

          ğŸ“Š æŸ¥çœ‹è©³ç´°å ±å‘Šè«‹æª¢æŸ¥ Artifacts ä¸­çš„ \`test-reports\`
          `;

          // æŸ¥æ‰¾ç¾æœ‰è©•è«–
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.data.find(comment =>
            comment.user.type === 'Bot' && comment.body.includes('ğŸ§ª æ¸¬è©¦è¦†è“‹ç‡å ±å‘Š')
          );

          if (botComment) {
            // æ›´æ–°ç¾æœ‰è©•è«–
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: comment
            });
          } else {
            // å‰µå»ºæ–°è©•è«–
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }

    - name: ğŸ“¤ ä¸Šå‚³æœ€çµ‚æ‘˜è¦
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-summary
        path: |
          coverage-reports/final-summary.md
          coverage-reports/coverage-detailed.txt
        retention-days: 30

    # è¦†è“‹ç‡é–€æª»æª¢æŸ¥ - åƒ…è­¦å‘Šï¼Œä¸å¼·åˆ¶å¤±æ•—
    - name: ğŸ¯ è¦†è“‹ç‡é–€æª»æª¢æŸ¥
      run: |
        echo "ğŸ¯ æª¢æŸ¥è¦†è“‹ç‡é–€æª»..."

        if [ "$COVERAGE_STATUS" = "fail" ]; then
          echo "âš ï¸ è­¦å‘Š: è¦†è“‹ç‡ ${COVERAGE_PERCENT}% ä½æ–¼é–€æª» ${COVERAGE_THRESHOLD}%"
          echo ""
          echo "å»ºè­°:"
          echo "â€¢ ç‚ºæ–°åŠŸèƒ½æ·»åŠ å–®å…ƒæ¸¬è©¦"
          echo "â€¢ æé«˜ç¾æœ‰æ¸¬è©¦çš„è¦†è“‹ç¯„åœ"
          echo "â€¢ æª¢æŸ¥æœªæ¸¬è©¦çš„ä»£ç¢¼åˆ†æ”¯"
          echo ""
          echo "æ³¨æ„: ç›®å‰åƒ…ç™¼å‡ºè­¦å‘Šï¼Œä¸æœƒå°è‡´ CI å¤±æ•—"

          # è¨­ç½®è­¦å‘Šç‹€æ…‹ï¼Œä½†ä¸å¤±æ•—
          echo "::warning title=è¦†è“‹ç‡ä¸è¶³::ç•¶å‰è¦†è“‹ç‡ ${COVERAGE_PERCENT}% ä½æ–¼ç›®æ¨™ ${COVERAGE_THRESHOLD}%"
        else
          echo "âœ… è¦†è“‹ç‡ ${COVERAGE_PERCENT}% ç¬¦åˆé–€æª»è¦æ±‚ ${COVERAGE_THRESHOLD}%"
        fi

  # æ€§èƒ½æ¸¬è©¦ (å¯é¸)
  performance-tests:
    name: âš¡ æ€§èƒ½åŸºæº–æ¸¬è©¦
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 15

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        pip install -e ".[dev,test]"
        pip install pytest-benchmark memory-profiler

    - name: âš¡ åŸ·è¡Œæ€§èƒ½æ¸¬è©¦
      run: |
        echo "âš¡ åŸ·è¡Œæ€§èƒ½åŸºæº–æ¸¬è©¦..."
        pytest tests/performance/ \
          --benchmark-only \
          --benchmark-json=benchmark-results.json \
          -v || true

    - name: ğŸ“Š æ€§èƒ½å ±å‘Šæ‘˜è¦
      run: |
        echo "ğŸ“Š æ€§èƒ½æ¸¬è©¦æ‘˜è¦"
        echo "==============="

        if [ -f benchmark-results.json ]; then
          echo "âœ… æ€§èƒ½åŸºæº–æ¸¬è©¦å®Œæˆ"
          echo "è©³ç´°çµæœè«‹æŸ¥çœ‹ benchmark-results.json"
        else
          echo "â„¹ï¸ æœªç™¼ç¾æ€§èƒ½æ¸¬è©¦"
        fi

    - name: ğŸ“¤ ä¸Šå‚³æ€§èƒ½å ±å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: performance-reports
        path: |
          benchmark-results.json
        retention-days: 90
