name: ğŸ§ª Test Coverage

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æ¸¬è©¦é¡å‹'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - integration
          - e2e

env:
  PYTHON_VERSION: '3.10'
  MIN_COVERAGE: '70'

jobs:
  unit-tests:
    name: ğŸ”¬ å–®å…ƒæ¸¬è©¦
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
        test-group: ['core', 'services', 'api', 'utils']
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .[test]
    
    - name: ğŸ—ï¸ è¨­ç½®æ¸¬è©¦ç’°å¢ƒ
      run: |
        # è¤‡è£½æ¸¬è©¦é…ç½®
        cp .env.example .env.test
        
        # è¨­ç½®æ¸¬è©¦è³‡æ–™åº«å’ŒåŸºæœ¬é…ç½®
        cat >> .env.test << EOF
        # æ¸¬è©¦ç’°å¢ƒé…ç½®
        TESTING=true
        LOG_LEVEL=WARNING
        
        # è³‡æ–™åº«é…ç½® (SQLite for unit tests)
        DATABASE_URL=sqlite:///test.db
        DB_HOST=localhost
        DB_PORT=3306
        DB_USER=test_user
        DB_PASSWORD=test_password
        DB_NAME=test_db
        
        # åŸºæœ¬ Discord é…ç½® (æ¸¬è©¦ç”¨å‡å€¼)
        DISCORD_TOKEN=test_token_unit_tests
        DISCORD_CLIENT_ID=123456789
        DISCORD_CLIENT_SECRET=test_secret
        DISCORD_REDIRECT_URI=http://localhost:3000/test
        DISCORD_GUILD_ID=987654321
        
        # Redis é…ç½®
        REDIS_URL=redis://localhost:6379/1
        
        # JWT é…ç½®
        JWT_SECRET=test_jwt_secret_for_unit_tests_minimum_32_chars
        
        # API é…ç½®
        ENABLE_API_SERVER=false
        API_HOST=localhost
        API_PORT=8001
        EOF
    
    - name: ğŸ§ª åŸ·è¡Œå–®å…ƒæ¸¬è©¦ - ${{ matrix.test-group }}
      run: |
        echo "ğŸ”¬ åŸ·è¡Œ ${{ matrix.test-group }} å–®å…ƒæ¸¬è©¦..."
        
        # æ ¹æ“šæ¸¬è©¦çµ„é¸æ“‡æ¸¬è©¦ç›®æ¨™
        case "${{ matrix.test-group }}" in
          "core")
            TEST_PATH="tests/unit/test_config.py tests/unit/test_database.py"
            ;;
          "services")
            TEST_PATH="tests/unit/test_cogs.py"
            ;;
          "api")
            # API ç›¸é—œæ¸¬è©¦ (å¦‚æœæ²’æœ‰å°±ä½¿ç”¨ integration)
            if [[ -d "tests/unit/api/" ]]; then
              TEST_PATH="tests/unit/api/"
            else
              TEST_PATH="tests/integration/test_api_integration.py"
            fi
            ;;
          "utils")
            # Utils æ¸¬è©¦ (å¦‚æœæ²’æœ‰å°±è·³é)
            if [[ -d "tests/unit/utils/" ]]; then
              TEST_PATH="tests/unit/utils/"
            else
              echo "âš ï¸ utils æ¸¬è©¦ç¾¤çµ„æš«æ™‚è·³é - æ¸¬è©¦æª”æ¡ˆä¸å­˜åœ¨"
              exit 0
            fi
            ;;
          *)
            TEST_PATH="tests/unit/"
            ;;
        esac
        
        # å¦‚æœæ¸¬è©¦è·¯å¾‘ä¸å­˜åœ¨ï¼Œè·³é
        if [[ ! -e $TEST_PATH ]]; then
          echo "âš ï¸ æ¸¬è©¦è·¯å¾‘ $TEST_PATH ä¸å­˜åœ¨ï¼Œè·³é"
          exit 0
        fi
        
        pytest $TEST_PATH \
          --cov=bot \
          --cov=shared \
          --cov-report=xml:coverage-${{ matrix.test-group }}.xml \
          --cov-report=html:htmlcov-${{ matrix.test-group }} \
          --cov-report=term-missing \
          --junit-xml=junit-${{ matrix.test-group }}.xml \
          -v \
          --tb=short
    
    - name: ğŸ“Š ä¸Šå‚³æ¸¬è©¦çµæœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.python-version }}-${{ matrix.test-group }}
        path: |
          coverage-${{ matrix.test-group }}.xml
          junit-${{ matrix.test-group }}.xml
          htmlcov-${{ matrix.test-group }}/

  integration-tests:
    name: ğŸ”— æ•´åˆæ¸¬è©¦
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'integration' || github.event.inputs.test_type == ''
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      mysql:
        image: mysql:8.0
        ports:
          - 3306:3306
        env:
          MYSQL_ROOT_PASSWORD: testpass
          MYSQL_DATABASE: potato_test
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .[test]
    
    - name: ğŸ—ï¸ è¨­ç½®æ•´åˆæ¸¬è©¦ç’°å¢ƒ
      run: |
        # è¨­ç½®æ¸¬è©¦é…ç½®
        cp .env.example .env.test
        
        # è¨­ç½®æ¸¬è©¦æœå‹™é€£æ¥
        cat >> .env.test << EOF
        DATABASE_URL=mysql://root:testpass@localhost:3306/potato_test
        REDIS_URL=redis://localhost:6379/0
        TESTING=true
        LOG_LEVEL=INFO
        DISCORD_TOKEN=test_token
        EOF
    
    - name: â³ ç­‰å¾…æœå‹™å°±ç·’
      run: |
        echo "â³ ç­‰å¾…è³‡æ–™åº«å’Œ Redis æœå‹™å°±ç·’..."
        
        # ç­‰å¾… MySQL
        for i in {1..30}; do
          if mysqladmin ping -h localhost -u root -ptestpass --silent; then
            echo "âœ… MySQL å·²å°±ç·’"
            break
          fi
          echo "â³ ç­‰å¾… MySQL... ($i/30)"
          sleep 2
        done
        
        # ç­‰å¾… Redis
        for i in {1..30}; do
          if redis-cli -h localhost ping | grep -q PONG; then
            echo "âœ… Redis å·²å°±ç·’"
            break
          fi
          echo "â³ ç­‰å¾… Redis... ($i/30)"
          sleep 1
        done
    
    - name: ğŸ—ï¸ åˆå§‹åŒ–æ¸¬è©¦è³‡æ–™åº«
      run: |
        echo "ğŸ—„ï¸ åˆå§‹åŒ–æ¸¬è©¦è³‡æ–™åº«..."
        
        # å¦‚æœæœ‰è³‡æ–™åº«é·ç§»è…³æœ¬ï¼ŒåŸ·è¡Œå®ƒå€‘
        if [[ -d "bot/db/migrations" ]]; then
          python -c "
        import asyncio
        from bot.db.database_manager import DatabaseManager
        
        async def init_test_db():
            db = DatabaseManager()
            await db.initialize()
            print('âœ… æ¸¬è©¦è³‡æ–™åº«åˆå§‹åŒ–å®Œæˆ')
            
        asyncio.run(init_test_db())
        " || echo "âš ï¸ è³‡æ–™åº«åˆå§‹åŒ–å¤±æ•—ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ"
        fi
    
    - name: ğŸ§ª åŸ·è¡Œæ•´åˆæ¸¬è©¦
      run: |
        echo "ğŸ”— åŸ·è¡Œæ•´åˆæ¸¬è©¦..."
        
        if [[ -d "tests/integration" ]]; then
          pytest tests/integration/ \
            --cov=bot \
            --cov=shared \
            --cov-report=xml:coverage-integration.xml \
            --cov-report=html:htmlcov-integration \
            --junit-xml=junit-integration.xml \
            -v \
            --tb=short \
            --timeout=300
        else
          echo "âš ï¸ æ•´åˆæ¸¬è©¦ç›®éŒ„ä¸å­˜åœ¨ï¼Œè·³éæ•´åˆæ¸¬è©¦"
        fi
    
    - name: ğŸ“Š ä¸Šå‚³æ•´åˆæ¸¬è©¦çµæœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          coverage-integration.xml
          junit-integration.xml
          htmlcov-integration/

  e2e-tests:
    name: ğŸŒ ç«¯åˆ°ç«¯æ¸¬è©¦
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: (github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'e2e') && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ³ å•Ÿå‹•å®Œæ•´æ¸¬è©¦ç’°å¢ƒ
      run: |
        echo "ğŸš€ å•Ÿå‹•å®Œæ•´æ¸¬è©¦ç’°å¢ƒ..."
        
        # å¦‚æœæœ‰ docker-compose.test.ymlï¼Œä½¿ç”¨å®ƒ
        if [[ -f "docker-compose.test.yml" ]]; then
          docker-compose -f docker-compose.test.yml up -d
          sleep 30  # ç­‰å¾…æœå‹™å•Ÿå‹•
        else
          echo "âš ï¸ æ²’æœ‰æ‰¾åˆ° docker-compose.test.ymlï¼Œè·³éç’°å¢ƒå•Ÿå‹•"
        fi
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -e .[test]
        
        # å®‰è£ E2E æ¸¬è©¦å°ˆç”¨ä¾è³´
        pip install playwright pytest-playwright || echo "âš ï¸ E2E æ¸¬è©¦ä¾è³´å®‰è£å¤±æ•—"
    
    - name: ğŸ§ª åŸ·è¡Œç«¯åˆ°ç«¯æ¸¬è©¦
      run: |
        echo "ğŸŒ åŸ·è¡Œç«¯åˆ°ç«¯æ¸¬è©¦..."
        
        if [[ -d "tests/e2e" ]]; then
          pytest tests/e2e/ \
            --junit-xml=junit-e2e.xml \
            -v \
            --tb=short \
            --timeout=600
        else
          echo "âš ï¸ E2E æ¸¬è©¦ç›®éŒ„ä¸å­˜åœ¨ï¼Œè·³é"
        fi
    
    - name: ğŸ“Š ä¸Šå‚³ E2E æ¸¬è©¦çµæœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-results
        path: junit-e2e.xml
    
    - name: ğŸ§¹ æ¸…ç†æ¸¬è©¦ç’°å¢ƒ
      if: always()
      run: |
        if [[ -f "docker-compose.test.yml" ]]; then
          docker-compose -f docker-compose.test.yml down -v
        fi

  coverage-report:
    name: ğŸ“Š è¦†è“‹ç‡å ±å‘Š
    needs: [unit-tests, integration-tests]
    runs-on: ubuntu-latest
    if: always()
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ å®‰è£è¦†è“‹ç‡å·¥å…·
      run: |
        pip install coverage[toml] coverage-badge
    
    - name: ğŸ“¥ ä¸‹è¼‰æ¸¬è©¦çµæœ
      uses: actions/download-artifact@v4
      with:
        path: test-artifacts
    
    - name: ğŸ”— åˆä½µè¦†è“‹ç‡å ±å‘Š
      run: |
        echo "ğŸ“Š åˆä½µæ‰€æœ‰è¦†è“‹ç‡å ±å‘Š..."
        
        # æ”¶é›†æ‰€æœ‰è¦†è“‹ç‡æ–‡ä»¶
        find test-artifacts -name "coverage-*.xml" -exec cp {} . \;
        
        # å¦‚æœæœ‰è¦†è“‹ç‡æ–‡ä»¶ï¼Œåˆä½µå®ƒå€‘
        if ls coverage-*.xml 1> /dev/null 2>&1; then
          # ä½¿ç”¨ coverage åˆä½µå ±å‘Š
          coverage combine || echo "âš ï¸ è¦†è“‹ç‡åˆä½µå¤±æ•—"
          
          # ç”Ÿæˆæœ€çµ‚å ±å‘Š
          coverage report --format=markdown > coverage-report.md
          coverage html
          
          # æª¢æŸ¥è¦†è“‹ç‡æ˜¯å¦é”åˆ°æœ€ä½è¦æ±‚
          COVERAGE=$(coverage report --format=total)
          echo "ğŸ“Š ç¸½è¦†è“‹ç‡: ${COVERAGE}%"
          
          if (( $(echo "$COVERAGE >= $MIN_COVERAGE" | bc -l) )); then
            echo "âœ… è¦†è“‹ç‡é”åˆ°è¦æ±‚ (${COVERAGE}% >= ${MIN_COVERAGE}%)"
          else
            echo "âŒ è¦†è“‹ç‡æœªé”åˆ°è¦æ±‚ (${COVERAGE}% < ${MIN_COVERAGE}%)"
            exit 1
          fi
        else
          echo "âš ï¸ æ²’æœ‰æ‰¾åˆ°è¦†è“‹ç‡å ±å‘Šæ–‡ä»¶"
        fi
    
    - name: ğŸ“Š ä¸Šå‚³åˆä½µè¦†è“‹ç‡å ±å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: final-coverage-report
        path: |
          coverage-report.md
          htmlcov/
    
    - name: ğŸ’¬ è¦†è“‹ç‡è©•è«– (PR)
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request' && always()
      with:
        script: |
          const fs = require('fs');
          
          try {
            if (fs.existsSync('coverage-report.md')) {
              const coverage = fs.readFileSync('coverage-report.md', 'utf8');
              
              const comment = `## ğŸ“Š æ¸¬è©¦è¦†è“‹ç‡å ±å‘Š
              
              ${coverage}
              
              ğŸ“ˆ æœ€ä½è¦æ±‚è¦†è“‹ç‡: ${process.env.MIN_COVERAGE}%
              
              ğŸ’¡ è©³ç´°å ±å‘Šè«‹æŸ¥çœ‹ Artifacts ä¸­çš„ \`final-coverage-report\`
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
          } catch (error) {
            console.log('âš ï¸ ç„¡æ³•å‰µå»ºè¦†è“‹ç‡è©•è«–:', error.message);
          }

  test-summary:
    name: ğŸ æ¸¬è©¦ç¸½çµ
    needs: [unit-tests, integration-tests, e2e-tests, coverage-report]
    runs-on: ubuntu-latest
    if: always()
    timeout-minutes: 5
    
    steps:
    - name: ğŸ“‹ æ¸¬è©¦åŸ·è¡Œç¸½çµ
      run: |
        echo "ğŸ§ª æ¸¬è©¦åŸ·è¡Œå®Œæˆç¸½çµ"
        echo ""
        echo "âœ… æ¸¬è©¦éšæ®µçµæœ:"
        echo "  â€¢ ğŸ”¬ å–®å…ƒæ¸¬è©¦ - ${{ needs.unit-tests.result }}"
        echo "  â€¢ ğŸ”— æ•´åˆæ¸¬è©¦ - ${{ needs.integration-tests.result }}"
        echo "  â€¢ ğŸŒ ç«¯åˆ°ç«¯æ¸¬è©¦ - ${{ needs.e2e-tests.result }}"
        echo "  â€¢ ğŸ“Š è¦†è“‹ç‡å ±å‘Š - ${{ needs.coverage-report.result }}"
        echo ""
        
        # æª¢æŸ¥é—œéµæ¸¬è©¦çµæœ
        if [[ "${{ needs.unit-tests.result }}" == "failure" ]]; then
          echo "âŒ å–®å…ƒæ¸¬è©¦å¤±æ•— - é€™æ˜¯é˜»æ–·æ€§å•é¡Œ"
          exit 1
        fi
        
        if [[ "${{ needs.coverage-report.result }}" == "failure" ]]; then
          echo "âš ï¸ è¦†è“‹ç‡ä¸è¶³ - è«‹å¢åŠ æ¸¬è©¦è¦†è“‹ç‡"
          exit 1
        fi
        
        if [[ "${{ needs.integration-tests.result }}" == "failure" ]]; then
          echo "âš ï¸ æ•´åˆæ¸¬è©¦å¤±æ•— - å»ºè­°ä¿®å¾©å¾Œå†åˆä½µ"
        fi
        
        echo "ğŸ‰ æ¸¬è©¦éšæ®µå®Œæˆ!"
        echo ""
        echo "ğŸ“Š æ¸¬è©¦çµ±è¨ˆ:"
        echo "  â€¢ Python ç‰ˆæœ¬: 3.10, 3.11"
        echo "  â€¢ æ¸¬è©¦çµ„åˆ¥: core, services, api, utils"
        echo "  â€¢ æœ€ä½è¦†è“‹ç‡è¦æ±‚: ${MIN_COVERAGE}%"