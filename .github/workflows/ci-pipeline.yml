name: ğŸš€ CI Pipeline

on:
  push:
    branches: [main, develop, dev]
  pull_request:
    branches: [main, develop, dev]

env:
  PYTHON_VERSION: '3.10'
  
jobs:
  # å¿«é€Ÿè®Šæ›´æª¢æ¸¬ - ä½¿ç”¨æˆç†Ÿçš„ paths-filter
  detect-changes:
    name: ğŸ” åµæ¸¬è®Šæ›´
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.changes.outputs.code }}
      tests: ${{ steps.changes.outputs.tests }}
      docs: ${{ steps.changes.outputs.docs }}
      config: ${{ steps.changes.outputs.config }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          code:
            - 'bot/**/*.py'
            - 'shared/**/*.py'
          tests:
            - 'tests/**/*'
          docs:
            - '**/*.md'
            - 'docs/**/*'
          config:
            - 'requirements.txt'
            - 'pyproject.toml'
            - '.github/**/*'

  # å“è³ªæª¢æŸ¥é–˜é–€ - æ•´åˆå¤šé …æª¢æŸ¥
  quality-gate:
    name: âš¡ å“è³ªæª¢æŸ¥é–˜é–€
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.code == 'true' || needs.detect-changes.outputs.config == 'true'
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Semgrep éœ€è¦å®Œæ•´æ­·å²
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£å“è³ªå·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install black isort flake8 bandit safety pip-audit
    
    - name: ğŸ¨ ä»£ç¢¼æ ¼å¼æª¢æŸ¥
      continue-on-error: true
      run: |
        echo "ğŸ” åŸ·è¡Œä»£ç¢¼æ ¼å¼æª¢æŸ¥..."
        black --check --diff bot/ shared/ || echo "âš ï¸ Black æ ¼å¼æª¢æŸ¥ç™¼ç¾å•é¡Œï¼Œä½†ç¹¼çºŒåŸ·è¡Œ"
        echo "ğŸ“ æª¢æŸ¥ import æ’åº..."
        isort --check-only --diff bot/ shared/ || echo "âš ï¸ isort æª¢æŸ¥ç™¼ç¾å•é¡Œï¼Œä½†ç¹¼çºŒåŸ·è¡Œ"
        echo "âœ¨ æª¢æŸ¥ä»£ç¢¼é¢¨æ ¼..."
        flake8 bot/ shared/ || echo "âš ï¸ Flake8 æª¢æŸ¥ç™¼ç¾å•é¡Œï¼Œä½†ç¹¼çºŒåŸ·è¡Œ"
        echo "ğŸ’¡ å»ºè­°ï¼šé‹è¡Œ 'black bot/ shared/' å’Œ 'isort bot/ shared/' ä¾†ä¿®å¾©æ ¼å¼å•é¡Œ"
    
    - name: ğŸ›¡ï¸ Bandit å®‰å…¨æƒæ
      continue-on-error: true
      run: |
        echo "ğŸ”’ åŸ·è¡Œ Python å®‰å…¨æƒæ..."
        bandit -r bot/ shared/ -f json -o bandit-report.json || echo "âš ï¸ Bandit æƒæç™¼ç¾å•é¡Œï¼Œä½†ç¹¼çºŒåŸ·è¡Œ"
        bandit -r bot/ shared/ -f txt || echo "âš ï¸ Bandit æ–‡å­—å ±å‘Šç”Ÿæˆå¤±æ•—ï¼Œä½†ç¹¼çºŒåŸ·è¡Œ"
        
        # æª¢æŸ¥é«˜é¢¨éšªå•é¡Œ
        if [ -f "bandit-report.json" ]; then
          HIGH_ISSUES=$(jq '.results[] | select(.issue_severity == "HIGH") | length' bandit-report.json 2>/dev/null | wc -l)
          if [ "$HIGH_ISSUES" -gt 0 ]; then
            echo "âš ï¸ ç™¼ç¾ $HIGH_ISSUES å€‹é«˜é¢¨éšªå®‰å…¨å•é¡Œ"
            echo "::warning::ç™¼ç¾ $HIGH_ISSUES å€‹é«˜é¢¨éšªå®‰å…¨å•é¡Œï¼Œå»ºè­°ä¿®å¾©"
          else
            echo "âœ… æœªç™¼ç¾é«˜é¢¨éšªå®‰å…¨å•é¡Œ"
          fi
        else
          echo "âš ï¸ Bandit å ±å‘Šæ–‡ä»¶æœªç”Ÿæˆï¼Œè·³éé¢¨éšªåˆ†æ"
        fi
    
    - name: ğŸ” Semgrep éœæ…‹åˆ†æ
      continue-on-error: true
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/python
          p/security-audit
          p/owasp-top-ten
          p/django
        generateSarif: "1"
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
    
    - name: ğŸš¨ ä¾è³´å®‰å…¨æƒæ
      continue-on-error: true
      run: |
        echo "ğŸ”’ åŸ·è¡Œä¾è³´å®‰å…¨æƒæ..."
        # å®‰è£é …ç›®ä¾è³´ä»¥é€²è¡Œæƒæ
        pip install -r requirements.txt || echo "âš ï¸ ä¾è³´å®‰è£å¤±æ•—ï¼Œä½†ç¹¼çºŒåŸ·è¡Œ"
        
        # Safety æƒæ
        safety check --json --output safety-report.json || echo "âš ï¸ Safety æƒæç™¼ç¾å•é¡Œï¼Œä½†ç¹¼çºŒåŸ·è¡Œ"
        
        # Pip-audit æƒæ  
        pip-audit --format=json --output=pip-audit-report.json || echo "âš ï¸ Pip-audit æƒæç™¼ç¾å•é¡Œï¼Œä½†ç¹¼çºŒåŸ·è¡Œ"
        pip-audit --format=columns || echo "âš ï¸ ä¾è³´æƒæç™¼ç¾å•é¡Œï¼Œä½†ç¹¼çºŒåŸ·è¡Œ"
        
        echo "ğŸ’¡ å»ºè­°ï¼šæª¢æŸ¥ç”Ÿæˆçš„å®‰å…¨å ±å‘Šä¸¦ä¿®å¾©ç™¼ç¾çš„æ¼æ´"
    
    - name: ğŸ“Š ä¸Šå‚³å®‰å…¨å ±å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
          pip-audit-report.json
    
    - name: ğŸ“‹ å“è³ªæª¢æŸ¥ç¸½çµ
      if: always()
      run: |
        echo "âš¡ å“è³ªæª¢æŸ¥é–˜é–€åŸ·è¡Œå®Œæˆ"
        echo "âœ… ä»£ç¢¼æ ¼å¼æª¢æŸ¥: å®Œæˆ"
        echo "ğŸ›¡ï¸ Bandit å®‰å…¨æƒæ: å®Œæˆ"  
        echo "ğŸ” Semgrep éœæ…‹åˆ†æ: å®Œæˆ"
        echo "ğŸš¨ ä¾è³´å®‰å…¨æƒæ: å®Œæˆ"

  # æ¸¬è©¦å¥—ä»¶ - å¤§å¹…ç°¡åŒ–
  test-suite:
    name: ğŸ§ª æ¸¬è©¦å¥—ä»¶
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.code == 'true' || needs.detect-changes.outputs.tests == 'true'
    timeout-minutes: 20
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio coverage[toml]
    
    - name: ğŸ—ï¸ è¨­ç½®æ¸¬è©¦ç’°å¢ƒ
      run: |
        cp .env.example .env.test
        echo "TESTING=true" >> .env.test
        echo "DATABASE_URL=sqlite:///test.db" >> .env.test
        echo "LOG_LEVEL=WARNING" >> .env.test
    
    - name: ğŸ§ª åŸ·è¡Œæ¸¬è©¦
      run: |
        echo "ğŸ”¬ åŸ·è¡Œæ¸¬è©¦å¥—ä»¶..."
        if [ -d "tests" ]; then
          pytest tests/ \
            --cov=bot \
            --cov=shared \
            --cov-report=xml:coverage.xml \
            --cov-report=html:htmlcov \
            --cov-report=term-missing \
            --junit-xml=pytest-report.xml \
            -v
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æ¸¬è©¦ç›®éŒ„ï¼Œè·³éæ¸¬è©¦"
          # å‰µå»ºç©ºçš„è¦†è“‹ç‡å ±å‘Š
          echo '<?xml version="1.0"?><coverage version="0.0"></coverage>' > coverage.xml
        fi
    
    - name: ğŸ“Š ä¸Šå‚³è‡³ Codecov
      uses: codecov/codecov-action@v4
      if: always()
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        verbose: true
        slug: Craig-0219/potato
    
    - name: ğŸ“ ä¸Šå‚³æ¸¬è©¦å ±å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports
        path: |
          coverage.xml
          htmlcov/
          pytest-report.xml

  # å»ºæ§‹é©—è­‰ - ç°¡åŒ–æ•´åˆ
  build-check:
    name: ğŸ—ï¸ å»ºæ§‹é©—è­‰
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.code == 'true' || needs.detect-changes.outputs.config == 'true'
    timeout-minutes: 5
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4  
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ—ï¸ é©—è­‰å»ºæ§‹
      run: |
        echo "ğŸ“¦ å®‰è£ä¾è³´..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
        echo "âœ… å»ºæ§‹é©—è­‰å®Œæˆ"
        python --version
        pip list

  # CI ç¸½çµ
  ci-summary:
    name: ğŸ“‹ CI ç¸½çµ
    runs-on: ubuntu-latest
    needs: [detect-changes, quality-gate, test-suite, build-check]
    if: always()
    timeout-minutes: 2
    
    steps:
    - name: ğŸ“Š ç”Ÿæˆ CI å ±å‘Š
      run: |
        echo "ğŸš€ CI Pipeline åŸ·è¡Œå®Œæˆ!"
        echo ""
        echo "ğŸ“‹ åŸ·è¡Œçµæœæ‘˜è¦:"
        echo "ğŸ” è®Šæ›´æª¢æ¸¬: âœ…"
        
        # å“è³ªæª¢æŸ¥çµæœ
        if [[ "${{ needs.quality-gate.result }}" == "success" ]]; then
          echo "âš¡ å“è³ªæª¢æŸ¥: âœ… é€šé"
        elif [[ "${{ needs.quality-gate.result }}" == "skipped" ]]; then
          echo "âš¡ å“è³ªæª¢æŸ¥: â­ï¸ è·³é (ç„¡ä»£ç¢¼è®Šæ›´)"
        else
          echo "âš¡ å“è³ªæª¢æŸ¥: âŒ å¤±æ•—"
        fi
        
        # æ¸¬è©¦çµæœ
        if [[ "${{ needs.test-suite.result }}" == "success" ]]; then
          echo "ğŸ§ª æ¸¬è©¦å¥—ä»¶: âœ… é€šé"
        elif [[ "${{ needs.test-suite.result }}" == "skipped" ]]; then
          echo "ğŸ§ª æ¸¬è©¦å¥—ä»¶: â­ï¸ è·³é (ç„¡ä»£ç¢¼è®Šæ›´)"
        else
          echo "ğŸ§ª æ¸¬è©¦å¥—ä»¶: âŒ å¤±æ•—"
        fi
        
        # å»ºæ§‹çµæœ
        if [[ "${{ needs.build-check.result }}" == "success" ]]; then
          echo "ğŸ—ï¸ å»ºæ§‹é©—è­‰: âœ… é€šé"
        elif [[ "${{ needs.build-check.result }}" == "skipped" ]]; then
          echo "ğŸ—ï¸ å»ºæ§‹é©—è­‰: â­ï¸ è·³é (ç„¡ä»£ç¢¼è®Šæ›´)"
        else
          echo "ğŸ—ï¸ å»ºæ§‹é©—è­‰: âŒ å¤±æ•—"
        fi
        
        echo ""
        echo "ğŸ¯ æ•´é«”ç‹€æ…‹: ${{ job.status }}"
        
        # æª¢æŸ¥é—œéµå¤±æ•—
        if [[ "${{ needs.quality-gate.result }}" == "failure" ]]; then
          echo "ğŸ’¡ å»ºè­°: æª¢æŸ¥ä»£ç¢¼æ ¼å¼å’Œå®‰å…¨å•é¡Œ"
        fi
        
        if [[ "${{ needs.test-suite.result }}" == "failure" ]]; then
          echo "ğŸ’¡ å»ºè­°: æª¢æŸ¥æ¸¬è©¦å¤±æ•—åŸå› å’Œè¦†è“‹ç‡"  
        fi
        
        echo "ğŸ”— è©³ç´°å ±å‘Šè«‹æŸ¥çœ‹å„ job çš„åŸ·è¡Œçµæœå’Œ artifacts"