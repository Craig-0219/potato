name: ğŸ›¡ï¸ Security Scans

on:
  pull_request:
    branches: [main, dev]
    paths:
      - '**.py'
      - 'requirements*.txt'
      - 'pyproject.toml'
  push:
    branches: [main, dev]
    paths:
      - '**.py'
      - 'requirements*.txt'
      - 'pyproject.toml'
  schedule:
    # æ¯æ—¥ 02:00 åŸ·è¡Œæ·±åº¦å®‰å…¨æƒæ
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_depth:
        description: 'æƒææ·±åº¦'
        required: false
        default: 'standard'
        type: choice
        options:
          - standard
          - deep

env:
  PYTHON_VERSION: '3.10'

jobs:
  security-scan:
    name: ğŸ›¡ï¸ å®‰å…¨æƒæ
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å®Œæ•´æ­·å²ï¼Œç”¨æ–¼ secrets æƒæ

    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ å®‰è£å®‰å…¨å·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml]>=1.7.9 safety>=3.0.0 semgrep>=1.45.0
        pip install detect-secrets>=1.4.0 pip-audit>=2.6.0
        pip install -r requirements.txt

    # Stage 1: SAST (éœæ…‹æ‡‰ç”¨å®‰å…¨æ¸¬è©¦)
    - name: ğŸ›¡ï¸ Bandit å®‰å…¨æƒæ
      run: |
        echo "ğŸ›¡ï¸ åŸ·è¡Œ Bandit å®‰å…¨æƒæ..."
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . -f txt || true

    - name: ğŸ” Semgrep éœæ…‹åˆ†æ
      run: |
        echo "ğŸ” åŸ·è¡Œ Semgrep éœæ…‹åˆ†æ..."
        semgrep --config=auto --json --output=semgrep-report.json . || true
        semgrep --config=auto --text || true

    # Stage 2: ä¾è³´å®‰å…¨æª¢æŸ¥
    - name: ğŸ“¦ Safety ä¾è³´æ¼æ´æƒæ
      run: |
        echo "ğŸ“¦ æª¢æŸ¥ä¾è³´æ¼æ´..."
        safety check --json --output=safety-report.json || true
        safety check --short-report || true

    - name: ğŸ”’ pip-audit ä¾è³´å¯©è¨ˆ
      run: |
        echo "ğŸ”’ åŸ·è¡Œä¾è³´å¯©è¨ˆ..."
        pip-audit --format=json --output=pip-audit-report.json || true
        pip-audit --desc || true

    # Stage 3: Secrets æª¢æ¸¬
    - name: ğŸ” detect-secrets æƒæ
      run: |
        echo "ğŸ” æª¢æ¸¬ secrets..."
        detect-secrets scan --all-files --force-use-all-plugins > secrets-baseline.json || true

    # å®‰å…¨æ‘˜è¦åˆ†æ
    - name: ğŸ“Š å®‰å…¨æƒææ‘˜è¦
      run: |
        echo "ğŸ“Š å®‰å…¨æƒææ‘˜è¦å ±å‘Š"
        echo "===================="

        # Bandit æ‘˜è¦
        if [ -f bandit-report.json ]; then
          HIGH_ISSUES=$(jq '.results | map(select(.issue_severity == "HIGH")) | length' bandit-report.json 2>/dev/null || echo "0")
          MEDIUM_ISSUES=$(jq '.results | map(select(.issue_severity == "MEDIUM")) | length' bandit-report.json 2>/dev/null || echo "0")
          LOW_ISSUES=$(jq '.results | map(select(.issue_severity == "LOW")) | length' bandit-report.json 2>/dev/null || echo "0")
          echo "ğŸ›¡ï¸ Bandit SAST: $HIGH_ISSUES high, $MEDIUM_ISSUES medium, $LOW_ISSUES low"

          # è¨­ç½®è¼¸å‡ºè®Šæ•¸ä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
          echo "BANDIT_HIGH=$HIGH_ISSUES" >> $GITHUB_ENV
          echo "BANDIT_MEDIUM=$MEDIUM_ISSUES" >> $GITHUB_ENV
        fi

        # Safety æ‘˜è¦
        if [ -f safety-report.json ]; then
          VULN_COUNT=$(jq 'length' safety-report.json 2>/dev/null || echo "0")
          echo "ğŸ“¦ Safety ä¾è³´æƒæ: $VULN_COUNT å€‹æ¼æ´"
          echo "SAFETY_VULNS=$VULN_COUNT" >> $GITHUB_ENV
        fi

        # Semgrep æ‘˜è¦
        if [ -f semgrep-report.json ]; then
          SEM_ISSUES=$(jq '.results | length' semgrep-report.json 2>/dev/null || echo "0")
          echo "ğŸ” Semgrep åˆ†æ: $SEM_ISSUES å€‹å•é¡Œ"
          echo "SEMGREP_ISSUES=$SEM_ISSUES" >> $GITHUB_ENV
        fi

        # Secrets æ‘˜è¦
        if [ -f secrets-baseline.json ]; then
          SECRET_COUNT=$(jq '.results | length' secrets-baseline.json 2>/dev/null || echo "0")
          echo "ğŸ” Secrets æª¢æ¸¬: $SECRET_COUNT å€‹å¯èƒ½çš„ secrets"
          echo "SECRET_DETECTIONS=$SECRET_COUNT" >> $GITHUB_ENV
        fi

    # å®‰å…¨ç‹€æ…‹è©•ä¼°
    - name: ğŸš¨ å®‰å…¨ç‹€æ…‹è©•ä¼°
      run: |
        echo "ğŸš¨ è©•ä¼°å®‰å…¨ç‹€æ…‹..."

        # åˆå§‹åŒ–è¨ˆæ•¸å™¨
        CRITICAL_ISSUES=0
        WARNING_ISSUES=0

        # æª¢æŸ¥ Bandit é«˜é¢¨éšªå•é¡Œ
        if [ "${BANDIT_HIGH:-0}" -gt 0 ]; then
          echo "âŒ ç™¼ç¾ ${BANDIT_HIGH} å€‹ Bandit é«˜é¢¨éšªå•é¡Œ"
          CRITICAL_ISSUES=$((CRITICAL_ISSUES + BANDIT_HIGH))
        fi

        # æª¢æŸ¥ä¾è³´æ¼æ´
        if [ "${SAFETY_VULNS:-0}" -gt 0 ]; then
          echo "âš ï¸ ç™¼ç¾ ${SAFETY_VULNS} å€‹ä¾è³´å®‰å…¨æ¼æ´"
          WARNING_ISSUES=$((WARNING_ISSUES + SAFETY_VULNS))
        fi

        # æª¢æŸ¥å¯ç–‘çš„ secrets
        if [ "${SECRET_DETECTIONS:-0}" -gt 0 ]; then
          echo "âš ï¸ æª¢æ¸¬åˆ° ${SECRET_DETECTIONS} å€‹å¯èƒ½çš„æ•æ„Ÿè³‡è¨Š"
          WARNING_ISSUES=$((WARNING_ISSUES + SECRET_DETECTIONS))
        fi

        # è¨­ç½®è¼¸å‡º
        echo "CRITICAL_ISSUES=$CRITICAL_ISSUES" >> $GITHUB_ENV
        echo "WARNING_ISSUES=$WARNING_ISSUES" >> $GITHUB_ENV

        # çµè«–
        echo ""
        if [ "$CRITICAL_ISSUES" -gt 0 ]; then
          echo "ğŸš¨ å®‰å…¨ç‹€æ…‹: åš´é‡ - éœ€è¦ç«‹å³è™•ç† $CRITICAL_ISSUES å€‹é—œéµå•é¡Œ"
        elif [ "$WARNING_ISSUES" -gt 0 ]; then
          echo "âš ï¸ å®‰å…¨ç‹€æ…‹: è­¦å‘Š - å»ºè­°è™•ç† $WARNING_ISSUES å€‹å•é¡Œ"
        else
          echo "âœ… å®‰å…¨ç‹€æ…‹: è‰¯å¥½ - æœªç™¼ç¾åš´é‡å®‰å…¨å•é¡Œ"
        fi

    - name: ğŸ“¤ ä¸Šå‚³å®‰å…¨å ±å‘Š
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: security-reports-${{ github.run_id }}
        path: |
          bandit-report.json
          semgrep-report.json
          safety-report.json
          pip-audit-report.json
          secrets-baseline.json
        retention-days: 30

    # åƒ…åœ¨ç™¼ç¾åš´é‡å•é¡Œæ™‚å¤±æ•—
    - name: ğŸ”’ å®‰å…¨é–€æª»æª¢æŸ¥
      run: |
        echo "ğŸ”’ æª¢æŸ¥å®‰å…¨é–€æª»..."

        # åƒ…åœ¨æœ‰åš´é‡å•é¡Œæ™‚å¤±æ•— CI
        if [ "${CRITICAL_ISSUES:-0}" -gt 0 ]; then
          echo "âŒ ç™¼ç¾ $CRITICAL_ISSUES å€‹åš´é‡å®‰å…¨å•é¡Œï¼ŒCI å¤±æ•—"
          echo ""
          echo "è«‹æŸ¥çœ‹ä»¥ä¸‹å ±å‘Šä¸¦ä¿®å¾©å•é¡Œï¼š"
          echo "â€¢ Bandit å ±å‘Š: bandit-report.json"
          echo "â€¢ Semgrep å ±å‘Š: semgrep-report.json"
          echo "â€¢ Safety å ±å‘Š: safety-report.json"
          echo ""
          echo "ä¿®å¾©æŒ‡å—:"
          echo "â€¢ é«˜é¢¨éšª Bandit å•é¡Œ: https://bandit.readthedocs.io/"
          echo "â€¢ ä¾è³´æ¼æ´: å‡ç´šæœ‰å•é¡Œçš„å¥—ä»¶åˆ°å®‰å…¨ç‰ˆæœ¬"
          echo "â€¢ Secrets: ç§»é™¤ç¡¬ç·¨ç¢¼çš„æ•æ„Ÿè³‡è¨Š"
          exit 1
        else
          echo "âœ… é€šéå®‰å…¨é–€æª»æª¢æŸ¥"
        fi

  # æ·±åº¦æƒæä½œæ¥­ (åƒ…åœ¨å®šæ™‚åŸ·è¡Œæˆ–æ‰‹å‹•è§¸ç™¼æ™‚)
  deep-scan:
    name: ğŸ”¬ æ·±åº¦å®‰å…¨æƒæ
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.scan_depth == 'deep')
    timeout-minutes: 30

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ğŸ“¦ å®‰è£æ“´å±•å®‰å…¨å·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml] safety semgrep detect-secrets pip-audit
        pip install prospector vulture dlint
        pip install -r requirements.txt

    - name: ğŸ”¬ Prospector æ·±åº¦åˆ†æ
      run: |
        echo "ğŸ”¬ åŸ·è¡Œ Prospector æ·±åº¦ä»£ç¢¼åˆ†æ..."
        prospector --output-format=json --output-file=prospector-report.json . || true
        prospector . || true

    - name: ğŸ¦… Vulture æ­»ä»£ç¢¼æª¢æ¸¬
      run: |
        echo "ğŸ¦… æª¢æ¸¬æ­»ä»£ç¢¼å’Œæœªä½¿ç”¨è®Šæ•¸..."
        vulture . --json > vulture-report.json || true
        vulture . || true

    - name: ğŸ” dlint å®‰å…¨ Lint
      run: |
        echo "ğŸ” åŸ·è¡Œå®‰å…¨ç›¸é—œ Lint æª¢æŸ¥..."
        python -m flake8 --select=DL . || true

    - name: ğŸ“Š æ·±åº¦æƒææ‘˜è¦
      run: |
        echo "ğŸ“Š æ·±åº¦å®‰å…¨æƒææ‘˜è¦"
        echo "===================="

        if [ -f prospector-report.json ]; then
          echo "ğŸ”¬ Prospector æ·±åº¦åˆ†æå®Œæˆ"
        fi

        if [ -f vulture-report.json ]; then
          DEAD_CODE=$(jq 'length' vulture-report.json 2>/dev/null || echo "0")
          echo "ğŸ¦… Vulture: $DEAD_CODE å€‹æ­»ä»£ç¢¼æª¢æ¸¬"
        fi

        echo ""
        echo "æ·±åº¦æƒææœ‰åŠ©æ–¼ç™¼ç¾æ½›åœ¨çš„ä»£ç¢¼å“è³ªå’Œå®‰å…¨å•é¡Œ"
        echo "å»ºè­°å®šæœŸæª¢æŸ¥é€™äº›å ±å‘Šä»¥æ”¹é€²ä»£ç¢¼å“è³ª"

    - name: ğŸ“¤ ä¸Šå‚³æ·±åº¦æƒæå ±å‘Š
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: deep-security-reports-${{ github.run_id }}
        path: |
          prospector-report.json
          vulture-report.json
        retention-days: 90
