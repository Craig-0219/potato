name: ğŸ›¡ï¸ Security Scans

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 é»åŸ·è¡Œå®‰å…¨æƒæ
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.10'

jobs:
  secret-scan:
    name: ğŸ” æ©Ÿå¯†è³‡è¨Šæƒæ
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ” å®‰è£å’Œè¨­ç½® detect-secrets
      run: |
        pip install detect-secrets
        
        # å¦‚æœæ²’æœ‰ baselineï¼Œå‰µå»ºä¸€å€‹
        if [[ ! -f .secrets.baseline ]]; then
          echo "ğŸ†• å‰µå»ºæ–°çš„ secrets baseline..."
          detect-secrets scan --all-files --force-use-all-plugins > .secrets.baseline
        fi
    
    - name: ğŸ”’ æƒææ–°çš„æ©Ÿå¯†è³‡è¨Š
      run: |
        echo "ğŸ” æƒææ–°çš„æ©Ÿå¯†è³‡è¨Š..."
        detect-secrets scan --baseline .secrets.baseline --all-files
        
        if [[ $? -ne 0 ]]; then
          echo "âŒ ç™¼ç¾æ–°çš„æ½œåœ¨æ©Ÿå¯†è³‡è¨Š!"
          echo "è«‹æª¢æŸ¥ä¸¦æ›´æ–° .secrets.baseline æˆ–ç§»é™¤æ©Ÿå¯†è³‡è¨Š"
          exit 1
        else
          echo "âœ… æœªç™¼ç¾æ–°çš„æ©Ÿå¯†è³‡è¨Š"
        fi
    
    - name: ğŸ” é©—è­‰ç¾æœ‰ baseline
      run: |
        echo "ğŸ” é©—è­‰ç¾æœ‰ secrets baseline..."
        detect-secrets audit .secrets.baseline --display-results || true

  bandit-scan:
    name: ğŸ Python å®‰å…¨æƒæ
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ å®‰è£ Bandit
      run: |
        pip install bandit[toml]
    
    - name: ğŸ›¡ï¸ åŸ·è¡Œ Bandit å®‰å…¨æƒæ
      run: |
        echo "ğŸ” åŸ·è¡Œ Python å®‰å…¨æƒæ..."
        
        # ä½¿ç”¨ pyproject.toml ä¸­çš„é…ç½®åŸ·è¡Œ bandit
        bandit -r bot/ shared/ -f json -o bandit-report.json || true
        bandit -r bot/ shared/ -f txt
        
        # æª¢æŸ¥é«˜é¢¨éšªå•é¡Œ
        HIGH_ISSUES=$(bandit -r bot/ shared/ -f json | jq '.results[] | select(.issue_severity == "HIGH") | length' 2>/dev/null || echo "0")
        
        if [[ $HIGH_ISSUES -gt 0 ]]; then
          echo "âš ï¸ ç™¼ç¾ $HIGH_ISSUES å€‹é«˜é¢¨éšªå®‰å…¨å•é¡Œ"
          echo "è«‹æª¢æŸ¥ä¸¦ä¿®å¾©é€™äº›å®‰å…¨å•é¡Œ"
        else
          echo "âœ… æœªç™¼ç¾é«˜é¢¨éšªå®‰å…¨å•é¡Œ"
        fi
    
    - name: ğŸ“Š ä¸Šå‚³ Bandit å ±å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-security-report
        path: bandit-report.json

  semgrep-scan:
    name: ğŸ” Semgrep ç¨‹å¼ç¢¼åˆ†æ
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ” åŸ·è¡Œ Semgrep æƒæ
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/python
          p/security-audit
          p/django
          p/flask
        publishToken: ${{ secrets.SEMGREP_APP_TOKEN }}
        publishDeployment: ${{ github.repository }}
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
    
    - name: ğŸ“‹ Semgrep çµæœæ‘˜è¦
      if: always()
      run: |
        echo "ğŸ” Semgrep ç¨‹å¼ç¢¼å®‰å…¨åˆ†æå®Œæˆ"
        echo "ğŸ“Š åˆ†æè¦å‰‡åŒ…æ‹¬:"
        echo "  â€¢ Python é€šç”¨å®‰å…¨è¦å‰‡"
        echo "  â€¢ å®‰å…¨å¯©è¨ˆè¦å‰‡"
        echo "  â€¢ Django/Flask æ¡†æ¶å®‰å…¨è¦å‰‡"

  dependency-vulnerability:
    name: ğŸš¨ ä¾è³´æ¼æ´æƒæ
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ›¡ï¸ Safety æ¼æ´æƒæ
      run: |
        echo "ğŸ”’ åŸ·è¡Œ Safety æ¼æ´æƒæ..."
        pip install "safety<3.6.0" "typer<0.17"
        
        # åŸ·è¡Œ safety æª¢æŸ¥
        safety check --json --output safety-report.json || true
        safety check --short-report
        
        # æª¢æŸ¥æ˜¯å¦æœ‰é«˜é¢¨éšªæ¼æ´
        if safety check --exit-code; then
          echo "âœ… æœªç™¼ç¾å·²çŸ¥å®‰å…¨æ¼æ´"
        else
          echo "âš ï¸ ç™¼ç¾æ½›åœ¨å®‰å…¨æ¼æ´ï¼Œè«‹æª¢æŸ¥ä¸¦æ›´æ–°ç›¸é—œå¥—ä»¶"
        fi
    
    - name: ğŸ” Pip-audit æƒæ
      run: |
        echo "ğŸ“Š åŸ·è¡Œ pip-audit æƒæ..."
        pip install pip-audit
        
        pip-audit --format=json --output=pip-audit-report.json || true
        pip-audit --format=columns
    
    - name: ğŸ“Š ä¸Šå‚³æ¼æ´å ±å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: vulnerability-reports
        path: |
          safety-report.json
          pip-audit-report.json

  docker-security:
    name: ğŸ³ Docker å®‰å…¨æƒæ
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name != 'pull_request' || contains(github.event.pull_request.changed_files, 'Dockerfile')
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ³ å»ºæ§‹ Docker æ˜ åƒ
      run: |
        echo "ğŸ—ï¸ å»ºæ§‹ Docker æ˜ åƒç”¨æ–¼å®‰å…¨æƒæ..."
        docker build -t potato-bot:security-scan .
    
    - name: ğŸ” å®‰è£ Trivy
      run: |
        sudo apt-get update
        sudo apt-get install wget apt-transport-https gnupg lsb-release
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install trivy
    
    - name: ğŸ›¡ï¸ Trivy æ˜ åƒæƒæ
      run: |
        echo "ğŸ” åŸ·è¡Œ Trivy Docker æ˜ åƒå®‰å…¨æƒæ..."
        
        # æƒæé«˜åš´é‡åº¦æ¼æ´
        trivy image --severity HIGH,CRITICAL --format table potato-bot:security-scan
        
        # ç”¢ç”Ÿ JSON å ±å‘Š
        trivy image --severity HIGH,CRITICAL --format json --output trivy-report.json potato-bot:security-scan
        
        # æª¢æŸ¥æ˜¯å¦æœ‰åš´é‡æ¼æ´
        CRITICAL_COUNT=$(trivy image --severity CRITICAL --format json potato-bot:security-scan | jq '.Results[]?.Vulnerabilities // [] | length' | awk '{sum+=$1} END {print sum+0}')
        
        if [[ $CRITICAL_COUNT -gt 0 ]]; then
          echo "âŒ ç™¼ç¾ $CRITICAL_COUNT å€‹åš´é‡å®‰å…¨æ¼æ´"
          echo "è«‹æ›´æ–°åŸºç¤æ˜ åƒæˆ–ç›¸é—œå¥—ä»¶"
          exit 1
        else
          echo "âœ… æœªç™¼ç¾åš´é‡å®‰å…¨æ¼æ´"
        fi
    
    - name: ğŸ“Š ä¸Šå‚³ Trivy å ±å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: trivy-security-report
        path: trivy-report.json

  security-summary:
    name: ğŸ“‹ å®‰å…¨æƒæç¸½çµ
    needs: [secret-scan, bandit-scan, semgrep-scan, dependency-vulnerability]
    runs-on: ubuntu-latest
    if: always()
    timeout-minutes: 5
    
    steps:
    - name: ğŸ“Š å®‰å…¨æƒæçµæœç¸½çµ
      run: |
        echo "ğŸ›¡ï¸ å®‰å…¨æƒæå®Œæˆç¸½çµ"
        echo ""
        echo "âœ… å·²å®Œæˆçš„å®‰å…¨æª¢æŸ¥:"
        echo "  â€¢ ğŸ” æ©Ÿå¯†è³‡è¨Šæƒæ - ${{ needs.secret-scan.result }}"
        echo "  â€¢ ğŸ Python Bandit æƒæ - ${{ needs.bandit-scan.result }}"
        echo "  â€¢ ğŸ” Semgrep ç¨‹å¼ç¢¼åˆ†æ - ${{ needs.semgrep-scan.result }}"
        echo "  â€¢ ğŸš¨ ä¾è³´æ¼æ´æƒæ - ${{ needs.dependency-vulnerability.result }}"
        echo ""
        
        # æª¢æŸ¥æ˜¯å¦æœ‰å¤±æ•—çš„ä»»å‹™
        if [[ "${{ needs.secret-scan.result }}" == "failure" ]] || 
           [[ "${{ needs.bandit-scan.result }}" == "failure" ]] || 
           [[ "${{ needs.semgrep-scan.result }}" == "failure" ]] || 
           [[ "${{ needs.dependency-vulnerability.result }}" == "failure" ]]; then
          echo "âš ï¸ éƒ¨åˆ†å®‰å…¨æª¢æŸ¥ç™¼ç¾å•é¡Œï¼Œè«‹æª¢æŸ¥è©³ç´°å ±å‘Š"
          echo ""
          echo "ğŸ’¡ å»ºè­°å‹•ä½œ:"
          echo "  1. æª¢æŸ¥å„å€‹å®‰å…¨æƒæçš„è©³ç´°çµæœ"
          echo "  2. ä¿®å¾©ç™¼ç¾çš„å®‰å…¨å•é¡Œ"
          echo "  3. æ›´æ–°ç›¸é—œä¾è³´å¥—ä»¶"
          echo "  4. é‡æ–°åŸ·è¡Œå®‰å…¨æƒæç¢ºèªä¿®å¾©"
        else
          echo "ğŸ‰ æ‰€æœ‰å®‰å…¨æª¢æŸ¥å‡é€šé!"
          echo ""
          echo "ğŸ”’ æ‚¨çš„ç¨‹å¼ç¢¼ç›®å‰ç¬¦åˆå®‰å…¨æ¨™æº–"
        fi