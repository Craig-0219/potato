name: ğŸš¨ Emergency Ptero Rollback

on:
  workflow_dispatch:
    inputs:
      rollback_reason:
        description: 'å›æ»¾åŸå›  (å¿…å¡«)'
        required: true
        type: string
      target_commit:
        description: 'ç›®æ¨™ commit hash (å¯é¸ï¼Œé è¨­å›æ»¾åˆ°ä¸Šä¸€å€‹ç‰ˆæœ¬)'
        required: false
        type: string
      skip_health_check:
        description: 'è·³éå¥åº·æª¢æŸ¥ (ç·Šæ€¥æƒ…æ³ç”¨)'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.10'
  TARGET_BRANCH: 'ptero'

# ç¢ºä¿åŒæ™‚åªæœ‰ä¸€å€‹å›æ»¾æ“ä½œé€²è¡Œ
concurrency:
  group: emergency-rollback-ptero
  cancel-in-progress: false

jobs:
  # ==========================================
  # éšæ®µ 1: å›æ»¾å‰æº–å‚™å’Œé©—è­‰
  # ==========================================
  pre-rollback-validation:
    name: ğŸ” Pre-rollback Validation
    runs-on: ubuntu-latest
    outputs:
      rollback_target: ${{ steps.target.outputs.rollback_target }}
      current_commit: ${{ steps.current.outputs.current_commit }}
      rollback_safe: ${{ steps.safety.outputs.rollback_safe }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 50  # ç²å–è¶³å¤ çš„æ­·å²ä»¥æ‰¾åˆ°ç›®æ¨™commit
          ref: ptero

      - name: ğŸ“‹ æ”¶é›†ç•¶å‰ç‹€æ…‹
        id: current
        run: |
          current_commit=$(git rev-parse HEAD)
          echo "current_commit=$current_commit" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ ç•¶å‰ ptero åˆ†æ”¯ç‹€æ…‹ï¼š"
          echo "  ç•¶å‰ Commit: $current_commit"
          echo "  æœ€å¾Œæäº¤æ™‚é–“: $(git log -1 --format='%cd' --date=iso)"
          echo "  æœ€å¾Œæäº¤è€…: $(git log -1 --format='%an')"
          echo "  æœ€å¾Œæäº¤è¨Šæ¯: $(git log -1 --format='%s')"

      - name: ğŸ¯ ç¢ºå®šå›æ»¾ç›®æ¨™
        id: target
        run: |
          if [ -n "${{ github.event.inputs.target_commit }}" ]; then
            target_commit="${{ github.event.inputs.target_commit }}"
            echo "ä½¿ç”¨æŒ‡å®šçš„ç›®æ¨™ commit: $target_commit"
          else
            # æ‰¾åˆ°ä¸Šä¸€å€‹éƒ¨ç½²commit (æ’é™¤ç•¶å‰commit)
            target_commit=$(git log --skip=1 --format='%H' --grep='ğŸš€ è‡ªå‹•éƒ¨ç½²å¾ main åˆ†æ”¯' | head -1)
            if [ -z "$target_commit" ]; then
              # å¦‚æœæ‰¾ä¸åˆ°è‡ªå‹•éƒ¨ç½²commitï¼Œä½¿ç”¨ä¸Šä¸€å€‹commit
              target_commit=$(git log --skip=1 --format='%H' | head -1)
              echo "æœªæ‰¾åˆ°éƒ¨ç½²commitï¼Œä½¿ç”¨ä¸Šä¸€å€‹commit: $target_commit"
            else
              echo "æ‰¾åˆ°ä¸Šä¸€å€‹éƒ¨ç½²commit: $target_commit"
            fi
          fi
          
          # é©—è­‰ç›®æ¨™commitæ˜¯å¦å­˜åœ¨
          if ! git cat-file -e "$target_commit"; then
            echo "âŒ ç›®æ¨™ commit $target_commit ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "rollback_target=$target_commit" >> $GITHUB_OUTPUT
          
          echo "ğŸ¯ å›æ»¾ç›®æ¨™è©³æƒ…ï¼š"
          echo "  ç›®æ¨™ Commit: $target_commit"
          echo "  ç›®æ¨™æäº¤æ™‚é–“: $(git log -1 --format='%cd' --date=iso $target_commit)"
          echo "  ç›®æ¨™æäº¤è€…: $(git log -1 --format='%an' $target_commit)"
          echo "  ç›®æ¨™æäº¤è¨Šæ¯: $(git log -1 --format='%s' $target_commit)"

      - name: ğŸ›¡ï¸ å®‰å…¨æ€§æª¢æŸ¥
        id: safety
        run: |
          rollback_safe="true"
          target_commit="${{ steps.target.outputs.rollback_target }}"
          current_commit="${{ steps.current.outputs.current_commit }}"
          
          # æª¢æŸ¥æ˜¯å¦å˜—è©¦å›æ»¾åˆ°åŒä¸€å€‹commit
          if [ "$target_commit" = "$current_commit" ]; then
            echo "âš ï¸ ç›®æ¨™commitèˆ‡ç•¶å‰commitç›¸åŒï¼Œç„¡éœ€å›æ»¾"
            rollback_safe="false"
          fi
          
          # æª¢æŸ¥ç›®æ¨™commitçš„å¹´é½¡
          target_date=$(git log -1 --format='%ct' $target_commit)
          current_date=$(date +%s)
          days_diff=$(( (current_date - target_date) / 86400 ))
          
          if [ $days_diff -gt 7 ]; then
            echo "âš ï¸ è­¦å‘Šï¼šç›®æ¨™commitè¶…é7å¤©å‰ ($days_diff å¤©å‰)"
            echo "é€™å¯èƒ½å°è‡´é‡å¤§åŠŸèƒ½å›é€€ï¼Œè«‹ç¢ºèªæ˜¯å¦éœ€è¦å¦‚æ­¤å¤§å¹…åº¦çš„å›æ»¾"
          fi
          
          echo "rollback_safe=$rollback_safe" >> $GITHUB_OUTPUT
          
          if [ "$rollback_safe" = "false" ]; then
            echo "ğŸ›‘ å›æ»¾å®‰å…¨æª¢æŸ¥æœªé€šé"
          else
            echo "âœ… å›æ»¾å®‰å…¨æª¢æŸ¥é€šé"
          fi

  # ==========================================
  # éšæ®µ 2: åŸ·è¡Œç·Šæ€¥å›æ»¾
  # ==========================================
  emergency-rollback:
    name: ğŸš¨ Execute Emergency Rollback
    runs-on: ubuntu-latest
    needs: pre-rollback-validation
    if: needs.pre-rollback-validation.outputs.rollback_safe == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 50
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ é…ç½® Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸš¨ åŸ·è¡Œç·Šæ€¥å›æ»¾
        run: |
          target_commit="${{ needs.pre-rollback-validation.outputs.rollback_target }}"
          
          echo "ğŸš¨ é–‹å§‹ç·Šæ€¥å›æ»¾æ“ä½œ..."
          echo "  å¾: ${{ needs.pre-rollback-validation.outputs.current_commit }}"
          echo "  åˆ°: $target_commit"
          echo "  åŸå› : ${{ github.event.inputs.rollback_reason }}"
          
          # åˆ‡æ›åˆ° ptero åˆ†æ”¯
          git checkout ptero
          
          # åŸ·è¡Œå¼·åˆ¶å›æ»¾
          git reset --hard $target_commit
          
          echo "âœ… æœ¬åœ°å›æ»¾å®Œæˆ"

      - name: ğŸ“ å‰µå»ºå›æ»¾è¨˜éŒ„
        run: |
          # å‰µå»ºå›æ»¾è³‡è¨Šæ–‡ä»¶
          cat > ROLLBACK_INFO.md << EOF
          # ğŸš¨ ç·Šæ€¥å›æ»¾è¨˜éŒ„
          
          **å›æ»¾æ™‚é–“**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **å›æ»¾åŸå› **: ${{ github.event.inputs.rollback_reason }}
          **æ“ä½œè€…**: ${{ github.actor }}
          **åŸå§‹ Commit**: ${{ needs.pre-rollback-validation.outputs.current_commit }}
          **å›æ»¾åˆ° Commit**: ${{ needs.pre-rollback-validation.outputs.rollback_target }}
          **GitHub Run ID**: ${{ github.run_id }}
          
          ## ğŸ”„ å›æ»¾æ“ä½œè©³æƒ…
          
          - [x] å®‰å…¨æ€§æª¢æŸ¥é€šé
          - [x] ç›®æ¨™commité©—è­‰å®Œæˆ
          - [x] å¼·åˆ¶å›æ»¾åŸ·è¡ŒæˆåŠŸ
          - [ ] å¥åº·æª¢æŸ¥ (å–æ±ºæ–¼è¨­å®š)
          
          ## ğŸ”— ç›¸é—œé€£çµ
          
          - [å›æ»¾æ—¥èªŒ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [åŸå§‹Commit](https://github.com/${{ github.repository }}/commit/${{ needs.pre-rollback-validation.outputs.current_commit }})
          - [å›æ»¾ç›®æ¨™Commit](https://github.com/${{ github.repository }}/commit/${{ needs.pre-rollback-validation.outputs.rollback_target }})
          
          ---
          
          > âš ï¸ é€™æ˜¯ç·Šæ€¥å›æ»¾æ“ä½œï¼Œè«‹ç¢ºä¿ç›¸é—œåœ˜éšŠæˆå“¡å·²å¾—åˆ°é€šçŸ¥
          > ğŸ¤– ç·Šæ€¥å›æ»¾ç³»çµ± v1.0
          EOF
          
          # ç”ŸæˆJSONæ ¼å¼çš„å›æ»¾è³‡è¨Š
          cat > .rollback_info.json << EOF
          {
            "rollback_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "rollback_reason": "${{ github.event.inputs.rollback_reason }}",
            "operator": "${{ github.actor }}",
            "from_commit": "${{ needs.pre-rollback-validation.outputs.current_commit }}",
            "to_commit": "${{ needs.pre-rollback-validation.outputs.rollback_target }}",
            "run_id": "${{ github.run_id }}",
            "type": "emergency_rollback"
          }
          EOF
          
          echo "ğŸ“ å›æ»¾è¨˜éŒ„å‰µå»ºå®Œæˆ"

      - name: ğŸš€ æ¨é€å›æ»¾è®Šæ›´
        run: |
          echo "ğŸš€ æ¨é€å›æ»¾è®Šæ›´åˆ° ptero åˆ†æ”¯..."
          
          # æ·»åŠ å›æ»¾æ–‡ä»¶
          git add ROLLBACK_INFO.md .rollback_info.json
          
          # å‰µå»ºå›æ»¾æäº¤
          git commit -m "ğŸš¨ ç·Šæ€¥å›æ»¾æ“ä½œ

          å›æ»¾åŸå› : ${{ github.event.inputs.rollback_reason }}
          å›æ»¾æ™‚é–“: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          æ“ä½œè€…: ${{ github.actor }}
          
          åŸå§‹ Commit: ${{ needs.pre-rollback-validation.outputs.current_commit }}
          å›æ»¾åˆ° Commit: ${{ needs.pre-rollback-validation.outputs.rollback_target }}
          
          ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
          
          Co-Authored-By: Claude <noreply@anthropic.com>"
          
          # å¼·åˆ¶æ¨é€ï¼ˆå› ç‚ºæ˜¯å›æ»¾æ“ä½œï¼‰
          git push --force-with-lease origin ptero
          
          echo "âœ… å›æ»¾è®Šæ›´å·²æ¨é€åˆ° ptero åˆ†æ”¯"

  # ==========================================
  # éšæ®µ 3: å›æ»¾å¾Œå¥åº·æª¢æŸ¥
  # ==========================================
  post-rollback-health-check:
    name: ğŸ©º Post-rollback Health Check
    runs-on: ubuntu-latest
    needs: [pre-rollback-validation, emergency-rollback]
    if: needs.emergency-rollback.result == 'success' && github.event.inputs.skip_health_check != 'true'

    steps:
      - name: Checkout rolled-back ptero branch
        uses: actions/checkout@v4
        with:
          ref: ptero
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ©º é©—è­‰å›æ»¾å¾Œå®Œæ•´æ€§
        run: |
          echo "ğŸ©º é©—è­‰å›æ»¾å¾Œçš„ ptero åˆ†æ”¯å®Œæ•´æ€§..."
          
          # æª¢æŸ¥å¿…è¦æ–‡ä»¶
          required_files=("bot/main.py" "requirements.txt" ".env.example" "start.py")
          missing_files=0
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file"
            else
              echo "âŒ ç¼ºå¤±: $file"
              missing_files=$((missing_files + 1))
            fi
          done
          
          if [ $missing_files -gt 0 ]; then
            echo "âš ï¸ è­¦å‘Šï¼šå›æ»¾å¾Œç¼ºå¤± $missing_files å€‹å¿…è¦æ–‡ä»¶"
            echo "é€™å¯èƒ½éœ€è¦é€²ä¸€æ­¥çš„ä¿®å¾©æ“ä½œ"
          fi
          
          # åŸºæœ¬èªæ³•æª¢æŸ¥
          if [ -f "bot/main.py" ]; then
            python -m py_compile bot/main.py && echo "âœ… ä¸»ç¨‹åºèªæ³•æª¢æŸ¥é€šé" || echo "âŒ ä¸»ç¨‹åºèªæ³•æª¢æŸ¥å¤±æ•—"
          fi
          
          echo "ğŸ©º å›æ»¾å®Œæ•´æ€§æª¢æŸ¥å®Œæˆ"

      - name: ğŸ“Š ç”Ÿæˆå›æ»¾é©—è­‰å ±å‘Š
        run: |
          echo "ğŸ“Š ç”Ÿæˆå›æ»¾é©—è­‰å ±å‘Š..."
          
          current_commit=$(git rev-parse HEAD)
          file_count=$(find . -type f -not -path "./.git/*" | wc -l)
          
          echo "ğŸ“‹ å›æ»¾å¾Œ Ptero åˆ†æ”¯ç‹€æ…‹å ±å‘Š"
          echo "=================================="
          echo "ğŸ”„ ç•¶å‰ Commit: $current_commit"
          echo "ğŸ“ æª”æ¡ˆç¸½æ•¸: $file_count"
          echo "ğŸ•’ é©—è­‰æ™‚é–“: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "ğŸ¯ å›æ»¾ç›®æ¨™: ${{ needs.pre-rollback-validation.outputs.rollback_target }}"
          echo "ğŸ“ å›æ»¾åŸå› : ${{ github.event.inputs.rollback_reason }}"
          echo "=================================="
          
          # é©—è­‰å›æ»¾æ˜¯å¦æˆåŠŸ
          if [ "$current_commit" = "${{ needs.pre-rollback-validation.outputs.rollback_target }}" ]; then
            echo "âœ… å›æ»¾æˆåŠŸï¼šç•¶å‰commitç¬¦åˆé æœŸç›®æ¨™"
          else
            echo "âŒ å›æ»¾å¯èƒ½å¤±æ•—ï¼šç•¶å‰commitèˆ‡ç›®æ¨™ä¸ç¬¦"
            echo "   é æœŸ: ${{ needs.pre-rollback-validation.outputs.rollback_target }}"
            echo "   å¯¦éš›: $current_commit"
          fi
          
          echo "âœ… å›æ»¾é©—è­‰å ±å‘Šç”Ÿæˆå®Œæˆ"

  # ==========================================
  # éšæ®µ 4: é€šçŸ¥å’Œå¾ŒçºŒè™•ç†
  # ==========================================
  rollback-notification:
    name: ğŸ“¢ Rollback Notification
    runs-on: ubuntu-latest
    needs: [pre-rollback-validation, emergency-rollback, post-rollback-health-check]
    if: always() && needs.pre-rollback-validation.outputs.rollback_safe == 'true'

    steps:
      - name: ğŸ“Š å›æ»¾æ“ä½œç¸½çµ
        run: |
          echo "ğŸ“Š ç·Šæ€¥å›æ»¾æ“ä½œç¸½çµ"
          echo "=================================="
          echo "ğŸš¨ æ“ä½œé¡å‹: ç·Šæ€¥å›æ»¾"
          echo "ğŸ“ å›æ»¾åŸå› : ${{ github.event.inputs.rollback_reason }}"
          echo "ğŸ‘¤ æ“ä½œè€…: ${{ github.actor }}"
          echo "ğŸ•’ æ“ä½œæ™‚é–“: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "ğŸ”„ å·¥ä½œæµç¨‹ ID: ${{ github.run_id }}"
          echo "=================================="
          
          # æª¢æŸ¥å„éšæ®µçµæœ
          rollback_result="${{ needs.emergency-rollback.result }}"
          health_result="${{ needs.post-rollback-health-check.result || 'skipped' }}"
          
          echo "ğŸ“‹ éšæ®µçµæœæ‘˜è¦:"
          echo "  ğŸš¨ ç·Šæ€¥å›æ»¾: $rollback_result"
          echo "  ğŸ©º å¥åº·æª¢æŸ¥: $health_result"
          echo "=================================="
          
          if [ "$rollback_result" = "success" ]; then
            echo "âœ… ç·Šæ€¥å›æ»¾æ“ä½œæˆåŠŸå®Œæˆ"
            echo "ğŸ¯ Ptero åˆ†æ”¯å·²å›æ»¾åˆ°: ${{ needs.pre-rollback-validation.outputs.rollback_target }}"
            echo "ğŸŒ Pterodactyl ç’°å¢ƒæ‡‰è©²æœƒè‡ªå‹•æ›´æ–°åˆ°å›æ»¾ç‰ˆæœ¬"
            
            echo ""
            echo "ğŸ”— é‡è¦é€£çµ:"
            echo "  â€¢ å›æ»¾æ—¥èªŒ: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo "  â€¢ Ptero åˆ†æ”¯: https://github.com/${{ github.repository }}/tree/ptero"
            echo "  â€¢ ç›®æ¨™ Commit: https://github.com/${{ github.repository }}/commit/${{ needs.pre-rollback-validation.outputs.rollback_target }}"
            
            echo ""
            echo "âš ï¸  é‡è¦æé†’:"
            echo "  1. è«‹é©—è­‰ Pterodactyl ç’°å¢ƒæ˜¯å¦æ­£å¸¸é‹ä½œ"
            echo "  2. é€šçŸ¥ç›¸é—œåœ˜éšŠæˆå“¡å›æ»¾å·²å®Œæˆ"
            echo "  3. è€ƒæ…®èª¿æŸ¥ä¸¦ä¿®å¾©å°è‡´å›æ»¾çš„åŸå§‹å•é¡Œ"
            echo "  4. å¿…è¦æ™‚å¯æº–å‚™é‡æ–°éƒ¨ç½²ä¿®å¾©ç‰ˆæœ¬"
            
          else
            echo "âŒ ç·Šæ€¥å›æ»¾æ“ä½œå¤±æ•—"
            echo "ğŸ’¥ è«‹æŸ¥çœ‹ä¸Šè¿°æ—¥èªŒäº†è§£å¤±æ•—åŸå› "
            
            echo ""
            echo "ğŸ› ï¸ å¤±æ•—è™•ç†å»ºè­°:"
            echo "  1. æª¢æŸ¥ Git æ¬Šé™å’Œåˆ†æ”¯ç‹€æ…‹"
            echo "  2. é©—è­‰ç›®æ¨™ commit æ˜¯å¦æœ‰æ•ˆ"
            echo "  3. è€ƒæ…®æ‰‹å‹•å›æ»¾æ“ä½œ"
            echo "  4. è¯ç¹«æŠ€è¡“åœ˜éšŠå”åŠ©è™•ç†"
          fi
          
      - name: ğŸš¨ é—œéµè­¦å‘Š
        if: needs.emergency-rollback.result == 'success'
        run: |
          echo "ğŸš¨ ==================== é—œéµè­¦å‘Š ==================== ğŸš¨"
          echo ""
          echo "ç·Šæ€¥å›æ»¾æ“ä½œå·²å®Œæˆï¼Œä½†è«‹æ³¨æ„ä»¥ä¸‹é‡è¦äº‹é …ï¼š"
          echo ""
          echo "1. ğŸ”„ é€™æ˜¯ä¸€å€‹å¼·åˆ¶å›æ»¾æ“ä½œï¼Œå¯èƒ½æœƒéºå¤±æœ€æ–°çš„åŠŸèƒ½æˆ–ä¿®å¾©"
          echo "2. ğŸ“Š è«‹ç¢ºèª Pterodactyl ç’°å¢ƒä¸­çš„æ‡‰ç”¨ç¨‹å¼å·²æ­£ç¢ºé‡å•Ÿ"
          echo "3. ğŸ§ª å»ºè­°é€²è¡ŒåŸºæœ¬åŠŸèƒ½æ¸¬è©¦ä»¥ç¢ºä¿ç³»çµ±ç©©å®šæ€§"
          echo "4. ğŸ“ è¨˜éŒ„æ­¤æ¬¡å›æ»¾äº‹ä»¶ä»¥ä¾¿å¾ŒçºŒåˆ†æ"
          echo "5. ğŸ”§ æº–å‚™ä¿®å¾©åŸå§‹å•é¡Œä¸¦é‡æ–°éƒ¨ç½²æ­£ç¢ºç‰ˆæœ¬"
          echo ""
          echo "ğŸš¨ ================================================== ğŸš¨"