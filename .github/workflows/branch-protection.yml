name: Branch Protection - Prevent Unauthorized Branch Merges

on:
  pull_request:
    branches: [main, dev]
    types: [opened, synchronize, reopened]

jobs:
  prevent-dev-to-main-merge:
    runs-on: ubuntu-latest
    if: github.head_ref == 'dev' && github.base_ref == 'main'
    
    steps:
      - name: Prevent Dev to Main Merge
        run: |
          echo "❌ BLOCKED: Direct merge from dev to main is not allowed"
          echo "🔄 Please use the smart-auto-merge workflow instead"
          echo "📋 Allowed merge paths:"
          echo "   1. dev → main (via smart-auto-merge workflow)"
          echo "   2. feature/* → dev (direct PR)"
          echo "   3. hotfix/* → main (emergency only)"
          exit 1

  prevent-main-to-dev-merge:
    runs-on: ubuntu-latest
    if: github.head_ref == 'main' && github.base_ref == 'dev'
    
    steps:
      - name: Prevent Main to Dev Merge
        run: |
          echo "❌ BLOCKED: Direct merge from main to dev is not allowed"
          echo "🚨 This prevents data loss in dev branch"
          echo "📋 Correct workflow:"
          echo "   1. Development should flow: feature/* → dev → main"
          echo "   2. If main has hotfixes, create feature branch from main"
          echo "   3. Then merge: hotfix-feature → dev → main"
          echo "   4. Never directly merge main → dev"
          exit 1

  branch-policy-check:
    runs-on: ubuntu-latest
    if: github.head_ref != 'dev'
    
    steps:
      - name: Check Branch Policy
        run: |
          echo "✅ Branch policy check passed"
          echo "🔍 Source branch: ${{ github.head_ref }}"
          echo "🎯 Target branch: ${{ github.base_ref }}"
          
          case "${{ github.head_ref }}" in
            hotfix/*)
              echo "🚨 Hotfix branch detected - allowing emergency merge to main"
              ;;
            feature/*)
              echo "❌ Feature branches should merge to dev, not main"
              exit 1
              ;;
            bugfix/*)
              echo "❌ Bugfix branches should merge to dev, not main"
              exit 1
              ;;
            *)
              echo "⚠️ Unknown branch pattern - please follow naming convention"
              echo "📝 Allowed patterns: feature/*, bugfix/*, hotfix/*"
              exit 1
              ;;
          esac

  notify-correct-workflow:
    runs-on: ubuntu-latest
    
    steps:
      - name: Provide Guidance
        run: |
          echo "📚 Branch Management Guidelines:"
          echo ""
          echo "🔄 For dev → main merges:"
          echo "   Use: smart-auto-merge workflow (automatic)"
          echo "   Trigger: Push to dev branch"
          echo ""
          echo "🆕 For feature development:"
          echo "   Create: feature/your-feature-name"
          echo "   Target: dev branch"
          echo ""
          echo "🐛 For bug fixes:"
          echo "   Create: bugfix/fix-description"
          echo "   Target: dev branch"
          echo ""
          echo "🚨 For emergency hotfixes:"
          echo "   Create: hotfix/critical-fix"
          echo "   Target: main branch (allowed)"