name: Branch Protection - Prevent Main from Merging Dev

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  prevent-dev-to-main-merge:
    runs-on: ubuntu-latest
    if: github.head_ref == 'dev'
    
    steps:
      - name: Prevent Dev to Main Merge
        run: |
          echo "âŒ BLOCKED: Direct merge from dev to main is not allowed"
          echo "ğŸ”„ Please use the smart-auto-merge workflow instead"
          echo "ğŸ“‹ Allowed merge paths:"
          echo "   1. dev â†’ main (via smart-auto-merge workflow)"
          echo "   2. feature/* â†’ dev (direct PR)"
          echo "   3. hotfix/* â†’ main (emergency only)"
          exit 1

  branch-policy-check:
    runs-on: ubuntu-latest
    if: github.head_ref != 'dev'
    
    steps:
      - name: Check Branch Policy
        run: |
          echo "âœ… Branch policy check passed"
          echo "ğŸ” Source branch: ${{ github.head_ref }}"
          echo "ğŸ¯ Target branch: ${{ github.base_ref }}"
          
          case "${{ github.head_ref }}" in
            hotfix/*)
              echo "ğŸš¨ Hotfix branch detected - allowing emergency merge to main"
              ;;
            feature/*)
              echo "âŒ Feature branches should merge to dev, not main"
              exit 1
              ;;
            bugfix/*)
              echo "âŒ Bugfix branches should merge to dev, not main"
              exit 1
              ;;
            *)
              echo "âš ï¸ Unknown branch pattern - please follow naming convention"
              echo "ğŸ“ Allowed patterns: feature/*, bugfix/*, hotfix/*"
              exit 1
              ;;
          esac

  notify-correct-workflow:
    runs-on: ubuntu-latest
    
    steps:
      - name: Provide Guidance
        run: |
          echo "ğŸ“š Branch Management Guidelines:"
          echo ""
          echo "ğŸ”„ For dev â†’ main merges:"
          echo "   Use: smart-auto-merge workflow (automatic)"
          echo "   Trigger: Push to dev branch"
          echo ""
          echo "ğŸ†• For feature development:"
          echo "   Create: feature/your-feature-name"
          echo "   Target: dev branch"
          echo ""
          echo "ğŸ› For bug fixes:"
          echo "   Create: bugfix/fix-description"
          echo "   Target: dev branch"
          echo ""
          echo "ğŸš¨ For emergency hotfixes:"
          echo "   Create: hotfix/critical-fix"
          echo "   Target: main branch (allowed)"