name: ğŸš€ Auto Merge Dev to Main

# è§¸ç™¼æ¢ä»¶ï¼šç•¶ dev åˆ†æ”¯æœ‰æ–°çš„æ¨é€æ™‚
on:
  push:
    branches: [dev]
    paths:
      # åªæœ‰ç•¶é€™äº›è·¯å¾‘ç™¼ç”Ÿè®ŠåŒ–æ™‚æ‰è§¸ç™¼è‡ªå‹•åˆä½µ
      - 'bot/**'
      - 'shared/**'
      - 'web-ui/**'
      - 'requirements.txt'
      - 'docs/user-guides/**'
      - 'docs/system/**'
      - 'CHANGELOG.md'
      - 'QUICK_START.md'
      - 'start.py'
      - 'start.sh'
      - 'start.bat'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - 'pyproject.toml'

  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      merge_type:
        description: 'åˆä½µé¡å‹'
        required: true
        default: 'selective'
        type: choice
        options:
        - selective
        - full
      skip_tests:
        description: 'è·³éæ¸¬è©¦'
        required: false
        default: false
        type: boolean

jobs:
  # éšæ®µ 1: é æª¢æŸ¥
  pre-checks:
    runs-on: ubuntu-latest
    outputs:
      should_merge: ${{ steps.check.outputs.should_merge }}
      test_passed: ${{ steps.test.outputs.passed }}

    steps:
    - name: ğŸ“¥ Checkout Dev Branch
      uses: actions/checkout@v4
      with:
        ref: dev
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ” Check Commit Messages
      id: check
      run: |
        # æª¢æŸ¥æœ€æ–°æäº¤æ˜¯å¦åŒ…å«ç‰¹å®šæ¨™è¨˜
        LATEST_COMMIT=$(git log -1 --pretty=%B)
        echo "Latest commit: $LATEST_COMMIT"

        # å¦‚æœæäº¤è¨Šæ¯åŒ…å« [no-merge] å‰‡è·³éåˆä½µ
        if echo "$LATEST_COMMIT" | grep -q "\[no-merge\]"; then
          echo "ğŸš« æäº¤åŒ…å« [no-merge] æ¨™è¨˜ï¼Œè·³éè‡ªå‹•åˆä½µ"
          echo "should_merge=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        # å¦‚æœæäº¤è¨Šæ¯åŒ…å« [merge] å‰‡å¼·åˆ¶åˆä½µ
        if echo "$LATEST_COMMIT" | grep -q "\[merge\]"; then
          echo "âœ… æäº¤åŒ…å« [merge] æ¨™è¨˜ï¼ŒåŸ·è¡Œè‡ªå‹•åˆä½µ"
          echo "should_merge=true" >> $GITHUB_OUTPUT
          exit 0
        fi

        # æª¢æŸ¥æ˜¯å¦åªæ˜¯æ–‡æª”è®Šæ›´
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        echo "Changed files: $CHANGED_FILES"

        # å¦‚æœåªæ”¹è®Šäº†é–‹ç™¼æ–‡æª”ï¼Œå‰‡è·³éåˆä½µ
        if echo "$CHANGED_FILES" | grep -v "^docs/plans/\|^docs/archived/\|^IMPLEMENTATION_PLAN.md" | grep -q "."; then
          echo "âœ… åŒ…å«ç”Ÿç”¢ç›¸é—œè®Šæ›´ï¼ŒåŸ·è¡Œè‡ªå‹•åˆä½µ"
          echo "should_merge=true" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“‹ åªåŒ…å«é–‹ç™¼æ–‡æª”è®Šæ›´ï¼Œè·³éè‡ªå‹•åˆä½µ"
          echo "should_merge=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ§ª Quick Syntax Test
      id: test
      if: steps.check.outputs.should_merge == 'true' && !inputs.skip_tests
      run: |
        # å¿«é€Ÿèªæ³•æª¢æŸ¥
        echo "ğŸ” åŸ·è¡Œå¿«é€Ÿèªæ³•æª¢æŸ¥..."

        # æª¢æŸ¥ Python èªæ³•
        find bot/ -name "*.py" -exec python -m py_compile {} \; || {
          echo "âŒ Python èªæ³•æª¢æŸ¥å¤±æ•—"
          echo "passed=false" >> $GITHUB_OUTPUT
          exit 1
        }

        # æª¢æŸ¥é‡è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [[ ! -f "bot/main.py" || ! -f "requirements.txt" ]]; then
          echo "âŒ é—œéµæ–‡ä»¶ç¼ºå¤±"
          echo "passed=false" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "âœ… èªæ³•æª¢æŸ¥é€šé"
        echo "passed=true" >> $GITHUB_OUTPUT

  # éšæ®µ 2: é¸æ“‡æ€§åˆä½µ
  selective-merge:
    needs: pre-checks
    if: needs.pre-checks.outputs.should_merge == 'true' && needs.pre-checks.outputs.test_passed == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Main Branch
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: âš™ï¸ Configure Git
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git config merge.ours.driver true

    - name: ğŸ”„ Fetch Latest Dev
      run: |
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
        git fetch origin dev

    - name: ğŸ“‹ Selective Merge Strategy
      id: merge
      run: |
        echo "ğŸ¯ é–‹å§‹é¸æ“‡æ€§åˆä½µ dev â†’ main"

        # ä½¿ç”¨ .gitattributes ç­–ç•¥åˆä½µ
        if git merge origin/dev --no-edit -m "ğŸš€ Auto-merge dev to main

        ğŸ¤– è‡ªå‹•åˆä½µ (Selective Strategy)
        â° $(date '+%Y-%m-%d %H:%M:%S UTC')
        ğŸ“ æäº¤: $(git rev-parse --short origin/dev)

        âœ… åˆä½µå…§å®¹:
        â€¢ ç”Ÿç”¢ä»£ç¢¼è®Šæ›´
        â€¢ ç”¨æˆ¶æ–‡æª”æ›´æ–°
        â€¢ ç³»çµ±é…ç½®æ–‡ä»¶

        ğŸš« æ’é™¤å…§å®¹:
        â€¢ é–‹ç™¼è¨ˆåŠƒæ–‡æª”
        â€¢ ä¿®å¾©æ­·ç¨‹è¨˜éŒ„
        â€¢ é–‹ç™¼å·¥å…·è…³æœ¬

        Generated by GitHub Actions"; then
          echo "âœ… åˆä½µæˆåŠŸ"
          echo "merge_success=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ åˆä½µè¡çªï¼Œéœ€è¦äººå·¥è™•ç†"
          echo "merge_success=false" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: ğŸ“¤ Push to Main
      if: steps.merge.outputs.merge_success == 'true'
      run: |
        echo "ğŸš€ æ¨é€åˆä½µçµæœåˆ° main åˆ†æ”¯"
        git push origin main

    - name: ğŸ“Š Create Summary Comment
      if: steps.merge.outputs.merge_success == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const merge_commit = await github.rest.repos.getCommit({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: 'main'
          });

          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: merge_commit.data.sha,
            body: `ğŸš€ **è‡ªå‹•åˆä½µå®Œæˆ**

            ğŸ“Š **åˆä½µæ‘˜è¦:**
            - æºåˆ†æ”¯: \`dev\`
            - ç›®æ¨™åˆ†æ”¯: \`main\`
            - åˆä½µç­–ç•¥: é¸æ“‡æ€§åˆä½µ
            - åŸ·è¡Œæ™‚é–“: \`${new Date().toISOString()}\`

            âœ… **æˆåŠŸåˆä½µçš„å…§å®¹:**
            - ç”Ÿç”¢ä»£ç¢¼å’Œé…ç½®
            - ç”¨æˆ¶æ–‡æª”æ›´æ–°
            - ç³»çµ±è¨­ç½®æ–‡ä»¶

            ğŸ”’ **main åˆ†æ”¯ä¿è­·:**
            - é–‹ç™¼æ–‡æª”æœªè¢«è¦†è“‹
            - ä¿®å¾©è¨ˆåŠƒä¿æŒåˆ†é›¢
            - ç”Ÿç”¢ç‰ˆæœ¬ä¿æŒä¹¾æ·¨

            ğŸ¤– æ­¤åˆä½µç”± GitHub Actions è‡ªå‹•åŸ·è¡Œ`
          });

  # éšæ®µ 3: åˆä½µå¤±æ•—è™•ç†
  merge-failure:
    needs: [pre-checks, selective-merge]
    if: failure() && needs.pre-checks.outputs.should_merge == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“§ Create Issue for Manual Review
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸš¨ è‡ªå‹•åˆä½µå¤±æ•— - éœ€è¦äººå·¥è™•ç†',
            body: `## ğŸš¨ è‡ªå‹•åˆä½µå¤±æ•—å ±å‘Š

            **â° å¤±æ•—æ™‚é–“:** ${new Date().toISOString()}
            **ğŸ“ è§¸ç™¼æäº¤:** ${context.sha}
            **ğŸ”— å·¥ä½œæµç¨‹:** [æŸ¥çœ‹è©³æƒ…](${context.payload.repository.html_url}/actions/runs/${context.runId})

            ## ğŸ” å¯èƒ½åŸå› 
            - âŒ åˆä½µè¡çªéœ€è¦äººå·¥è§£æ±º
            - âŒ èªæ³•æª¢æŸ¥æœªé€šé
            - âŒ é—œéµæ–‡ä»¶ç¼ºå¤±æˆ–æå£

            ## ğŸ› ï¸ è™•ç†æ­¥é©Ÿ
            1. æª¢æŸ¥ [Actions æ—¥èªŒ](${context.payload.repository.html_url}/actions/runs/${context.runId}) äº†è§£å…·é«”å¤±æ•—åŸå› 
            2. åœ¨æœ¬åœ°åŸ·è¡Œæ‰‹å‹•åˆä½µï¼š
               \`\`\`bash
               git checkout main
               git pull origin main
               git merge origin/dev
               # è§£æ±ºè¡çªå¾Œ
               git push origin main
               \`\`\`
            3. åˆä½µå®Œæˆå¾Œé—œé–‰æ­¤ Issue

            ## ğŸ“‹ æª¢æŸ¥æ¸…å–®
            - [ ] æª¢æŸ¥åˆä½µè¡çª
            - [ ] ç¢ºèªèªæ³•æ­£ç¢ºæ€§
            - [ ] é©—è­‰æ ¸å¿ƒåŠŸèƒ½
            - [ ] æ¸¬è©¦ç”Ÿç”¢éƒ¨ç½²

            /label bug,auto-merge,needs-review`,
            labels: ['bug', 'auto-merge', 'needs-review']
          });

  # éšæ®µ 4: é€šçŸ¥
  notify:
    needs: [pre-checks, selective-merge]
    if: always()
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¢ Slack/Discord Notification (Optional)
      if: needs.selective-merge.result == 'success'
      run: |
        echo "ğŸ‰ è‡ªå‹•åˆä½µæˆåŠŸé€šçŸ¥"
        echo "å¯ä»¥åœ¨é€™è£¡æ·»åŠ  Slack æˆ– Discord Webhook é€šçŸ¥"
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"âœ… Potato Bot: è‡ªå‹•åˆä½µ dev â†’ main æˆåŠŸå®Œæˆ!"}' \
        #   $SLACK_WEBHOOK_URL
