name: ğŸš€ Simple Production Deploy

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.github/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç’°å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

permissions:
  contents: write

jobs:
  deploy:
    name: ğŸš€ éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ·ï¸ ç”Ÿæˆç‰ˆæœ¬æ¨™ç±¤
      id: version
      run: |
        TIMESTAMP=$(date -u '+%Y%m%d-%H%M%S')
        COMMIT_HASH=$(git rev-parse --short HEAD)
        VERSION_TAG="v${TIMESTAMP}-${COMMIT_HASH}"
        echo "tag=$VERSION_TAG" >> $GITHUB_OUTPUT
        echo "ğŸ“‹ ç‰ˆæœ¬: $VERSION_TAG"

    - name: ğŸ” åŸºæœ¬æª¢æŸ¥
      run: |
        echo "ğŸ” æª¢æŸ¥æ ¸å¿ƒæ–‡ä»¶..."
        test -f bot/main.py || { echo "âŒ ç¼ºå°‘ bot/main.py"; exit 1; }
        test -f requirements.txt || { echo "âŒ ç¼ºå°‘ requirements.txt"; exit 1; }
        test -f start.py || { echo "âŒ ç¼ºå°‘ start.py"; exit 1; }
        echo "âœ… æ ¸å¿ƒæ–‡ä»¶æª¢æŸ¥é€šé"

    - name: ğŸš€ æ¨é€åˆ° ptero éƒ¨ç½²åˆ†æ”¯
      run: |
        echo "ğŸš€ æº–å‚™éƒ¨ç½²åˆ†æ”¯..."

        # é…ç½® Git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # å‰µå»ºæˆ–åˆ‡æ›åˆ° ptero åˆ†æ”¯
        git fetch origin ptero:ptero || git checkout -b ptero
        git checkout ptero

        # åˆä½µ main åˆ†æ”¯çš„è®Šæ›´
        git merge main --no-edit

        # æ¨é€åˆ°é ç«¯
        git push origin ptero

        echo "âœ… éƒ¨ç½²åˆ†æ”¯æ›´æ–°å®Œæˆ"

    - name: ğŸ“Š éƒ¨ç½²çµ±è¨ˆ
      run: |
        echo "ğŸ“Š éƒ¨ç½²çµ±è¨ˆ"
        echo "==================="
        echo "ç‰ˆæœ¬: ${{ steps.version.outputs.tag }}"
        echo "åˆ†æ”¯: main â†’ ptero"
        echo "æäº¤: $(git rev-parse --short HEAD)"
        echo "æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ç’°å¢ƒ: ${{ github.event.inputs.environment || 'production' }}"
