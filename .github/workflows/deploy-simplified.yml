name: ğŸš€ Simple Production Deploy

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.github/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç’°å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

permissions:
  contents: write

jobs:
  deploy:
    name: ğŸš€ éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ·ï¸ ç”Ÿæˆç‰ˆæœ¬æ¨™ç±¤
      id: version
      run: |
        TIMESTAMP=$(date -u '+%Y%m%d-%H%M%S')
        COMMIT_HASH=$(git rev-parse --short HEAD)
        VERSION_TAG="v${TIMESTAMP}-${COMMIT_HASH}"
        echo "tag=$VERSION_TAG" >> $GITHUB_OUTPUT
        echo "ğŸ“‹ ç‰ˆæœ¬: $VERSION_TAG"

    - name: ğŸ” åŸºæœ¬æª¢æŸ¥
      run: |
        echo "ğŸ” æª¢æŸ¥æ ¸å¿ƒæ–‡ä»¶..."
        test -f bot/main.py || { echo "âŒ ç¼ºå°‘ bot/main.py"; exit 1; }
        test -f requirements.txt || { echo "âŒ ç¼ºå°‘ requirements.txt"; exit 1; }
        test -f start.py || { echo "âŒ ç¼ºå°‘ start.py"; exit 1; }
        echo "âœ… æ ¸å¿ƒæ–‡ä»¶æª¢æŸ¥é€šé"

    - name: ğŸš€ å‰µå»ºä¹¾æ·¨çš„éƒ¨ç½²åˆ†æ”¯
      run: |
        echo "ğŸš€ æº–å‚™ä¹¾æ·¨çš„éƒ¨ç½²ç’°å¢ƒ..."

        # æº–å‚™éƒ¨ç½²ç›®éŒ„
        rm -rf /tmp/ptero-deploy && mkdir -p /tmp/ptero-deploy
        cd /tmp/ptero-deploy

        # è¤‡è£½æ ¸å¿ƒæ‡‰ç”¨æª”æ¡ˆ (æ’é™¤é–‹ç™¼æª”æ¡ˆ)
        rsync -a --prune-empty-dirs \
          --include='bot/***' \
          --include='shared/***' \
          --include='transcripts/' \
          --exclude='**/__pycache__' \
          --exclude='**/*.pyc' \
          --exclude='**/*.log' \
          --exclude='**/.*' \
          --exclude='tests/' \
          --exclude='.github/' \
          --exclude='docs/' \
          --exclude='*' \
          $GITHUB_WORKSPACE/ ./

        # è¤‡è£½å¿…è¦æª”æ¡ˆ
        cp $GITHUB_WORKSPACE/requirements.txt ./
        cp $GITHUB_WORKSPACE/start.py ./ 2>/dev/null || echo "start.py not found"
        cp $GITHUB_WORKSPACE/start.sh ./ 2>/dev/null || echo "start.sh not found"
        cp $GITHUB_WORKSPACE/start.bat ./ 2>/dev/null || echo "start.bat not found"
        cp $GITHUB_WORKSPACE/.env.example ./ 2>/dev/null || echo "Creating .env.example"

        # å¦‚æœæ²’æœ‰ .env.exampleï¼Œå‰µå»ºåŸºæœ¬çš„
        if [ ! -f .env.example ]; then
          cat > .env.example << 'EOF'
        # Discord Bot Token
        DISCORD_TOKEN=your_discord_bot_token_here

        # Database Configuration
        DB_HOST=localhost
        DB_PORT=3306
        DB_USER=your_db_user
        DB_PASSWORD=your_db_password  # pragma: allowlist secret
        DB_NAME=potato_bot

        # API Server Configuration
        ENABLE_API_SERVER=true
        API_EXTERNAL_ACCESS=true
        LOCAL_API_HOST=0.0.0.0
        LOCAL_API_PORT=8080

        # Basic Settings
        DEBUG=false
        LOG_LEVEL=INFO
        EOF
        fi

        # è¨­ç½®åŸ·è¡Œæ¬Šé™
        chmod +x start.py 2>/dev/null || true
        chmod +x start.sh 2>/dev/null || true

        # é…ç½® Git ä¸¦æ¨é€
        git init
        git config user.email "action@github.com"
        git config user.name "GitHub Action"
        git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
        git add .

        DEPLOY_MSG="ğŸš€ è‡ªå‹•éƒ¨ç½² (main â†’ ptero) ${{ steps.version.outputs.tag }}

        ğŸ“… æ™‚é–“: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        ğŸ”— æäº¤: ${{ github.sha }}
        ğŸ‘¤ è§¸ç™¼: ${{ github.actor }}

        âœ¨ ä¹¾æ·¨éƒ¨ç½²ç‰ˆæœ¬ - åƒ…åŒ…å«é‹è¡Œå¿…è¦æª”æ¡ˆ"

        git commit -m "$DEPLOY_MSG"
        git push origin HEAD:ptero --force

        echo "âœ… éƒ¨ç½²å®Œæˆ"

    - name: ğŸ“Š éƒ¨ç½²çµ±è¨ˆ
      run: |
        echo "ğŸ“Š éƒ¨ç½²çµ±è¨ˆ"
        echo "==================="
        echo "ç‰ˆæœ¬: ${{ steps.version.outputs.tag }}"
        echo "åˆ†æ”¯: main â†’ ptero"
        echo "æäº¤: $(git rev-parse --short HEAD)"
        echo "æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ç’°å¢ƒ: ${{ github.event.inputs.environment || 'production' }}"
