name: push-to-ptero
on:
  push:
    branches-ignore:
      - ptero   # 避免 workflow 自己觸發自己

permissions:
  contents: write   # 允許修改 repo 分支

jobs:
  build-deploy-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Copy only bot/ into deploy dir
        run: |
          rm -rf /tmp/ptero && mkdir -p /tmp/ptero
          rsync -a --prune-empty-dirs \
            --include='bot/***' \
            --include='shared/***' \
            --include='transcripts/***' \
            --exclude='*' \
            ./ /tmp/ptero/

            install -D -m 0644 \
            potato/docs/requirements/requirements-production.txt \
            /tmp/ptero/potato/docs/requirements/requirements-production.txt

      - name: Commit & push to ptero
        run: |
          cd /tmp/ptero
          git init
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git add .
          if [ "$MODE" = "subset" ]; then
            git commit -m "deploy(subset from ${GITHUB_REF_NAME})"
          else
            git commit -m "deploy(full from main)"
          fi
          # 用 GITHUB_TOKEN 驗證推送到同一個 repo 的 ptero 分支
          git push -f "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:ptero

