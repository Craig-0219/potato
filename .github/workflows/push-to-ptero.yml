name: push-to-ptero
on:
  push:
    branches-ignore:
      - ptero   # 避免 workflow 自己觸發自己

permissions:
  contents: write   # 允許修改 repo 分支

jobs:
  build-deploy-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Decide mode & prepare dir
        run: |
          mkdir -p /tmp/ptero
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "MODE=full" >> $GITHUB_ENV
          else
            echo "MODE=subset" >> $GITHUB_ENV
          fi

      - name: Copy files
        run: |
          if [ "$MODE" = "subset" ]; then
            # ★ 非 main：只同步你要給託管的內容
            rsync -a --prune-empty-dirs \
              --include='bot/***' \
              --include='README.md' \
              --exclude='*' \
              ./ /tmp/ptero/
          else
            # ★ main：整個專案
            rsync -a --exclude='.git' ./ /tmp/ptero/
          fi

      - name: Commit & push to ptero
        run: |
          cd /tmp/ptero
          git init
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git add .
          if [ "$MODE" = "subset" ]; then
            git commit -m "deploy(subset from ${GITHUB_REF_NAME})"
          else
            git commit -m "deploy(full from main)"
          fi
          git branch -M ptero
          git remote add origin "https://github.com/${{ github.repository }}.git"
          git push -f origin ptero
