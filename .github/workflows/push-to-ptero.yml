name: Deploy to Ptero Branch
on:
  push:
    branches:
      - main   # åªåœ¨æŽ¨é€åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼éƒ¨ç½²
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

permissions:
  contents: write   # å…è¨±ä¿®æ”¹ repo åˆ†æ”¯

jobs:
  build-deploy-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare clean deployment directory
        run: |
          rm -rf /tmp/ptero && mkdir -p /tmp/ptero
          echo "ðŸ“ æº–å‚™ä¹¾æ·¨çš„éƒ¨ç½²ç›®éŒ„"

      - name: Copy core application files
        run: |
          echo "ðŸ“¦ è¤‡è£½æ ¸å¿ƒæ‡‰ç”¨ç¨‹å¼æª”æ¡ˆ..."
          
          # è¤‡è£½ä¸»è¦ä»£ç¢¼ç›®éŒ„
          rsync -a --prune-empty-dirs \
            --include='bot/***' \
            --include='shared/***' \
            --include='transcripts/' \
            --exclude='**/__pycache__' \
            --exclude='**/*.pyc' \
            --exclude='**/*.log' \
            --exclude='**/.*' \
            --exclude='*' \
            ./ /tmp/ptero/

          echo "âœ… æ ¸å¿ƒæª”æ¡ˆè¤‡è£½å®Œæˆ"

      - name: Copy dependencies and configuration
        run: |
          echo "âš™ï¸ è¤‡è£½ä¾è³´å’Œé…ç½®æª”æ¡ˆ..."
          
          # è¤‡è£½ä¾è³´æ–‡ä»¶
          mkdir -p /tmp/ptero/docs/requirements
          cp requirements.txt /tmp/ptero/
          cp docs/requirements/requirements-production.txt /tmp/ptero/docs/requirements/

          # è¤‡è£½ç’°å¢ƒé…ç½®ç¯„ä¾‹
          cp .env.example /tmp/ptero/ 2>/dev/null || echo ".env.example not found, creating basic one"
          
          # å¦‚æžœæ²’æœ‰ .env.exampleï¼Œå‰µå»ºä¸€å€‹åŸºæœ¬çš„
          if [ ! -f /tmp/ptero/.env.example ]; then
            cat > /tmp/ptero/.env.example << 'EOF'
          # Discord Bot Token
          DISCORD_TOKEN=your_discord_bot_token_here
          
          # Database Configuration
          DB_HOST=localhost
          DB_PORT=3306
          DB_USER=your_db_user
          DB_PASSWORD=your_db_password
          DB_NAME=potato_bot
          
          # Redis Configuration (Optional)
          REDIS_URL=redis://localhost:6379
          
          # API Server Configuration
          ENABLE_API_SERVER=true
          API_EXTERNAL_ACCESS=true
          LOCAL_API_HOST=0.0.0.0
          LOCAL_API_PORT=8080
          
          # Basic Settings
          DEBUG=false
          LOG_LEVEL=INFO
          EOF
          fi

          echo "âœ… é…ç½®æª”æ¡ˆè¤‡è£½å®Œæˆ"

      - name: Copy startup tools
        run: |
          echo "ðŸš€ è¤‡è£½å•Ÿå‹•å·¥å…·..."
          
          # è¤‡è£½å¿«é€Ÿå•Ÿå‹•å·¥å…·
          cp start.py /tmp/ptero/ 2>/dev/null || echo "start.py not found, skipping"
          cp start.bat /tmp/ptero/ 2>/dev/null || echo "start.bat not found, skipping"  
          cp start.sh /tmp/ptero/ 2>/dev/null || echo "start.sh not found, skipping"
          cp QUICK_START.md /tmp/ptero/ 2>/dev/null || echo "QUICK_START.md not found, skipping"

          # è¨­ç½®åŸ·è¡Œæ¬Šé™
          chmod +x /tmp/ptero/start.py 2>/dev/null || echo "start.py not found for chmod"
          chmod +x /tmp/ptero/start.sh 2>/dev/null || echo "start.sh not found for chmod"

          echo "âœ… å•Ÿå‹•å·¥å…·è¨­ç½®å®Œæˆ"

      - name: Create deployment summary
        run: |
          echo "ðŸ“‹ å‰µå»ºéƒ¨ç½²æ‘˜è¦..."
          cd /tmp/ptero
          
          cat > DEPLOYMENT_INFO.md << 'EOF'
          # Ptero éƒ¨ç½²åˆ†æ”¯
          
          é€™æ˜¯ä¸€å€‹è‡ªå‹•ç”Ÿæˆçš„ä¹¾æ·¨éƒ¨ç½²åˆ†æ”¯ï¼Œåƒ…åŒ…å«é‹è¡Œæ‰€éœ€çš„æª”æ¡ˆã€‚
          
          ## éƒ¨ç½²è³‡è¨Š
          - **æºåˆ†æ”¯**: main
          - **éƒ¨ç½²æ™‚é–“**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **æäº¤é›œæ¹Š**: ${{ github.sha }}
          - **GitHub Actor**: ${{ github.actor }}
          
          ## åŒ…å«çš„åŠŸèƒ½
          - âœ… Discord Bot æ ¸å¿ƒåŠŸèƒ½
          - âœ… ç¥¨åˆ¸ç³»çµ±
          - âœ… æŠ•ç¥¨ç³»çµ±
          - âœ… Web API æœå‹™
          - âœ… é›¢ç·šæ¨¡å¼æ”¯æ´
          - âœ… Redis æ•´åˆ
          - âœ… æœ¬åœ°å¿«å–å¾Œå‚™
          
          ## å¿«é€Ÿé–‹å§‹
          1. è¤‡è£½ `.env.example` åˆ° `.env`
          2. å¡«å¯«å¿…è¦çš„ç’°å¢ƒè®Šæ•¸
          3. é‹è¡Œ `python3 bot/main.py` æˆ–ä½¿ç”¨æä¾›çš„å•Ÿå‹•å·¥å…·
          
          ## æ³¨æ„äº‹é …
          - é€™å€‹åˆ†æ”¯æœƒè¢«è‡ªå‹•è¦†å¯«ï¼Œè«‹å‹¿ç›´æŽ¥ä¿®æ”¹
          - æ‰€æœ‰è®Šæ›´æ‡‰è©²æŽ¨é€åˆ° main åˆ†æ”¯
          - éƒ¨ç½²æœƒè‡ªå‹•è§¸ç™¼ä¸¦æ›´æ–°æ­¤åˆ†æ”¯
          EOF

      - name: Setup git and deploy
        run: |
          echo "ðŸš€ è¨­ç½® Git ä¸¦éƒ¨ç½²..."
          cd /tmp/ptero
          
          git init
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # è¨­å®šé ç«¯
          git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          
          # æ·»åŠ æ‰€æœ‰æª”æ¡ˆ
          git add .

          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´éœ€è¦æäº¤
          if ! git diff --cached --quiet; then
            echo "ðŸ“ ç™¼ç¾è®Šæ›´ï¼Œæº–å‚™éƒ¨ç½²..."
            
            # ç²å–æäº¤è¨Šæ¯
            COMMIT_MSG="ðŸš€ è‡ªå‹•éƒ¨ç½² (main â†’ ptero)
            
            ðŸ“… éƒ¨ç½²æ™‚é–“: $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
            ðŸ”— æºæäº¤: ${{ github.sha }}
            ðŸ‘¤ è§¸ç™¼è€…: ${{ github.actor }}
            
            ðŸŽ¯ é€™æ˜¯ä¸€å€‹å¾ž main åˆ†æ”¯è‡ªå‹•ç”Ÿæˆçš„ä¹¾æ·¨éƒ¨ç½²ç‰ˆæœ¬"
            
            git commit -m "$COMMIT_MSG"
            
            echo "â¬†ï¸ æŽ¨é€åˆ° ptero åˆ†æ”¯..."
            # å¼·åˆ¶æŽ¨é€åˆ° ptero åˆ†æ”¯ï¼ˆéƒ¨ç½²åˆ†æ”¯æ‡‰è©²å®Œå…¨æ›¿æ›ï¼‰
            git push origin HEAD:ptero --force
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          else
            echo "â„¹ï¸ æ²’æœ‰è®Šæ›´éœ€è¦éƒ¨ç½²"
          fi

