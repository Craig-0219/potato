name: ğŸ—ï¸ Build Validation

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'å»ºæ§‹é¡å‹'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - docker
          - python
          - web-ui

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

jobs:
  python-build:
    name: ğŸ Python å»ºæ§‹é©—è­‰
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: ğŸ“¦ å‡ç´š pip å’Œå»ºæ§‹å·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install build wheel setuptools
    
    - name: ğŸ” é©—è­‰ä¾è³´
      run: |
        echo "ğŸ” é©—è­‰ä¾è³´è§£æ..."
        pip install -r requirements.txt --dry-run --no-deps || true
        
        echo "ğŸ“Š åˆ†æä¾è³´è¡çª..."
        pip-check || echo "âš ï¸ ç™¼ç¾ä¾è³´è¡çªï¼Œä½†ç¹¼çºŒå»ºæ§‹"
      continue-on-error: true
    
    - name: ğŸ“¦ å®‰è£å°ˆæ¡ˆä¾è³´
      run: |
        echo "ğŸ“¦ å®‰è£ç”Ÿç”¢ä¾è³´..."
        pip install -r requirements.txt
        
        echo "ğŸ› ï¸ å®‰è£é–‹ç™¼ä¾è³´..."
        pip install -e .[dev]
    
    - name: ğŸ” é©—è­‰å®‰è£
      run: |
        echo "âœ… é©—è­‰å¥—ä»¶å®‰è£..."
        python -c "
        import sys
        import pkg_resources
        
        print('ğŸ Python ç‰ˆæœ¬:', sys.version)
        print('ğŸ“¦ å·²å®‰è£å¥—ä»¶æ•¸é‡:', len(list(pkg_resources.working_set)))
        
        # æª¢æŸ¥é—œéµä¾è³´
        critical_packages = ['discord.py', 'fastapi', 'pydantic', 'aiomysql']
        for pkg in critical_packages:
            try:
                __import__(pkg.replace('.py', '').replace('-', '_'))
                print(f'âœ… {pkg} å¯æ­£å¸¸å°å…¥')
            except ImportError as e:
                print(f'âŒ {pkg} å°å…¥å¤±æ•—: {e}')
                sys.exit(1)
        "
    
    - name: ğŸ—ï¸ æ¸¬è©¦æ‡‰ç”¨å•Ÿå‹•
      run: |
        echo "ğŸš€ æ¸¬è©¦æ‡‰ç”¨å•Ÿå‹•èƒ½åŠ›..."
        
        # è¨­ç½®æ¸¬è©¦ç’°å¢ƒè®Šæ•¸
        export TESTING=true
        export LOG_LEVEL=ERROR
        export DATABASE_URL=sqlite:///:memory:
        
        # æ¸¬è©¦ä¸»æ¨¡çµ„å°å…¥
        python -c "
        import sys
        sys.path.insert(0, '.')
        
        try:
            from bot.main import main
            print('âœ… ä¸»æ‡‰ç”¨æ¨¡çµ„å¯æ­£å¸¸å°å…¥')
        except ImportError as e:
            print(f'âŒ ä¸»æ‡‰ç”¨æ¨¡çµ„å°å…¥å¤±æ•—: {e}')
            sys.exit(1)
        except Exception as e:
            print(f'âš ï¸ æ‡‰ç”¨åˆå§‹åŒ–è­¦å‘Š: {e}')
            print('âœ… æ¨¡çµ„å°å…¥æˆåŠŸï¼Œåˆå§‹åŒ–å•é¡Œåœ¨æ¸¬è©¦ç’°å¢ƒæ˜¯æ­£å¸¸çš„')
        "
    
    - name: ğŸ” ç¨‹å¼ç¢¼å¥åº·æª¢æŸ¥
      run: |
        echo "ğŸ©º åŸ·è¡Œç¨‹å¼ç¢¼å¥åº·æª¢æŸ¥..."
        
        # æª¢æŸ¥èªæ³•éŒ¯èª¤
        python -m py_compile bot/main.py
        python -m py_compile shared/config.py
        
        # æª¢æŸ¥å¾ªç’°ä¾è³´
        echo "ğŸ”„ æª¢æŸ¥å¾ªç’°ä¾è³´..."
        python -c "
        import ast
        import os
        
        def check_imports(file_path):
            try:
                with open(file_path, 'r') as f:
                    tree = ast.parse(f.read())
                return [node.module for node in ast.walk(tree) if isinstance(node, ast.Import) and hasattr(node, 'module')]
            except:
                return []
        
        bot_files = [f for f in os.listdir('bot') if f.endswith('.py')]
        shared_files = [f for f in os.listdir('shared') if f.endswith('.py')]
        
        print(f'âœ… æª¢æŸ¥ {len(bot_files)} å€‹ bot æ¨¡çµ„å’Œ {len(shared_files)} å€‹ shared æ¨¡çµ„')
        print('ğŸ¯ èªæ³•æª¢æŸ¥å®Œæˆ')
        "

  docker-build:
    name: ğŸ³ Docker å»ºæ§‹é©—è­‰
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event.inputs.build_type == 'all' || github.event.inputs.build_type == 'docker' || github.event.inputs.build_type == ''
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ” æª¢æŸ¥ Dockerfile
      run: |
        echo "ğŸ³ æª¢æŸ¥ Dockerfile èªæ³•..."
        
        if [[ -f "Dockerfile" ]]; then
          echo "âœ… Dockerfile å­˜åœ¨"
          
          # æª¢æŸ¥ Dockerfile åŸºæœ¬èªæ³•
          if docker run --rm -i hadolint/hadolint < Dockerfile; then
            echo "âœ… Dockerfile èªæ³•æª¢æŸ¥é€šé"
          else
            echo "âš ï¸ Dockerfile èªæ³•æª¢æŸ¥æœ‰è­¦å‘Š"
          fi
        else
          echo "âŒ Dockerfile ä¸å­˜åœ¨"
          exit 1
        fi
    
    - name: ğŸ—ï¸ å»ºæ§‹ Docker æ˜ åƒ
      run: |
        echo "ğŸ³ å»ºæ§‹ Docker æ˜ åƒ..."
        
        # å»ºæ§‹æ˜ åƒ
        docker build -t potato-bot:build-test .
        
        # æª¢æŸ¥æ˜ åƒå¤§å°
        IMAGE_SIZE=$(docker images potato-bot:build-test --format "table {{.Size}}" | tail -n 1)
        echo "ğŸ“¦ æ˜ åƒå¤§å°: $IMAGE_SIZE"
        
        # æª¢æŸ¥æ˜ åƒå±¤æ•¸
        LAYERS=$(docker history potato-bot:build-test | wc -l)
        echo "ğŸ“š æ˜ åƒå±¤æ•¸: $LAYERS"
        
        if [[ $LAYERS -gt 20 ]]; then
          echo "âš ï¸ æ˜ åƒå±¤æ•¸è¼ƒå¤š ($LAYERS)ï¼Œå»ºè­°å„ªåŒ–"
        fi
    
    - name: ğŸ” æ˜ åƒå…§å®¹é©—è­‰
      run: |
        echo "ğŸ” é©—è­‰æ˜ åƒå…§å®¹..."
        
        # æª¢æŸ¥ Python ç’°å¢ƒ
        docker run --rm potato-bot:build-test python --version
        
        # æª¢æŸ¥é—œéµæ–‡ä»¶å­˜åœ¨
        docker run --rm potato-bot:build-test ls -la /app/ | head -10
        
        # æª¢æŸ¥ä¾è³´å®‰è£
        docker run --rm potato-bot:build-test pip list | head -10
        
        # æ¸¬è©¦æ‡‰ç”¨å•Ÿå‹•
        echo "ğŸš€ æ¸¬è©¦å®¹å™¨å…§æ‡‰ç”¨å•Ÿå‹•..."
        timeout 30s docker run --rm \
          -e TESTING=true \
          -e LOG_LEVEL=ERROR \
          potato-bot:build-test python -c "
        import sys
        sys.path.insert(0, '/app')
        try:
            print('âœ… å®¹å™¨å…§ Python ç’°å¢ƒæ­£å¸¸')
            print('ğŸ Python ç‰ˆæœ¬:', sys.version.split()[0])
        except Exception as e:
            print('âŒ å®¹å™¨æ¸¬è©¦å¤±æ•—:', e)
            sys.exit(1)
        " || echo "âš ï¸ å•Ÿå‹•æ¸¬è©¦è¶…æ™‚æˆ–å¤±æ•—ï¼Œé€™åœ¨æŸäº›æƒ…æ³ä¸‹æ˜¯æ­£å¸¸çš„"
    
    - name: ğŸ§¹ æ¸…ç†æ¸¬è©¦æ˜ åƒ
      if: always()
      run: |
        docker rmi potato-bot:build-test || true

  web-ui-build:
    name: ğŸŒ Web UI å»ºæ§‹é©—è­‰
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: (github.event.inputs.build_type == 'all' || github.event.inputs.build_type == 'web-ui') && hashFiles('web-ui/**') != ''
    
    defaults:
      run:
        working-directory: ./web-ui
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ è¨­ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: web-ui/package-lock.json
    
    - name: ğŸ“¦ å®‰è£ Web UI ä¾è³´
      run: |
        echo "ğŸ“¦ å®‰è£ Node.js ä¾è³´..."
        npm ci
    
    - name: ğŸ” ä¾è³´å®‰å…¨å¯©è¨ˆ
      run: |
        echo "ğŸ›¡ï¸ åŸ·è¡Œ npm å®‰å…¨å¯©è¨ˆ..."
        npm audit --audit-level=high || echo "âš ï¸ ç™¼ç¾å®‰å…¨å•é¡Œï¼Œä½†ç¹¼çºŒå»ºæ§‹"
    
    - name: ğŸ—ï¸ å»ºæ§‹ Web UI
      run: |
        echo "ğŸ—ï¸ å»ºæ§‹ Web UI..."
        npm run build
    
    - name: ğŸ” å»ºæ§‹ç”¢ç‰©é©—è­‰
      run: |
        echo "ğŸ“Š é©—è­‰å»ºæ§‹ç”¢ç‰©..."
        
        # æª¢æŸ¥å»ºæ§‹ç›®éŒ„
        if [[ -d "dist" ]] || [[ -d ".next" ]] || [[ -d "build" ]]; then
          BUILD_DIR=$(find . -maxdepth 1 -type d -name "dist" -o -name ".next" -o -name "build" | head -1)
          echo "âœ… æ‰¾åˆ°å»ºæ§‹ç›®éŒ„: $BUILD_DIR"
          
          # æª¢æŸ¥å»ºæ§‹æª”æ¡ˆ
          FILES_COUNT=$(find $BUILD_DIR -type f | wc -l)
          echo "ğŸ“„ å»ºæ§‹æª”æ¡ˆæ•¸é‡: $FILES_COUNT"
          
          # æª¢æŸ¥é—œéµæª”æ¡ˆ
          if find $BUILD_DIR -name "*.html" | grep -q .; then
            echo "âœ… HTML æª”æ¡ˆå­˜åœ¨"
          fi
          
          if find $BUILD_DIR -name "*.js" | grep -q .; then
            echo "âœ… JavaScript æª”æ¡ˆå­˜åœ¨"
          fi
          
          if find $BUILD_DIR -name "*.css" | grep -q .; then
            echo "âœ… CSS æª”æ¡ˆå­˜åœ¨"
          fi
        else
          echo "âŒ æœªæ‰¾åˆ°å»ºæ§‹ç”¢ç‰©ç›®éŒ„"
          exit 1
        fi
    
    - name: ğŸ“Š å»ºæ§‹çµ±è¨ˆ
      run: |
        echo "ğŸ“Š Web UI å»ºæ§‹çµ±è¨ˆ:"
        
        BUILD_DIR=$(find . -maxdepth 1 -type d -name "dist" -o -name ".next" -o -name "build" | head -1)
        
        if [[ -n "$BUILD_DIR" ]]; then
          TOTAL_SIZE=$(du -sh $BUILD_DIR | cut -f1)
          echo "  â€¢ ç¸½å¤§å°: $TOTAL_SIZE"
          
          JS_FILES=$(find $BUILD_DIR -name "*.js" | wc -l)
          CSS_FILES=$(find $BUILD_DIR -name "*.css" | wc -l)
          HTML_FILES=$(find $BUILD_DIR -name "*.html" | wc -l)
          
          echo "  â€¢ JavaScript æª”æ¡ˆ: $JS_FILES"
          echo "  â€¢ CSS æª”æ¡ˆ: $CSS_FILES"
          echo "  â€¢ HTML æª”æ¡ˆ: $HTML_FILES"
        fi

  performance-check:
    name: âš¡ æ•ˆèƒ½æª¢æŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [python-build]
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
      uses: actions/checkout@v4
    
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ å®‰è£ä¾è³´å’Œæ•ˆèƒ½å·¥å…·
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install memory-profiler psutil
    
    - name: ğŸ§  è¨˜æ†¶é«”ä½¿ç”¨æª¢æŸ¥
      run: |
        echo "ğŸ§  æª¢æŸ¥æ¨¡çµ„å°å…¥è¨˜æ†¶é«”ä½¿ç”¨..."
        
        python -c "
        import psutil
        import os
        import sys
        
        # è¨˜éŒ„åˆå§‹è¨˜æ†¶é«”
        process = psutil.Process(os.getpid())
        initial_memory = process.memory_info().rss / 1024 / 1024
        print(f'ğŸ“Š åˆå§‹è¨˜æ†¶é«”ä½¿ç”¨: {initial_memory:.2f} MB')
        
        # å°å…¥ä¸»è¦æ¨¡çµ„
        sys.path.insert(0, '.')
        
        try:
            import bot.main
            import shared.config
            import shared.logger
            
            final_memory = process.memory_info().rss / 1024 / 1024
            memory_increase = final_memory - initial_memory
            
            print(f'ğŸ“Š æ¨¡çµ„å°å…¥å¾Œè¨˜æ†¶é«”: {final_memory:.2f} MB')
            print(f'ğŸ“ˆ è¨˜æ†¶é«”å¢é•·: {memory_increase:.2f} MB')
            
            if memory_increase > 100:
                print('âš ï¸ è¨˜æ†¶é«”ä½¿ç”¨é‡è¼ƒé«˜ï¼Œå»ºè­°æª¢æŸ¥å°å…¥çš„æ¨¡çµ„')
            else:
                print('âœ… è¨˜æ†¶é«”ä½¿ç”¨åœ¨æ­£å¸¸ç¯„åœå…§')
                
        except Exception as e:
            print(f'âš ï¸ æ¨¡çµ„å°å…¥æ¸¬è©¦å¤±æ•—: {e}')
        "
    
    - name: âš¡ å•Ÿå‹•æ™‚é–“æª¢æŸ¥
      run: |
        echo "âš¡ æª¢æŸ¥æ‡‰ç”¨å•Ÿå‹•æ™‚é–“..."
        
        # è¨­ç½®æ¸¬è©¦ç’°å¢ƒ
        export TESTING=true
        export LOG_LEVEL=ERROR
        export DATABASE_URL=sqlite:///:memory:
        
        # æ¸¬é‡å°å…¥æ™‚é–“
        python -c "
        import time
        import sys
        
        sys.path.insert(0, '.')
        
        start_time = time.time()
        
        try:
            import bot.main
            import shared.config
            import shared.logger
            
            end_time = time.time()
            import_time = (end_time - start_time) * 1000
            
            print(f'âš¡ æ¨¡çµ„å°å…¥æ™‚é–“: {import_time:.2f} ms')
            
            if import_time > 5000:
                print('âš ï¸ å°å…¥æ™‚é–“è¼ƒé•·ï¼Œå»ºè­°å„ªåŒ–')
            else:
                print('âœ… å°å…¥æ™‚é–“åœ¨åˆç†ç¯„åœå…§')
                
        except Exception as e:
            print(f'âš ï¸ å•Ÿå‹•æ™‚é–“æ¸¬è©¦å¤±æ•—: {e}')
        "

  build-summary:
    name: ğŸ å»ºæ§‹ç¸½çµ
    needs: [python-build, docker-build, web-ui-build, performance-check]
    runs-on: ubuntu-latest
    if: always()
    timeout-minutes: 5
    
    steps:
    - name: ğŸ“‹ å»ºæ§‹çµæœç¸½çµ
      run: |
        echo "ğŸ—ï¸ å»ºæ§‹é©—è­‰å®Œæˆç¸½çµ"
        echo ""
        echo "âœ… å»ºæ§‹éšæ®µçµæœ:"
        echo "  â€¢ ğŸ Python å»ºæ§‹ - ${{ needs.python-build.result }}"
        echo "  â€¢ ğŸ³ Docker å»ºæ§‹ - ${{ needs.docker-build.result }}"
        echo "  â€¢ ğŸŒ Web UI å»ºæ§‹ - ${{ needs.web-ui-build.result }}"
        echo "  â€¢ âš¡ æ•ˆèƒ½æª¢æŸ¥ - ${{ needs.performance-check.result }}"
        echo ""
        
        # æª¢æŸ¥é—œéµå»ºæ§‹çµæœ
        if [[ "${{ needs.python-build.result }}" == "failure" ]]; then
          echo "âŒ Python å»ºæ§‹å¤±æ•— - é€™æ˜¯é˜»æ–·æ€§å•é¡Œ"
          exit 1
        fi
        
        if [[ "${{ needs.docker-build.result }}" == "failure" ]]; then
          echo "âŒ Docker å»ºæ§‹å¤±æ•— - éœ€è¦ä¿®å¾© Dockerfile"
          exit 1
        fi
        
        # Web UI å’Œæ•ˆèƒ½æª¢æŸ¥å¤±æ•—ä¸é˜»æ–·ä¸»æµç¨‹
        if [[ "${{ needs.web-ui-build.result }}" == "failure" ]]; then
          echo "âš ï¸ Web UI å»ºæ§‹å¤±æ•— - è«‹æª¢æŸ¥å‰ç«¯ç¨‹å¼ç¢¼"
        fi
        
        if [[ "${{ needs.performance-check.result }}" == "failure" ]]; then
          echo "âš ï¸ æ•ˆèƒ½æª¢æŸ¥å¤±æ•— - å»ºè­°å„ªåŒ–æ•ˆèƒ½"
        fi
        
        echo "ğŸ‰ å»ºæ§‹é©—è­‰éšæ®µå®Œæˆ!"
        echo ""
        echo "ğŸ“Š å»ºæ§‹çµ±è¨ˆ:"
        echo "  â€¢ Python ç‰ˆæœ¬æ¸¬è©¦: 3.10, 3.11, 3.12"
        echo "  â€¢ Docker æ˜ åƒå»ºæ§‹: å®Œæˆ"
        echo "  â€¢ ä¾è³´è§£æé©—è­‰: å®Œæˆ"
        echo "  â€¢ æ•ˆèƒ½åŸºæº–æ¸¬è©¦: å®Œæˆ"