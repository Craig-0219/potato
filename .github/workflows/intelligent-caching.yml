name: ğŸ§  Intelligent Caching Strategy

on:
  workflow_run:
    workflows: ["ğŸ§  Smart Change Detection"]
    branches: [dev, main]
    types: [completed]
  workflow_dispatch:
    inputs:
      cache_level:
        description: 'å¿«å–ç­–ç•¥ç­‰ç´š'
        required: false
        default: 'selective'
        type: choice
        options:
          - refresh    # åˆ·æ–°æ‰€æœ‰å¿«å–
          - selective  # é¸æ“‡æ€§å¿«å–
          - preserve   # ä¿ç•™æ‰€æœ‰å¿«å–
          - standard   # æ¨™æº–å¿«å–

env:
  CACHE_VERSION: v2.0.0

jobs:
  analyze-cache-strategy:
    name: ğŸ” åˆ†æå¿«å–ç­–ç•¥
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    outputs:
      cache_strategy: ${{ steps.determine.outputs.cache_strategy }}
      pip_cache_key: ${{ steps.determine.outputs.pip_cache_key }}
      deps_cache_key: ${{ steps.determine.outputs.deps_cache_key }}
      test_cache_key: ${{ steps.determine.outputs.test_cache_key }}
      should_refresh: ${{ steps.determine.outputs.should_refresh }}
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: ğŸ§  æ™ºèƒ½å¿«å–ç­–ç•¥æ±ºç­–
      id: determine
      run: |
        # æª¢æŸ¥è®Šæ›´çš„æª”æ¡ˆé¡å‹
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        echo "è®Šæ›´çš„æª”æ¡ˆ:"
        echo "$CHANGED_FILES"
        
        # åˆ†æè®Šæ›´å½±éŸ¿
        CACHE_STRATEGY="standard"
        SHOULD_REFRESH="false"
        
        # L1 å¿«å–: ä¾è³´å¥—ä»¶å¿«å–éµ
        REQUIREMENTS_HASH=$(sha256sum requirements.txt 2>/dev/null | cut -d' ' -f1 || echo "no-requirements")
        PIP_CACHE_KEY="pip-${{ runner.os }}-python-${{ env.CACHE_VERSION }}-${REQUIREMENTS_HASH}"
        
        # L2 å¿«å–: ä¾è³´å’Œå·¥å…·é…ç½®å¿«å–éµ  
        CONFIG_FILES="requirements.txt pyproject.toml pytest.ini .bandit .coveragerc"
        CONFIG_HASH=""
        for file in $CONFIG_FILES; do
          if [ -f "$file" ]; then
            CONFIG_HASH="${CONFIG_HASH}$(sha256sum $file | cut -d' ' -f1)"
          fi
        done
        CONFIG_HASH=$(echo "$CONFIG_HASH" | sha256sum | cut -d' ' -f1)
        DEPS_CACHE_KEY="deps-${{ runner.os }}-${{ env.CACHE_VERSION }}-${CONFIG_HASH}"
        
        # L3 å¿«å–: æ¸¬è©¦çµæœå’Œåˆ†æå¿«å–éµ
        SOURCE_HASH=$(find bot/ shared/ -name "*.py" -type f -exec sha256sum {} \; | sha256sum | cut -d' ' -f1 2>/dev/null || echo "no-source")
        TEST_CACHE_KEY="tests-${{ runner.os }}-${{ env.CACHE_VERSION }}-${SOURCE_HASH}"
        
        # æ ¹æ“šè®Šæ›´é¡å‹æ±ºå®šå¿«å–ç­–ç•¥
        if echo "$CHANGED_FILES" | grep -q "requirements.txt\|pyproject.toml\|setup.py"; then
          CACHE_STRATEGY="refresh"
          SHOULD_REFRESH="true"
          echo "ğŸ”„ æª¢æ¸¬åˆ°ä¾è³´è®Šæ›´ï¼Œåˆ·æ–°æ‰€æœ‰å¿«å–"
        elif echo "$CHANGED_FILES" | grep -q "\.github/workflows/"; then
          CACHE_STRATEGY="selective"
          echo "âš¡ æª¢æ¸¬åˆ° CI é…ç½®è®Šæ›´ï¼Œä½¿ç”¨é¸æ“‡æ€§å¿«å–"
        elif echo "$CHANGED_FILES" | grep -q "\.py$"; then
          CACHE_STRATEGY="selective"
          echo "ğŸ æª¢æ¸¬åˆ° Python ä»£ç¢¼è®Šæ›´ï¼Œä½¿ç”¨é¸æ“‡æ€§å¿«å–"
        elif echo "$CHANGED_FILES" | grep -q "\.md$\|docs/"; then
          CACHE_STRATEGY="preserve"
          echo "ğŸ“š æª¢æ¸¬åˆ°æ–‡æª”è®Šæ›´ï¼Œä¿ç•™æ‰€æœ‰å¿«å–"
        else
          CACHE_STRATEGY="standard"
          echo "ğŸ”§ å…¶ä»–è®Šæ›´ï¼Œä½¿ç”¨æ¨™æº–å¿«å–ç­–ç•¥"
        fi
        
        # æ‰‹å‹•è§¸ç™¼æ™‚çš„è™•ç†
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          CACHE_STRATEGY="${{ inputs.cache_level }}"
          if [ "$CACHE_STRATEGY" = "refresh" ]; then
            SHOULD_REFRESH="true"
          fi
        fi
        
        # è¼¸å‡ºçµæœ
        echo "cache_strategy=$CACHE_STRATEGY" >> $GITHUB_OUTPUT
        echo "pip_cache_key=$PIP_CACHE_KEY" >> $GITHUB_OUTPUT
        echo "deps_cache_key=$DEPS_CACHE_KEY" >> $GITHUB_OUTPUT
        echo "test_cache_key=$TEST_CACHE_KEY" >> $GITHUB_OUTPUT
        echo "should_refresh=$SHOULD_REFRESH" >> $GITHUB_OUTPUT
        
        echo ""
        echo "ğŸ§  æ™ºèƒ½å¿«å–ç­–ç•¥åˆ†æçµæœ:"
        echo "  â€¢ å¿«å–ç­–ç•¥: $CACHE_STRATEGY"
        echo "  â€¢ æ˜¯å¦åˆ·æ–°: $SHOULD_REFRESH"
        echo "  â€¢ L1 å¿«å–éµ: $PIP_CACHE_KEY"
        echo "  â€¢ L2 å¿«å–éµ: $DEPS_CACHE_KEY"
        echo "  â€¢ L3 å¿«å–éµ: $TEST_CACHE_KEY"

  setup-intelligent-cache:
    name: ğŸš€ å»ºç«‹æ™ºèƒ½å¿«å–
    needs: analyze-cache-strategy
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # L1 å¿«å–: Python å¥—ä»¶å¿«å–
    - name: ğŸ’¾ L1 å¿«å– - Python å¥—ä»¶
      uses: actions/cache@v4
      id: pip-cache
      with:
        path: ~/.cache/pip
        key: ${{ needs.analyze-cache-strategy.outputs.pip_cache_key }}
        restore-keys: |
          pip-${{ runner.os }}-python-${{ env.CACHE_VERSION }}-

    # L2 å¿«å–: å·²å®‰è£ä¾è³´å’Œå·¥å…·é…ç½®
    - name: ğŸ’¾ L2 å¿«å– - ä¾è³´å’Œå·¥å…·é…ç½®
      uses: actions/cache@v4
      id: deps-cache
      with:
        path: |
          ~/.local/lib/python3.10/site-packages
          ~/.local/bin
        key: ${{ needs.analyze-cache-strategy.outputs.deps_cache_key }}
        restore-keys: |
          deps-${{ runner.os }}-${{ env.CACHE_VERSION }}-

    # L3 å¿«å–: æ¸¬è©¦çµæœå’Œåˆ†æçµæœ
    - name: ğŸ’¾ L3 å¿«å– - æ¸¬è©¦å’Œåˆ†æçµæœ
      uses: actions/cache@v4
      id: test-cache
      if: needs.analyze-cache-strategy.outputs.cache_strategy != 'refresh'
      with:
        path: |
          .pytest_cache
          .mypy_cache
          .coverage
          bandit-report.json
        key: ${{ needs.analyze-cache-strategy.outputs.test_cache_key }}
        restore-keys: |
          tests-${{ runner.os }}-${{ env.CACHE_VERSION }}-

    # æ™ºèƒ½ä¾è³´å®‰è£
    - name: ğŸ“¦ æ™ºèƒ½ä¾è³´å®‰è£
      run: |
        CACHE_STRATEGY="${{ needs.analyze-cache-strategy.outputs.cache_strategy }}"
        
        echo "ğŸ§  åŸ·è¡Œæ™ºèƒ½ä¾è³´å®‰è£ (ç­–ç•¥: $CACHE_STRATEGY)"
        
        if [ "${{ steps.pip-cache.outputs.cache-hit }}" = "true" ] && [ "$CACHE_STRATEGY" != "refresh" ]; then
          echo "âœ… L1 å¿«å–å‘½ä¸­ - è·³é pip å‡ç´š"
        else
          echo "ğŸ“¦ L1 å¿«å–æœªå‘½ä¸­ - å‡ç´š pip"
          python -m pip install --upgrade pip
        fi
        
        if [ "${{ steps.deps-cache.outputs.cache-hit }}" = "true" ] && [ "$CACHE_STRATEGY" != "refresh" ]; then
          echo "âœ… L2 å¿«å–å‘½ä¸­ - è·³éä¾è³´å®‰è£"
        else
          echo "ğŸ“¦ L2 å¿«å–æœªå‘½ä¸­ - å®‰è£ä¾è³´"
          pip install --user -r requirements.txt
          
          # å®‰è£é–‹ç™¼å’Œæ¸¬è©¦ä¾è³´
          pip install --user pytest pytest-cov mypy bandit safety black isort flake8
        fi
        
        # é©—è­‰å®‰è£
        echo "ğŸ” é©—è­‰é—œéµä¾è³´:"
        python -c "import discord; print(f'Discord.py: {discord.__version__}')"
        python -c "import fastapi; print(f'FastAPI: {fastapi.__version__}')"

    - name: ğŸ“Š å¿«å–æ•ˆæœçµ±è¨ˆ
      run: |
        echo "ğŸ“Š å¤šå±¤å¿«å–æ•ˆæœçµ±è¨ˆ:"
        echo "========================"
        echo "å¿«å–ç­–ç•¥: ${{ needs.analyze-cache-strategy.outputs.cache_strategy }}"
        echo ""
        
        # L1 å¿«å–çµ±è¨ˆ
        if [ "${{ steps.pip-cache.outputs.cache-hit }}" = "true" ]; then
          echo "âœ… L1 (pip) å¿«å–: å‘½ä¸­ - ç¯€çœ pip å®‰è£æ™‚é–“"
        else
          echo "âŒ L1 (pip) å¿«å–: æœªå‘½ä¸­ - åŸ·è¡Œå®Œæ•´ pip å®‰è£"
        fi
        
        # L2 å¿«å–çµ±è¨ˆ
        if [ "${{ steps.deps-cache.outputs.cache-hit }}" = "true" ]; then
          echo "âœ… L2 (ä¾è³´) å¿«å–: å‘½ä¸­ - ç¯€çœä¾è³´å®‰è£æ™‚é–“"
        else
          echo "âŒ L2 (ä¾è³´) å¿«å–: æœªå‘½ä¸­ - åŸ·è¡Œå®Œæ•´ä¾è³´å®‰è£"
        fi
        
        # L3 å¿«å–çµ±è¨ˆ
        if [ "${{ steps.test-cache.outputs.cache-hit }}" = "true" ]; then
          echo "âœ… L3 (æ¸¬è©¦) å¿«å–: å‘½ä¸­ - å¯é‡ç”¨æ¸¬è©¦å’Œåˆ†æçµæœ"
        else
          echo "âŒ L3 (æ¸¬è©¦) å¿«å–: æœªå‘½ä¸­ - éœ€è¦å®Œæ•´æ¸¬è©¦å’Œåˆ†æ"
        fi
        
        echo ""
        echo "ğŸ’¡ å¿«å–å„ªåŒ–å»ºè­°:"
        
        CACHE_STRATEGY="${{ needs.analyze-cache-strategy.outputs.cache_strategy }}"
        case "$CACHE_STRATEGY" in
          "preserve")
            echo "  â€¢ æ–‡æª”è®Šæ›´: æ‰€æœ‰å¿«å–éƒ½æ‡‰è©²å‘½ä¸­ï¼Œå¤§å¹…ç¯€çœæ™‚é–“"
            ;;
          "selective")
            echo "  â€¢ é¸æ“‡æ€§å¿«å–: æ ¹æ“šè®Šæ›´æ™ºèƒ½é¸æ“‡å¿«å–ç­–ç•¥"
            ;;
          "refresh")
            echo "  â€¢ åˆ·æ–°ç­–ç•¥: ä¾è³´è®Šæ›´éœ€è¦é‡å»ºæ‰€æœ‰å¿«å–"
            ;;
          *)
            echo "  â€¢ æ¨™æº–ç­–ç•¥: ä½¿ç”¨é è¨­å¿«å–è¡Œç‚º"
            ;;
        esac

    - name: ğŸ¯ å¿«å–ç­–ç•¥é©—è­‰
      run: |
        echo "ğŸ¯ é©—è­‰æ™ºèƒ½å¿«å–ç­–ç•¥åŸ·è¡Œçµæœ"
        echo "======================================"
        
        # è¨ˆç®—é ä¼°ç¯€çœæ™‚é–“
        CACHE_HIT_COUNT=0
        TOTAL_CACHE_LAYERS=3
        
        [ "${{ steps.pip-cache.outputs.cache-hit }}" = "true" ] && ((CACHE_HIT_COUNT++))
        [ "${{ steps.deps-cache.outputs.cache-hit }}" = "true" ] && ((CACHE_HIT_COUNT++))  
        [ "${{ steps.test-cache.outputs.cache-hit }}" = "true" ] && ((CACHE_HIT_COUNT++))
        
        CACHE_HIT_RATE=$((CACHE_HIT_COUNT * 100 / TOTAL_CACHE_LAYERS))
        ESTIMATED_SAVINGS=$((CACHE_HIT_COUNT * 2))  # æ¯å±¤å¿«å–ç´„ç¯€çœ 2 åˆ†é˜
        
        echo "ğŸ“Š å¿«å–æ•ˆèƒ½æŒ‡æ¨™:"
        echo "  â€¢ å¿«å–å‘½ä¸­ç‡: ${CACHE_HIT_RATE}% (${CACHE_HIT_COUNT}/${TOTAL_CACHE_LAYERS})"
        echo "  â€¢ é ä¼°ç¯€çœæ™‚é–“: ${ESTIMATED_SAVINGS} åˆ†é˜"
        echo "  â€¢ å¿«å–ç­–ç•¥: ${{ needs.analyze-cache-strategy.outputs.cache_strategy }}"
        
        # æˆåŠŸæ¨™æº–
        if [ $CACHE_HIT_RATE -ge 50 ]; then
          echo "âœ… å¿«å–æ•ˆæœè‰¯å¥½ (å‘½ä¸­ç‡ â‰¥ 50%)"
        else
          echo "âš ï¸  å¿«å–æ•ˆæœéœ€è¦æ”¹å–„ (å‘½ä¸­ç‡ < 50%)"
        fi
        
        echo ""
        echo "ğŸš€ æ™ºèƒ½å¿«å–ç³»çµ±å·²å°±ç·’ï¼Œå¾ŒçºŒ workflows å¯ä½¿ç”¨å„ªåŒ–çš„å¿«å–ï¼"