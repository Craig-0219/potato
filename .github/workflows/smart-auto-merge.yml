name: ğŸ§  Smart Auto Merge - Dev to Main

# æ¬Šé™è¨­ç½®
permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read

on:
  # ç•¶è¼•é‡ç´š CI æˆåŠŸå®Œæˆæ™‚è§¸ç™¼
  workflow_run:
    workflows: ["ğŸš€ Lightweight CI - Essential Checks Only"]
    types: [completed]
    branches: [dev]

  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      merge_type:
        description: 'åˆä½µé¡å‹'
        required: true
        default: 'auto'
        type: choice
        options:
        - auto        # è‡ªå‹•åˆ¤æ–·
        - force       # å¼·åˆ¶åˆä½µ
        - skip        # è·³éåˆä½µ
      bypass_checks:
        description: 'ç¹éé¡å¤–æª¢æŸ¥'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.10'

jobs:
  # æ™ºèƒ½æ±ºç­–ç³»çµ±
  merge-decision:
    name: ğŸ¤– åˆä½µæ±ºç­–åˆ†æ
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'

    outputs:
      should_merge: ${{ steps.decision.outputs.should_merge }}
      merge_reason: ${{ steps.decision.outputs.merge_reason }}
      risk_level: ${{ steps.decision.outputs.risk_level }}
      changed_files: ${{ steps.analysis.outputs.changed_files }}

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        ref: dev
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ” è®Šæ›´åˆ†æ
      id: analysis
      run: |
        echo "ğŸ” åˆ†ææœ€è¿‘çš„è®Šæ›´..."

        # ç²å–è®Šæ›´æ–‡ä»¶
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        echo "è®Šæ›´æ–‡ä»¶:"
        echo "$CHANGED_FILES" | tee changed_files.txt

        # çµ±è¨ˆè®Šæ›´
        TOTAL_FILES=$(echo "$CHANGED_FILES" | wc -l)
        CORE_FILES=$(echo "$CHANGED_FILES" | grep -E "(main\.py|config\.py|database_manager\.py)" | wc -l)
        COGS_FILES=$(echo "$CHANGED_FILES" | grep -E "bot/cogs/.*\.py" | wc -l)
        DOC_FILES=$(echo "$CHANGED_FILES" | grep -E "(\.md|docs/)" | wc -l)

        echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT
        echo "core_files=$CORE_FILES" >> $GITHUB_OUTPUT
        echo "cogs_files=$COGS_FILES" >> $GITHUB_OUTPUT
        echo "doc_files=$DOC_FILES" >> $GITHUB_OUTPUT
        echo "changed_files<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: ğŸ¤– æ™ºèƒ½åˆä½µæ±ºç­–
      id: decision
      run: |
        echo "ğŸ¤– åŸ·è¡Œæ™ºèƒ½åˆä½µæ±ºç­–..."

        # ç²å–æœ€æ–°æäº¤è¨Šæ¯
        LATEST_COMMIT=$(git log -1 --pretty=%B)
        echo "æœ€æ–°æäº¤: $LATEST_COMMIT"

        # é è¨­å€¼
        SHOULD_MERGE="false"
        MERGE_REASON="æœªçŸ¥åŸå› "
        RISK_LEVEL="medium"

        # æª¢æŸ¥æ‰‹å‹•è§¸ç™¼
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          if [ "${{ github.event.inputs.merge_type }}" = "force" ]; then
            SHOULD_MERGE="true"
            MERGE_REASON="æ‰‹å‹•å¼·åˆ¶åˆä½µ"
            RISK_LEVEL="low"
          elif [ "${{ github.event.inputs.merge_type }}" = "skip" ]; then
            SHOULD_MERGE="false"
            MERGE_REASON="æ‰‹å‹•è·³éåˆä½µ"
          fi
        fi

        # æª¢æŸ¥æäº¤æ¨™è¨˜
        if echo "$LATEST_COMMIT" | grep -q '\[no-merge\]'; then
          SHOULD_MERGE="false"
          MERGE_REASON="æäº¤åŒ…å« [no-merge] æ¨™è¨˜"
          echo "ğŸš« ç™¼ç¾ [no-merge] æ¨™è¨˜ï¼Œè·³éåˆä½µ"
        elif echo "$LATEST_COMMIT" | grep -q '\[force-merge\]'; then
          SHOULD_MERGE="true"
          MERGE_REASON="æäº¤åŒ…å« [force-merge] æ¨™è¨˜"
          RISK_LEVEL="low"
          echo "ğŸš€ ç™¼ç¾ [force-merge] æ¨™è¨˜ï¼ŒåŸ·è¡Œå¼·åˆ¶åˆä½µ"
        elif echo "$LATEST_COMMIT" | grep -q '\[merge\]'; then
          SHOULD_MERGE="true"
          MERGE_REASON="æäº¤åŒ…å« [merge] æ¨™è¨˜"
          RISK_LEVEL="low"
          echo "âœ… ç™¼ç¾ [merge] æ¨™è¨˜ï¼ŒåŸ·è¡Œè‡ªå‹•åˆä½µ"
        fi

        # åŸºæ–¼è®Šæ›´é¡å‹çš„æ™ºèƒ½æ±ºç­–
        if [ "$SHOULD_MERGE" = "false" ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
          TOTAL_FILES=${{ steps.analysis.outputs.total_files }}
          CORE_FILES=${{ steps.analysis.outputs.core_files }}
          COGS_FILES=${{ steps.analysis.outputs.cogs_files }}
          DOC_FILES=${{ steps.analysis.outputs.doc_files }}

          echo "è®Šæ›´çµ±è¨ˆ: ç¸½è¨ˆ=$TOTAL_FILES, æ ¸å¿ƒ=$CORE_FILES, Cogs=$COGS_FILES, æ–‡æª”=$DOC_FILES"

          # åªæœ‰æ–‡æª”è®Šæ›´ - è·³é
          if [ "$DOC_FILES" -gt 0 ] && [ "$CORE_FILES" -eq 0 ] && [ "$COGS_FILES" -eq 0 ]; then
            NON_DOC_FILES=$(echo "${{ steps.analysis.outputs.changed_files }}" | grep -v -E "(\.md|docs/|CHANGELOG|README)" | wc -l)
            if [ "$NON_DOC_FILES" -eq 0 ]; then
              SHOULD_MERGE="false"
              MERGE_REASON="åƒ…æ–‡æª”è®Šæ›´ï¼Œè·³éè‡ªå‹•åˆä½µ"
              echo "ğŸ“š åƒ…æª¢æ¸¬åˆ°æ–‡æª”è®Šæ›´ï¼Œè·³éåˆä½µ"
            fi
          fi

          # å°è¦æ¨¡è®Šæ›´ - è‡ªå‹•åˆä½µ
          if [ "$TOTAL_FILES" -le 5 ] && [ "$CORE_FILES" -eq 0 ]; then
            SHOULD_MERGE="true"
            MERGE_REASON="å°è¦æ¨¡è®Šæ›´ï¼Œè‡ªå‹•åˆä½µ"
            RISK_LEVEL="low"
            echo "âœ¨ æª¢æ¸¬åˆ°å°è¦æ¨¡è®Šæ›´ï¼ŒåŸ·è¡Œè‡ªå‹•åˆä½µ"
          fi

          # ä¸€èˆ¬è®Šæ›´ - è‡ªå‹•åˆä½µ
          if [ "$TOTAL_FILES" -le 10 ] && [ "$CORE_FILES" -le 1 ]; then
            SHOULD_MERGE="true"
            MERGE_REASON="ä¸€èˆ¬è¦æ¨¡è®Šæ›´ï¼Œè‡ªå‹•åˆä½µ"
            RISK_LEVEL="medium"
            echo "ğŸ”„ æª¢æ¸¬åˆ°ä¸€èˆ¬è®Šæ›´ï¼ŒåŸ·è¡Œè‡ªå‹•åˆä½µ"
          fi

          # å¤§è¦æ¨¡è®Šæ›´ - éœ€è¦æª¢æŸ¥
          if [ "$TOTAL_FILES" -gt 10 ] || [ "$CORE_FILES" -gt 1 ]; then
            echo "âš ï¸ æª¢æ¸¬åˆ°å¤§è¦æ¨¡è®Šæ›´ï¼Œéœ€è¦é¡å¤–æª¢æŸ¥"

            # å¦‚æœè¼•é‡ç´š CI é€šéï¼Œä»å¯åˆä½µ
            if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
              SHOULD_MERGE="true"
              MERGE_REASON="å¤§è¦æ¨¡è®Šæ›´ä½† CI é€šéï¼ŒåŸ·è¡Œåˆä½µ"
              RISK_LEVEL="high"
              echo "âœ… CI é€šéï¼ŒåŸ·è¡Œå¤§è¦æ¨¡è®Šæ›´åˆä½µ"
            fi
          fi
        fi

        # è¼¸å‡ºçµæœ
        echo "should_merge=$SHOULD_MERGE" >> $GITHUB_OUTPUT
        echo "merge_reason=$MERGE_REASON" >> $GITHUB_OUTPUT
        echo "risk_level=$RISK_LEVEL" >> $GITHUB_OUTPUT

        echo "ğŸ¯ åˆä½µæ±ºç­–çµæœ:"
        echo "  åˆä½µ: $SHOULD_MERGE"
        echo "  åŸå› : $MERGE_REASON"
        echo "  é¢¨éšª: $RISK_LEVEL"

  # åŸ·è¡Œè‡ªå‹•åˆä½µ
  execute-merge:
    name: ğŸš€ åŸ·è¡Œè‡ªå‹•åˆä½µ
    runs-on: ubuntu-latest
    needs: merge-decision
    if: needs.merge-decision.outputs.should_merge == 'true'

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: âš™ï¸ è¨­ç½® Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git config --local pull.rebase false

    - name: ğŸ”„ åŸ·è¡Œåˆä½µæ“ä½œ
      run: |
        echo "ğŸ”„ é–‹å§‹åŸ·è¡Œè‡ªå‹•åˆä½µ..."
        echo "åˆä½µåŸå› : ${{ needs.merge-decision.outputs.merge_reason }}"
        echo "é¢¨éšªç­‰ç´š: ${{ needs.merge-decision.outputs.risk_level }}"

        # ç¢ºä¿åˆ†æ”¯æ˜¯æœ€æ–°çš„
        git fetch origin

        # æª¢æŸ¥ main åˆ†æ”¯ç‹€æ…‹
        git checkout main
        git pull origin main

        # æª¢æŸ¥ dev åˆ†æ”¯ç‹€æ…‹
        git checkout dev
        git pull origin dev

        # åŸ·è¡Œåˆä½µ
        git checkout main

        # æ ¹æ“šé¢¨éšªç­‰ç´šé¸æ“‡åˆä½µç­–ç•¥
        if [ "${{ needs.merge-decision.outputs.risk_level }}" = "low" ]; then
          echo "ğŸš€ ä½é¢¨éšªåˆä½µ - ä½¿ç”¨ fast-forward"
          git merge dev --ff-only
        else
          echo "âš ï¸ ä¸­/é«˜é¢¨éšªåˆä½µ - å‰µå»ºåˆä½µæäº¤"
          MERGE_MSG="ğŸ”€ Auto merge dev to main - ${{ needs.merge-decision.outputs.merge_reason }} (Risk: ${{ needs.merge-decision.outputs.risk_level }})"
          git merge dev --no-ff -m "$MERGE_MSG"
        fi

        echo "âœ… åˆä½µå®Œæˆ"

    - name: ğŸ“¤ æ¨é€è®Šæ›´
      run: |
        echo "ğŸ“¤ æ¨é€åˆä½µçµæœåˆ° main åˆ†æ”¯..."
        git push origin main
        echo "ğŸ‰ è‡ªå‹•åˆä½µå®Œæˆï¼"

    - name: ğŸ“Š åˆä½µçµ±è¨ˆ
      run: |
        echo "ğŸ“Š åˆä½µçµ±è¨ˆè³‡è¨Š"
        echo "================"
        echo "åˆ†æ”¯: dev â†’ main"
        echo "æäº¤æ•¸: $(git rev-list --count dev ^main~1)"
        echo "è®Šæ›´æ–‡ä»¶: $(echo '${{ needs.merge-decision.outputs.changed_files }}' | wc -l)"
        echo "åˆä½µé¡å‹: ${{ needs.merge-decision.outputs.risk_level }} é¢¨éšª"
        echo "æ™‚é–“æˆ³: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

  # åˆä½µå¤±æ•—è™•ç†
  merge-failure:
    name: ğŸš¨ åˆä½µå¤±æ•—è™•ç†
    runs-on: ubuntu-latest
    needs: [merge-decision, execute-merge]
    if: failure() && needs.merge-decision.outputs.should_merge == 'true'

    steps:
    - name: ğŸš¨ è™•ç†åˆä½µå¤±æ•—
      run: |
        echo "ğŸš¨ è‡ªå‹•åˆä½µå¤±æ•—ï¼"
        echo "åŸå› : ${{ needs.merge-decision.outputs.merge_reason }}"
        echo ""
        echo "ğŸ”§ å¯èƒ½çš„è§£æ±ºæ–¹æ¡ˆ:"
        echo "1. æª¢æŸ¥æ˜¯å¦å­˜åœ¨åˆä½µè¡çª"
        echo "2. ç¢ºèª main åˆ†æ”¯æ²’æœ‰å—ä¿è­·è¦å‰‡é™åˆ¶"
        echo "3. é©—è­‰ GitHub Token æ¬Šé™"
        echo "4. æ‰‹å‹•åŸ·è¡Œåˆä½µ: git merge dev"
        echo ""
        echo "ğŸ“ è«‹é€šçŸ¥é–‹ç™¼åœ˜éšŠè™•ç†æ­¤å•é¡Œ"

  # è·³éåˆä½µé€šçŸ¥
  merge-skipped:
    name: â­ï¸ åˆä½µè·³éé€šçŸ¥
    runs-on: ubuntu-latest
    needs: merge-decision
    if: needs.merge-decision.outputs.should_merge == 'false'

    steps:
    - name: â­ï¸ åˆä½µè·³é
      run: |
        echo "â­ï¸ è·³éè‡ªå‹•åˆä½µ"
        echo "åŸå› : ${{ needs.merge-decision.outputs.merge_reason }}"
        echo ""
        echo "å¦‚éœ€æ‰‹å‹•åˆä½µï¼Œè«‹åŸ·è¡Œ:"
        echo "  git checkout main"
        echo "  git merge dev"
        echo "  git push origin main"
