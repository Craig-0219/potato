name: ğŸ§  Smart Change Detection

on:
  pull_request:
    branches: [main, dev]
  push:
    branches: [main, dev]
  workflow_dispatch:
    inputs:
      analysis_mode:
        description: 'åˆ†ææ¨¡å¼'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - detailed

env:
  CHANGE_DETECTION_VERSION: v2.0.0

jobs:
  analyze-changes:
    name: ğŸ” è®Šæ›´å½±éŸ¿åˆ†æ
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    outputs:
      change_type: ${{ steps.classify.outputs.change_type }}
      impact_level: ${{ steps.classify.outputs.impact_level }}
      test_strategy: ${{ steps.classify.outputs.test_strategy }}
      cache_strategy: ${{ steps.classify.outputs.cache_strategy }}
      skip_workflows: ${{ steps.classify.outputs.skip_workflows }}
      run_quality: ${{ steps.classify.outputs.run_quality }}
      run_security: ${{ steps.classify.outputs.run_security }}
      run_tests: ${{ steps.classify.outputs.run_tests }}
      changed_files: ${{ steps.collect.outputs.changed_files }}
      
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” æ”¶é›†è®Šæ›´æ–‡ä»¶
      id: collect
      run: |
        # æ ¹æ“šè§¸ç™¼äº‹ä»¶ç²å–è®Šæ›´æ–‡ä»¶
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # PR æ¨¡å¼ï¼šæ¯”è¼ƒ base å’Œ head
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
        else
          # Push æ¨¡å¼ï¼šæ¯”è¼ƒ HEAD å’Œå‰ä¸€å€‹æäº¤
          if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          else
            # æ–°åˆ†æ”¯çš„æƒ…æ³
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi
        fi
        
        echo "è®Šæ›´çš„æ–‡ä»¶:"
        echo "$CHANGED_FILES"
        
        # å°‡æ–‡ä»¶åˆ—è¡¨è¼¸å‡ºåˆ°ç’°å¢ƒè®Šæ•¸
        echo "changed_files<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # è¨ˆç®—è®Šæ›´çµ±è¨ˆ
        TOTAL_FILES=$(echo "$CHANGED_FILES" | wc -l)
        echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT

    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ğŸ§  æ™ºèƒ½è®Šæ›´åˆ†é¡
      id: classify
      run: |
        # è¨­ç½®ç’°å¢ƒè®Šæ•¸ä¸¦åŸ·è¡Œåˆ†é¡
        export CHANGED_FILES="${{ steps.collect.outputs.changed_files }}"
        python .github/scripts/classify-changes.py

    - name: ğŸ“‹ è¼¸å‡ºåˆ†æçµæœæ‘˜è¦
      run: |
        echo "ğŸ§  Smart Change Detection åˆ†æå®Œæˆ!"
        echo ""
        echo "ğŸ“Š åˆ†æçµæœ:"
        echo "â€¢ è®Šæ›´é¡å‹: ${{ steps.classify.outputs.change_type }}"
        echo "â€¢ å½±éŸ¿ç­‰ç´š: ${{ steps.classify.outputs.impact_level }}"
        echo "â€¢ å»ºè­°æ¸¬è©¦ç­–ç•¥: ${{ steps.classify.outputs.test_strategy }}"
        echo "â€¢ å»ºè­°å¿«å–ç­–ç•¥: ${{ steps.classify.outputs.cache_strategy }}"
        echo "â€¢ å¯è·³éçš„æª¢æŸ¥: ${{ steps.classify.outputs.skip_workflows }}"
        echo ""
        echo "ğŸ¯ å¾ŒçºŒ workflows å°‡æ ¹æ“šæ­¤åˆ†æçµæœèª¿æ•´åŸ·è¡Œç­–ç•¥"

  # æä¾›å…¶ä»– workflows å¯ä»¥ä½¿ç”¨çš„æ¢ä»¶è¼¸å‡º
  provide-conditions:
    name: ğŸ“‹ æä¾›æ™ºèƒ½åŸ·è¡Œæ¢ä»¶
    needs: analyze-changes
    runs-on: ubuntu-latest
    if: needs.analyze-changes.outputs.change_type != 'none'
    timeout-minutes: 1
    
    outputs:
      run_quality: ${{ needs.analyze-changes.outputs.run_quality }}
      run_security: ${{ needs.analyze-changes.outputs.run_security }}
      run_tests: ${{ needs.analyze-changes.outputs.run_tests }}
      change_type: ${{ needs.analyze-changes.outputs.change_type }}
      impact_level: ${{ needs.analyze-changes.outputs.impact_level }}
    
    steps:
    - name: ğŸ“‹ è¨˜éŒ„æ™ºèƒ½æ±ºç­–
      run: |
        echo "ğŸ§  æ™ºèƒ½è®Šæ›´æª¢æ¸¬åˆ†æå®Œæˆ"
        echo "=============================="
        echo ""
        echo "ğŸ“Š åˆ†æçµæœ:"
        echo "â€¢ è®Šæ›´é¡å‹: ${{ needs.analyze-changes.outputs.change_type }}"
        echo "â€¢ å½±éŸ¿ç­‰ç´š: ${{ needs.analyze-changes.outputs.impact_level }}"
        echo "â€¢ æ¸¬è©¦ç­–ç•¥: ${{ needs.analyze-changes.outputs.test_strategy }}"
        echo "â€¢ å¿«å–ç­–ç•¥: ${{ needs.analyze-changes.outputs.cache_strategy }}"
        echo ""
        echo "ğŸ¯ åŸ·è¡Œå»ºè­°:"
        echo "â€¢ å“è³ªæª¢æŸ¥: ${{ needs.analyze-changes.outputs.run_quality }}"
        echo "â€¢ å®‰å…¨æƒæ: ${{ needs.analyze-changes.outputs.run_security }}"
        echo "â€¢ æ¸¬è©¦åŸ·è¡Œ: ${{ needs.analyze-changes.outputs.run_tests }}"
        echo ""
        echo "ğŸ’¡ å…¶ä»– workflows å¯ä»¥ä½¿ç”¨é€™äº›æ¢ä»¶ä¾†æ™ºèƒ½è·³éä¸å¿…è¦çš„æ­¥é©Ÿ"
        echo "   ä¾‹å¦‚: if: needs.change-detection.outputs.run_tests == 'true'"