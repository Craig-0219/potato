name: ğŸ§  Smart Change Detection

on:
  pull_request:
    branches: [main, dev]
  push:
    branches: [main, dev]
  workflow_dispatch:
    inputs:
      analysis_mode:
        description: 'åˆ†ææ¨¡å¼'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - detailed

env:
  CHANGE_DETECTION_VERSION: v2.0.0

jobs:
  analyze-changes:
    name: ğŸ” è®Šæ›´å½±éŸ¿åˆ†æ
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    outputs:
      change_type: ${{ steps.classify.outputs.change_type }}
      impact_level: ${{ steps.classify.outputs.impact_level }}
      test_strategy: ${{ steps.classify.outputs.test_strategy }}
      cache_strategy: ${{ steps.classify.outputs.cache_strategy }}
      skip_workflows: ${{ steps.classify.outputs.skip_workflows }}
      changed_files: ${{ steps.collect.outputs.changed_files }}
      
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” æ”¶é›†è®Šæ›´æ–‡ä»¶
      id: collect
      run: |
        # æ ¹æ“šè§¸ç™¼äº‹ä»¶ç²å–è®Šæ›´æ–‡ä»¶
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # PR æ¨¡å¼ï¼šæ¯”è¼ƒ base å’Œ head
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
        else
          # Push æ¨¡å¼ï¼šæ¯”è¼ƒ HEAD å’Œå‰ä¸€å€‹æäº¤
          if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          else
            # æ–°åˆ†æ”¯çš„æƒ…æ³
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi
        fi
        
        echo "è®Šæ›´çš„æ–‡ä»¶:"
        echo "$CHANGED_FILES"
        
        # å°‡æ–‡ä»¶åˆ—è¡¨è¼¸å‡ºåˆ°ç’°å¢ƒè®Šæ•¸
        echo "changed_files<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # è¨ˆç®—è®Šæ›´çµ±è¨ˆ
        TOTAL_FILES=$(echo "$CHANGED_FILES" | wc -l)
        echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT

    - name: ğŸ§  æ™ºèƒ½è®Šæ›´åˆ†é¡
      id: classify
      run: |
        # è¨­ç½®ç’°å¢ƒè®Šæ•¸ä¸¦åŸ·è¡Œåˆ†é¡
        export CHANGED_FILES="${{ steps.collect.outputs.changed_files }}"
        python .github/scripts/classify_changes.py

    - name: ğŸ“‹ è¼¸å‡ºåˆ†æçµæœæ‘˜è¦
      run: |
        echo "ğŸ§  Smart Change Detection åˆ†æå®Œæˆ!"
        echo ""
        echo "ğŸ“Š åˆ†æçµæœ:"
        echo "â€¢ è®Šæ›´é¡å‹: ${{ steps.classify.outputs.change_type }}"
        echo "â€¢ å½±éŸ¿ç­‰ç´š: ${{ steps.classify.outputs.impact_level }}"
        echo "â€¢ å»ºè­°æ¸¬è©¦ç­–ç•¥: ${{ steps.classify.outputs.test_strategy }}"
        echo "â€¢ å»ºè­°å¿«å–ç­–ç•¥: ${{ steps.classify.outputs.cache_strategy }}"
        echo "â€¢ å¯è·³éçš„æª¢æŸ¥: ${{ steps.classify.outputs.skip_workflows }}"
        echo ""
        echo "ğŸ¯ å¾ŒçºŒ workflows å°‡æ ¹æ“šæ­¤åˆ†æçµæœèª¿æ•´åŸ·è¡Œç­–ç•¥"

  # æ ¹æ“šåˆ†æçµæœæ±ºå®šæ˜¯å¦è§¸ç™¼å…¶ä»– workflows
  trigger-conditional-workflows:
    name: ğŸš€ æ¢ä»¶è§¸ç™¼å¾ŒçºŒæª¢æŸ¥
    needs: analyze-changes
    runs-on: ubuntu-latest
    if: needs.analyze-changes.outputs.change_type != 'none'
    timeout-minutes: 2
    
    steps:
    - name: ğŸ“‹ è¨˜éŒ„è§¸ç™¼æ±ºç­–
      run: |
        echo "ğŸ“ˆ æ ¹æ“šè®Šæ›´åˆ†æçµæœè§¸ç™¼ç›¸æ‡‰æª¢æŸ¥:"
        echo ""
        
        CHANGE_TYPE="${{ needs.analyze-changes.outputs.change_type }}"
        IMPACT_LEVEL="${{ needs.analyze-changes.outputs.impact_level }}"
        SKIP_WORKFLOWS="${{ needs.analyze-changes.outputs.skip_workflows }}"
        
        case "$CHANGE_TYPE" in
          "critical")
            echo "ğŸš¨ é—œéµè®Šæ›´ - è§¸ç™¼å®Œæ•´æª¢æŸ¥å¥—ä»¶"
            echo "  âœ… ä»£ç¢¼å“è³ªæª¢æŸ¥"
            echo "  âœ… å®‰å…¨æƒæ"
            echo "  âœ… å®Œæ•´æ¸¬è©¦å¥—ä»¶"
            ;;
          "code"|"api")
            echo "âš¡ ä»£ç¢¼è®Šæ›´ - è§¸ç™¼é‡å°æ€§æª¢æŸ¥"
            echo "  âœ… ä»£ç¢¼å“è³ªæª¢æŸ¥" 
            echo "  âœ… å®‰å…¨æƒæ"
            echo "  âœ… ç›¸é—œæ¸¬è©¦"
            ;;
          "docs")
            echo "ğŸ“š æ–‡æª”è®Šæ›´ - åƒ…è§¸ç™¼æ ¼å¼æª¢æŸ¥"
            echo "  âœ… æ–‡æª”æ ¼å¼æª¢æŸ¥"
            echo "  â­ï¸  è·³é: æ¸¬è©¦ã€å®‰å…¨æƒæ"
            ;;
          "test")
            echo "ğŸ§ª æ¸¬è©¦è®Šæ›´ - è§¸ç™¼æ¸¬è©¦é©—è­‰"
            echo "  âœ… æ–°æ¸¬è©¦åŸ·è¡Œ"
            echo "  â­ï¸  è·³é: å®‰å…¨æƒæ"
            ;;
          *)
            echo "ğŸ”§ å…¶ä»–è®Šæ›´ - æ¨™æº–æª¢æŸ¥æµç¨‹"
            ;;
        esac
        
        echo ""
        echo "ğŸ’¡ æ™ºèƒ½è·³éæ©Ÿåˆ¶å·²å•Ÿå‹•ï¼Œé ä¼°ç¯€çœ 40-60% åŸ·è¡Œæ™‚é–“"

    - name: ğŸ¯ è¨­ç½®å¾ŒçºŒ workflow æ¢ä»¶
      id: conditions
      run: |
        # æ ¹æ“šåˆ†æçµæœè¨­ç½®æ¢ä»¶
        CHANGE_TYPE="${{ needs.analyze-changes.outputs.change_type }}"
        SKIP_WORKFLOWS="${{ needs.analyze-changes.outputs.skip_workflows }}"
        
        # æ±ºå®šæ˜¯å¦åŸ·è¡Œå„ç¨®æª¢æŸ¥
        RUN_QUALITY="true"
        RUN_SECURITY="true" 
        RUN_TESTS="true"
        
        if [[ "$SKIP_WORKFLOWS" == *"quality"* ]]; then
          RUN_QUALITY="false"
        fi
        
        if [[ "$SKIP_WORKFLOWS" == *"security"* ]]; then
          RUN_SECURITY="false"
        fi
        
        if [[ "$SKIP_WORKFLOWS" == *"tests"* ]]; then
          RUN_TESTS="false"
        fi
        
        # ç‰¹æ®Šæƒ…æ³è™•ç†
        if [ "$CHANGE_TYPE" = "docs" ]; then
          RUN_SECURITY="false"
          RUN_TESTS="false"
        fi
        
        echo "run_quality=$RUN_QUALITY" >> $GITHUB_OUTPUT
        echo "run_security=$RUN_SECURITY" >> $GITHUB_OUTPUT  
        echo "run_tests=$RUN_TESTS" >> $GITHUB_OUTPUT
        
        echo "ğŸ“‹ å¾ŒçºŒåŸ·è¡Œæ±ºç­–:"
        echo "  â€¢ ä»£ç¢¼å“è³ªæª¢æŸ¥: $RUN_QUALITY"
        echo "  â€¢ å®‰å…¨æƒæ: $RUN_SECURITY"
        echo "  â€¢ æ¸¬è©¦åŸ·è¡Œ: $RUN_TESTS"